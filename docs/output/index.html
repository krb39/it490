<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Ryan Tolboom">
<title>Systems Integration: A Project Based Approach</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Systems Integration: A Project Based Approach</h1>
<div class="details">
<span id="author" class="author">Ryan Tolboom</span><br>
<span id="email" class="email"><a href="mailto:Ryan.Tolboom@njit.edu">Ryan.Tolboom@njit.edu</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_legal">Legal</a></li>
<li><a href="#_preface">Preface</a></li>
<li><a href="#git">1. Git</a>
<ul class="sectlevel2">
<li><a href="#_version_control">1.1. Version Control</a></li>
<li><a href="#_getting_git">1.2. Getting Git</a></li>
<li><a href="#_basic_git_actions">1.3. Basic Git Actions</a></li>
<li><a href="#_example">1.4. Example</a></li>
<li><a href="#_resources">1.5. Resources</a></li>
</ul>
</li>
<li><a href="#_github">2. GitHub</a>
<ul class="sectlevel2">
<li><a href="#_purpose">2.1. Purpose</a></li>
<li><a href="#_remote_repositories">2.2. Remote Repositories</a></li>
<li><a href="#_issues">2.3. Issues</a></li>
<li><a href="#_pull_requests">2.4. Pull requests</a></li>
<li><a href="#_documentation">2.5. Documentation</a></li>
<li><a href="#_resources_2">2.6. Resources</a></li>
<li><a href="#_questions">2.7. Questions</a></li>
</ul>
</li>
<li><a href="#_yaml">3. YAML</a></li>
<li><a href="#_docker">4. Docker</a></li>
<li><a href="#_midterm_check_in">5. Midterm Check In</a>
<ul class="sectlevel2">
<li><a href="#_overview">5.1. Overview</a></li>
<li><a href="#_messaging">5.2. Messaging</a></li>
<li><a href="#_database">5.3. Database</a></li>
<li><a href="#_back_end">5.4. Back End</a></li>
<li><a href="#_front_end">5.5. Front End</a></li>
</ul>
</li>
<li><a href="#_replication">6. Replication</a>
<ul class="sectlevel2">
<li><a href="#_background">6.1. Background</a></li>
<li><a href="#_implementation">6.2. Implementation</a></li>
<li><a href="#_high_availability">6.3. High Availability</a></li>
<li><a href="#_load_balancing">6.4. Load Balancing</a></li>
<li><a href="#_questions_2">6.5. Questions</a></li>
</ul>
</li>
<li><a href="#_kubernetes">7. Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction">7.1. Introduction</a></li>
<li><a href="#_minikube">7.2. Minikube</a></li>
<li><a href="#_debugging">7.3. Debugging</a></li>
<li><a href="#_conclusion">7.4. Conclusion</a></li>
<li><a href="#_questions_3">7.5. Questions</a></li>
</ul>
</li>
<li><a href="#_database_in_kubernetes">8. Database in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_2">8.1. Introduction</a></li>
<li><a href="#_persistentvolumeclaims">8.2. PersistentVolumeClaims</a></li>
<li><a href="#_services">8.3. Services</a></li>
<li><a href="#_deployments">8.4. Deployments</a></li>
<li><a href="#_running_the_example">8.5. Running the Example</a></li>
<li><a href="#_conclusion_2">8.6. Conclusion</a></li>
<li><a href="#_questions_4">8.7. Questions</a></li>
</ul>
</li>
<li><a href="#_messaging_in_kubernetes">9. Messaging in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_resources_3">9.1. Resources</a></li>
<li><a href="#_rabbitmq">9.2. RabbitMQ</a></li>
<li><a href="#_kubernetes_2">9.3. Kubernetes</a></li>
<li><a href="#_example_2">9.4. Example</a></li>
<li><a href="#_questions_5">9.5. Questions</a></li>
</ul>
</li>
<li><a href="#_front_end_in_kubernetes">10. Front End in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_3">10.1. Introduction</a></li>
<li><a href="#_kubernetes_3">10.2. Kubernetes</a></li>
<li><a href="#_example_3">10.3. Example</a></li>
<li><a href="#_questions_6">10.4. Questions</a></li>
</ul>
</li>
<li><a href="#_back_end_in_kubernetes">11. Back End in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_4">11.1. Introduction</a></li>
<li><a href="#_questions_7">11.2. Questions</a></li>
</ul>
</li>
<li><a href="#_google_cloud_platform">12. Google Cloud Platform</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/logo.png" alt="logo" width="33%">
</div>
</div>
<div class="paragraph text-center">
<p>eBook versions: <a href="systems-integration.epub">ePub</a> | <a href="systems-integration.mobi">mobi</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_legal">Legal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This work is licensed under a
<a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons
Attribution-ShareAlike 4.0 International License.</a></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/cc.png" alt="Creative Commons License"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of this text is to provide a practical introduction to systems
integration by designing and implementing an actual system. In accordance with
the show-me-the-code attitude of the open source software movement, all of the
code for the text and examples are available at
<a href="https://github.com/rxt1077/it490" class="bare">https://github.com/rxt1077/it490</a>. The philosophy of this text can probably best
be summed up in a quote:</p>
</div>
<div class="quoteblock">
<blockquote>
Knowledge isn&#8217;t power until it&#8217;s applied.
</blockquote>
<div class="attribution">
&#8212; Dale Carnegie
</div>
</div>
<div class="paragraph">
<p>A computer that meets <a href="https://ist.njit.edu/fall-2020-recommended-specs/">these</a>
minimum specifications will be required to complete the coursework.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="git">1. Git</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/git.png" alt="git" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_version_control">1.1. Version Control</h3>
<div class="paragraph">
<p>In the simplest sense, version control tracks changes to a group of files.
Building off of this premise, teams can use version control to cooperative
change a group of files and revert to a previous state if needed.</p>
</div>
<div class="paragraph">
<p>Some of the benefits of a version control system can be understood if you
consider a few examples:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Programming Project</div>
<div class="content">
<div class="paragraph">
<p>You are working on a project for your CS101 class and you need to write a
Python program that plays tic-tac-toe. It must support player-vs-computer
<em>and</em> player-vs-player. It&#8217;s due in two days. On the first day you write the
initial code and implement player-vs-player. It works great and you fall asleep
knowing tomorrow you will finish it and turn it in on time. The next morning
you update it to support player-vs-computer and <em>everything</em> stops working.
What do you do now?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you were working with a version control system, you could easily roll-back
your changes and see what went wrong.</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Working with a Team</div>
<div class="content">
<div class="paragraph">
<p>You are working working with a team of people to implement a complex system
that utilizes several files in several different directories. How do you make
sure everyone has the most up-to-date version of the files? What happens if two
people work on the same file at the same time?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In a version control system, you could set up a centralized repository for the
files and have everyone pull from one location. In the case of two people
working on the same thing at the same time, a version control system could
handle merging their changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_getting_git">1.2. Getting Git</h3>
<div class="paragraph">
<p>Depending on the OS you are using, there are a few different ways to install
git on your machine:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Windows</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://gitforwindows.org/">git for windows</a>: Installs git, git BASH, and a
GUI. The git command can then be run from PowerShell, CMD, or the BASH shell
(which it installs).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Mac</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://sourceforge.net/projects/git-osx-installer/files/">git for Mac Installer</a>:
Provides an easy installer for git on MacOS.</p>
</li>
<li>
<p><a href="https://developer.apple.com/xcode/">Xcode</a>: Xcode installs a command line git
and you may have it installed already.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Linux</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Basically all distributions have git available in their standard package
manager. Chances are, if you&#8217;re running Linux you have it installed already,
so I&#8217;ll take the opportunity to highlight the strangest distro I can think of:
You can install git in <a href="http://hannahmontana.sourceforge.net/">Hannah Montana
Linux</a> with the command <code>apt-get install git</code>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_basic_git_actions">1.3. Basic Git Actions</h3>
<div class="sect3">
<h4 id="_creating_a_repository">1.3.1. Creating a Repository</h4>
<div class="paragraph">
<p>Any directory can be made into a git repository by running the <code>git init</code>
command. This will add the <code>.git</code> directory which stores information about the
state of the repository and certain user variables.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cloning_a_repository">1.3.2. Cloning a Repository</h4>
<div class="paragraph">
<p>If you want to make a copy of an already existing repository, typically done
when you <em>start</em> working on a project, the <code>git clone</code> command will make a copy
of a repository using any supported protocol.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tracking_staging_files">1.3.3. Tracking / Staging Files</h4>
<div class="paragraph">
<p>You need to tell git which files you want to keep track of and when you want to
stage them to be committed. These both use the same command <code>git add</code>. The
first time you call <code>git add</code> it begins tracking the file and stages it for a
commit. The second time you call <code>git add</code> it tells git that you want to commit
any changes to that file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_committing_changes_to_a_repository">1.3.4. Committing Changes to a Repository</h4>
<div class="paragraph">
<p>Once you have made some changes to your repository and staged those files with
<code>git add</code> you can use the <code>git commit</code> command to <em>commit</em> your changes. All
commits must have a message, and git will use a default editor depending on
your installation.
<a href="https://help.github.com/en/github/using-git/associating-text-editors-with-git">
This can be changed.</a> To complete the commit, add a message, save the file, and
exit the editor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_a_remote">1.3.5. Setting Up a Remote</h4>
<div class="paragraph">
<p>Git repositories are often linked to a remote repository. This could be a
service, like <a href="https://github.com">GitHub</a>, <a href="https://gitlab.com">GitLab</a>, or
<a href="https://sr.ht">SourceHut</a> or more simply another server that the team has
access to. The <code>git remote add origin</code> command adds a remote URL that is the
default target for actions. You can then <code>git push</code> your changes to the remote
or <code>git pull</code> to get the latest changes from the remote. The <code>git clone</code>
command automatically sets the origin.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example">1.4. Example</h3>
<div class="paragraph">
<p>Let&#8217;s take a look at an example of two people, Jessica and Darsh, working with
the same remote repository:</p>
</div>
<div class="listingblock">
<div class="title">Jessica&#8217;s First Session (PowerShell)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS jess&gt; mkdir example <i class="conum" data-value="1"></i><b>(1)</b>


    Directory: jess


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        4/22/2020  10:02 PM                example


PS jess&gt; cd example
PS jess\example&gt; git init <i class="conum" data-value="2"></i><b>(2)</b>
Initialized empty Git repository in jess/example/.git/
PS jess\example&gt; Set-Content -Path 'test.txt' -Value 'Hello from git!' <i class="conum" data-value="3"></i><b>(3)</b>
PS jess\example&gt; git add . <i class="conum" data-value="4"></i><b>(4)</b>
PS jess\example&gt; git commit -m "Initial Commit" <i class="conum" data-value="5"></i><b>(5)</b>
[master (root-commit) 46c7c75] Initial Commit
 1 file changed, 0 insertions(+), 0 deletions(-)
 create mode 100644 test.txt
PS jess\example&gt; git remote add origin ssh://git@192.168.10.1/home/git/example.git <i class="conum" data-value="6"></i><b>(6)</b>
PS jess\example&gt; git push origin master <i class="conum" data-value="7"></i><b>(7)</b>
git@192.168.10.1's password:
Enumerating objects: 3, done.
Counting objects: 100% (3/3), done.
Writing objects: 100% (3/3), 249 bytes | 249.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To ssh://192.168.10.1/home/git/example.git
 * [new branch]      master -&gt; master</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Jessica will be creating the repository, so she makes a new directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inside the directory, she uses <code>git init</code> to initialize it</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/set-content?view=powershell-7">
She adds some content so she has something to commit</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The form <code>git add .</code> means <em>stage all files in this directory</em>. It is the
most common invokation of <code>git add</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Jessica commits her work. The <code>-m</code> option allows her to add a commit
message without needing to open an editor.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>She adds a remote as the default. This <em>does</em> require configuration on the
remote server, a local machine in our case, but we will talk about how that is
usually handled in the <a href="#_github">GitHub</a> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Finally she pushes her changes to the remote so that Darsh can get them.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Darsh&#8217;s Session (BASH)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">darsh@laptop:~$ git clone ssh://git@192.168.10.1:/home/git/example.git <i class="conum" data-value="1"></i><b>(1)</b>
Cloning into 'example'...
remote: Enumerating objects: 3, done.
remote: Counting objects: 100% (3/3), done.
remote: Total 3 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (3/3), done.
darsh@laptop:~$ cd example <i class="conum" data-value="2"></i><b>(2)</b>
darsh@laptop:~/example$ cat test.txt
Hello from git! <i class="conum" data-value="3"></i><b>(3)</b>
darsh@laptop:~/example$ echo "Hello Jess!" &gt;&gt; test.txt <i class="conum" data-value="4"></i><b>(4)</b>
darsh@laptop:~/example$ git add . <i class="conum" data-value="5"></i><b>(5)</b>
darsh@laptop:~/example$ git commit -m "Added my message"
[master 55dc946] Added my message
 1 file changed, 1 insertion(+)
darsh@laptop:~/example$ git push
Counting objects: 3, done.
Writing objects: 100% (3/3), 271 bytes | 271.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To ssh://192.168.10.1:/home/git/example.git
   182a481..55dc946  master -&gt; master</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Darsh isn&#8217;t creating a new repository so he uses the <code>git clone</code> command to
clone the repository Jessica has made.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default, cloned repositories are put in their own directory based on the
repository name. You can specify a different directory by adding an argument
after the URL: <code>git clone ssh://git@192.168.10.1:/home/git/example.git
new-directory</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Jess&#8217;s content is there!</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Darsh appends a message of his own.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Then he follows the standard add, commit, push work flow to sync his
changes.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Jessica&#8217;s Second Session (PowerShell)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS jess\example&gt; Get-Content -Path 'test.txt'
Hello from git! <i class="conum" data-value="1"></i><b>(1)</b>
PS jess\example&gt; git pull origin master <i class="conum" data-value="2"></i><b>(2)</b>
git@192.168.10.1's password:
From ssh://192.168.10.1/home/git/example
 * branch            master     -&gt; FETCH_HEAD
Updating 182a481..55dc946
Fast-forward
 test.txt | 1 +
 1 file changed, 1 insertion(+)
PS jess\example&gt; Get-Content -Path 'test.txt'
Hello from git! <i class="conum" data-value="3"></i><b>(3)</b>
Hello Jess!</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When Jess goes to check on Darsh&#8217;s work, it isn&#8217;t there! Why?</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Because she hasn&#8217;t pulled from the remote yet.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Once she does, she can see Darsh&#8217;s addition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This scenario begs the question, "What would happen if Jess didn&#8217;t pull Darsh&#8217;s
work and kept working on her local, unsynced copy?" Assuming they were both
working on the same file, when Jess goes to push there would be a
<a href="https://www.atlassian.com/git/tutorials/using-branches/merge-conflicts">merge
conflict.</a> Git is very good at resolving conflicts and team members tend to be
working on different parts of the codebase, making the resolution simpler.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resources">1.5. Resources</h3>
<div class="ulist">
<ul>
<li>
<p>The entire <a href="https://git-scm.com/book/en/v2">Pro Git Book</a> can be found online.
It is a comprehensive text that will cover much more than the brief outline
presented here.</p>
</li>
<li>
<p>GitHub has some <a href="https://try.github.io">excellent and interactive resources</a>
for learning to use git.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_github">2. GitHub</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/github.svg" alt="github" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_purpose">2.1. Purpose</h3>
<div class="paragraph">
<p><a href="https://github.com">GitHub</a> is a service that provides a space for remote git
repositories. It features an extensive web interface and several project
management features.</p>
</div>
<div class="paragraph">
<p>GitHub has become a popular for open-source projects and is a
<a href="https://pydanny.blogspot.com/2011/08/github-is-my-resume.html">great way</a>
to showcase your projects to prospective employers. It is free to sign up for
GitHub and we will be using it for project management in this course. I suggest
you sign up with your .edu email address and UCID as your username to keep
things simple.</p>
</div>
</div>
<div class="sect2">
<h3 id="_remote_repositories">2.2. Remote Repositories</h3>
<div class="paragraph">
<p>To set up a remote repository in GitHub, follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a local git repository as shown in the <a href="#git">previous section</a>.
Choose a repository name that is simple. Avoid spaces or trailing dashes as
Docker Compose may have troulbe with them.</p>
</li>
<li>
<p>Sign in to GitHub and navigate to <a href="https://github.com/new">Create a New
Repository</a></p>
</li>
<li>
<p>Put in the your repository name (make sure it matches your local repository
name) and a description.</p>
</li>
<li>
<p>GitHub now offers unlimited private repositories with unlimited
collaborators. This means you could complete your project in a private
repository, just be sure to add your instructor as a collaborator. Later when
you want to showcase your work, it may be a good idea to make this repository
public.</p>
</li>
<li>
<p>You can also work in a public repository and it can be good practice for
learning to separate your secrets from your commits. You will still need to
add group members as collaborators, but your instructor should be able to
have ready-only access without any additional setup.</p>
</li>
<li>
<p>Once you click "Create Repository", instructions will be provided for setting
the remote on your local repository. It is very similar to the scenario
covered in the <a href="#git">previous section</a>. Follow the directions.</p>
</li>
<li>
<p>Now your group members should be able to <code>clone</code> the repository, but they will
not be able to make commits until you invite them as collaborators.</p>
</li>
<li>
<p>Go to <em>Settings (top right gear icon) &#8594; Manage access &#8594; Invite a
Collaborator</em> within the GitHub web interface for your repository. Add all of
your group members as collaborators.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_issues">2.3. Issues</h3>
<div class="paragraph">
<p>GitHub has a built-in bug tracker called <em>Issues</em>. You can find it next to the
<em>Code</em> tab, under the repository name when viewing a repository. An issue is
typically a bug that needs to be fixed or a feature that needs to be
implemented. It can be assigned to a group member who can then close it when it
is completed. It can also be linked to a milestone, which can be thought of as
as group of things that need to be done to reach the next phase.</p>
</div>
<div class="paragraph">
<p>We will be using the GitHub Issues to monitor individual contributions to a
project and to see how well a team functions. Do not be afraid to create issues
and use the discussion features inside of them. They help document your
progress. You will also have milestones assigned as you progress through the
text. You should create those milestones in GitHub and assign the goals
accordingly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pull_requests">2.4. Pull requests</h3>
<div class="paragraph">
<p>For complex projects or projects that have external contributers GitHub
supports a fork-based pull request (PR) workflow. Although we probably won&#8217;t
be using it too much, it is helpful to know how it works in case you end up
working on larger projects, you want to contribute to another project, or your
instructor wants to contribute to your project.</p>
</div>
<div class="paragraph">
<p>In GitHub, a typical PR workflow looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pr.svg" alt="pr" width="470" height="584">
</div>
<div class="title">Figure 1. Pull Request</div>
</div>
<div class="paragraph">
<p>A contributer forks a project (makes their own personal copy), which is as easy
as clicking the <em>Fork</em> button in the upper-right when viewing a project
repository. They change the parts of the repository that they want to in their
personal copy and commit their changes. Then they click on <em>Pull Requests &#8594;
Create Pull Request</em> on the project&#8217;s repository. GitHub defaults to creating
PRs across branches (a good technique when working on a large project with lots
of contributers), but you can select PRs across forks as well. The owner of the
project can review the PR and if they like the changes they have the option to
merge them with their repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="_documentation">2.5. Documentation</h3>
<div class="paragraph">
<p>GitHub supports several styles of documentation, but the most common is
<a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a>. Files written in markdown and
ending in the <code>.md</code> extension will be rendered and displayed when viewed in the
GitHub web interface. If a file named <code>README.md</code> exists in a directory, it
will be automatically displayed at the bottom of a directory listing. This
makes it easy to build documentation right into your repository. Learn markdown
and be sure to have a <code>README.md</code> in your repository.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
</div>
<div class="sect2">
<h3 id="_resources_2">2.6. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://guides.github.com/features/issues/">Mastering Issues</a></p>
</li>
<li>
<p><a href="https://www.atlassian.com/git/tutorials/making-a-pull-request">Making a Pull Request</a></p>
</li>
<li>
<p><a href="https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-requests#draft-pull-requests">
About Pull Requests</a></p>
</li>
<li>
<p><a href="https://www.markdownguide.org/">The Markdown Guide</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions">2.7. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What does GitHub provide for a project?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between using git and GitHub?</em></p>
<p></p>
</li>
<li>
<p><em>A new member joins your team. As the maintainer of the repository on GitHub, what steps do you need to take so that they have commit access to the repository? What steps does the group member need to take to get set up?</em></p>
<p></p>
</li>
<li>
<p><em>What is the purpose of issues in GitHub?</em></p>
<p></p>
</li>
<li>
<p><em>Why might a team want to use pull requests instead of adding all contributers as collaborators to a project?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_yaml">3. YAML</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_docker">4. Docker</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_midterm_check_in">5. Midterm Check In</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section summarizes the content of the class so far and provides an example
of a system that meets the midterm goals. This example is just one way to solve
the problem. It&#8217;s not the only way, in fact it&#8217;s not even the best way. The
example&#8217;s purpose is to show you a solution that avoids common pitfalls.
Hopefully you can integrate some of the lessons of this example into your
project.</p>
</div>
<div class="sect2">
<h3 id="_overview">5.1. Overview</h3>
<div class="paragraph">
<p>At this point you should have a working system that can be pulled from a git
repository and brought up with <code>docker-compose up</code>. As a reminder, the midterm
deliverables used to the project are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <strong>Front End</strong> that interacts with the user via HTTP and communicates
with the messaging container.</p>
</li>
<li>
<p><strong>Messaging</strong> (RabbitMQ) that brokers the exchange of information
between the front end and the back end.</p>
</li>
<li>
<p><strong>Database</strong> (PostgreSQL, MariaDB, MySQL) that only <strong>Back End</strong> uses for storage
of persistent information. All stateful information should be stored in a
volume.</p>
</li>
<li>
<p>A <strong>Back End</strong> that gathers information from your data sources, reads and
writes from the database, and interacts with the messaging container.</p>
</li>
<li>
<p>These four services work with each other to provide a web-based registration
and authentication system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The project is structured in such a way that <strong>Front End</strong> and <strong>Back End</strong>
never communicate directly and <strong>Back End</strong> is the only service that can
write to the <strong>Database</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/overview_compose.svg" alt="overview compose" width="587" height="103">
</div>
</div>
<div class="paragraph">
<p>This allows for more scalability when we introduce replication in the second
half of the semester.</p>
</div>
<div class="paragraph">
<p>An example directory structure is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   .env
   docker-compose.yml

back_end
       app.py
       Dockerfile
       requirements.txt

db
       Dockerfile
       setup.sql

front_end
       app.py
       Dockerfile
       requirements.txt
       wait-for-it.sh
    
    templates
            base.html
            login.html
            register.html</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Notice the <code>.env</code> file in the directory structure. docker-compose will
load environment variables from this file that you can then use in the
<code>docker-compose.yml</code> file. This keeps you from having to repeat yourself when
multiple services need the same information. For example, both <strong>Database</strong> and
<strong>Back End</strong> need to know the <code>POSTGRES_PASSWORD</code>. It also allows you to have a
single secret file that you can put in <code>.gitignore</code> to keep out of your
repository.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_messaging">5.2. Messaging</h3>
<div class="paragraph">
<p>In our example, the <strong>Messaging</strong> can be run straight from the
<a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Docker Hub image</a> via the
<code>docker-compose.yml</code> file, hence the absence of a <code>messaging</code> directory with a
<code>Dockerfile</code> in the directory structure. The image allows for sufficient
configuration via its environment variables. At this point it is recommended
that you still run the management interface and forward the management interface
port, 15672, so that you can see how the queues are being used. The messaging
service will be used in the
<a href="https://www.rabbitmq.com/tutorials/tutorial-six-python.html">request / reply pattern</a>
detailed in the diagram below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/messaging.svg" alt="messaging" width="349" height="293">
</div>
</div>
<div class="paragraph">
<p>Fortunately this works out-of-the-box since queue creation is handled by the
by the clients. The service simply has to be up and running to function.</p>
</div>
<div class="paragraph">
<p>The service definition in <code>docker-compose.yml</code> can be seen here:</p>
</div>
<div class="listingblock">
<div class="title">docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">    messaging:
        image: 'rabbitmq:3-management'
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
            RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE}
        ports:
            - 15672:15672</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moving forward, we will migrate from a single RabbitMQ instance to a
cluster. Familiarize yourself with the
<a href="https://www.rabbitmq.com/clustering.html">RabbitMQ Clustering Guide</a> and then
see if you can create a three node cluster with docker-compose.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> You may still be able to do this with just environment variables
in the <code>docker-compose.yml</code> file. If you need to, feel free to create new
container images in separate directories with their own Dockerfiles. There are
also plenty of good
<a href="https://github.com/harbur/docker-rabbitmq-cluster">web resources</a> to explore.</p>
</div>
</div>
<div class="sect2">
<h3 id="_database">5.3. Database</h3>
<div class="paragraph">
<p><strong>Database</strong> is responsible for storing the persistent information the system
uses. It only communicates with <strong>Back End</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/database.svg" alt="database" width="234" height="117">
</div>
</div>
<div class="paragraph">
<p>In this example, <strong>Database</strong> creates a database and the appropriate tables <em>if</em>
the database is currently empty. This can be done by placing the SQL file that
we want executed in <code>/docker-entrypoint-initdb.d/</code> of the image. Our
<code>db/Dockerfile</code> handles copying our initialization SQL appropriately:</p>
</div>
<div class="listingblock">
<div class="title">db/Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="Dockerfile" class="language-Dockerfile hljs">FROM postgres
COPY setup.sql /docker-entrypoint-initdb.d/</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">db/setup.sql</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="SQL" class="language-SQL hljs">CREATE DATABASE example;
\c example
CREATE TABLE users(
    email VARCHAR(255) PRIMARY KEY,
    hash VARCHAR(255) NOT NULL
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The schema in this example is quite simple, consisting of a database and a
single table for holding emails and hashes. It should be noted that the <code>\c</code>
command is specific to PostgreSQL and it is the equivalent of a <code>USE</code> statement
in MySQL, meaning use that particular database.</p>
</div>
<div class="paragraph">
<p>The relevant service definition part of the <code>docker-compose.yml</code> file can be seen
here:</p>
</div>
<div class="listingblock">
<div class="title">docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">    db:
        build: ./db
        environment:
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        volumes:
            - data-volume:/var/lib/postgresql/data</code></pre>
</div>
</div>
<div class="paragraph">
<p>The database files are stored in a Docker volume named <code>data-volume</code> and the
password for our database is loaded from an environment variable defined in
<code>.env</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="https://hub.docker.com/_/adminer/">adminer</a> image is a great way to see
what&#8217;s going on in your database. It provides a web interface to many different
types of databases that can be easily accessed via port 8080. See the example
<code>docker-compose.yml</code> file for an example of its use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Moving forward, we should begin to explore how we can implement replication to
make <strong>Database</strong> more scalable and resilient. Try to get a master / slave
configuration set up in a <code>docker-compose.yml</code>. How does replication help our
system? Will we need any other pieces to maximize its potential? Once again,
there are many good
<a href="https://medium.com/@2hamed/replicating-postgres-inside-docker-the-how-to-3244dc2305be">web resources</a>
on the topic.</p>
</div>
</div>
<div class="sect2">
<h3 id="_back_end">5.4. Back End</h3>
<div class="paragraph">
<p><strong>Back End</strong> brokers the exchange of information between <strong>Messaging</strong> and
<strong>Database</strong>. It also provides an area to perform the tasks needed to support the
complete system such as web scraping or computation. At this point, our example
does not include any of the latter and mainly focuses on storing / utilizing
authentication information in the database.</p>
</div>
<div class="paragraph">
<p>You can think of <strong>Back End</strong> as providing an API that is accessible through
<strong>Messaging</strong>. Any language can be a good choice for the <strong>Back End</strong> as long as it
has libraries to interface with <strong>Database</strong> and <strong>Messaging</strong>.</p>
</div>
<div class="ulist">
<div class="title">Popular Libraries used by <strong>Back End</strong></div>
<ul>
<li>
<p>Python</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.psycopg.org/">psycopg2</a> (PostgreSQL)</p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/connector-python/en/">mysql.connector</a> (MySQL / MariaDB)</p>
</li>
<li>
<p><a href="https://github.com/pika/pika">pika</a> (RabbitMQ)</p>
</li>
</ul>
</div>
</li>
<li>
<p>PHP</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.php.net/manual/en/book.mysqli.php">mysqli</a> (MySQL / MariaDB)</p>
</li>
<li>
<p><a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a> (RabbitMQ)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/backend.svg" alt="backend" width="693" height="245">
</div>
</div>
<div class="paragraph">
<p>The code for the <strong>Back End</strong> example is entirely contained in <code>back_end/app.py</code>.
<strong>Back End</strong> starts by connecting to both <strong>Messaging</strong> and <strong>Database</strong> using the
pika and psycopg2 libraries respectively. With Docker Compose you don&#8217;t know
when the services will become available so the example repeatedly attempts to
connect, waiting up to 60 seconds and
<a href="https://en.wikipedia.org/wiki/Exponential_backoff">backing off exponentially</a>
each time. Below is an example of typical startup output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="console" class="language-console hljs">&gt; docker-compose logs --tail=100 back_end | Select-String -Pattern root

back_end_1   | INFO:root:Waiting 1s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Waiting 2s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Waiting 4s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Waiting 8s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Starting consumption...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example then creates the required database cursor, messaging channel,
messaging queues, and sets up a callback for messages arriving in the <code>requests</code>
queue. This is where the majority of work is performed and the function can be
seen here:</p>
</div>
<div class="listingblock">
<div class="title">back_end/app.py (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="python" class="language-python hljs">def process_request(ch, method, properties, body):
    """
    Gets a request from the queue, acts on it, and returns a response to the
    reply-to queue
    """
    request = json.loads(body)
    if 'action' not in request:
        response = {
            'success': False,
            'message': "Request does not have action"
        }
    else:
        action = request['action']
        if action == 'GETHASH':
            data = request['data']
            email = data['email']
            logging.info(f"GETHASH request for {email} received")
            curr.execute('SELECT hash FROM users WHERE email=%s;', (email,))
            row =  curr.fetchone()
            if row == None:
                response = {'success': False}
            else:
                response = {'success': True, 'hash': row[0]}
        elif action == 'REGISTER':
            data = request['data']
            email = data['email']
            hashed = data['hash']
            logging.info(f"REGISTER request for {email} received")
            curr.execute('SELECT * FROM users WHERE email=%s;', (email,))
            if curr.fetchone() != None:
                response = {'success': False, 'message': 'User already exists'}
            else:
                curr.execute('INSERT INTO users VALUES (%s, %s);', (email, hashed))
                conn.commit()
                response = {'success': True}
        else:
            response = {'success': False, 'message': "Unknown action"}
    logging.info(response)
    ch.basic_publish(
        exchange='',
        routing_key=properties.reply_to,
        body=json.dumps(response)
    )</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Notice that psycopg2 functions are used to put variables into the SQL
statements. Do <strong>NOT</strong> use Python string formating to build your SQL statements.
You may be thinking that we are in <strong>Back End</strong> and the parameters we receive are
already <a href="https://xkcd.com/327/">sanitized</a> by <strong>Front End</strong> but this is not always
the case.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_front_end">5.5. Front End</h3>
<div class="paragraph">
<p>The <strong>Front End</strong> can be created using any web framework, but the most popular
choices are <a href="https://www.php.net">PHP</a> or
<a href="https://palletsprojects.com/p/flask">Flask</a>. The most popular Docker Hub images
for those frameworks are <a href="https://hub.docker.com/_/php">php:apache</a> and
<a href="https://hub.docker.com/_/python">python</a> respectively. For interacting with
<strong>Messaging</strong> there are a few options, but groups tend to gravitate towards
<a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a> for PHP and
<a href="https://github.com/pika/pika">pika</a> for Python Flask. This is probably due to
the fact that the
<a href="https://www.rabbitmq.com/getstarted.html">documentation for RabbitMQ</a> references
those libraries.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/frontend.svg" alt="frontend" width="505" height="264">
</div>
</div>
<div class="paragraph">
<p>A custom <code>front_end/Dockerfile</code> is used for creating the image:</p>
</div>
<div class="listingblock">
<div class="title">front_end/Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="docker" class="language-docker hljs">FROM python
COPY . /app
WORKDIR /app
RUN pip install -r requirements.txt
ENV FLASK_APP=app.py
CMD ["./wait-for-it.sh", "messaging:5672", "--", \
     "flask", "run", "--host=0.0.0.0"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A script called <a href="https://github.com/vishnubob/wait-for-it"><code>wait-for-it.sh</code></a> is
included with the image. It is used
<a href="https://docs.docker.com/compose/startup-order/">as recommended by the Docker documentation</a>
to make sure the <strong>Messaging</strong> is up before <strong>Front End</strong> starts. This way
<strong>Front End</strong> will give errors to users who attempt to use it before the full
system has been brought up.</p>
</div>
<div class="paragraph">
<p><code>front_end/Dockerfile</code> is built in the service section of the
<code>docker-compose.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">    front_end:
        build: ./front_end
        ports:
            - 5000:5000
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
            FLASK_ENV: development
            FLASK_SECRET_KEY: ${FLASK_SECRET_KEY}
        volumes:
            - "./front_end:/app"</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a few things in the <code>docker-compose.yml</code> service definition that
should be noted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Port <code>5000</code> needs to be forwarded as it will be accessed externally</p>
</li>
<li>
<p>The <code>FLASK_ENV</code> environment variable is useful for development. It causes
Flask to print more friendly error messages right inside the web browser.</p>
</li>
<li>
<p><code>front_end/</code> is bind mounted to <code>/app</code> in the container even though the
<code>Dockerfile</code> copies those files to the <code>/app</code> directory when the image is
created. This allows for easier development, the container can be running
while you edit the files Flask is using. The development server will
automatically restart if changes are detected.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make communication with <strong>Messaging</strong> a easier, <code>front_end/messaging.py</code>
defines a <code>Messaging</code> class that initializes the connection, shuts down the
connection, and provides a send and receive function. All messages are sent to
the general <code>requests</code> queue and replies are returned via an exclusive reply
queue.</p>
</div>
<div class="listingblock">
<div class="title">front_end/messaging.py</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="python" class="language-python hljs">import pika
import json
import time
import logging
import os

class Messaging:
    """
    Helper class for dealing with the messaging service
    """
    request_queue_name = 'request'

    # Get credentials from the environment
    credentials = pika.PlainCredentials(os.environ['RABBITMQ_DEFAULT_USER'],
                                        os.environ['RABBITMQ_DEFAULT_PASS'])

    # docker-compose will resolve this host to our messaging service
    host = 'messaging'

    def __init__(self):
        """
        Establishes connection and creates queues as needed
        """
        logging.info("Messaging: Establishing connection")
        self.connection = pika.BlockingConnection(
            pika.ConnectionParameters(host=self.host, credentials=self.credentials))
        self.channel = self.connection.channel()
        logging.info("Messaging: Creating queues")
        self.channel.queue_declare(queue=self.request_queue_name)
        self.result_queue = self.channel.queue_declare(queue='', exclusive=True).method.queue

    def __del__(self):
        """
        Closes down the connection
        """
        logging.info("Messaging: Closing down connection")
        self.connection.close()

    def send(self, action, data):
        """
        Sends an action and data to the request queue in JSON. Sets the
        reply_to property to the custom result queue.
        """
        logging.info(f"Messaging: send(action={action}, data={data})")

        self.channel.basic_publish(
            exchange='',
            routing_key=self.request_queue_name,
            properties=pika.BasicProperties(
                reply_to=self.result_queue),
                body=json.dumps({'action': action, 'data': data}
            )
        )

    def receive(self):
        """
        Waits for a single message and returns it. Waits up to 1s, checking
        every 0.1s.
        """
        attempts = 0
        while True:
            method_frame, properties, body = self.channel.basic_get(
                self.result_queue, auto_ack=True)
            if method_frame:
                received = json.loads(body)
                logging.info(f"Messaging: received={received}")
                return received
            elif attempts &gt; 10:
                logging.info("Messaging: receive did not get message")
                return None
            else:
                time.sleep(0.1)
                attempts += 1</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Every HTTP request received by <strong>Front End</strong> will result in a full
connection sequence with <strong>Messaging</strong> which is not optimal. A
<a href="https://github.com/eandersson/python-rabbitmq-examples/blob/master/Flask-examples/pika_async_rpc_example.py">better solution</a>
is to have the <code>Messaging</code> class run in its own thread and maintain a permanent
connection.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at a registration sequence involving the <strong>User</strong>, <strong>Front End</strong>,
and <strong>Back End</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/registration.svg" alt="registration" width="481" height="283">
</div>
</div>
<div class="paragraph">
<p>The relevant code in <code>app.py</code> follows:</p>
</div>
<div class="listingblock">
<div class="title">front_end/app.py (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="python" class="language-python hljs">@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        email = request.form['email']
        password = request.form['password']
        msg = messaging.Messaging()
        msg.send(
            'REGISTER',
            {
                'email': email,
                'hash': generate_password_hash(password)
            }
        )
        response = msg.receive()
        if response['success']:
            session['email'] = email
            return redirect('/')
        else:
            return f"{response['message']}"
    return render_template('register.html')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fortunately password hashing functions are readily available in the
<code>werkzeug.security</code> module. <a href="https://palletsprojects.com/p/werkzeug/">Werkzeug</a>
is a WSGI utility library that Flask already uses, so we don&#8217;t need to add
anything to <code>requirements.txt</code>. We can use the functions <code>check_password_hash</code>
and <code>generate_password_hash</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do <strong>NOT</strong> store user passwords in cleartext. There are plenty of good
hashing options in both PHP and Python. Try to minimize systems that come in
contact with unencrypted passwords as well. In this example it is hashed before
it is even passed to the <strong>Back End</strong>. For the same reason, in production your
users should only be able to connect via TLS (HTTPS). This will secure the
channel between <strong>User</strong> and <strong>Front End</strong> which passes the password when the user
registers or logs in.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>register</code> function will also set <code>email</code> in the user session upon
successful completion. This is akin to having a user log in automatically once
they have created an account.
<a href="https://flask.palletsprojects.com/en/1.1.x/api/#flask.session">Flask sessions</a>
are a good way of storing things on the client that can&#8217;t be modified. They
default to a lifetime of 31 days.</p>
</div>
<div class="paragraph">
<p>A similar sequence is used to log in a user:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/login.svg" alt="login" width="426" height="283">
</div>
</div>
<div class="paragraph">
<p>The relevant code in <code>front_end/app.py</code> follows:</p>
</div>
<div class="listingblock">
<div class="title">front_end/app.py (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="python" class="language-python hljs">@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        email = request.form['email']
        password = request.form['password']
        msg = messaging.Messaging()
        msg.send('GETHASH', { 'email': email })
        response = msg.receive()
        if response['success'] != True:
            return "Login failed."
        if check_password_hash(response['hash'], password):
            session['email'] = email
            return redirect('/')
        else:
            return "Login failed."
    return render_template('login.html')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compared to the <code>register</code> function, handling a login is simpler. A few other
routes of interest with brief descriptions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/</code> - serves the <code>index.html</code></p>
</li>
<li>
<p><code>/logout</code> - removes <code>email</code> from the user&#8217;s session and redirects to <code>/</code></p>
</li>
<li>
<p><code>/secret</code> - protected by the <code>@login_required</code> decorator (see below), serves
<code>secret.html</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://realpython.com/primer-on-python-decorators/">Python decorators</a> are used
for routing in Flask so it is a natural fit to use them to protect routes as
well. The <code>@login_required</code> decorator does exactly that:</p>
</div>
<div class="listingblock">
<div class="title">front_end/app.py (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="python" class="language-python hljs">def login_required(f):
    """
    Decorator that returns a redirect if session['email'] is not set
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'email' not in session:
            return redirect('/login')
        return f(*args, **kwargs)
    return decorated_function</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moving forward, we should start thinking about how we are going to transition
our development server to a production environment. The built-in Flask server is
great for testing our code but we will want to shift to something meant for
large scale use as we begin to scale up our application. Some packages to
research are <a href="https://www.nginx.com/">NGINX</a>,
<a href="https://uwsgi-docs.readthedocs.io/en/latest/">uWSGI</a>,
<a href="https://gunicorn.org/">gunicorn</a>, <a href="https://www.apache.org/">Apache</a>, and
<a href="https://modwsgi.readthedocs.io/en/develop/">mod_wsgi</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_replication">6. Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replicating a service can provide many benefits. In this section we will
replicate a <a href="http://postgresql.org">PostgreSQL</a> database service to analyze the
advantages and complexity costs. PostgreSQL was purposefully chosen because it
leaves much of work, which is understandably outside the purview of a Database
Management System (DBMS), to the user. We will be using Docker compose so that
we do not have to introduce a new tool as well.</p>
</div>
<div class="sect2">
<h3 id="_background">6.1. Background</h3>
<div class="imageblock">
<div class="content">
<img src="images/replication.svg" alt="replication" width="199" height="140">
</div>
<div class="title">Figure 2. Basic Replication</div>
</div>
<div class="paragraph">
<p>In the simplest sense, replication is running more than one service for a given
component of our system. We can do this in Docker Compose by declaring more
than one service:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">    db1:
        build: ./db
        environment:
            POSTGRES_PASSWORD: asdffdsa
            POSTGRES_REPLICA_PASSWORD: asdffdsa
            POSTGRES_NODES: "db1 db2"
    db2:
        build: ./db
        environment:
            POSTGRES_PASSWORD: asdffdsa
            POSTGRES_REPLICA_PASSWORD: asdffdsa
            POSTGRES_NODES: "db1 db2"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A better solution would be to use a more complete orchestration solution
than Docker Compose. For syntax that you are used to, see
<a href="https://docs.docker.com/compose/compose-file/#deploy">the deploy option and
Docker Swarm</a>. You could also bite the bullet and migrate to
<a href="https://kubernetes.io">kubernetes</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In most DBMS, replication can be implemented via Volume Sharing or Hot / Warm
Standby:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/volshare.svg" alt="volshare" width="441" height="445">
</div>
<div class="title">Figure 3. Volume Sharing</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/standby.svg" alt="standby" width="510" height="311">
</div>
<div class="title">Figure 4. Hot / Warm Standby</div>
</div>
<div class="paragraph">
<p>Volume Sharing has the advantage of being easy to implement <em>if</em> you already
have network storage. You can scale simply by increasing the amount of
database instances (db3, db4, db5&#8230;&#8203;). Each instance has full read / write
access, making it easy to load balance. Despite that, reading / writing from
network storage tends to be a bottleneck. Also, shared access to files and the
issues that arise (file locking, etc.) are difficult problems. Your DBMS may
not be able to handle them. Even if they can be handled, performance can be an
issue. Lastly, this method puts all of your eggs in one basket with regard to
where your data is stored. There may be no duplicates of the data depending on
how you handle your network storage.</p>
</div>
<div class="paragraph">
<p>Hot / Warm Standby mode is typically already implemented by the DBMS. It is
usually performed via <em>Log Shipping</em>, sending logs of all actions between a
primary node and standby nodes. The standby nodes can keep up with transactions
and be <em>promoted</em> in the event of an issue. Each node maintains a separate data
volume. With this system, only the primary node is capable of performing write
operations. If the standby node is a <em>hot</em> standby node it can perform reads as
well. Fortunately, write operations tend to be less frequent that read
operations, meaning you may see significant performance gains from scaling with
this type of system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
What&#8217;s the difference between a hot and warm standby? A hot standby can
perform read operations while replicating the primary. This allows for load
balancing to be performed. A warm standby simply keeps up with the primary so
that it can be brought up in the event of a problem.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_implementation">6.2. Implementation</h3>
<div class="paragraph">
<p>This example implements a
<a href="https://www.postgresql.org/docs/current/hot-standby.html">Hot Standby in PostgreSQL</a>.
Actually implementing <em>replication</em> is largely handled for us by the DMBS. It is
simply a matter of setting configuration variables, starting the databases are
in the correct state, and bringing up the services in the right order. We can
handle this in the <code>docker-entrypoint.sh</code> file that is used as the ENTRYPOINT
for the container. In the <a href="https://hub.docker.com/_/postgres">official Docker
image</a> this script is responsible for setting up the database and running the
user-specified command, <code>postgres</code> by default.</p>
</div>
<div class="paragraph">
<p>A basic Dockerfile that builds from this image and adds some extra needed
utilities will be used:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="Dockerfile" class="language-Dockerfile hljs">FROM postgres
RUN apt-get -y update &amp;&amp; \
    apt-get -y install iputils-ping dnsutils
COPY docker-entrypoint.sh /usr/local/bin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rather than create separate primary and standby images, this example employs one
image that detects the status of the cluster on startup and creates either a
primary or standby node accordingly. The logic for startup is as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/startup_logic.svg" alt="startup logic" width="486" height="530">
</div>
</div>
<div class="paragraph">
<p>By passing a list of all nodes in an environment variable, we can create a bash
function to see who is up and who is the primary when <code>docker-entrypoint.sh</code> is
called at container creation:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">function find_primary() {
    # Goes through all the nodes in POSTGRES_NODES and looks for one that is up
    # and is a PRIMARY
    echo "Looking for a primary node..."
    PRIMARY=""
    for NODE in $POSTGRES_NODES; do
        NODE_IP=$( dig +short $NODE )
        if [ -z $NODE_IP ] || [ $NODE_IP != $MY_IP ]; then
            # https://stackoverflow.com/questions/11231937/bash-ignoring-error-for-a-particular-command
            EXIT_CODE=0
            pg_isready -h $NODE || EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
                echo "$NODE:5432:postgres:postgres:$POSTGRES_PASSWORD" &gt;&gt; ~/.pgpass
                VALUE=$(psql -U postgres -t -h $NODE -d postgres -c "select pg_is_in_recovery()")
                if [ $VALUE == "f" ]; then
                    echo "$NODE is primary node"
                    if [ ! -z $PRIMARY ]; then
                        echo "Two primary nodes detected! Exiting..."
                        exit 1
                    fi
                    PRIMARY=$NODE
                fi
            fi
        fi
    done
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a situation arises where there are two primaries on the network, this
function will prevent a new db container from being created. No sense adding to
the confusion.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now all that is left is to configure either a primary or a standby node.
The code to configure a primary node follows:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">    echo "Configuring a PRIMARY instance..."

    if [ -s "$PGDATA/PG_VERSION" ]; then
        echo "Database already exists, NOT creating a new one"
    else
        echo "Creating a new database..."

        initdb --username=postgres --pwfile=&lt;(echo "$POSTGRES_PASSWORD")

        # Start a temporary server listening on localhost
        pg_ctl -D "$PGDATA" -w start

        # Create a user for replication operations
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" &lt;&lt; EOSQL
            CREATE USER repuser REPLICATION LOGIN ENCRYPTED PASSWORD '$POSTGRES_REPLICA_PASSWORD';
EOSQL

        # Stop the temporary server
        pg_ctl -D "$PGDATA" -m fast -w stop

        # Set up authentication parameters
        echo "host replication all all md5" &gt;&gt; $PGDATA/pg_hba.conf
        echo "host all all all md5" &gt;&gt; $PGDATA/pg_hba.conf
    fi

    # if, for some reason, a cold standby is being brought up as a primary
    # remove the standby.signal file
    if [ -f $PGDATA/standby.signal ]; then
        rm $PGDATA/standby.signal
    fi</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is self-explanatory, but it should be noted that the actual building
of the database, including auth configuration, and the create of a replication
user is a rare occurrence. That should only happen once when the volume is
initialized.</p>
</div>
<div class="paragraph">
<p>The code to configure a standby node is shown below:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">    echo "Configuring a STANDBY instance..."

    # Set up our password so we can connect to replicate
    echo "$PRIMARY:5432:replication:repuser:$POSTGRES_REPLICA_PASSWORD" &gt;&gt; /var/lib/postgresql/.pgpass

    # Clone the primary database
    rm -rf $PGDATA/*
    pg_basebackup -h $PRIMARY -D $PGDATA -U repuser -v -P -X stream
    chmod -R 700 $PGDATA

    # Add connection info
    cat &lt;&lt; EOF &gt;&gt; $PGDATA/postgresql.conf
        primary_conninfo = 'host=$PRIMARY port=5432 user=repuser password=$POSTGRES_REPLICA_PASSWORD'
EOF

    # Notify postgres that this is a standby server
    touch $PGDATA/standby.signal

    # Make sure there is a primary server and failover if there isn't
    monitor &amp;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a standby is brought up, any database on the volume is removed and the
entire database from the primary is backed up You may want to revisit this
design decision if your database becomes large. Connection info is also added to
the end of <code>postgres.conf</code>. This does mean that if a standby is promoted the
previous connect line will be synced to any new standbys that are brought up.
This will result in an ever growing <code>postgres.conf</code> file. The monitor function
will be covered in the next section.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may notice that primaries and standbys have a very similar
configuration. This is by design in PostgreSQL &gt;= 12, to simplify the failover
procedure.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the relevant log messages of db1 and db2 when we bring them
both up with <code>docker-compose up</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">db1 - Looking for a primary node...
db1 - db2:5432 - no response
db1 - Configuring a PRIMARY instance...
db2 - Looking for a primary node...
db2 - db1:5432 - no response
db2 - Giving the first node a 10s head start...
db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node
db2 - Configuring a STANDBY instance...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen, db2 wasn&#8217;t able to detect db1 at first but the additional 10s
delay prevented a multiple-primary situation.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Having multiple primaries in a cluster is bad. So bad, that most
solutions implement a <a href="https://en.wikipedia.org/wiki/STONITH">STONITH</a> policy. It
is quite possibly the greatest acronym in all of technology.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Just because we have our database replicated on two volumes <strong>does not</strong>
mean that we have backups. Those volumes are designed to be used as part of a
running system and are not a reliable long-term solution. Create and implement
a reliable backup plan as you would for any other database.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_high_availability">6.3. High Availability</h3>
<div class="paragraph">
<p>Even though we now have a replicated database, it isn&#8217;t doing us much good. If
we want to make our database service highly available (HA) we will need to
monitor for problems and promote a standby server if the primary server fails.
This is referred to as <em>failover</em> and is often handled by a
<a href="https://wiki.clusterlabs.org/wiki/Pacemaker">a separate component</a>.  In this
simple example it is implemented in the <code>monitor</code> function shown below:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">function monitor() {
    while true; do
        # spread out our checks to avoid the chance of two nodes promoting at
        # the same time
        WAIT=$((20 + $RANDOM % 10))
        sleep $WAIT
        find_primary
        if [ -z $PRIMARY ]; then
            echo "Can't find a primary failing over..."
            pg_ctl promote
            # we don't need to monitor any more if we are the primary
            exit
        fi
    done
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function is run in the background on every standby instance. The
timeout is randomized to decrease the likelihood that two standby instances
will promote themselves at exactly the same time. To better understand this,
let&#8217;s examine the <strong>non-randomized</strong> scenario shown in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dualpromotion.svg" alt="dualpromotion" width="487" height="240">
</div>
<div class="title">Figure 5. Dual Promotion</div>
</div>
<div class="paragraph">
<p>In the above scenario each standby node is checking to see that there is a
primary node every 30s. The primary fails at 50s and <em>both</em> nodes check for a
primary at exactly 60s. At that moment, neither node is a primary, no primary
can be found, and they both begin the promotion process. This leaves the
cluster with two primary nodes. This can be largely avoided by randomizing
the check intervals.</p>
</div>
<div class="paragraph">
<p>Finally, lets simulate a failure and a recovery to see that our HA system is
working.  The following commands were executed and the Docker Compose logs were
captured.  Each command was run with about a minute pause between them:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>docker-compose up</code></p>
</li>
<li>
<p><code>docker-compose stop db1</code></p>
</li>
<li>
<p><code>docker-compose up db1</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The relevant, simplified log messages and descriptions follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">db2 - Looking for a primary node...
db1 - Looking for a primary node...
db2 - db1:5432 - no response
db1 - db2:5432 - no response
db2 - Giving the first node a 10s head start...
db1 - Configuring a PRIMARY instance...
db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node
db2 - Configuring a STANDBY instance...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both db1 and db2 are brought up at the same time. db1 ends up being
the primary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node
db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node</code></pre>
</div>
</div>
<div class="paragraph">
<p>db1 begins checking to make sure there is a primary node about every 30s.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">db1 - LOG:  shutting down
db2 - Looking for a primary node...
db2 - db1:5432 - no response
db2 - Can't find a primary failing over...
db2 - server promoted</code></pre>
</div>
</div>
<div class="paragraph">
<p>db1 is shut down. db2 performs its regularly scheduled check and self promotes
because it cannot find a primary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">db1 - Looking for a primary node...
db1 - db2:5432 - accepting connections
db1 - db2 is primary node
db1 - Configuring a STANDBY instance...
db1 - Looking for a primary node...
db1 - db2:5432 - accepting connections
db1 - db2 is primary node
db1 - Looking for a primary node...
db1 - db2:5432 - accepting connections
db1 - db2 is primary node</code></pre>
</div>
</div>
<div class="paragraph">
<p>db1 is brought back up, finds another primary and makes itself a standby. db1
begins checking to make sure the primary is available at regular intervals.</p>
</div>
</div>
<div class="sect2">
<h3 id="_load_balancing">6.4. Load Balancing</h3>
<div class="paragraph">
<p>Another advantage to replication is the ability to split the work among
different nodes in the cluster. In our particular case, the primary node can
handle any request, while the standby node can only handle read requests. Since
we also control the application, we could create a connection for read requests
and a separate connection for write requests.</p>
</div>
<div class="paragraph">
<p>Fortunately this can be accomplished by
<a href="https://www.percona.com/blog/2019/10/23/seamless-application-failover-using-libpq-features-in-postgresql/">changing
the connect string that is used</a> in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="python" class="language-python hljs"># get a read / write connection
psycopg.connect(
    database="example",
    host="db1,db2",
    user="postgres",
    password=password,
    target_session_attrs="read-write"
)

# get a read connection
psycopg.connect(
    database="example",
    host="db2,db1", # order should be randomized
    user="postgres",
    password=password,
    target_session_attrs="any"
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The other option is to employ a proxy to forward requests, the most popular
being <a href="http://www.haproxy.org/">HAProxy</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Load balancing is often referenced as a part of <em>horizontal scaling</em>.
You can think of horizontal scaling as adding more instances to serve requests.
<em>Vertical scaling</em> refers to making instances more powerful so that each
individual one can serve more requests.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_questions_2">6.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What are some of the issues with a volume sharing database?</em></p>
<p></p>
</li>
<li>
<p><em>Why does our example have a startup delay? What could happen if we brought all of the nodes up at the same time?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between high availability and load balancing?</em></p>
<p></p>
</li>
<li>
<p><em>What does a <em>hot</em> standby node do?</em></p>
<p></p>
</li>
<li>
<p><em>Our example starts up two nodes, but what would we have to change in our docker-compose.yml file if we wanted to start ten nodes? Is this congruent with the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">"Don&#8217;t Repeat Yourself" (DRY)</a> principle?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kubernetes">7. Kubernetes</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/k8s-logo.svg" alt="Kubernetes Logo" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction">7.1. Introduction</h3>
<div class="paragraph">
<p>Kubernetes is a container orchestration system originally designed by Google.
It is currently the most popular orchestration system and is notorious for
being difficult to learn. Fortunately, we have already covered most of the
concepts and the command syntax is similar to Docker.</p>
</div>
<div class="paragraph">
<p>A Kubernetes cluster is made up of nodes. Each node is capable of running
pods, which in turn are running containers:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/k8s_cluster.svg" alt="k8s cluster" width="714" height="262">
</div>
<div class="title">Figure 6. Kubernetes Cluster</div>
</div>
<div class="paragraph">
<p>Kubernetes is designed to solve the hard problems of multi-node deployment,
replication, volume sharing, container communication, updates, roll-backs,
service discovery and monitoring. It does this by defining objects and
providing an API to interact with them. Some of the first objects we will be
working with are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deployment</dt>
<dd>
<p>Defines how to handle the creation / maintenance of pods</p>
</dd>
<dt class="hdlist1">Service</dt>
<dd>
<p>Defines what pods offer to the cluster and how it should be accessed</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_minikube">7.2. Minikube</h3>
<div class="paragraph">
<p>For our purposes we will be using a single-node, local version of Kubernetes
called <a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">minikube</a>.
minikube acts as a single-node cluster by running Linux in a virtual machine on
the host. It provides a several options for how the VM is run:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/minikube_arch.svg" alt="minikube arch" width="645" height="451">
</div>
<div class="title">Figure 7. Minikube Architecture</div>
</div>
<div class="paragraph">
<p><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">Follow these directions
to install minikube.</a> There are a few virtualization options depending on the
OS that you are running.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have Docker Desktop running, minikube defaults to the Docker
driver. This driver is still experimental and may not work well. You can
explicitly specify another driver when you start minikube with the <code>--driver=</code>
option.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hyper-V and VirtualBox were still mutually exclusive in Windows at the
time of this writing. You will need to choose one or the other.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hyper-V will require you to run your commands as an Administrator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you start minikube, you should see output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; minikube start --driver=hyperv
* minikube v1.9.0 on Microsoft Windows 10 Enterprise 10.0.18362 Build 18362
* Using the hyperv driver based on existing profile
* Retarting existing hyperv VM for "minikube" ...
* Preparing Kubernetes v1.18.0 on Docker 19.03.8 ...
* Enabling addons: default-storageclass, storage-provisioner
* Done! kubectl is now configured to use "minikube"</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you get errors due to low memory, close a few applications and try
again. Typically you can restart the applications after minikube is running.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Kubernetes will attempt to pull all container images from a container
repository by default. To avoid having to upload our images to a repository, we
can set environment variables in our terminal so that we interact with the
Docker daemon <em>inside</em> our minikube virtual
machine.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> Fortunately, minikube has the
<code>docker-env</code> command to make this easier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; minikube docker-env | Invoke-Expression
PS minikube-demo&gt; docker ps
CONTAINER ID        IMAGE                  COMMAND                  CREATED
1bf91c2ca7df        4689081edb10           "/storage-provisioner"   7 minutes ago
a9866f5f5838        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago
03a4f7f5e320        67da37a9a360           "/coredns -conf /etc"   7 minutes ago
05061b993702        67da37a9a360           "/coredns -conf /etc"   7 minutes ago
78977b068886        43940c34f24f           "/usr/local/bin/kube"   7 minutes ago
b5312ba91086        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago
968acc692934        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago
0a72059bbe5f        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago
d9c5aa3d43d0        303ce5db0e90           "etcd --advertise-cl"   7 minutes ago
21b09398206f        74060cea7f70           "kube-apiserver --ad"   7 minutes ago
313982f14a1c        d3e55153f52f           "kube-controller-man"   7 minutes ago
35813d25f0bf        a31f78c7c8ce           "kube-scheduler --au"   7 minutes ago
e6cdb564a306        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago
b6bfe0e6f093        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago
da47e560edab        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago
3c599f97ecec        k8s.gcr.io/pause:3.2   "/pause"                 7 minutes ago</code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen from the output of the <code>docker ps</code> command, our Kubernetes
cluster is made up of many containers running in a VM. If you ran <code>docker ps</code>
without setting up the environment first, you would only see the containers you
had running on your local Docker daemon (which may actually be
<a href="https://inception.davepedu.com/">running on a VM itself</a> if you are using Docker
Toolbox).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>minikube</code> commands will work in a new terminal, but if you want to build
docker images and have them available on your Kubernetes cluster you will need
to use minikube&#8217;s docker-env command for each new terminal you open.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are experiencing errors with minikube, the first thing you should
try is running <code>minikube delete</code> and <code>minikube start --driver=&lt;your driver&gt;</code>.
This addresses the vast majority of issues by wiping all traces of the old VM,
creating a new one, and starting fresh.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>minikube includes a popular command line tool called kubectl. This is the
command that we will be using for interacting with our Kubernetes cluster. To
show that everything is working, lets create and build a basic Dockerfile that
should print some output to standard out:</p>
</div>
<div class="listingblock">
<div class="title">minikube-demo/Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="Dockerfile" class="language-Dockerfile hljs">FROM alpine
ENTRYPOINT ["/bin/sh", "-c", "echo 'Hello from a Kubernetes log!'; sleep 30"]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; docker build -t k8s-example:v1 .
Sending build context to Docker daemon  2.048kB
Step 1/2 : FROM alpine
latest: Pulling from library/alpine
aad63a933944: Pull complete
Digest: sha256:b276d875eeed9c7d3f1cfa7edb06b22ed22b14219a7d67c52c56612330348239
Status: Downloaded newer image for alpine:latest
 ---&gt; a187dde48cd2
Step 2/2 : ENTRYPOINT ["/bin/sh", "-c", "echo 'Hello from a Kubernetes log!'; sleep 30"]
 ---&gt; Running in 96c1739d805e
Removing intermediate container 96c1739d805e
 ---&gt; 7b9898952ce0
Successfully built 7b9898952ce0
Successfully tagged k8s-example:v1</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
We built our image with a tag <em>and</em> a version. You need the tag so you
can reference it from Kubernetes. If you don&#8217;t specify a version Kubernetes
will try to pull the <code>latest</code> from a repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we&#8217;ll create a deployment, which by default will make one pod that runs
your image. We also run the <code>get deployment</code> and <code>get pod</code> commands so we can
see the outcome. Lastly, we will inspect the logs for the pod that was created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; kubectl create deployment k8s-example --image=k8s-example:v1
deployment.apps/k8s-example created
PS minikube-demo&gt; kubectl get deployment
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
k8s-example   1/1     1            1           7s
PS minikube-demo&gt; kubectl get pod
NAME                           READY   STATUS    RESTARTS   AGE
k8s-example-5787cd97dc-ft2cr   1/1     Running   0          12s
PS minikube-demo&gt; kubectl logs k8s-example-5787cd97dc-ft2cr
Hello from a Kubernetes log!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our image is up and running, but remember that after 30 seconds it should exit.
As an orchestration system, Kubernetes defaults to restarting pods that have
stopped. Lets wait a while (14 minutes to be exact) and then execute the <code>get
pod</code> command again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; kubectl get pod
NAME                           READY   STATUS             RESTARTS   AGE
k8s-example-5787cd97dc-ft2cr   0/1     CrashLoopBackOff   6          14m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Kubernetes has restarted our pod six times now. In fact, it restarted it so
much that it is now waiting before trying again (<code>CrashLoopBackOff</code>). You now
have a minikube single-node Kubernetes cluster running on your local machine.
You can build custom Docker images and have them run on your cluster.</p>
</div>
<div class="paragraph">
<p>To bring everything down, use the <code>delete deployment</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; kubectl delete deployment k8s-example
deployment.apps "k8s-example" deleted
PS minikube-demo&gt; kubectl get pod
No resources found in default namespace.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging">7.3. Debugging</h3>
<div class="paragraph">
<p>The official Kubernetes documentation has an
<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-service/">
excellent article</a> on debugging services. What follows are some tips they may
help reinforce or fill-in-the-blanks for topics in the article.</p>
</div>
<div class="paragraph">
<p>Two <code>kubectl</code> commands are especially useful for finding out more information
about an object:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kubectl get</code></dt>
<dd>
<p>gets brief information about an object or all of the objects of
that type</p>
</dd>
<dt class="hdlist1"><code>kubectl describe</code></dt>
<dd>
<p>gets more information about an object</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; kubectl get pod
NAME                           READY   STATUS    RESTARTS   AGE
k8s-example-5787cd97dc-fbrxl   1/1     Running   0          33s
PS minikube-demo&gt; kubectl describe pod k8s-example-5787cd97dc-fbrxl
Name:         k8s-example-5787cd97dc-fbrxl
Namespace:    default
Priority:     0
Node:         minikube/172.17.0.2
Start Time:   Mon, 13 Apr 2020 18:22:39 -0400
Labels:       app=k8s-example
              pod-template-hash=5787cd97dc
Annotations:  &lt;none&gt;
Status:       Running
IP:           172.18.0.3
IPs:
  IP:           172.18.0.3
Controlled By:  ReplicaSet/k8s-example-5787cd97dc
Containers:
  k8s-example:
    Container ID:   docker://f22a1be8401f256c42c8c8ad82cf6757bc9e34ec7ae1fe0c4329fff57ff09bcb
    Image:          k8s-example:v1
    Image ID:       docker://sha256:374b52c1385d25269a05e9542e65690fe9dc00146b869580db8ab51b5027096a
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Mon, 13 Apr 2020 18:23:37 -0400
    Last State:     Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Mon, 13 Apr 2020 18:23:06 -0400
      Finished:     Mon, 13 Apr 2020 18:23:36 -0400
    Ready:          True
    Restart Count:  1
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5mgft (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-5mgft:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-5mgft
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Scheduled  &lt;unknown&gt;          default-scheduler  Successfully assigned default/k8s-example-5787cd97dc-fbrxl to minikube
  Normal   BackOff    62s                kubelet, minikube  Back-off pulling image "k8s-example:v1"
  Warning  Failed     62s                kubelet, minikube  Error: ImagePullBackOff
  Normal   Pulling    50s (x2 over 62s)  kubelet, minikube  Pulling image "k8s-example:v1"
  Warning  Failed     50s (x2 over 62s)  kubelet, minikube  Failed to pull image "k8s-example:v1": rpc error: code = Unknown desc = Error
 response from daemon: pull access denied for k8s-example, repository does not exist or may require 'docker login': denied: requested acc
ess to the resource is denied
  Warning  Failed     50s (x2 over 62s)  kubelet, minikube  Error: ErrImagePull
  Normal   Pulled     5s (x2 over 36s)   kubelet, minikube  Container image "k8s-example:v1" already present on machine
  Normal   Created    5s (x2 over 36s)   kubelet, minikube  Created container k8s-example
  Normal   Started    5s (x2 over 36s)   kubelet, minikube  Started container k8s-example</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see there, is lots of useful information here including a full
history of events that have occured.</p>
</div>
<div class="paragraph">
<p>Many of the same techniques used for debugging Docker images can be used for
debugging Kubernetes objects. For example you can execute interactive commands
(including a shell) on running docker images with <code>kubectl exec -it</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS minikube-demo&gt; kubectl exec -it k8s-example-5787cd97dc-7j6cc -- /bin/sh
/ # ps ax
PID   USER     TIME  COMMAND
    1 root      0:00 sleep 30
   11 root      0:00 /bin/sh
   16 root      0:00 ps ax
/ # ls
bin    dev    etc    home   lib    media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var
/ # exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>If, for some reason, an image does not start up, you can replace the ENTRYPOINT
of the Dockerfile from within the <code>template</code> definition of a <strong>Deployment</strong>. By
replacing it with something you know will work, you can then execute an
interactive shell in the container to see what is going on. The following is an
example of executing the sleep command, assuring that the pod will run for at
least an hour:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">kind: Deployment
metadata:
  name: db-rw
  labels:
    app: db-rw
spec:
  replicas: 1
  selector:
    matchLabels:
      app: db-rw
  template:
    metadata:
      labels:
        app: db-rw
    spec:
      containers:
        - name: db-rw
          image: postgres
          env:
            - name: POSTGRES_PASSWORD
              value: "changeme"
            - name: POSTGRES_REPLICA_PASSWORD
              value: "changeme"
          command: ["bash", "-c", "sleep 3600"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes your objects are applied, but no pods start up. This may mean
that Kubernetes started your <strong>Deployment</strong> or <strong>StatefulSet</strong> which created a
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">
<strong>ReplicaSet</strong></a>, but the <strong>ReplicaSet</strong> was unable to start your pods. Try running
<code>kubectl get replicaset</code> to find which <strong>ReplicaSet</strong> is running and then
<code>kubectl describe replicaset &lt;replicaset_name&gt;</code> where &lt;replicaset_name&gt; is the
name of your <strong>ReplicaSet</strong>.</p>
</div>
<div class="paragraph">
<p>Finally, you may find yourself in a situation where you need to run <code>kubectl</code>
from within a pod. This can be helpful for sorting out role based access
control issues, namely "how can this pod interact with the Kubernetes API?"
<a href="https://itnext.io/running-kubectl-commands-from-within-a-pod-b303e8176088">
This guide</a> is a great resource. It largely boils down to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From within the pod (<code>kubectl exec -it &lt;pod-name&gt;&#8201;&#8212;&#8201;bash</code>) install curl:
<code>apt-get install curl</code>.</p>
</li>
<li>
<p>Download <code>kubectl</code>:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>VERSION=curl <a href="https://storage.googleapis.com/kubernetes-release/release/stable.txt" class="bare">https://storage.googleapis.com/kubernetes-release/release/stable.txt</a></code></p>
</li>
<li>
<p><code>curl -LO <a href="https://storage.googleapis.com/kubernetes-release/release/$VERSION/bin/linux/amd64/kubectl" class="bare">https://storage.googleapis.com/kubernetes-release/release/$VERSION/bin/linux/amd64/kubectl</a></code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Make it executable and install it:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>chmod +x ./kubectl</code></p>
</li>
<li>
<p><code>mv ./kubectl /usr/local/bin/</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">7.4. Conclusion</h3>
<div class="paragraph">
<p>Hopefully you can see the benefit of working with an orchestration framework.
While it may be daunting at first to learn all of the objects and to use new,
unfamiliar commands, Kubernetes does provide a lot of options for someone
looking to deploy scalable applications. Kubernetes has emerged as the
<a href="https://www.forbes.com/sites/udinachmany/2018/11/01/kubernetes-evolution-of-an-it-revolution/#67e70c2454e1">
de facto standard</a> and knowing how to use it is a <em>very</em> marketable skill.</p>
</div>
</div>
<div class="sect2">
<h3 id="_questions_3">7.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What is the role of a pod in Kubernetes?</em></p>
<p></p>
</li>
<li>
<p><em>What does a <strong>Deployment</strong> do?</em></p>
<p></p>
</li>
<li>
<p><em>What is minikube used for and what platforms can it run on?</em></p>
<p></p>
</li>
<li>
<p><em>If you were given an image to deploy on Kubernetes and it continually failed to start, what steps would you take to figure out what was going wrong?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database_in_kubernetes">8. Database in Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_2">8.1. Introduction</h3>
<div class="paragraph">
<p>In this example we implement a primary / standby replication setup for
PostgreSQL. Two <strong>Services</strong> will be provided: one for read/write requests and
another exclusively for read requests. We will try to use Kubernetes to handle
the initialization and monitoring functions that had to be done by hand in
<a href="#_replication">previously</a>.</p>
</div>
<div class="paragraph">
<p>Rather than passing command line options to the <code>kubectl</code> command, we will be
defining what we create in a YAML file: <code>example-final/db-k8s.yml</code>. kubectl can
load object definitions from YAML files with the <code>apply</code> command.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at the Kubernetes objects we are defining:</p>
</div>
</div>
<div class="sect2">
<h3 id="_persistentvolumeclaims">8.2. PersistentVolumeClaims</h3>
<div class="paragraph">
<p>A <strong>PersistentVolumeClaim</strong> lets the cluster know that you are expecting certain
storage resources. In this case, we are looking for a place to store our
primary database files. This claim will be fulfilled by a
<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/"><strong>StorageClass</strong></a>
that is built into minikube. As far as we are concerned, we just have to tell
it what we want and it will make it happen.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>.</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: db-primary-pv-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 512M</code></pre>
</div>
</div>
<div class="paragraph">
<p>This claim will be used by our <em>one</em> <code>db-rw</code> pod, so we don&#8217;t have to worry
about shared access. The supported accessModes are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ReadWriteOnce</strong> - can be mounted read / write by only one pod</p>
</li>
<li>
<p><strong>ReadOnlyMany</strong>  can be mounted read-only by many pods</p>
</li>
<li>
<p><strong>ReadWriteMany</strong>  can be mounted as read-write by many pods</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_services">8.3. Services</h3>
<div class="paragraph">
<p>A <strong>Service</strong> exposes an application on a group of pods. In our case we will be
providing two <strong>Services</strong>: a <code>db-rw</code> <strong>Service</strong> which connects to our primary
PostgreSQL instance and a <code>db-r</code> <strong>Service</strong> which connects to our standby
PostgreSQL instances. Unlike Docker Compose, even on our internal network we
have to explicitly state which ports we make available.</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: v1
kind: Service
metadata:
  name: db-rw
  labels:
    app: db-rw
spec:
  selector:
    app: db-rw
  ports:
    - protocol: TCP
      port: 5432

---
apiVersion: v1
kind: Service
metadata:
  name: db-r
  labels:
    app: db-r
spec:
  selector:
    app: db-r
  ports:
    - protocol: TCP
      port: 5432</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>selector</code> field above defines how a <strong>Service</strong> knows which pods to utilize.
In our case all pods with the app label <code>db-r</code> are used by the <code>db-r</code> <strong>Service</strong>
and a similar rule is applied to the <code>db-rw</code> <strong>Service</strong>. Both services accept
incoming connections on port 5432 and route those connections to 5432. In the
case where there are multiple pods in a <strong>Service</strong> a load balancing scheme is
used by default.</p>
</div>
<div class="paragraph">
<p>From a service discovery perspective, Kubernetes <strong>Services</strong> make things easier.
If you want to connect to a read-only database instance all you have to do is
use the hostname <code>db-r</code>. Similarly, if you want to connect to a read-write
database, use the hostname <code>db-rw</code>. The DNS resolution, load-balancing proxy,
and routing are set up automatically.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deployments">8.4. Deployments</h3>
<div class="paragraph">
<p>A <strong>Deployment</strong> tells Kubernetes how to create and monitor pods. The bulk of our
work will be done in the <code>db-r</code> and <code>db-rw</code> <strong>Deployments</strong>. Fortunately we have
already covered the logic of what needs to happen <a href="#_replication">previously</a>, so
let&#8217;s jump right in and take a look at the <strong>Deployment</strong> for our primary
PostgreSQL instance:</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db-rw
  labels:
    app: db-rw
spec:
  replicas: 1
  selector:
    matchLabels:
      app: db-rw
  template:
    metadata:
      labels:
        app: db-rw
    spec:
      containers:
        - name: db-rw
          image: postgres
          env:
            - name: POSTGRES_PASSWORD
              value: "changeme"
            - name: POSTGRES_REPLICA_PASSWORD
              value: "changeme"
          command:
            - bash
            - "-c"
            - |
              set -ex

              if [ -s "/var/lib/postgresql/data/PG_VERSION" ]; then
                echo "Database already exists, not creating a new one."
              else
                rm -rf /var/lib/postgresql/data/*
                chown postgres /var/lib/postgresql/data

                su -c "initdb --username=postgres --pwfile=&lt;(echo \"$POSTGRES_PASSWORD\")" postgres

                # Start a temporary server listening on localhost
                su -c "pg_ctl -D /var/lib/postgresql/data -w start" postgres

                # Create a user for replication operations
                psql -v ON_ERROR_STOP=1 --username postgres --dbname postgres &lt;&lt;EOF
                  CREATE USER repuser REPLICATION LOGIN ENCRYPTED PASSWORD '$POSTGRES_REPLICA_PASSWORD';
              EOF
              # ^ this EOF has to be in line with the YAML scalar block

                # Stop the temporary server
                su -c "pg_ctl -D /var/lib/postgresql/data -m fast -w stop" postgres

                # Set up authentication parameters
                echo "host replication all all md5" &gt;&gt; /var/lib/postgresql/data/pg_hba.conf
                echo "host all all all md5" &gt;&gt; /var/lib/postgresql/data/pg_hba.conf
              fi

              # Now run the server
              su -c postgres postgres
          volumeMounts:
            - name: db-primary-storage
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: db-primary-storage
          persistentVolumeClaim:
            claimName: db-primary-pv-claim</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ths <strong>Deployment</strong> tells Kubernetes to maintain one <code>replica</code> of the pod defined
in the <code>template</code> section. The <code>containers</code> section is a list of one container
that uses the <code>postgres</code> image from Docker Hub and overrides the ENTRYPOINT of
that Dockerfile (this is <code>command</code> in Kubernetespeak). Our script is taken
almost line-for-line from our <a href="#_replication">previous example</a>. Lastly, this
deployment makes use of our <strong>PersistentVolumeClaim</strong> defined previously and
mounts it in <code>/var/lib/postgresql/data</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the <strong>Deployment</strong> for our standby PostgreSQL instances:</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db-r
  labels:
    app: db-r
spec:
  replicas: 2
  selector:
    matchLabels:
      app: db-r
  template:
    metadata:
      labels:
        app: db-r
    spec:
      containers:
        - name: db-r
          image: postgres
          env:
            - name: POSTGRES_REPLICA_PASSWORD
              value: "changeme"
          command:
            - bash
            - "-c"
            - |
              set -ex

              # Set up our password in .pgpass so we can connect to replicate
              # without a prompt
              echo "db-rw:5432:replication:repuser:$POSTGRES_REPLICA_PASSWORD" &gt;&gt; /var/lib/postgresql/.pgpass
              chown postgres /var/lib/postgresql/.pgpass
              chmod 600 /var/lib/postgresql/.pgpass

              # we may start before their are WALs, so we need to make this directory
              mkdir -p /var/lib/postgresql/data/pg_wal
              chown postgres /var/lib/postgresql/data/pg_wal

              # Clone the database from db-rw
              rm -rf /var/lib/postgresql/data/*
              chown postgres /var/lib/postgresql/data
              chmod -R 700 /var/lib/postgresql/data
              su -c "pg_basebackup -h db-rw -D /var/lib/postgresql/data -U repuser -w -v -P -X stream" postgres

              # Add connection info
              cat &lt;&lt; EOF &gt;&gt; /var/lib/postgresql/data/postgresql.conf
                primary_conninfo = 'host=db-rw port=5432 user=repuser password=$POSTGRES_REPLICA_PASSWORD'
              EOF

              # Notify postgres that this is a standby server
              touch /var/lib/postgresql/data/standby.signal

              # Now run the server
              su -c postgres postgres</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <strong>Deployment</strong> stands up two replicas. Each replica clones the primary
database (using the hostname <code>db-rw</code> provided by our <code>db-rw</code> <strong>Service</strong>) and then
acts as a hot standby. A <strong>PersistentVolumeClaim</strong> is <em>not</em> used, meaning if push
came to shove, we may not be able to easily recover the database from one of
these containers.</p>
</div>
<div class="paragraph">
<p>Notice that neither <strong>Deployment</strong> has to search for the primary or monitor the
other instances. Kubernetes handles this for us. In fact, the standbys don&#8217;t
even have to wait for the primary to be up. If they can&#8217;t clone the database,
they will fail and Kubernetes will restart them until they work.</p>
</div>
<div class="paragraph">
<p>Much of the hard work of our <a href="#_replication">earlier example</a> is now handled for
us by a <em>proper</em> orchestration framework.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_example">8.5. Running the Example</h3>
<div class="paragraph">
<p>Let&#8217;s take a look at the example in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl apply -f .\db-k8s.yml
persistentvolumeclaim/db-primary-pv-claim created
service/db-rw created
service/db-r created
deployment.apps/db-rw created
deployment.apps/db-r created</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kubectl apply -f</code> command can be used to bring up all of the objects
defined in a file. It should also be noted that it can work with an entire
directory of files, allowing for separation of logical segments, unlike a
<code>docker-compose.yml</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
db-r-54d9bc6496-cjhn8    1/1     Running   1          2m31s
db-r-54d9bc6496-pg8b2    1/1     Running   0          2m31s
db-rw-6fd7767ddd-g6kvj   1/1     Running   0          2m31s</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>kubectl get pod</code> show you all of the pods that are currently running. All of
the pods in our deployment are now up. They are given hash codes for the second
part of their name to keep them unique. You may notice that
<code>db-r-54d9bc6496-cjhn8</code> had to be restarted once. It probably came up before
<code>db-rw-6fd7767ddd-g6kvj</code> was ready to have its database cloned.</p>
</div>
<div class="paragraph">
<p>Using the command <code>kubectl logs</code> we can get the logs for a pod. Let&#8217;s take a
look at our primary PostgreSQL instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl logs db-rw-6fd7767ddd-g6kvj
+ '[' -s /var/lib/postgresql/PG_VERSION ']'
+ rm -rf '/var/lib/postgresql/data/*'
+ chown postgres /var/lib/postgresql/data
+ su -c 'initdb --username=postgres --pwfile=&lt;(echo "changeme")' postgres
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.utf8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/data ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
initdb: warning: enabling "trust" authentication for local connections
You can change this by editing pg_hba.conf or using the option -A, or
--auth-local and --auth-host, the next time you run initdb.
syncing data to disk ... ok


Success. You can now start the database server using:

    pg_ctl -D /var/lib/postgresql/data -l logfile start

+ su -c 'pg_ctl -D /var/lib/postgresql/data -w start' postgres
waiting for server to start....2020-04-06 01:34:45.086 UTC [27] LOG:  starting PostgreSQL 12.2 (Debian 12.2-2.pgdg100+1) on x86_64
-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit
2020-04-06 01:34:45.086 UTC [27] LOG:  listening on IPv4 address "0.0.0.0", port 5432
2020-04-06 01:34:45.086 UTC [27] LOG:  listening on IPv6 address "::", port 5432
2020-04-06 01:34:45.091 UTC [27] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2020-04-06 01:34:45.104 UTC [28] LOG:  database system was shut down at 2020-04-06 01:34:44 UTC
2020-04-06 01:34:45.109 UTC [27] LOG:  database system is ready to accept connections
 done
server started
+ psql -v ON_ERROR_STOP=1 --username postgres --dbname postgres
CREATE ROLE
+ su -c 'pg_ctl -D /var/lib/postgresql/data -m fast -w stop' postgres
waiting for server to shut down....2020-04-06 01:34:45.238 UTC [27] LOG:  received fast shutdown request
2020-04-06 01:34:45.242 UTC [27] LOG:  aborting any active transactions
2020-04-06 01:34:45.244 UTC [27] LOG:  background worker "logical replication launcher" (PID 34) exited with exit code 1
2020-04-06 01:34:45.244 UTC [29] LOG:  shutting down
2020-04-06 01:34:45.275 UTC [27] LOG:  database system is shut down
 done
server stopped
+ echo 'host replication all all md5'
+ echo 'host all all all md5'
+ su -c postgres postgres
2020-04-06 01:34:45.362 UTC [46] LOG:  starting PostgreSQL 12.2 (Debian 12.2-2.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc
(Debian 8.3.0-6) 8.3.0, 64-bit
2020-04-06 01:34:45.363 UTC [46] LOG:  listening on IPv4 address "0.0.0.0", port 5432
2020-04-06 01:34:45.363 UTC [46] LOG:  listening on IPv6 address "::", port 5432
2020-04-06 01:34:45.368 UTC [46] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2020-04-06 01:34:45.383 UTC [47] LOG:  database system was shut down at 2020-04-06 01:34:45 UTC
2020-04-06 01:34:45.388 UTC [46] LOG:  database system is ready to accept connections</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as <a href="#_replication">before</a>, the primary node initialized a database, set
up a replication user, and started <code>postgres</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at one of the standby nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl logs db-r-54d9bc6496-cjhn8
+ echo db-rw:5432:replication:repuser:changeme
+ chown postgres /var/lib/postgresql/.pgpass
+ chmod 600 /var/lib/postgresql/.pgpass
+ mkdir -p /var/lib/postgresql/data/pg_wal
+ chown postgres /var/lib/postgresql/data/pg_wal
+ rm -rf /var/lib/postgresql/data/pg_wal
+ chown postgres /var/lib/postgresql/data
+ chmod -R 700 /var/lib/postgresql/data
+ su -c 'pg_basebackup -h db-rw -D /var/lib/postgresql/data -U repuser -w -v -P -X stream' postgres
pg_basebackup: initiating base backup, waiting for checkpoint to complete
pg_basebackup: checkpoint completed
pg_basebackup: write-ahead log start point: 0/3000028 on timeline 1
pg_basebackup: starting background WAL receiver
pg_basebackup: created temporary replication slot "pg_basebackup_57"
    0/24554 kB (0%), 0/1 tablespace (...lib/postgresql/data/backup_label)
24564/24564 kB (100%), 0/1 tablespace (...ostgresql/data/global/pg_control)
24564/24564 kB (100%), 1/1 tablespace
pg_basebackup: write-ahead log end point: 0/3000100
pg_basebackup: waiting for background process to finish streaming ...
pg_basebackup: syncing data to disk ...
pg_basebackup: base backup completed
+ cat
+ touch /var/lib/postgresql/data/standby.signal
+ su -c postgres postgres
2020-04-06 01:34:47.283 UTC [18] LOG:  starting PostgreSQL 12.2 (Debian 12.2-2.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc
(Debian 8.3.0-6) 8.3.0, 64-bit
2020-04-06 01:34:47.283 UTC [18] LOG:  listening on IPv4 address "0.0.0.0", port 5432
2020-04-06 01:34:47.283 UTC [18] LOG:  listening on IPv6 address "::", port 5432
2020-04-06 01:34:47.289 UTC [18] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2020-04-06 01:34:47.304 UTC [19] LOG:  database system was interrupted; last known up at 2020-04-06 01:34:46 UTC
2020-04-06 01:34:47.442 UTC [19] LOG:  entering standby mode
2020-04-06 01:34:47.446 UTC [19] LOG:  redo starts at 0/3000028
2020-04-06 01:34:47.449 UTC [19] LOG:  consistent recovery state reached at 0/3000100
2020-04-06 01:34:47.449 UTC [18] LOG:  database system is ready to accept read only connections
2020-04-06 01:34:47.455 UTC [23] LOG:  started streaming WAL from primary at 0/4000000 on timeline 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This standby backed up the primary database and started streaming logs from the
primary.</p>
</div>
<div class="paragraph">
<p>The <code>kubectl exec</code> command lets you execute a command on a running pod. Lets
use this to run psql on one of the standbys, connect to the primary, create
a table, and then check to see if it shows up on the standbys:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl exec -it db-r-54d9bc6496-pg8b2 -- bash
root@db-r-54d9bc6496-pg8b2:/# psql -h db-rw -U postgres
Password for user postgres:
psql (12.2 (Debian 12.2-2.pgdg100+1))
Type "help" for help.

postgres=# \dt
Did not find any relations.
postgres=# CREATE TABLE test(test_column INTEGER);
CREATE TABLE
postgres=# \dt
        List of relations
 Schema | Name | Type  |  Owner
--------+------+-------+----------
 public | test | table | postgres
(1 row)

postgres=# \q
root@db-r-54d9bc6496-pg8b2:/# psql -h db-r -U postgres
Password for user postgres:
psql (12.2 (Debian 12.2-2.pgdg100+1))
Type "help" for help.

postgres=# \dt
        List of relations
 Schema | Name | Type  |  Owner
--------+------+-------+----------
 public | test | table | postgres
(1 row)

postgres=# \q</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, anything we create on the primary (which we access by resolving
the name <code>db-rw</code> shows up on the standby. Now lets try performing a write
operation on a standby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">root@db-r-54d9bc6496-pg8b2:/# psql -h db-r -U postgres
Password for user postgres:
psql (12.2 (Debian 12.2-2.pgdg100+1))
Type "help" for help.

postgres=# CREATE TABLE test2(test_column INTEGER);
ERROR:  cannot execute CREATE TABLE in a read-only transaction</code></pre>
</div>
</div>
<div class="paragraph">
<p>It fails, as it should. Lets take a look at how <strong>Services</strong> glue all of this
together with the <code>kubectl get service</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl get service
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
db-r         ClusterIP   10.106.33.23    &lt;none&gt;        5432/TCP   41m
db-rw        ClusterIP   10.99.113.228   &lt;none&gt;        5432/TCP   41m
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    35h</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>db-r</code> and <code>db-rw</code> are <strong>Services</strong>, so if a pod tries to resolve on of those
names, they will get the CLUSTER-IP (10.106.33.23 and 10.99.113.228
respectively). That ClusterIP is a proxy that will forward their request to
a pod that can handle it. This allows for load-balancing and high availability.</p>
</div>
<div class="paragraph">
<p>On the subject of HA, the last thing we have to check is that pods will be
automatically restarted. Let&#8217;s do something bad to one of our pods with the
<code>kubectl exec</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl exec -it db-rw-6fd7767ddd-g6kvj -- bash
root@db-rw-6fd7767ddd-g6kvj:/# killall5 -9
command terminated with exit code 137
PS C:\Users\rxt1077\it490\example-final&gt; kubectl get pods
NAME                     READY   STATUS    RESTARTS   AGE
db-r-54d9bc6496-cjhn8    1/1     Running   1          48m
db-r-54d9bc6496-pg8b2    1/1     Running   0          48m
db-rw-6fd7767ddd-g6kvj   1/1     Running   1          48m</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>killall5 -9</code> will send a kill signal to all processes on the pod, causing it
to shut down. Kubernetes brought it back up again as evidenced by RESTARTS
being equal to one. While the primary is restarting you will lose write
access, but the standbys will continue to provide read access. Once it is back
up (a matter of seconds), everything should be functioning as normal.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion_2">8.6. Conclusion</h3>
<div class="paragraph">
<p>Using Kubernetes we were able to quickly build a HA PostgreSQL cluster. This is
just the tip of the iceberg for what Kubernetes supports and as you learn more
about it you should be able to revisit and improve this implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_questions_4">8.7. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>A systems architect was using a stock Docker Hub image with a custom ENTRYPOINT point script she had designed. This required a Dockerfile, BASH script, and a directory to store them. When she migrated to Kubernetes she was able to do this all in one YAML file. Describe how this is possible.</em></p>
<p></p>
</li>
<li>
<p><em>Why are <strong>Services</strong> essential to replication?</em></p>
<p></p>
</li>
<li>
<p><em>Why do we define two <strong>Deployments</strong> for our example?</em></p>
<p></p>
</li>
<li>
<p><em>How can our database deployment be improved?</em></p>
<p></p>
</li>
<li>
<p><em>Compare and contrast Kubernetes PersistentVolumeClaims with Docker compose named volumes.</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_messaging_in_kubernetes">9. Messaging in Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will build a RabbitMQ cluster in Kubernetes to support our
application.</p>
</div>
<div class="sect2">
<h3 id="_resources_3">9.1. Resources</h3>
<div class="paragraph">
<p>Before we get started, there are some excellent resources for what we are going
to be covering. You should read / explore <em>all</em> of the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.rabbitmq.com/clustering.html">RabbitMQ Clustering Guide</a></p>
</li>
<li>
<p><a href="https://www.rabbitmq.com/cluster-formation.html">RabbitMQ Cluster Formation and Peer Discovery</a></p>
</li>
<li>
<p><a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Documentation on Docker Hub</a></p>
</li>
<li>
<p><a href="https://github.com/rabbitmq/rabbitmq-peer-discovery-k8s/tree/master/examples">
Deploy RabbitMQ on Kubernetes with the Kubernetes Peer Discovery Plugin</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_rabbitmq">9.2. RabbitMQ</h3>
<div class="paragraph">
<p>RabbitMQ is built on Erlang/OTP, a platform designed in the telecom industry.
Given the nature of that industry, Erlang/OTP was designed to be highly scalable
and have strong concurrency support. In other words, it is the perfect platform
for building non-hierarchical, distributed applications. To give you an example
that you may be familiar with, Whatsapp runs on Erlang/OTP and it handles about
two million connected users per server.</p>
</div>
<div class="paragraph">
<p>All nodes in a RabbitMQ cluster are equal peers, there is no primary / standby
structure like we used in the database example. The <a href="https://raft.github.io/">
RAFT</a> consensus algorithm is used to make decisions for the cluster and as such,
it is <a href="https://www.rabbitmq.com/quorum-queues.html">highly recommended</a> that the
number of nodes be odd. Given the amount of traffic and the need for quick
communication, clustering is designed to function at the LAN level, not the WAN
level.</p>
</div>
<div class="paragraph">
<p>Messages in queues are <strong>not</strong> replicated by default, although that
<a href="https://www.rabbitmq.com/ha.html">can be turned on.</a> For us, this only really
matters for the <code>incoming</code> queue as our other queues are exclusive. Any node can
route requests through the node that happens to contain the <code>incoming</code> queue
and given the short nature of our connections this should function just fine.
It is also worth nothing that when a node joins a cluster, its state is reset.
Once again, given the nature of our connections this shouldn&#8217;t have much of an
impact on our application.</p>
</div>
<div class="paragraph">
<p>It is recommended that all nodes run the same version of Erlang/OTP. This
should be easy for us since our nodes will be built from the same image. Nodes
also need to have the same Erlang cookie (shared secret) so they can communicate
with each other securely. This can be passed via the <code>RABBITMQ_ERLANG_COOKIE</code>
environment variable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kubernetes_2">9.3. Kubernetes</h3>
<div class="paragraph">
<p>RabbitMQ has a peer discovery plugin for Kubernetes that is included with its
base image. It just needs to be enabled. RabbitMQ also provides a
<a href="https://github.com/rabbitmq/rabbitmq-peer-discovery-k8s/tree/master/examples">
repository</a> that demonstrates how to use it. This example will implement
something similar, but before we do, we need to go over some new Kubernetes
objects.</p>
</div>
<div class="paragraph">
<p>Our example will make use of
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">
<strong>StatefulSets</strong></a>, which are similar to <strong>Deployments</strong> in that they use a template
to build pods. <strong>StatefulSets</strong> also maintain a unique, predictable, enumerated
name which in our case will be: <code>messaging-0</code>, <code>messaging-1</code>, <code>messaging-2</code>,
etc. Lastly, <strong>StatefulSets</strong> bring up their pods one-at-a-time, solving some
initialization / cluster-building problems we&#8217;ve encountered in the past.</p>
</div>
<div class="paragraph">
<p>The peer discovery plugin, rabbit_peer_discovery_k8s, uses the Kubernetes API to
find other nodes. Kubernetes uses Role Based Access Control (RBAC) by default to
grant permissions to use the Kubernetes API.  Therefore we will need to
configure a <strong>ServiceAccount</strong>, <strong>Role</strong>, and <strong>RoleBinding</strong> to allow the plugin to
make the requests it needs.</p>
</div>
<div class="paragraph">
<p>RabbitMQ requires that the hostnames of all cluster members be fully resolvable
via DNS. By setting up a <strong>Service</strong> we can let Kubernetes handle the hostname
resolution for us. While this isn&#8217;t new to us, for RabbitMQ it is important to
understand exactly how Kubernetes assigns fully qualified domain names (FQDN).
By default, it uses the form
<code>&lt;hostname&gt;.&lt;servicename&gt;.&lt;namespace&gt;.svc.cluster.local</code>. If you don&#8217;t specify
a namespace, you are working in the <code>default</code> namespace, therefore we could
expect the FQDN for the first node of our RabbitMQ cluster to be
<code>messaging-0.messaging.default.svc.cluster.local</code>.</p>
</div>
<div class="paragraph">
<p>To make things easier we will be using a
<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">
<strong>ConfigMap</strong></a> to store our custom configs for RabbitMQ. This allows us to put
our config files directly inside our YAML definitions and then mount them as
volumes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_2">9.4. Example</h3>
<div class="paragraph">
<p>Now we&#8217;ll look at our actual Kubernetes objects. These can be found in
<code>..//example-final/messaging-k8s.yml</code>.</p>
</div>
<div class="sect3">
<h4 id="_rbac">9.4.1. RBAC</h4>
<div class="paragraph">
<p>Let&#8217;s start by establishing a <strong>ServiceAccount</strong> for our pods and binding it to a
<strong>Role</strong> that allows us to GET or LIST endpoints for a <strong>Service</strong>:</p>
</div>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: messaging

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: rabbitmq-peer-discovery-rbac
rules:
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: rabbitmq-peer-discovery-rbac
subjects:
  - kind: ServiceAccount
    name: messaging
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rabbitmq-peer-discovery-rbac</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>ServiceAccount</strong> <code>messaging</code> will be used in our <strong>StatefulSet</strong> so that when
a node is brought up, it can query the Kubernetes API to discover the other
nodes. You will see this process in the logs later.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configmap">9.4.2. <strong>ConfigMap</strong></h4>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
data:
  enabled_plugins: |
    [rabbitmq_management,rabbitmq_peer_discovery_k8s].
  rabbitmq.conf: |
    cluster_formation.peer_discovery_backend  = rabbit_peer_discovery_k8s
    cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
    cluster_formation.k8s.address_type = hostname
    cluster_formation.node_cleanup.interval = 30
    cluster_formation.node_cleanup.only_log_warning = true
    cluster_partition_handling = autoheal
    queue_master_locator=min-masters
    loopback_users.guest = false</code></pre>
</div>
</div>
<div class="paragraph">
<p>The keys and values in the <code>data</code> section of a <strong>ConfigMap</strong> are used to hold
information that is later placed in a file in a pod template. <strong>ConfigMaps</strong> are
mounted as volumes in the template as we will see in a moment.</p>
</div>
</div>
<div class="sect3">
<h4 id="_services_2">9.4.3. <strong>Services</strong></h4>
<div class="paragraph">
<p>We will use a <strong>Service</strong> for two purposes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To keep track of what nodes are in the RabbitMQ cluster. The
rabbit_peer_discovery_k8s plugin will use this when RabbitMQ is started on a
pod.</p>
</li>
<li>
<p>To load balance requests. We can send AMQP traffic <em>and</em> HTTP traffic to any
node for messaging and administrative interface purposes respectively.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: v1
kind: Service
metadata:
  name: messaging
  labels:
    app: messaging
spec:
  selector:
    app: messaging
  ports:
    - name: amqp
      protocol: TCP
      port: 5672
    - name: http
      protocol: TCP
      port: 15672</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a standard Kubernetes service that will be given a <code>ClusterIP</code> and will
load balance requests for port <code>5672</code> and <code>15672</code> (AMQP and RabbitMQ admin
interface, respectively).</p>
</div>
</div>
<div class="sect3">
<h4 id="_statefulset">9.4.4. <strong>StatefulSet</strong></h4>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: messaging
  labels:
    app: messaging
spec:
  serviceName: messaging
  replicas: 3
  selector:
    matchLabels:
      app: messaging
  template:
    metadata:
      labels:
        app: messaging
    spec:
      serviceAccountName: messaging
      containers:
        - name: rabbitmq
          image: rabbitmq:management
          env:
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: RABBITMQ_USE_LONGNAME
              value: "true"
            - name: K8S_SERVICE_NAME
              value: messaging
            - name: K8S_HOSTNAME_SUFFIX
              value: .messaging.default.svc.cluster.local
            - name: RABBITMQ_NODENAME
              value: rabbit@$(MY_POD_NAME).messaging.default.svc.cluster.local
            - name: RABBITMQ_ERLANG_COOKIE
              value: "changeme"
          volumeMounts:
            - name: config-volume
              mountPath: /etc/rabbitmq
      volumes:
        - name: config-volume
          configMap:
            name: rabbitmq-config
            items:
              - key: rabbitmq.conf
                path: rabbitmq.conf
              - key: enabled_plugins
                path: enabled_plugins</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should look pretty similar to the <strong>Deployment</strong> we worked on
<a href="#_kubernetes">earlier</a>. It creates three replicas by default. Some new things
that it has introduced:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Environment variables can be pulled from Kubernetes parameters, see
<code>MY_POD_NAME</code> for an example.</p>
</li>
<li>
<p><strong>ConfigMaps</strong> can be mounted in a directory. The keys in the data section serve
as file names and the values service as the file contents.
<a href="https://yaml-multiline.info/">You may want to brush up on your YAML multiline
strings.</a></p>
</li>
<li>
<p>The environment variables <code>K8S_SERVICE_NAME</code> and <code>K8S_HOSTNAME_SUFFIX</code> are
used by the discovery plugin. If they are not defined it <em>will</em> fail.</p>
</li>
<li>
<p><code>serviceAccountName</code> is set to messaging to take advantage of our RBAC
configuration.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_example_2">9.4.5. Running the Example</h4>
<div class="paragraph">
<p>Let&#8217;s apply our system to a Kubernetes cluster and perform some analysis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS \example-final&gt; kubectl apply -f .\messaging-k8s.yml
serviceaccount/messaging created
role.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
rolebinding.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
configmap/rabbitmq-config created
service/messaging created
statefulset.apps/messaging created
PS C:\Users\rxt1077\it490\example-final&gt; kubectl get pod
NAME          READY   STATUS    RESTARTS   AGE
messaging-0   1/1     Running   0          4m2s
messaging-1   1/1     Running   0          4m1s
messaging-2   1/1     Running   0          4m</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, it brings up three pods. Unlike a <strong>Deployment</strong> which uses
hashes, the pod names are enumerated. Also unlink a <strong>Deployment</strong> they are
brought up one-at-a-time.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the logs and see how startup proceeded for <code>messaging-0</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS C:\Users\rxt1077\it490\example-final&gt; kubectl logs messaging-0
2020-04-11 18:38:08.118 [info] &lt;0.9.0&gt; Feature flags: list of feature flags found:
2020-04-11 18:38:08.118 [info] &lt;0.9.0&gt; Feature flags:   [ ] drop_unroutable_metric
&lt;snip&gt;
 cookie hash    : TLnIqASP0CKUR3/LGkEZGg==<i class="conum" data-value="1"></i><b>(1)</b>
&lt;snip&gt;
2020-04-11 18:38:08.301 [info] &lt;0.278.0&gt; Node database directory at /var/lib/rabbitmq/mnesia/rabbit@messaging-0.messaging.default.
svc.cluster.local is empty. Assuming we need to join an existing cluster or initialise from scratch...
2020-04-11 18:38:08.301 [info] &lt;0.278.0&gt; Configured peer discovery backend: rabbit_peer_discovery_k8s
2020-04-11 18:38:08.301 [info] &lt;0.278.0&gt; Will try to lock with peer discovery backend rabbit_peer_discovery_k8s
2020-04-11 18:38:08.301 [info] &lt;0.278.0&gt; Peer discovery backend does not support locking, falling back to randomized delay
2020-04-11 18:38:08.301 [info] &lt;0.278.0&gt; Peer discovery backend rabbit_peer_discovery_k8s supports registration.
2020-04-11 18:38:08.302 [info] &lt;0.278.0&gt; Will wait for 1638 milliseconds before proceeding with registration...<i class="conum" data-value="2"></i><b>(2)</b>
2020-04-11 18:38:09.975 [info] &lt;0.278.0&gt; All discovered existing cluster peers: rabbit@messaging-2.messaging.default.svc.cluster.l
ocal, rabbit@messaging-1.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:09.975 [info] &lt;0.278.0&gt; Peer nodes we can cluster with: rabbit@messaging-2.messaging.default.svc.cluster.local, r
abbit@messaging-1.messaging.default.svc.cluster.local<i class="conum" data-value="3"></i><b>(3)</b>
2020-04-11 18:38:09.981 [warning] &lt;0.278.0&gt; Could not auto-cluster with node rabbit@messaging-2.messaging.default.svc.cluster.loca
l: {error,mnesia_not_running}
2020-04-11 18:38:09.985 [warning] &lt;0.278.0&gt; Could not auto-cluster with node rabbit@messaging-1.messaging.default.svc.cluster.loca
l: {error,tables_not_present}
2020-04-11 18:38:09.985 [warning] &lt;0.278.0&gt; Could not successfully contact any node of: rabbit@messaging-2.messaging.default.svc.c
luster.local,rabbit@messaging-1.messaging.default.svc.cluster.local (as in Erlang distribution). Starting as a blank standalone no
de...<i class="conum" data-value="4"></i><b>(4)</b>
&lt;snip&gt;
2020-04-11 18:38:11.041 [info] &lt;0.9.0&gt; Server startup complete; 5 plugins started.
 * rabbitmq_management
 * rabbitmq_web_dispatch
 * rabbitmq_management_agent
 * rabbitmq_peer_discovery_k8s
 * rabbitmq_peer_discovery_common
 completed with 5 plugins.
2020-04-11 18:38:11.650 [info] &lt;0.535.0&gt; rabbit on node 'rabbit@messaging-2.messaging.default.svc.cluster.local' up <i class="conum" data-value="5"></i><b>(5)</b>
2020-04-11 18:38:11.859 [info] &lt;0.535.0&gt; rabbit on node 'rabbit@messaging-1.messaging.default.svc.cluster.local' up</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This should match the cookie on the other nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This randomized wait could be optimized since we know we will start in
order. See the official example for a better implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Other peers were detected, but RabbitMQ was not fully initialized on them.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Therefore <code>messaging-0</code> became a standalone node.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Eventually the other nodes joined us.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the logs and see how startup proceeded for <code>messaging-1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl logs messaging-1
2020-04-11 18:38:09.658 [info] &lt;0.9.0&gt; Feature flags: list of feature flags found:
2020-04-11 18:38:09.658 [info] &lt;0.9.0&gt; Feature flags:   [ ] drop_unroutable_metric
2020-04-11 18:38:09.658 [info] &lt;0.9.0&gt; Feature flags:   [ ] empty_basic_get_metric
&lt;snip&gt;
 cookie hash    : TLnIqASP0CKUR3/LGkEZGg==<i class="conum" data-value="1"></i><b>(1)</b>
&lt;snip&gt;
2020-04-11 18:38:09.790 [info] &lt;0.278.0&gt; Node database directory at /var/lib/rabbitmq/mnesia/rabbit@messaging-1.messaging.default.
svc.cluster.local is empty. Assuming we need to join an existing cluster or initialise from scratch...
2020-04-11 18:38:09.790 [info] &lt;0.278.0&gt; Configured peer discovery backend: rabbit_peer_discovery_k8s
2020-04-11 18:38:09.791 [info] &lt;0.278.0&gt; Will try to lock with peer discovery backend rabbit_peer_discovery_k8s
2020-04-11 18:38:09.791 [info] &lt;0.278.0&gt; Peer discovery backend does not support locking, falling back to randomized delay
2020-04-11 18:38:09.791 [info] &lt;0.278.0&gt; Peer discovery backend rabbit_peer_discovery_k8s supports registration.
2020-04-11 18:38:09.791 [info] &lt;0.278.0&gt; Will wait for 855 milliseconds before proceeding with registration...
2020-04-11 18:38:10.670 [info] &lt;0.278.0&gt; All discovered existing cluster peers: rabbit@messaging-2.messaging.default.svc.cluster.l
ocal, rabbit@messaging-1.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:10.670 [info] &lt;0.278.0&gt; Peer nodes we can cluster with: rabbit@messaging-2.messaging.default.svc.cluster.local, r
abbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:10.673 [warning] &lt;0.278.0&gt; Could not auto-cluster with node rabbit@messaging-2.messaging.default.svc.cluster.loca
l: {error,tables_not_present}
2020-04-11 18:38:10.696 [info] &lt;0.278.0&gt; Node 'rabbit@messaging-0.messaging.default.svc.cluster.local' selected for auto-clusterin
g<i class="conum" data-value="2"></i><b>(2)</b>
&lt;snip&gt;
2020-04-11 18:38:12.118 [info] &lt;0.9.0&gt; Server startup complete; 5 plugins started.
 * rabbitmq_management
 * rabbitmq_web_dispatch
 * rabbitmq_management_agent
 * rabbitmq_peer_discovery_k8s
 * rabbitmq_peer_discovery_common
 completed with 5 plugins.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sure enough, our cookie is the same</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>messaging-0</code> is up an available for peering, but <code>messaging-1</code> is not. We
peered with <code>messaging-0</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s look at the logs and see how startup proceeded for <code>messaging-2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl logs messaging-2
2020-04-11 18:38:10.155 [info] &lt;0.9.0&gt; Feature flags: list of feature flags found:
2020-04-11 18:38:10.155 [info] &lt;0.9.0&gt; Feature flags:   [ ] drop_unroutable_metric
&lt;snip&gt;
 cookie hash    : TLnIqASP0CKUR3/LGkEZGg==<i class="conum" data-value="1"></i><b>(1)</b>
&lt;snip&gt;
2020-04-11 18:38:10.279 [info] &lt;0.287.0&gt; Configured peer discovery backend: rabbit_peer_discovery_k8s
2020-04-11 18:38:10.279 [info] &lt;0.287.0&gt; Will try to lock with peer discovery backend rabbit_peer_discovery_k8s
2020-04-11 18:38:10.279 [info] &lt;0.287.0&gt; Peer discovery backend does not support locking, falling back to randomized delay
2020-04-11 18:38:10.279 [info] &lt;0.287.0&gt; Peer discovery backend rabbit_peer_discovery_k8s supports registration.
2020-04-11 18:38:10.279 [info] &lt;0.287.0&gt; Will wait for 598 milliseconds before proceeding with registration...
2020-04-11 18:38:10.891 [info] &lt;0.287.0&gt; All discovered existing cluster peers: rabbit@messaging-2.messaging.default.svc.cluster.l
ocal, rabbit@messaging-1.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:10.891 [info] &lt;0.287.0&gt; Peer nodes we can cluster with: rabbit@messaging-1.messaging.default.svc.cluster.local, r
abbit@messaging-0.messaging.default.svc.cluster.local<i class="conum" data-value="2"></i><b>(2)</b>
2020-04-11 18:38:10.946 [info] &lt;0.287.0&gt; Node 'rabbit@messaging-1.messaging.default.svc.cluster.local' selected for auto-clusterin
g
&lt;snip&gt;
2020-04-11 18:38:12.009 [info] &lt;0.9.0&gt; Server startup complete; 5 plugins started.
 * rabbitmq_management
 * rabbitmq_web_dispatch
 * rabbitmq_management_agent
 * rabbitmq_peer_discovery_k8s
 * rabbitmq_peer_discovery_common</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Same cookie as all the other nodes, good.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>messaging-2</code> could peer with either <code>messaging-0</code> or <code>messaging-1</code> as it
was started last. It chose <code>messaging-1</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The last thing we can do is look at the output of <code>rabbitmqctl cluster_status</code>
to see how our cluster is running. Executing
<a href="https://www.rabbitmq.com/rabbitmqctl.8.html">this command</a> on any node will tell
you about the health of the entire RabbitMQ cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl exec -it messaging-0 -- rabbitmqctl cluster_status
Cluster status of node rabbit@messaging-0.messaging.default.svc.cluster.local ...
Basics

Cluster name: rabbit@messaging-0.messaging.default.svc.cluster.local

Disk Nodes

rabbit@messaging-0.messaging.default.svc.cluster.local
rabbit@messaging-1.messaging.default.svc.cluster.local
rabbit@messaging-2.messaging.default.svc.cluster.local

Running Nodes

rabbit@messaging-0.messaging.default.svc.cluster.local
rabbit@messaging-1.messaging.default.svc.cluster.local
rabbit@messaging-2.messaging.default.svc.cluster.local

Versions

rabbit@messaging-0.messaging.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.1
rabbit@messaging-1.messaging.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.1
rabbit@messaging-2.messaging.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.1

Alarms

(none)

Network Partitions

(none)

Listeners

Node: rabbit@messaging-0.messaging.default.svc.cluster.local, interface: [::], port: 25672, protocol: clustering, purpose: inter-n
ode and CLI tool communication
Node: rabbit@messaging-0.messaging.default.svc.cluster.local, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and
 AMQP 1.0
Node: rabbit@messaging-0.messaging.default.svc.cluster.local, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@messaging-1.messaging.default.svc.cluster.local, interface: [::], port: 25672, protocol: clustering, purpose: inter-n
ode and CLI tool communication
Node: rabbit@messaging-1.messaging.default.svc.cluster.local, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and
 AMQP 1.0
Node: rabbit@messaging-1.messaging.default.svc.cluster.local, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@messaging-2.messaging.default.svc.cluster.local, interface: [::], port: 25672, protocol: clustering, purpose: inter-n
ode and CLI tool communication
Node: rabbit@messaging-2.messaging.default.svc.cluster.local, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and
 AMQP 1.0
Node: rabbit@messaging-2.messaging.default.svc.cluster.local, interface: [::], port: 15672, protocol: http, purpose: HTTP API

Feature flags

Flag: drop_unroutable_metric, state: enabled
Flag: empty_basic_get_metric, state: enabled
Flag: implicit_default_bindings, state: enabled
Flag: quorum_queue, state: enabled
Flag: virtual_host_metadata, state: enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows us that there are three nodes, the nodes are all running the same
version of RabbitMQ and Erlang, and that they are listening for AMQP and admin
interface connections.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_questions_5">9.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What sets RabbitMQ clustering apart from more traditional primary / standby replication?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between a <strong>Deployment</strong> and a <strong>StatefulSet</strong>? Why did we choose a <strong>StatefulSet</strong> for this application?</em></p>
<p></p>
</li>
<li>
<p><em>Why does our peer discovery plugin use the Kubernetes API and what alternatives are there?</em></p>
<p></p>
</li>
<li>
<p><em>What role does RBAC play in the Kubernetes cluster?</em></p>
<p></p>
</li>
<li>
<p><em>What does a <strong>ConfigMap</strong> do and how is it used?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_front_end_in_kubernetes">10. Front End in Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_3">10.1. Introduction</h3>
<div class="paragraph">
<p>Migrating <strong>Front End</strong> to Kubernetes should be a relatively simple. It is already
designed with horizontal scaling in mind. All communication with the other
components is handled by <strong>Messaging</strong> and <strong>Front End</strong> does not maintain any
state. Multiple <strong>Front Ends</strong> can be run at the same time and as far as the
client is concerned, any instance can be used. Kubernetes <strong>Services</strong> can be used
to manage our <strong>Messaging</strong> and <strong>Front End</strong> instances, making connections easy:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/front-end-k8s.svg" alt="front end k8s" width="729" height="383">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice how the front-end instances don&#8217;t need to communicate with each
other unlike the messaging instances which are part of a cluster. This makes
scaling much less complex.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_kubernetes_3">10.2. Kubernetes</h3>
<div class="paragraph">
<p><strong>Front End</strong> requires a way of accessing a <strong>Service</strong> from the outside world. The
traditional way of doing this is through a load balancer, which has an external
IP and forwards traffic from a standard port, 80 for HTTP or 443 for HTTPS, to
the <strong>Service</strong> and ultimately one of the running pods. The concept of load
balancing isn&#8217;t new to us, we have been using it implicitly when we create a
<strong>Service</strong>. The new concept is a method of external access.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/loadbalancer.svg" alt="loadbalancer" width="734" height="438">
</div>
<div class="title">Figure 8. Load Balancer Architecture</div>
</div>
<div class="paragraph">
<p>Our Flask application will listen on port 5000 by default. In an actual
production environment (not minikube) the load balancer would be given an
external IP listening on a standard port. Minikube will support the definition
of a LoadBalancer type <strong>Service</strong> object, but it will actually use a slightly
simpler object called a
<a href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport">
NodePort</a> to access the service. For us, this means we can get to our service
via a local IP and a random port between 30000 and 32767. The
<code>minikube service</code> command will automatically open the URL for the service in
your default web browser.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_3">10.3. Example</h3>
<div class="sect3">
<h4 id="_updating_the_docker_image">10.3.1. Updating the Docker Image</h4>
<div class="paragraph">
<p>The Docker image for use in Kubernetes can actually be simplified from what we
were running before. We can remove the <code>wait-for-it.sh</code> script and we no longer
have to call it from the Dockerfile:</p>
</div>
<div class="listingblock">
<div class="title">example-final/front-end/Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="Dockerfile" class="language-Dockerfile hljs">FROM python
COPY . /app
WORKDIR /app
RUN pip install -r requirements.txt
ENV FLASK_APP=app.py
CMD ["flask", "run", "--host=0.0.0.0"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our <strong>Service</strong> name for <strong>Messaging</strong> is still messaging, so we don&#8217;t even need
to change the hostname the Messaging class connects to. If you look at the
source code you will see that I just changed the comment to reference
Kubernetes instead of Docker Compose.</p>
</div>
</div>
<div class="sect3">
<h4 id="_building_the_docker_image">10.3.2. Building the Docker Image</h4>
<div class="paragraph">
<p>In order for Kubernetes to be able to use our custom image, we need to build it
and make it available to the Docker daemon running <em>inside</em> minikube. With
minikube started, but without the environment set up correctly, <code>docker ps</code>
will only show the containers you have running natively on the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; docker ps
CONTAINER ID  IMAGE                                COMMAND
9689f05c2fca  gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entr"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this example the only container I have running is the container used
by the minikube <code>docker</code> driver. If you are running it under <code>virtualbox</code> or
<code>hyperv</code> you may not see any containers running. If you don&#8217;t have docker
running on your host, you may not even be able to execute the <code>docker ps</code>
command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now if we execute the <code>minikube docker-env</code> command and follow the directions,
<code>docker ps</code> should show the entire Kubernetes environment running in containers
as it is querying the Docker daemon running <em>inside</em> minikube:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; minikube docker-env <i class="conum" data-value="1"></i><b>(1)</b>
$Env:DOCKER_TLS_VERIFY = "1"
$Env:DOCKER_HOST = "tcp://127.0.0.1:32769"
$Env:DOCKER_CERT_PATH = "C:\Users\rxt1077\.minikube\certs"
$Env:MINIKUBE_ACTIVE_DOCKERD = "minikube"
# To point your shell to minikube's docker-daemon, run:
# &amp; minikube -p minikube docker-env | Invoke-Expression <i class="conum" data-value="2"></i><b>(2)</b>
PS example-final&gt; minikube docker-env | Invoke-Expression <i class="conum" data-value="3"></i><b>(3)</b>
PS example-final&gt; docker ps <i class="conum" data-value="4"></i><b>(4)</b>
CONTAINER ID        IMAGE                  COMMAND                  CREATED
47eff1ee88b2        67da37a9a360           "/coredns -conf /etc"   15 hours ago
79d53aceb8f2        67da37a9a360           "/coredns -conf /etc"   15 hours ago
c0eebfebded2        aa67fec7d7ef           "/bin/kindnetd"          15 hours ago
b6a95759fdbe        43940c34f24f           "/usr/local/bin/kube"   15 hours ago
2173eeb16643        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
3b72a0aa725b        4689081edb10           "/storage-provisioner"   15 hours ago
4616fd610301        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
78e245e291fb        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
764d41d70f58        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
29f46b453297        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
fa87bf3bdcfb        a31f78c7c8ce           "kube-scheduler --au"   15 hours ago
5e51df5cc257        d3e55153f52f           "kube-controller-man"   15 hours ago
dc051639dbed        74060cea7f70           "kube-apiserver --ad"   15 hours ago
01cb4068fc8b        303ce5db0e90           "etcd --advertise-cl"   15 hours ago
efb620d9f59a        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
f723dce3ac9d        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
89d58b537cae        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
d05cf6dbe82a        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Running docker-env by itself prints out how the command should be executed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here it is telling us how to run it</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Now we actually run it as recommended and change the environment</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>docker ps</code> now lists everything running on the minikube docker daemon</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can build our front-end image and it will be available to minikube:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; docker build -t front-end:v1 ./front-end
Sending build context to Docker daemon  9.728kB
Step 1/6 : FROM python
latest: Pulling from library/python
7e2b2a5af8f6: Pull complete
09b6f03ffac4: Pull complete
dc3f0c679f0f: Pull complete
fd4b47407fc3: Pull complete
b32f6bf7d96d: Pull complete
3940e1b57073: Pull complete
ce1fce2a6cf9: Pull complete
1f593157bb4c: Pull complete
bde1ccd8f1b8: Pull complete
Digest: sha256:3df040cc8e804b731a9e98c82e2bc5cf3c979d78288c28df4f54bbdc18dbb521
Status: Downloaded newer image for python:latest
 ---&gt; b55669b4130e
Step 2/6 : COPY . /app
 ---&gt; b88600cc635a
Step 3/6 : WORKDIR /app
 ---&gt; Running in 20bc72069ed8
Removing intermediate container 20bc72069ed8
 ---&gt; 61eb3608a02a
Step 4/6 : RUN pip install -r requirements.txt
 ---&gt; Running in da9520ffee48
Collecting Flask
  Downloading Flask-1.1.2-py2.py3-none-any.whl (94 kB)
Collecting pika
  Downloading pika-1.1.0-py2.py3-none-any.whl (148 kB)
Collecting itsdangerous&gt;=0.24
  Downloading itsdangerous-1.1.0-py2.py3-none-any.whl (16 kB)
Collecting Werkzeug&gt;=0.15
  Downloading Werkzeug-1.0.1-py2.py3-none-any.whl (298 kB)
Collecting click&gt;=5.1
  Downloading click-7.1.1-py2.py3-none-any.whl (82 kB)
Collecting Jinja2&gt;=2.10.1
  Downloading Jinja2-2.11.2-py2.py3-none-any.whl (125 kB)
Collecting MarkupSafe&gt;=0.23
  Downloading MarkupSafe-1.1.1-cp38-cp38-manylinux1_x86_64.whl (32 kB)
Installing collected packages: itsdangerous, Werkzeug, click, MarkupSafe, Jinja2, Flask, pika
Successfully installed Flask-1.1.2 Jinja2-2.11.2 MarkupSafe-1.1.1 Werkzeug-1.0.1 click-7.1.1 itsdangerous-1.1.0 pika-1.1.0
Removing intermediate container da9520ffee48
 ---&gt; 8d2f4da8b8b4
Step 5/6 : ENV FLASK_APP=app.py
 ---&gt; Running in 4cdf7ad5a96e
Removing intermediate container 4cdf7ad5a96e
 ---&gt; 4b5853571124
Step 6/6 : CMD ["flask", "run", "--host=0.0.0.0"]
 ---&gt; Running in ff512bc5e42b
Removing intermediate container ff512bc5e42b
 ---&gt; 52ec5d015433
Successfully built 52ec5d015433
Successfully tagged front-end:v1</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure you give your image a tag with a version ("v1" in our
example). Kubernetes will automatically try to pull the "latest" version
for untagged images and since we are not using a Docker image repository
that pull will fail.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_service">10.3.3. Service</h4>
<div class="paragraph">
<p>Let&#8217;s take a look at our <strong>Service</strong> definition:</p>
</div>
<div class="listingblock">
<div class="title">example-final/front-end-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="YAML" class="language-YAML hljs">---
apiVersion: v1
kind: Service
metadata:
  name: front-end
  labels:
    app: front-end
spec:
  type: LoadBalancer
  selector:
    app: front-end
  ports:
    - name: http
      protocol: TCP
      port: 5000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only new thing in this definition is <code>type: LoadBalancer</code> in the <code>spec</code>.
This allows us to access this service externally. It is worth noting that in a
real-life scenario, this will create a load balancer with an external IP via
your IaaS provider. These cost money and it can add up as you expose more
services to the outside world. Fortunately, as explained in the previous
<a href="#_kubernetes_3">Kubernetes</a> section, we can still use minikube to test externally connecting
to our service with the <code>minikube service</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deployment">10.3.4. Deployment</h4>
<div class="paragraph">
<p>For <strong>Front End</strong> we can use a simple deployment:</p>
</div>
<div class="listingblock">
<div class="title">example-final/front-end-k8s.yml (excerpted)</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yml" class="language-yml hljs">---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: front-end
  labels:
    app: front-end
spec:
  replicas: 3
  selector:
    matchLabels:
      app: front-end
  template:
    metadata:
      labels:
        app: front-end
    spec:
      containers:
        - name: front-end
          image: front-end:v1
          env:
            - name: RABBITMQ_DEFAULT_USER
              value: "guest"
            - name: RABBITMQ_DEFAULT_PASS
              value: "guest"
            - name: FLASK_SECRET_KEY
              value: "changeme"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_example_3">10.3.5. Running the Example</h4>
<div class="paragraph">
<p>Now let&#8217;s apply both <strong>Messaging</strong> and <strong>Front End</strong>. This will let us check to see
if the <strong>Front End</strong> serves web pages <em>and</em> if the <strong>Front End</strong> can connect to
<strong>Messaging</strong> and create queues. We won&#8217;t be able to login / register users
entirely yet because we don&#8217;t have <strong>Back End</strong> running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS example-final&gt; kubectl apply -f messaging-k8s.yml -f front-end-k8s.yml <i class="conum" data-value="1"></i><b>(1)</b>
serviceaccount/messaging created
role.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
rolebinding.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
configmap/rabbitmq-config created
service/messaging created
statefulset.apps/messaging created
service/front-end created
deployment.apps/front-end created
PS example-final&gt; kubectl get pod <i class="conum" data-value="2"></i><b>(2)</b>
NAME                         READY   STATUS    RESTARTS   AGE
front-end-7f7c4f5455-6qbcx   1/1     Running   0          4h46m
front-end-7f7c4f5455-htdlv   1/1     Running   0          4h46m
front-end-7f7c4f5455-q2nn6   1/1     Running   0          4h46m
messaging-0                  1/1     Running   0          16m
messaging-1                  1/1     Running   0          16m
messaging-2                  1/1     Running   0          16m
PS example-final&gt; minikube service front-end <i class="conum" data-value="3"></i><b>(3)</b>
|-----------|-----------|-------------|----------------------------|
| NAMESPACE |   NAME    | TARGET PORT |            URL             |
|-----------|-----------|-------------|----------------------------|
| default   | front-end | http/5000   | http://192.168.135.5:31232 |
|-----------|-----------|-------------|----------------------------|
* Opening service default/front-end in default browser...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>kubectl apply</code> command can be used with multiple files or all YAML
files in a directory. Here we specify the two components we want to start.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After a little while, you should see six pods running: three for
<strong>Messaging</strong> and three for <strong>Front End</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This command will start the default browser and pass it the URL to the
front-end <strong>Service</strong>. If you just want the URL instead of having it open the
browser you can use <code>kubectl service --url front-end</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you apply the objects, run the <code>kubectl get pod</code> command, and see
<code>ErrImagePull</code> or <code>ImagePullBackOff</code> it means that Kubernetes can&#8217;t pull your
Docker images. Either you&#8217;ve misnamed a stock image that in the <code>name</code>
attribute of your container, or you are trying to use a custom image that
you did not make available to minikube. See <a href="#_building_the_docker_image">Building the Docker Image</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If your connections are timing out with the <code>minikube service</code> command
and you are using the minikube <code>docker</code> driver, try with <code>hyperv</code> or
<code>virtualbox</code>. The <code>docker</code> driver seems to have some issues with port
forwarding.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We see our <strong>Front End</strong> website in our default browser. If we try to register
a user we get a message saying "No response from back end."</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to test things quickly, without opening a browser the
<a href="https://curl.haxx.se/">curl</a> command is a great thing to know. In PowerShell
curl is an alias to Invoke-WebRequest, but it will still work for simple
testing. Try <code>curl $(minikube service --url front-end)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s run a shell in our RabbitMQ cluster and use the <code>rabbitmqctl</code> command
to verify that a <code>requests</code> queue has actually been created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">PS C:\Users\rxt1077\it490\example-final&gt; kubectl exec -it messaging-0 -- bash <i class="conum" data-value="1"></i><b>(1)</b>
root@messaging-0:/# rabbitmqctl list_queues
Timeout: 60.0 seconds ...
Listing queues for vhost / ...
name    messages
request 1 <i class="conum" data-value="2"></i><b>(2)</b>
root@messaging-0:/# exit
exit</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It doesn&#8217;t matter which node we run a shell on, they should all be able to
see all queues. I chose <code>messaging-0</code> because it is easy to remember.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>There is a request queue, with one message in it.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_questions_6">10.4. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>Why is it easier to set up <strong>Front End</strong> in Kubernetes than it is to set up <strong>Messaging</strong>?</em></p>
<p></p>
</li>
<li>
<p><em>What does a LoadBalancer type <strong>Service</strong> do?</em></p>
<p></p>
</li>
<li>
<p><em>When creating custom images for use with minikube, why do you have to set up your Docker environment variables before building images?</em></p>
<p></p>
</li>
<li>
<p><em>How do you make a <strong>Service</strong> accessible from outside the Kubernetes cluster?</em></p>
<p></p>
</li>
<li>
<p><em>If you wanted to use the RabbitMQ web-based admin interface for testing, what would you have to do to access it?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_back_end_in_kubernetes">11. Back End in Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last key to our Kubernetes migration is a functioning <strong>Back End</strong>. In this
section we will build the Kubernetes objects needed to support this role.</p>
</div>
<div class="sect2">
<h3 id="_introduction_4">11.1. Introduction</h3>
<div class="paragraph">
<p><strong>Back End</strong> is our conduit between <strong>Messaging</strong> and <strong>Database</strong> and we have
implemented it as a Python script. Replicas of <strong>Back End</strong> can function
independently since messages can only be pulled off the queue one-at-a-time,
they are removed after they are pulled, and an exclusive response queue is
created for the response:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/backend-arch.svg" alt="backend arch" width="407" height="491">
</div>
<div class="title">Figure 9. <strong>Back End</strong> Architecture</div>
</div>
<div class="paragraph">
<p>In the above diagram two different <strong>Front Ends</strong> are communicating with
<strong>Messaging</strong>. Two different <strong>Back Ends</strong> are pulling requests (FE1, FE2, etc.)
out of the requests queue and processing them. Notice that each <strong>Front End</strong> has
a separate response queue (that can be derived from the message in the requests
queue). This architecture allows multiple <strong>Backends</strong> to run at the same time
without needing to be in communication with eachother.</p>
</div>
</div>
<div class="sect2">
<h3 id="_questions_7">11.2. Questions</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_google_cloud_platform">12. Google Cloud Platform</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will deploy our full system on Google Cloud Platform to see
what the differences between our production and development environments are.</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. If you&#8217;re looking to take things a bit further <a href="https://asciidoctor.org/docs/asciidoc-writers-guide/">asciidoc</a>, <a href="https://docutils.sourceforge.io/rst.html">reStructuredText</a>, and <a href="https://docs.racket-lang.org/scribble/">scribble</a> are worth exploring too. This book is written in asciidoc.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Eventually we will want things to be more scalable than just a static, three node cluster.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://medium.com/@maumribeiro/running-your-own-docker-images-in-minikube-for-windows-ea7383d931f6"> See this great blog post for more details</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://platform9.com/blog/tutorial-dynamic-provisioning-of-persistent-storage-in-kubernetes-with-minikube"> The fascinating details of how this works are revealed in this blog post.</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-04-24 16:09:13 -0400
</div>
</div>
<link rel="stylesheet" href="highlight/styles/github.min.css">
<script src="highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>