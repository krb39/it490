<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Ryan Tolboom">
<title>Systems Integration: A Project Based Approach</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Systems Integration: A Project Based Approach</h1>
<div class="details">
<span id="author" class="author">Ryan Tolboom</span><br>
<span id="email" class="email"><a href="mailto:Ryan.Tolboom@njit.edu">Ryan.Tolboom@njit.edu</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_colophon">Colophon</a></li>
<li><a href="#_legal">Legal</a></li>
<li><a href="#_preface">Preface</a></li>
<li><a href="#_acknowledgements">Acknowledgements</a></li>
<li><a href="#_project">Project</a>
<ul class="sectlevel2">
<li><a href="#_project_proposal">Project Proposal</a></li>
<li><a href="#_milestones">Milestones</a></li>
<li><a href="#_deliverables">Deliverables</a></li>
</ul>
</li>
<li><a href="#git">1. Git</a>
<ul class="sectlevel2">
<li><a href="#_version_control">1.1. Version Control</a></li>
<li><a href="#_installation">1.2. Installation</a></li>
<li><a href="#_basic_git_actions">1.3. Basic Git Actions</a></li>
<li><a href="#_example">1.4. Example</a></li>
<li><a href="#_resources">1.5. Resources</a></li>
<li><a href="#_questions">1.6. Questions</a></li>
</ul>
</li>
<li><a href="#_github">2. GitHub</a>
<ul class="sectlevel2">
<li><a href="#_purpose">2.1. Purpose</a></li>
<li><a href="#_remote_repositories">2.2. Remote Repositories</a></li>
<li><a href="#_issues">2.3. Issues</a></li>
<li><a href="#_pull_requests">2.4. Pull requests</a></li>
<li><a href="#_documentation">2.5. Documentation</a></li>
<li><a href="#_resources_2">2.6. Resources</a></li>
<li><a href="#_questions_2">2.7. Questions</a></li>
</ul>
</li>
<li><a href="#_yaml">3. YAML</a>
<ul class="sectlevel2">
<li><a href="#_introduction">3.1. Introduction</a></li>
<li><a href="#_parts_of_a_yaml_stream">3.2. Parts of a YAML Stream</a></li>
<li><a href="#_editors">3.3. Editors</a></li>
<li><a href="#_resources_3">3.4. Resources</a></li>
<li><a href="#_questions_3">3.5. Questions</a></li>
</ul>
</li>
<li><a href="#_docker">4. Docker</a>
<ul class="sectlevel2">
<li><a href="#_purpose_2">4.1. Purpose</a></li>
<li><a href="#_installation_2">4.2. Installation</a></li>
<li><a href="#_concepts">4.3. Concepts</a></li>
<li><a href="#_commands">4.4. Commands</a></li>
<li><a href="#_examples">4.5. Examples</a></li>
<li><a href="#_resources_4">4.6. Resources</a></li>
<li><a href="#_questions_4">4.7. Questions</a></li>
</ul>
</li>
<li><a href="#_messaging">5. Messaging</a>
<ul class="sectlevel2">
<li><a href="#_purpose_3">5.1. Purpose</a></li>
<li><a href="#_frameworks">5.2. Frameworks</a></li>
<li><a href="#_rabbitmq_and_docker">5.3. RabbitMQ and Docker</a></li>
<li><a href="#_resources_5">5.4. Resources</a></li>
<li><a href="#_questions_5">5.5. Questions</a></li>
</ul>
</li>
<li><a href="#_database">6. Database</a>
<ul class="sectlevel2">
<li><a href="#_introduction_2">6.1. Introduction</a></li>
<li><a href="#_popular_rdms">6.2. Popular RDMS</a></li>
<li><a href="#_example_2">6.3. Example</a></li>
<li><a href="#_resources_6">6.4. Resources</a></li>
<li><a href="#_questions_6">6.5. Questions</a></li>
</ul>
</li>
<li><a href="#_front_end">7. Front End</a>
<ul class="sectlevel2">
<li><a href="#_introduction_3">7.1. Introduction</a></li>
<li><a href="#_example_3">7.2. Example</a></li>
<li><a href="#_resources_7">7.3. Resources</a></li>
<li><a href="#_questions_7">7.4. Questions</a></li>
</ul>
</li>
<li><a href="#_back_end">8. Back End</a>
<ul class="sectlevel2">
<li><a href="#_introduction_4">8.1. Introduction</a></li>
<li><a href="#_example_4">8.2. Example</a></li>
<li><a href="#_resources_8">8.3. Resources</a></li>
<li><a href="#_questions_8">8.4. Questions</a></li>
</ul>
</li>
<li><a href="#_midterm_example">9. Midterm Example</a>
<ul class="sectlevel2">
<li><a href="#_introduction_5">9.1. Introduction</a></li>
<li><a href="#_messaging_2">9.2. Messaging</a></li>
<li><a href="#_database_2">9.3. Database</a></li>
<li><a href="#_back_end_2">9.4. Back End</a></li>
<li><a href="#_front_end_2">9.5. Front End</a></li>
<li><a href="#_questions_9">9.6. Questions</a></li>
</ul>
</li>
<li><a href="#_replication">10. Replication</a>
<ul class="sectlevel2">
<li><a href="#_background">10.1. Background</a></li>
<li><a href="#_implementation">10.2. Implementation</a></li>
<li><a href="#_high_availability">10.3. High Availability</a></li>
<li><a href="#_load_balancing">10.4. Load Balancing</a></li>
<li><a href="#_questions_10">10.5. Questions</a></li>
</ul>
</li>
<li><a href="#_kubernetes">11. Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_6">11.1. Introduction</a></li>
<li><a href="#_minikube">11.2. Minikube</a></li>
<li><a href="#_debugging">11.3. Debugging</a></li>
<li><a href="#_conclusion">11.4. Conclusion</a></li>
<li><a href="#_questions_11">11.5. Questions</a></li>
</ul>
</li>
<li><a href="#_database_in_kubernetes">12. Database in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_7">12.1. Introduction</a></li>
<li><a href="#_persistentvolumeclaims">12.2. PersistentVolumeClaims</a></li>
<li><a href="#_services">12.3. Services</a></li>
<li><a href="#_deployments">12.4. Deployments</a></li>
<li><a href="#_running_the_example">12.5. Running the Example</a></li>
<li><a href="#_conclusion_2">12.6. Conclusion</a></li>
<li><a href="#_questions_12">12.7. Questions</a></li>
</ul>
</li>
<li><a href="#_messaging_in_kubernetes">13. Messaging in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_8">13.1. Introduction</a></li>
<li><a href="#_rabbitmq">13.2. RabbitMQ</a></li>
<li><a href="#_kubernetes_2">13.3. Kubernetes</a></li>
<li><a href="#_example_5">13.4. Example</a></li>
<li><a href="#_resources_9">13.5. Resources</a></li>
<li><a href="#_questions_13">13.6. Questions</a></li>
</ul>
</li>
<li><a href="#_front_end_in_kubernetes">14. Front End in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_9">14.1. Introduction</a></li>
<li><a href="#_kubernetes_3">14.2. Kubernetes</a></li>
<li><a href="#_example_6">14.3. Example</a></li>
<li><a href="#_questions_14">14.4. Questions</a></li>
</ul>
</li>
<li><a href="#_back_end_in_kubernetes">15. Back End in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_introduction_10">15.1. Introduction</a></li>
<li><a href="#_example_7">15.2. Example</a></li>
<li><a href="#_questions_15">15.3. Questions</a></li>
</ul>
</li>
<li><a href="#_google_kubernetes_engine">16. Google Kubernetes Engine</a>
<ul class="sectlevel2">
<li><a href="#_introduction_11">16.1. Introduction</a></li>
<li><a href="#_setting_up_gcloud">16.2. Setting up gcloud</a></li>
<li><a href="#_pushing_images">16.3. Pushing Images</a></li>
<li><a href="#_creating_objects">16.4. Creating Objects</a></li>
<li><a href="#_cleaning_up">16.5. Cleaning Up</a></li>
<li><a href="#_resources_10">16.6. Resources</a></li>
<li><a href="#_questions_16">16.7. Questions</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/containers.jpg" alt="containers" width="50%">
</div>
</div>
<div class="paragraph text-center">
<p>eBook versions: <a href="systems-integration.epub">ePub</a> |
 <a href="systems-integration.mobi">mobi</a> |
 <a href="systems-integration.pdf">pdf</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_colophon">Colophon</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Test test test</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_legal">Legal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This work is licensed under a
<a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons
Attribution-ShareAlike 4.0 International License.</a></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/cc.png" alt="Creative Commons License"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of this text is to provide a practical introduction to systems
integration by designing and implementing an actual system. In accordance with
the show-me-the-code attitude of the open source software movement, all of the
code for the text and examples are available at
<a href="https://github.com/rxt1077/it490" class="bare">https://github.com/rxt1077/it490</a>. The philosophy of this text can probably best
be summed up in a quote:</p>
</div>
<div class="quoteblock">
<blockquote>
Knowledge isn&#8217;t power until it&#8217;s applied.
</blockquote>
<div class="attribution">
&#8212; Dale Carnegie
</div>
</div>
<div class="paragraph">
<p>A computer that meets <a href="https://ist.njit.edu/fall-2020-recommended-specs/">these</a>
minimum specifications will be required to complete the coursework.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_acknowledgements">Acknowledgements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The author would like to acknowledge the hard work of DJ Kehoe, whose devotion
to the success of his students led him to create a rigorous, project-based
Systems Integration course. Without his work, none of this would be possible.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project">Project</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/all.png" alt="all" width="25%">
</div>
</div>
<div class="paragraph">
<p>This text is meant to accompany the creation of a group project. The project is
designed to be completed by a four person group over a 15 week semester. If you
are using this text as part of a course, all parts of this section are subject
to change / augmentation by your instructor. If you are using this text as an
independent, self-study tool you should still be able to complete all of the
milestones and create the deliverables although it may take you longer. What
follows is the typical assignment schedule for developing the project:</p>
</div>
<div class="sect2">
<h3 id="_project_proposal">Project Proposal</h3>
<div class="paragraph">
<p>The project proposal and the comments on it function as a record of dialog
between the instructor and the group. You can think of the proposal as a
contract showing what is required to achieve a good grade on the project. The
instructor may specify additional deliverables depending on what your group has
chosen to work on, or they may walk-back your proposal if they believe it is
too difficult to achieve in the time frame.</p>
</div>
<div class="sect3">
<h4 id="_developing_a_proposal">Developing a Proposal</h4>
<div class="paragraph">
<p>Think of a data source that you can use to create a marketable software as a
service (SaaS) product. This data source needs to be freely available for the
purposes of this project. Use the following questions to guide your proposal:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What data will you use?</p>
</li>
<li>
<p>What service will you offer with this data?</p>
</li>
<li>
<p>Why would people be willing to pay money for your service?</p>
</li>
<li>
<p>Who would be willing to pay money for your service?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example that you can <em>not</em> use:</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Project Proposal</div>
<div class="content">
<div class="paragraph">
<p>My group will design a web app that allows people in New Jersey to create
itineraries for upcoming events based on what the weather is. We will use data
from <a href="https://openweathermaps.org">OpenWeatherMaps.org</a> as well
<a href="https://www.nj.com">NJ.com</a> to plan separate events based on how filled people
want their schedule and what the weather is going to be like. Our target
demographic is busy professionals who are comfortable using technology. Since
they already use services like Google Calendar for keeping track of their
events, why not try using a service that will suggest upcoming events?</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_milestones">Milestones</h3>
<div class="paragraph">
<p>The goal of the milestones are to encourage group members to keep pace with the
project. This is not the kind of project that can be completed in the last week
of class. All milestones should be entered in GitHub and linked with Issues
assigned to specific members of the group. Individual contributions of group
members will be assessed through GitHub activity so be sure you are actively
participating.</p>
</div>
<div class="sect3">
<h4 id="_one">One</h4>
<div class="ulist">
<ul>
<li>
<p>Form a group of four members.</p>
</li>
<li>
<p>Each member of the group should read the <a href="#git">Git</a>, <a href="#_github">GitHub</a>, <a href="#_yaml">YAML</a>, and
<a href="#_docker">Docker</a> chapters.</p>
</li>
<li>
<p>Each member of the group should have Docker up and running on their machine.</p>
</li>
<li>
<p>Each member of the group should have a GitHub login that utilizes their school
email.</p>
</li>
<li>
<p>As a group, design and submit a <a href="#_project_proposal">Project Proposal</a>.</p>
</li>
<li>
<p>As a group, create a GitHub project with all of the members as collaborators.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_two">Two</h4>
<div class="ulist">
<ul>
<li>
<p>Each member of the group should read the <a href="#_messaging">Messaging</a>, <a href="#_database">Database</a>,
<a href="#_front_end">Front End</a>, and <a href="#_back_end">Back End</a> chapters.</p>
</li>
<li>
<p>As a group, create a <code>docker-compose.yml</code> file in your group repository that
brings up a messaging service, database service, front end service, and back
end service.</p>
</li>
<li>
<p><strong>Front End</strong> should at least have at a "Hello World" page available a port
accessible from the local host.</p>
</li>
<li>
<p><strong>Back End</strong> should be able to read from and write to a queue on <strong>Messaging</strong>.</p>
</li>
<li>
<p>The completion of this milestone should be documented through the use of
Issues in your GitHub project.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_three">Three</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Back End</strong> should be able to read and write from <strong>Database</strong>.</p>
</li>
<li>
<p><strong>Front End</strong> should have a register new user page and a login page. They do not
have to be functional, but the HTML development should be done.</p>
</li>
<li>
<p><strong>Database</strong> should at least have a <code>user</code> table on a persistent volume that can
be accessed by <strong>Back End</strong>.</p>
</li>
<li>
<p>Documentation should be developed that describes how to use the RabbitMQ
management interface to check to see if queues are being created. The
documentation should take the form of a README file in any GitHub supported
format within the messaging directory.</p>
</li>
<li>
<p>The completion of this milestone should be documented through the use of
Issues in your GitHub project.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_four">Four</h4>
<div class="ulist">
<ul>
<li>
<p>Each member of the group should read the <a href="#_replication">Replication</a> and <a href="#_kubernetes">Kubernetes</a>
chapters.</p>
</li>
<li>
<p>Each member of the group needs to have minikube up and running on their
machine.</p>
</li>
<li>
<p><strong>Database</strong> needs to move from a single instance to a replicated, high
availability, load balancing cluster. For now, the instances can be statically
configured inside a <code>docker-compose.yml</code> file.</p>
</li>
<li>
<p>The completion of this milestone should be documented through the use of
Issues in your GitHub project.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_five">Five</h4>
<div class="ulist">
<ul>
<li>
<p>Each member of the group should read the <a href="#_database_in_kubernetes">Database in Kubernetes</a> and
<a href="#_messaging_in_kubernetes">Messaging in Kubernetes</a> chapters.</p>
</li>
<li>
<p>Migrate <strong>Database</strong> to Kubernetes using the minikube environment. Put all of
your Kubernetes objects in one file named &lt;component&gt;-k8s.yml in your
repository (where &lt;component&gt; is your component name.</p>
</li>
<li>
<p>Migrate <strong>Messaging</strong> to Kubernetes using the minikube environment. Put all of
your Kubernetes objects in one file named &lt;component&gt;-k8s.yml in your
repository (where &lt;component&gt; is your component name.</p>
</li>
<li>
<p>The completion of this milestone should be documented through the use of
Issues in your GitHub project.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_six">Six</h4>
<div class="ulist">
<ul>
<li>
<p>Each member of the group should read the <a href="#_front_end_in_kubernetes">Front End in Kubernetes</a> and
<a href="#_back_end_in_kubernetes">Back End in Kubernetes</a> chapters.</p>
</li>
<li>
<p>Migrate <strong>Front End</strong> to Kubernetes using the minikube environment. Put all of
your Kubernetes objects in one file named &lt;component&gt;-k8s.yml in your
repository (where &lt;component&gt; is your component name.</p>
</li>
<li>
<p>Migrate <strong>Back End</strong> to Kubernetes using the minikube environment. Put all of
your Kubernetes objects in one file named &lt;component&gt;-k8s.yml in your
repository (where &lt;component&gt; is your component name.</p>
</li>
<li>
<p>The completion of this milestone should be documented through the use of
Issues in your GitHub project.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deliverables">Deliverables</h3>
<div class="paragraph">
<p>Deliverables are larger assessments designed to show a running system. Given
deployment-centric nature of the project, it should be easy to bring up the
deliverables on any system to test them. Groups are encouraged to test running
their system on new a different machines to make sure that everything will go
well when it is time to assess their project. Groups are also encouraged and
<em>expected</em> to keep the deliverables in mind over the course of the entire
project.</p>
</div>
<div class="sect3">
<h4 id="_midterm">Midterm</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Front End</strong> (Python, PHP, or Node) interacts with the user via HTTP and
communicates with <strong>Messaging</strong> via a messaging library.</p>
</li>
<li>
<p><strong>Messaging</strong> (RabbitMQ) brokers the exchange of information between <strong>Front End</strong>
and <strong>Back End</strong>.</p>
</li>
<li>
<p><strong>Database</strong> (PostgreSQL, MariaDB, or MySQL) is used by <strong>Back End</strong> uses for the
storage of persistent information. All database files are stored in a Docker
volume.</p>
</li>
<li>
<p><strong>Back End</strong> container that gathers information from your data sources, stores
information on <strong>Database</strong>, and interacts with <strong>Messaging</strong>.</p>
</li>
<li>
<p>These four services will be working with each other to provide a registration
and authentication system for your users.</p>
</li>
<li>
<p>The project should be fully testable on any machine running Docker by simply
cloning the git repository and running <code>docker up</code> in the root of the project.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_final">Final</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Front End</strong>, <strong>Database</strong>, <strong>Messaging</strong>, and <strong>Back End</strong> should all be running in
pods on the minikube Kubernetes Cluster. Each should have three replicas.</p>
</li>
<li>
<p><strong>Front End</strong>, <strong>Database</strong>, <strong>Messaging</strong>, and <strong>Back End</strong> should all be able to
scale horizontally and recover from the failure of pods.</p>
</li>
<li>
<p>The project should be fully testable on any machine running minikube by simply
cloning the git repository and running, building the custom images locally
(with an environment configured for the Docker daemon running <em>within</em>
minikube), and running <code>kubectl apply -f .</code> in the root of the project.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="git">1. Git</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/git.png" alt="git" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_version_control">1.1. Version Control</h3>
<div class="paragraph">
<p>In the simplest sense, version control tracks changes to a group of files.
Building off of this premise, teams can use version control to cooperatively
change a group of files and revert to a previous state if needed.</p>
</div>
<div class="paragraph">
<p>The benefits of a version control system can be more readily understood if you
consider a few examples:</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Programming Project</div>
<div class="content">
<div class="paragraph">
<p>You are working on a project for your CS101 class and you need to write a
Python program that plays tic-tac-toe. It must support player-vs-computer
<em>and</em> player-vs-player. It&#8217;s due in two days. On the first day you write the
initial code and implement player-vs-player. It works great and you fall asleep
knowing tomorrow you will finish it and turn it in on time. The next morning
you update it to support player-vs-computer and <em>everything</em> stops working.
What do you do now?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you were working with a version control system, you could easily roll-back
your changes and see what went wrong.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Working with a Team</div>
<div class="content">
<div class="paragraph">
<p>You are working working with a team of people to implement a complex system
that utilizes several files in several different directories. How do you make
sure everyone has the most up-to-date version of the files? What happens if two
people work on the same file at the same time?</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In a version control system, you could set up a centralized repository for the
files and have everyone pull from one location. In the case of two people
working on the same thing at the same time, a version control system could
handle merging their changes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation">1.2. Installation</h3>
<div class="paragraph">
<p>Depending on the OS you are using, there are a few different ways to install
git on your machine:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Windows</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://gitforwindows.org/">git for windows</a>: Installs git, git BASH, and a
GUI. The git command can then be run from PowerShell, CMD, or the BASH shell
(which it installs).</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Mac</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://sourceforge.net/projects/git-osx-installer/files/">git for Mac Installer</a>:
Provides an easy installer for git on MacOS.</p>
</li>
<li>
<p><a href="https://developer.apple.com/xcode/">Xcode</a>: Xcode installs a command line git
and you may have it installed already.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Linux</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Basically all distributions have git available in their standard package
manager. Chances are, if you&#8217;re running Linux you have it installed already,
so I&#8217;ll take the opportunity to highlight the strangest distro I can think of:
You can install git in <a href="http://hannahmontana.sourceforge.net/">Hannah Montana
Linux</a> with the command <code>apt-get install git</code>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_basic_git_actions">1.3. Basic Git Actions</h3>
<div class="sect3">
<h4 id="_creating_a_repository">1.3.1. Creating a Repository</h4>
<div class="paragraph">
<p>Any directory can be made into a git repository by running the <code>git init</code>
command. This will add the <code>.git</code> directory which stores information about the
state of the repository and certain user variables.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cloning_a_repository">1.3.2. Cloning a Repository</h4>
<div class="paragraph">
<p>If you want to make a copy of an already existing repository, typically done
when you <em>start</em> working on a project, the <code>git clone</code> command will make a copy
of a repository using any supported protocol.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tracking_staging_files">1.3.3. Tracking / Staging Files</h4>
<div class="paragraph">
<p>You need to tell git which files you want to keep track of and when you want to
stage them to be committed. These both use the same command <code>git add</code>. The
first time you call <code>git add</code> it begins tracking the file and stages it for a
commit. The second time you call <code>git add</code> it tells git that you want to commit
any changes to that file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_committing_changes_to_a_repository">1.3.4. Committing Changes to a Repository</h4>
<div class="paragraph">
<p>Once you have made some changes to your repository and staged those files with
<code>git add</code> you can use the <code>git commit</code> command to <em>commit</em> your changes. All
commits must have a message, and git will use a default editor depending on
your installation.
<a href="https://help.github.com/en/github/using-git/associating-text-editors-with-git">
This can be changed.</a> To complete the commit, add a message, save the file, and
exit the editor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_a_remote">1.3.5. Setting Up a Remote</h4>
<div class="paragraph">
<p>Git repositories are often linked to a remote repository. This could be a
service, like <a href="https://github.com">GitHub</a>, <a href="https://gitlab.com">GitLab</a>, or
<a href="https://sr.ht">SourceHut</a> or more simply another server that the team has
access to. The <code>git remote add origin</code> command adds a remote URL that is the
default target for actions. You can then <code>git push</code> your changes to the remote
or <code>git pull</code> to get the latest changes from the remote. The <code>git clone</code>
command automatically sets the origin.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example">1.4. Example</h3>
<div class="paragraph">
<p>Let&#8217;s take a look at an example of two people, Jessica and Darsh, working with
the same remote repository:</p>
</div>
<div class="listingblock">
<div class="title">Jessica&#8217;s First Session (PowerShell)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS jess&gt;</span><span class="w"> </span><span class="nb">mkdir </span>example <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">

    Directory: jess


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        4/22/2020  10:02 PM                example


</span><span class="gp">PS jess&gt;</span><span class="w"> </span><span class="nb">cd </span>example
<span class="gp">PS jess\example&gt;</span><span class="w"> </span>git init <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">Initialized empty Git repository in jess/example/.git/
</span><span class="gp">PS jess\example&gt;</span><span class="w"> </span>Set-Content <span class="nt">-Path</span> <span class="s1">'test.txt'</span> <span class="nt">-Value</span> <span class="s1">'Hello from git!'</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="gp">PS jess\example&gt;</span><span class="w"> </span>git add <span class="nb">.</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="gp">PS jess\example&gt;</span><span class="w"> </span>git commit <span class="nt">-m</span> <span class="s2">"Initial Commit"</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="go">[master (root-commit) 46c7c75] Initial Commit
 1 file changed, 0 insertions(+), 0 deletions(-)
 create mode 100644 test.txt
</span><span class="gp">PS jess\example&gt;</span><span class="w"> </span>git remote add origin ssh://git@192.168.10.1/home/git/example.git <i class="conum" data-value="6"></i><b>(6)</b>
<span class="gp">PS jess\example&gt;</span><span class="w"> </span>git push origin master <i class="conum" data-value="7"></i><b>(7)</b>
<span class="go">git@192.168.10.1's password:
Enumerating objects: 3, done.
Counting objects: 100% (3/3), done.
Writing objects: 100% (3/3), 249 bytes | 249.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To ssh://192.168.10.1/home/git/example.git
</span><span class="gp"> * [new branch]      master -&gt;</span><span class="w"> </span>master</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Jessica will be creating the repository, so she makes a new directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inside the directory, she uses <code>git init</code> to initialize it</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/set-content?view=powershell-7">
She adds some content so she has something to commit</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The form <code>git add .</code> means <em>stage all files in this directory</em>. It is the
most common invocation of <code>git add</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Jessica commits her work. The <code>-m</code> option allows her to add a commit
message without needing to open an editor.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>She adds a remote as the default. This <em>does</em> require configuration on the
remote server, a local machine in our case, but we will talk about how that is
usually handled in the <a href="#_github">GitHub</a> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Finally she pushes her changes to the remote so that Darsh can get them.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Darsh&#8217;s Session (BASH)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">darsh@laptop:~$</span><span class="w"> </span>git clone ssh://git@192.168.10.1:/home/git/example.git <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">Cloning into 'example'...
remote: Enumerating objects: 3, done.
remote: Counting objects: 100% (3/3), done.
remote: Total 3 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (3/3), done.
</span><span class="gp">darsh@laptop:~$</span><span class="w"> </span><span class="nb">cd </span>example <i class="conum" data-value="2"></i><b>(2)</b>
<span class="gp">darsh@laptop:~/example$</span><span class="w"> </span><span class="nb">cat </span>test.txt
<span class="go">Hello from git! <i class="conum" data-value="3"></i><b>(3)</b>
</span><span class="gp">darsh@laptop:~/example$</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"Hello Jess!"</span> <span class="o">&gt;&gt;</span> test.txt <i class="conum" data-value="4"></i><b>(4)</b>
<span class="gp">darsh@laptop:~/example$</span><span class="w"> </span>git add <span class="nb">.</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="gp">darsh@laptop:~/example$</span><span class="w"> </span>git commit <span class="nt">-m</span> <span class="s2">"Added my message"</span>
<span class="go">[master 55dc946] Added my message
 1 file changed, 1 insertion(+)
</span><span class="gp">darsh@laptop:~/example$</span><span class="w"> </span>git push
<span class="go">Counting objects: 3, done.
Writing objects: 100% (3/3), 271 bytes | 271.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To ssh://192.168.10.1:/home/git/example.git
</span><span class="gp">   182a481..55dc946  master -&gt;</span><span class="w"> </span>master</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Darsh isn&#8217;t creating a new repository so he uses the <code>git clone</code> command to
clone the repository Jessica has made.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default, cloned repositories are put in their own directory based on the
repository name. You can specify a different directory by adding an argument
after the URL: <code>git clone ssh://git@192.168.10.1:/home/git/example.git
new-directory</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Jess&#8217;s content is there!</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Darsh appends a message of his own.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Then he follows the standard add, commit, push work flow to sync his
changes.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Jessica&#8217;s Second Session (PowerShell)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS jess\example&gt;</span><span class="w"> </span>Get-Content <span class="nt">-Path</span> <span class="s1">'test.txt'</span>
<span class="go">Hello from git! <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="gp">PS jess\example&gt;</span><span class="w"> </span>git pull origin master <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">git@192.168.10.1's password:
From ssh://192.168.10.1/home/git/example
</span><span class="gp"> * branch            master     -&gt;</span><span class="w"> </span>FETCH_HEAD
<span class="go">Updating 182a481..55dc946
Fast-forward
 test.txt | 1 +
 1 file changed, 1 insertion(+)
</span><span class="gp">PS jess\example&gt;</span><span class="w"> </span>Get-Content <span class="nt">-Path</span> <span class="s1">'test.txt'</span>
<span class="go">Hello from git! <i class="conum" data-value="3"></i><b>(3)</b>
Hello Jess!</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When Jess goes to check on Darsh&#8217;s work, it isn&#8217;t there! Why?</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Because she hasn&#8217;t pulled from the remote yet.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Once she does, she can see Darsh&#8217;s addition</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This scenario begs the question, "What would happen if Jess didn&#8217;t pull Darsh&#8217;s
work and kept working on her local, unsynced copy?" Assuming they were both
working on the same file, when Jess goes to push there would be a
<a href="https://www.atlassian.com/git/tutorials/using-branches/merge-conflicts">merge
conflict.</a> Git is very good at resolving conflicts and team members tend to be
working on different parts of the codebase, making the resolution simpler.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resources">1.5. Resources</h3>
<div class="ulist">
<ul>
<li>
<p>The entire <a href="https://git-scm.com/book/en/v2">Pro Git Book</a> can be found online.
It is a comprehensive text that will cover much more than the brief outline
presented here.</p>
</li>
<li>
<p>GitHub has some <a href="https://try.github.io">excellent and interactive resources</a>
for learning to use git.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions">1.6. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What are the advantages of using version control?</em></p>
<p></p>
</li>
<li>
<p><em>What does it mean that files are <em>staged</em> for a <em>commit</em>?</em></p>
<p></p>
</li>
<li>
<p><em>What are the two things that the <code>git add</code> command can do?</em></p>
<p></p>
</li>
<li>
<p><em>How do you create a new repository in a directory?</em></p>
<p></p>
</li>
<li>
<p><em>What is a <em>remote</em> and what does the <code>git push</code> command do?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_github">2. GitHub</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/github.svg" alt="github" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_purpose">2.1. Purpose</h3>
<div class="paragraph">
<p><a href="https://github.com">GitHub</a> is a service that provides a space for remote git
repositories. It features an extensive web interface and several project
management features.</p>
</div>
<div class="paragraph">
<p>GitHub has become a popular for open-source projects and is a
<a href="https://pydanny.blogspot.com/2011/08/github-is-my-resume.html">great way</a>
to showcase your projects to prospective employers. It is free to sign up for
GitHub and we will be using it for project management in this course. I suggest
you sign up with your .edu email address and UCID as your username to keep
things simple.</p>
</div>
</div>
<div class="sect2">
<h3 id="_remote_repositories">2.2. Remote Repositories</h3>
<div class="paragraph">
<p>To set up a remote repository in GitHub, follow these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a local git repository as shown in the <a href="#git">previous section</a>.
Choose a repository name that is simple. Avoid spaces or trailing dashes as
Docker Compose may have trouble with them.</p>
</li>
<li>
<p>Sign in to GitHub and navigate to <a href="https://github.com/new">Create a New
Repository</a></p>
</li>
<li>
<p>Put in the your repository name (make sure it matches your local repository
name) and a description.</p>
</li>
<li>
<p>GitHub now offers unlimited private repositories with unlimited
collaborators. This means you could complete your project in a private
repository, just be sure to add your instructor as a collaborator. Later when
you want to showcase your work, it may be a good idea to make this repository
public.</p>
</li>
<li>
<p>You can also work in a public repository and it can be good practice for
learning to separate your secrets from your commits. You will still need to
add group members as collaborators, but your instructor should be able to
have ready-only access without any additional setup.</p>
</li>
<li>
<p>Once you click "Create Repository", instructions will be provided for setting
the remote on your local repository. It is very similar to the scenario
covered in the <a href="#git">previous section</a>. Follow the directions.</p>
</li>
<li>
<p>Now your group members should be able to <code>clone</code> the repository, but they will
not be able to make commits until you invite them as collaborators.</p>
</li>
<li>
<p>Go to <em>Settings (top right gear icon) &#8594; Manage access &#8594; Invite a
Collaborator</em> within the GitHub web interface for your repository. Add all of
your group members as collaborators.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_issues">2.3. Issues</h3>
<div class="paragraph">
<p>GitHub has a built-in bug tracker called <em>Issues</em>. You can find it next to the
<em>Code</em> tab, under the repository name when viewing a repository. An issue is
typically a bug that needs to be fixed or a feature that needs to be
implemented. It can be assigned to a group member who can then close it when it
is completed. It can also be linked to a milestone, which can be thought of as
as group of things that need to be done to reach the next phase.</p>
</div>
<div class="paragraph">
<p>We will be using the GitHub Issues to monitor individual contributions to a
project and to see how well a team functions. Do not be afraid to create issues
and use the discussion features inside of them. They help document your
progress. You will also have milestones assigned as you progress through the
text. You should create those milestones in GitHub and assign the goals
accordingly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pull_requests">2.4. Pull requests</h3>
<div class="paragraph">
<p>For complex projects or projects that have external contributers GitHub
supports a fork-based pull request (PR) workflow. Although we probably won&#8217;t
be using it too much, it is helpful to know how it works in case you end up
working on larger projects, you want to contribute to another project, or your
instructor wants to contribute to your project.</p>
</div>
<div class="paragraph">
<p>In GitHub, a typical PR workflow looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pr.svg" alt="pr" width="470" height="584">
</div>
<div class="title">Figure 1. Pull Request</div>
</div>
<div class="paragraph">
<p>A contributer forks a project (makes their own personal copy), which is as easy
as clicking the <em>Fork</em> button in the upper-right when viewing a project
repository. They change the parts of the repository that they want to in their
personal copy and commit their changes. Then they click on <em>Pull Requests &#8594;
Create Pull Request</em> on the project&#8217;s repository. GitHub defaults to creating
PRs across branches (a good technique when working on a large project with lots
of contributers), but you can select PRs across forks as well. The owner of the
project can review the PR and if they like the changes they have the option to
merge them with their repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="_documentation">2.5. Documentation</h3>
<div class="paragraph">
<p>GitHub supports several styles of documentation, but the most common is
<a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a>. Files written in markdown and
ending in the <code>.md</code> extension will be rendered and displayed when viewed in the
GitHub web interface. If a file named <code>README.md</code> exists in a directory, it
will be automatically displayed at the bottom of a directory listing. This
makes it easy to build documentation right into your repository. Learn markdown
and be sure to have a <code>README.md</code> in your repository.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
</div>
<div class="sect2">
<h3 id="_resources_2">2.6. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://guides.github.com/features/issues/">Mastering Issues</a></p>
</li>
<li>
<p><a href="https://www.atlassian.com/git/tutorials/making-a-pull-request">Making a Pull Request</a></p>
</li>
<li>
<p><a href="https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-requests#draft-pull-requests">
About Pull Requests</a></p>
</li>
<li>
<p><a href="https://www.markdownguide.org/">The Markdown Guide</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_2">2.7. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What does GitHub provide for a project?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between using git and GitHub?</em></p>
<p></p>
</li>
<li>
<p><em>A new member joins your team. As the maintainer of the repository on GitHub, what steps do you need to take so that they have commit access to the repository? What steps does the group member need to take to get set up?</em></p>
<p></p>
</li>
<li>
<p><em>What is the purpose of issues in GitHub?</em></p>
<p></p>
</li>
<li>
<p><em>Why might a team want to use pull requests instead of adding all contributers as collaborators to a project?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_yaml">3. YAML</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/yaml.png" alt="yaml" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction">3.1. Introduction</h3>
<div class="paragraph">
<p>In the long-standing tradition of
<a href="https://en.wikipedia.org/wiki/Recursive_acronym#Early_computer-related_examples">
informal, recursive acronyms</a>, YAML stands for YAML Ain&#8217;t Markup Language. It
is designed to be a plain text way to represent complex objects. It is easier to
read than JSON, but not as complex as XML. YAML uses indentation to specify scope,
like Python, and therefore <em>spacing matters</em>.</p>
</div>
<div class="paragraph">
<p>The vast majority of what we will be creating is written in YAML so it pays to
give it at least a cursory treatment. It&#8217;s even become a bit of an inside joke
that modern system architects are simply <a href="https://yaml.engineering/">YAML
engineers</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parts_of_a_yaml_stream">3.2. Parts of a YAML Stream</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section is parts of a YAML <em>stream</em>, not a YAML <em>document</em> because
technically a single YAML file could have multiple Documents.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at some sample streams to get a clearer picture of how YAML is used:</p>
</div>
<div class="listingblock">
<div class="title">Sample Docker Compose YAML</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="c1"># source: https://docs.docker.com/compose/gettingstarted/ </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="nn">---</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="na">services</span><span class="pi">:</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">5000:5000"</span> <i class="conum" data-value="5"></i><b>(5)</b>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">redis:alpine"</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Anything following a <code>#</code> in YAML is considered a comment. Don&#8217;t be afraid to
use them!</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>YAML documents start with <code>---</code> and optionally end with <code>&#8230;&#8203;</code>. This allows
multiple documents to included in a stream.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>keyword: value</code> signals a mapping. This mapping maps the keyword <code>version</code>
to the string <code>'3'</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Mappings can be nested. This mapping maps the keyword <code>services</code> to
mappings with keywords <code>web</code> and <code>redis</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Sequences can be shown as a block of lines starting with <code>-</code>. In this case
<code>ports</code> is mapping to a sequence with one item, the string <code>"5000:5000"</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample Kubernetes YAML</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="c1"># source: https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="s">2016-02-18T18:52:05Z</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">name</span><span class="pi">:</span> <span class="s">game-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">516"</span>
  <span class="na">uid</span><span class="pi">:</span> <span class="s">b4952dc3-d670-11e5-8cd0-68f728db1985</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">game.properties</span><span class="pi">:</span> <span class="pi">|</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="s">enemies=aliens</span>
    <span class="s">lives=3</span>
    <span class="s">enemies.cheat=true</span>
    <span class="s">enemies.cheat.level=noGoodRotten</span>
    <span class="s">secret.code.passphrase=UUDDLRLRBABAS</span>
    <span class="s">secret.code.allowed=true</span>
    <span class="s">secret.code.lives=30</span>
  <span class="s">ui.properties</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">color.good=purple</span>
    <span class="s">color.bad=yellow</span>
    <span class="s">allow.textmode=true</span>
    <span class="s">how.nice.to.look=fairlyNice</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>YAML supports timestamp types.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>|</code> indicates block scalar style. The keyword <code>game.properties</code> is
mapped to a string where the newlines are preserved but the leading spaces are
removed. The string, with newlines shown as '\n', is
'enemies=aliens\nlives=3\nenemies.cheat=true\n&#8230;&#8203;'. This is a common way of
defining files or scripts within YAML.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_editors">3.3. Editors</h3>
<div class="paragraph">
<p>Given YAML&#8217;s strict whitespace requirements, you will need to use a text editor
that supports configuring spacing and expanding tabs into spaces. At a minimum,
you should be able to do the following with your text editor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Translate tab keystrokes into spaces. This is sometimes referred to as
<em>expanding tabs</em>. YAML files that mix tabs and spaces will not work.</p>
</li>
<li>
<p>Adjust tab spacing. Typically you will see YAML files with two spaces of
indentation for their blocks. This allows you to have many nested blocks and
not have to worry about lines wrapping or scrolling to the right.</p>
</li>
<li>
<p>Increase / Decrease the indentation level of several lines at once. As you
make changes, you may have to change the indentation level of a block being
able to do this quickly, without having to visit every line will save you
time.</p>
</li>
<li>
<p>Cut/Copy/Paste - You should be able to copy things between your web browser
and the file your are editing. If you can copy things between multiple
tabs/buffers in your text editor, even better.</p>
</li>
<li>
<p>Convert between DOS/UNIX line endings. Most of the tools you will be working
with come from the UNIX world, where a line ends with '\n'. Some older DOS
utilities still end lines with '\r\n'. You need to be able to save documents
with UNIX line endings in your text editor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many editors that meet these requirements. Choosing an editor is a
matter of personal taste and the subject of
<a href="https://en.wikipedia.org/wiki/Editor_war">unending flame wars</a>. With this in
mind the following list is not meant to be exhaustive and I&#8217;m sure the comments
may be subject of some debate. Popular editor choices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="https://www.vim.org/download.php">vim</a>/<a href="https://neovim.io/">neovim</a>/
<a href="http://ex-vi.sourceforge.net/">vi</a></strong> - Some form of vi is almost always
installed on any *NIX/BSD system. Knowing how to use it can be a major
lifesaver. You can also find versions for Windows. Since most of your work will
be in a terminal, having an editor that runs directly inside a terminal can be
an advantage. All that being said,
<a href="https://twitter.com/iamdevloper/status/435555976687923200">
the learning curve is steep</a>. If you are interested in learning vi, I&#8217;d suggest
either vimtutor or <code>:Tutor</code> inside neovim.</p>
</li>
<li>
<p><strong><a href="https://code.visualstudio.com/">Visual Studio Code</a></strong> - vscode is more akin to
a modern IDE. It is rapidly gaining more adoption and is certainly worth
checking out if that is the type of experience you are looking for.</p>
</li>
<li>
<p><strong><a href="https://notepad-plus-plus.org/downloads/">Notepad&#43;&#43;</a></strong> -
Notepad&#43;&#43; is a popular Windows GUI text editor. It starts quickly, and
many things work right out of the box. If you want something like notepad, but a
little more versatile (the next iteration you could say&#8230;&#8203; get it?), then this
is for you.</p>
</li>
<li>
<p><strong><a href="https://macromates.com/">TextMate</a></strong> - TextMate is a popular MacOS GUI text
editor. It is simple to get started, but offers the advanced features you may
need as you progress.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_resources_3">3.4. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://yaml.org/">The Official YAML Web Site</a></p>
</li>
<li>
<p><a href="https://yaml-multiline.info/">YAML Multiline Strings</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_3">3.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>How does YAML signify different blocks?</em></p>
<p></p>
</li>
<li>
<p><em>Are nested structures possible in YAML?</em></p>
<p></p>
</li>
<li>
<p><em>What are the two components of a YAML mapping?</em></p>
<p></p>
</li>
<li>
<p><em>How would you comment out a line in a YAML file?</em></p>
<p></p>
</li>
<li>
<p><em>What does the expandtab or "replace by spaces" option do in a text editor and why is it important for YAML?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_docker">4. Docker</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/docker.png" alt="docker" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_purpose_2">4.1. Purpose</h3>
<div class="paragraph">
<p>Traditionally, virtualization has made use of the virtual machine (VM) to
provide an isolated environment in which an operating system (OS) and
applications can run. This allows the application to have a completely custom
environment and ultimately makes it easier to deploy.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Maintaining a Legacy Application</div>
<div class="content">
<div class="paragraph">
<p>Prithi is in charge of maintaining a payroll system written using Perl, a web
server, and a CGI module. This system requires specific, older versions of each
of those components to function. Unfortunately all of the web servers that her
company uses are upgrading to newer versions and removing Perl and the CGI
module from their environment due to security concerns.</p>
</div>
<div class="paragraph">
<p>To solve this problem, Prithi asks the team that maintains the servers if they
will run a VM for her on one of their machines. Prithi can install the version
of Linux that she needs on the VM and use the packages the payroll system
requires. If appropriately isolated, a security breach on the VM would be
limited to just the payroll system. The web servers can still be upgraded <em>and</em>
Prithi can maintain the payroll system thanks to virtualization with VMs.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you expand this example a bit, and have a team that runs a datacenter,
provides VMs to customers, and charges for the amount of resources the VM uses,
you have the beginnings of infrastructure as a service (IaaS). As servers run
multiple VMs, you end up with a system that looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/vms.svg" alt="vms" width="612" height="448">
</div>
<div class="title">Figure 2. VM Server Architecture</div>
</div>
<div class="paragraph">
<p>Every VM having to run its own OS creates a lot of overhead and you can&#8217;t fit
as many VMs on one server. To solve this, containers were created. Containers
allow for similar isolation as VMs, but at a reduced resource cost. As opposed
to VMs which emulate a physical machine, containers use
<a href="https://en.wikipedia.org/wiki/Cgroups">control groups</a>,
<a href="https://en.wikipedia.org/wiki/Linux_namespaces">namespaces</a>, and
<a href="https://en.wikipedia.org/wiki/Chroot">chroot</a> to allow <em>containers</em> to share the
same operating system, but still be isolated. A server running containers has
significantly less overhead and looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/containers.svg" alt="containers" width="369" height="448">
</div>
<div class="title">Figure 3. Container Server Architecture</div>
</div>
<div class="paragraph">
<p>There are many different container runtime environments including:
<a href="https://linuxcontainers.org/">LXC</a>, <a href="https://containerd.io/">containerd</a>, and
<a href="https://www.docker.com/">Docker</a>. We will be using Docker due to its file format
popularity and its ability to run on multiple operating systems. By using
Docker, we will be able to create a system that can easily be tested and used
on any other machine that runs Docker.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation_2">4.2. Installation</h3>
<div class="paragraph">
<p>There are several options for installing Docker on your device, depending on the
operating system and hardware that you use:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Linux</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Docker can easily be installed natively on Linux and packages for Docker exist
for all major distributions.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Windows</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://hub.docker.com/?overlay=onboarding">Docker Desktop</a> should run fine
on any Windows system that has Hyper-V (a virtualization feature) available.</p>
</li>
<li>
<p>Windows 10 Home <em>does not</em> have Hyper-V available, but you can easily
<a href="https://answers.microsoft.com/en-us/windows/forum/windows_10-update/how-to-convert-windows-10-home-to-education/5a6e42b0-51fc-4e53-9497-454c3adc671c?auth=1">
Upgrade to Windows 10 Education</a> (typically this is provided by your
University) and then try installing it. This should be your first step if
Docker Desktop does not work out-of-the-box.</p>
</li>
<li>
<p><a href="https://docs.docker.com/toolbox/">Docker Toolbox</a> is an older version of
Docker, running under a VM in VirtualBox. It can be difficult to work with
and I highly recommend Docker Desktop if possible.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Mac</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://hub.docker.com/?overlay=onboarding&gt;">Docker Desktop</a> should run fine
on most Macs. We will be running it from the terminal so do not be alarmed if
you install it and do not see an application running.</p>
</li>
<li>
<p>If for some reason your computer is not supported you can try the macOS version
of <a href="https://docs.docker.com/toolbox/">Docker Toolbox</a>.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_concepts">4.3. Concepts</h3>
<div class="paragraph">
<p>An image is the complete file system of a Linux instance. You can think of it
like the hard drive of a server that someone has already set up. Images can be
tagged using the format <code>name:version</code>. One of the reasons Docker has become so
popular is because there are many pre-built images available. If you try to use
an image that does not exist on the local machine, Docker will automatically
attempt to <code>pull</code> that image from the <a href="https://hub.docker.com/">Docker Hub</a>
container registry.</p>
</div>
<div class="paragraph">
<p>Docker can <code>run</code> containers by taking images, copying the file system, and
running commands on that file system within an isolated environment. This is
called running a container. You can run several containers from the same image
since the file system is cloned.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images-containers-registry.svg" alt="images containers registry" width="594" height="503">
</div>
<div class="title">Figure 4. Images, Containers, and the Registry</div>
</div>
<div class="paragraph">
<p>In the above image, you can see that two images were pulled from the container
registry: Image 1 and Image 2. Once images are pulled, they are locally cached.
Image 3 was built locally and is available on the local machine, but is not
available from the registry. From those images, four containers have been run.
Container 1 and Container 2 are both using the same image, but keep in mind
they have their own <em>copy</em> of the file system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_commands">4.4. Commands</h3>
<div class="paragraph">
<p>Docker commands are run via the <code>docker</code> command line interface in a terminal.
Here is a <em>brief</em> listing of some of the most useful commands:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">images</dt>
<dd>
<p>Lists images that are locally available.</p>
</dd>
<dt class="hdlist1">ps</dt>
<dd>
<p>Lists the currently <em>running</em> containers.</p>
</dd>
<dt class="hdlist1">pull</dt>
<dd>
<p>Downloads an image from the container registry (Docker Hub by default).</p>
</dd>
<dt class="hdlist1">run</dt>
<dd>
<p>Creates a container from an image and starts that container. If a command is
specified that command is run, otherwise the default command for the image is
run.</p>
</dd>
<dt class="hdlist1">exec</dt>
<dd>
<p>Executes a command on an <em>already running</em> container.</p>
</dd>
<dt class="hdlist1">stop</dt>
<dd>
<p>Stops a running container.</p>
</dd>
<dt class="hdlist1">rm</dt>
<dd>
<p>Removes a container.</p>
</dd>
<dt class="hdlist1">image rm</dt>
<dd>
<p>Removes an image.</p>
</dd>
<dt class="hdlist1">build</dt>
<dd>
<p>Builds the Dockerfile in the directory specified into an image.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As you use Docker, it will download / create a lot of resources and it can be
helpful to clean those resources up periodically. Here are some commands to do
just that:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">system prune</dt>
<dd>
<p>Removes resources that aren&#8217;t in use by any containers. This includes inactive
containers: stopped containers that may be used again.</p>
</dd>
<dt class="hdlist1">image prune --all</dt>
<dd>
<p>Removes all images that aren&#8217;t <em>currently</em> being used. After you have been
running Docker for a while, this can free up GB of space.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_examples">4.5. Examples</h3>
<div class="paragraph">
<p>For the following examples, it is assumed that you have Docker installed and
that you are in a terminal that has access to the Docker command. This may be
the Docker Quickstart terminal if you installed Docker Toolbox, PowerShell if
you installed Docker Desktop, or Terminal if you are in MacOS.</p>
</div>
<div class="sect3">
<h4 id="_running_a_web_server">4.5.1. Running a Web Server</h4>
<div class="paragraph">
<p>Let&#8217;s take a look at just how easy it is to run a web server in a Linux
container with Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS &gt;</span><span class="w"> </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 8080:80 httpd:2.4.43 <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">Unable to find image 'httpd:2.4.43' locally
2.4.43: Pulling from library/httpd <i class="conum" data-value="2"></i><b>(2)</b>
54fec2fa59d0: Pull complete
8219e18ac429: Pull complete
3ae1b816f5e1: Pull complete
a5aa59ad8b5e: Pull complete
4f6febfae8db: Pull complete
Digest: sha256:c9e4386ebcdf0583204e7a54d7a827577b5ff98b932c498e9ee603f7050db1c1
Status: Downloaded newer image for httpd:2.4.43

fa13023485993c9ec47c805d0ce06b69b305ddf61657fbb6ec58674abb5a057b <i class="conum" data-value="3"></i><b>(3)</b>
</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we are telling Docker we want to <code>run</code> a container , <code>-d</code> in the
background (daemon mode), <code>-p 8080:80</code> with port 8080 on our local machine
forwarded to port 80 on the container, and the image is version <code>2.4.43</code> of
<code>httpd</code>. You can read more about this image <a href="https://hub.docker.com/_/httpd">
here</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Because we don&#8217;t have the image locally, it is pulled from the Docker Hub
container registry.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Each running container is given a unique hash.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s see what containers we have running with the <code>docker ps</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS &gt;</span><span class="w"> </span>docker ps <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">CONTAINER ID        IMAGE               COMMAND              CREATED             STATUS              PORTS                  NAMES
</span><span class="gp">fa1302348599        httpd:2.4.43        "httpd-foreground"   5 seconds ago       Up 5 seconds        0.0.0.0:8080-&gt;</span>80/tcp   eager_heyrovsky <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>docker ps</code> shows all <em>running</em> containers, to see <em>all</em> containers we
could have used <code>docker ps -a</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This displays the container id (enough of the hash to identify it for
commands), the image that the container is copied from, when it was started,
what its status is, which ports are being forwarded, and a friendly name for
the container (automatically generated if you don&#8217;t specify one) that you can
use in place of the container id in commands.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you&#8217;ve been following along with these commands, you should be able to open
a web browser and go to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> and see a page stating, "It
works!"</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s clean up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS &gt;</span><span class="w"> </span>docker stop fa1302348599 <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">fa1302348599

</span><span class="gp">PS &gt;</span><span class="w"> </span>docker ps <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS
</span><span class="gp">PS &gt;</span><span class="w"> </span>docker ps <span class="nt">-a</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS
fa1302348599        httpd:2.4.43        "httpd-foreground"  18 minutes ago      Exited (0) 5 seconds ago

</span><span class="gp">PS &gt;</span><span class="w"> </span>docker <span class="nb">rm </span>fa1302348599 <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">fa1302348599

</span><span class="gp">PS &gt;</span><span class="w"> </span>docker ps <span class="nt">-a</span>
<span class="go">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We know the id from the previous <code>docker ps</code> command, by running
<code>docker stop</code> we can stop the container.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Now we won&#8217;t see it in the plain <code>docker ps</code> command.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is still there, just not running as evidenced by the <code>docker ps -a</code>
command.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>docker rm</code> will remove it for good.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In most situations, <code>docker rm</code> isn&#8217;t really necessary. As stopped containers
do not actively consume resources. The browsing to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> again
to confirm that the container is actually shut down.</p>
</div>
</div>
<div class="sect3">
<h4 id="_building_a_custom_image">4.5.2. Building a Custom Image</h4>
<div class="paragraph">
<p>Sometimes the stock images are not enough to do what you want. In this example
we will be building an image for a web server that still uses <code>httpd:2.4.43</code> as
its base, but adds an extra file to change the default page. To do this, we
need to create a directory with a Dockerfile and our new index.html page. We&#8217;ll
do this in the <code>docker-demo</code> directory:</p>
</div>
<div class="listingblock">
<div class="title">docker-demo/index.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;h1&gt;</span>Hello from a container running a custom image!<span class="nt">&lt;/h1&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">docker-demo/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> httpd:2.4.43</span>
<span class="k">COPY</span><span class="s"> index.html /usr/local/apache2/htdocs/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A Dockerfile is a list of basic instructions for building an image. Instructions
are typically capitalized and in this case our Dockerfile is using two of them:
FROM and COPY. FROM tells Docker that you want to build an image on top of
another image. In this case we want to build our image on top of the
httpd:2.4.43 image. We also use the COPY instruction to copy a local file into
the image we are building. In this case we copy a custom index.html into the
directory that the <a href="https://httpd.apache.org/">Apache web server</a> serves files
from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Details about what directories an image uses can often be found in the
image&#8217;s documentation on Docker Hub.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To build our Dockerfile into an image, we are going to use the <code>build</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS docker-demo&gt;</span><span class="w"> </span>docker build <span class="nt">-t</span> docker-demo:v1 <span class="nb">.</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">Sending build context to Docker daemon  3.072kB
Step 1/2 : FROM httpd:2.4.43 <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="gp"> ---&gt;</span><span class="w"> </span>b2c2ab6dcf2e
<span class="go">Step 2/2 : COPY index.html /usr/local/apache2/htdocs/
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Using cache
<span class="gp"> ---&gt;</span><span class="w"> </span>7a8122895898
<span class="go">Successfully built 7a8122895898
Successfully tagged docker-demo:v1
SECURITY WARNING: You are building a Docker image from Windows against a non-Windows Docker host. All files and directories adde
d to build context will have '-rwxr-xr-x' permissions. It is recommended to double check and reset permissions for sensitive fil
es and directories. <i class="conum" data-value="3"></i><b>(3)</b>

</span><span class="gp">PS docker-demo&gt;</span><span class="w"> </span>docker images <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
docker-demo         v1                  7a8122895898        17 minutes ago      166MB
httpd               2.4.43              b2c2ab6dcf2e        2 weeks ago         166MB</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we specify that we want to <code>build</code> an image and we want to tag it as
<code>docker-demo:v1</code>. This command takes one argument, the directory which contains
the Dockerfile. In our case we pass it <code>.</code> to signify the current directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can see each instruction and the results as they are performed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Windows does not support the same file permissions as Linux so you may see
this warning.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally we look at the images currently available and see that the one we
built is available.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s run our custom image in a container with the <code>docker run</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS docker-demo&gt;</span><span class="w"> </span>docker run <span class="nt">-p</span> 8080:80 docker-demo:v1 <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">AH00558: httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.2. Set the 'ServerName' directive globally to suppress this message
AH00558: httpd: Could not reliably determine the server's fully qualified domain name, using 172.17.0.2. Set the 'ServerName' directive globally to suppress this message
[Sat May 09 15:09:48.016060 2020] [mpm_event:notice] [pid 1:tid 140614148256896] AH00489: Apache/2.4.43 (Unix) configured -- resuming normal operations
[Sat May 09 15:09:48.016154 2020] [core:notice] [pid 1:tid 140614148256896] AH00094: Command line: 'httpd -D FOREGROUND'</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice that we didn&#8217;t pass the <code>-d</code> option to Docker run, meaning we are
running in the foreground. This is useful if we want to run something quickly
as the log messages are printed directly in your terminal.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you open a web browser and navigate to <a href="https://localhost:8080" class="bare">https://localhost:8080</a> you should see
the message "Hello from a container running a custom image!" When you are done,
you can type Ctrl+C in the terminal to stop running the container, use
<code>docker ps</code> to get its ID, and then use <code>docker stop</code> to stop it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_docker_compose">4.5.3. Using Docker Compose</h4>
<div class="paragraph">
<p>Having to specify command line arguments for the docker command can get tedious,
especially as your environment becomes more complex. Docker compose is a tool
bundled with Docker that can be used to store the configuration for a
multi-container setup in a single <code>docker-compose.yml</code> file. The best way to
learn about it is to see it in action, so let&#8217;s start by looking at an example:</p>
</div>
<div class="listingblock">
<div class="title">docker-demo/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This file defines a Docker Compose service named <code>web</code> that builds an image
from the directory that <code>docker-compose.yml</code> is in. A container is run with the
image and local port 8080 is forwarded to port 80 in the container.</p>
</div>
<div class="paragraph">
<p>Here is a brief listing of some of the most useful docker-compose commands:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">up</dt>
<dd>
<p>Brings up all services in <code>docker-compose.yml</code></p>
</dd>
<dt class="hdlist1">down</dt>
<dd>
<p>Brings down all services in <code>docker-compose.yml</code></p>
</dd>
<dt class="hdlist1">stop</dt>
<dd>
<p>Stops all services or a service specified</p>
</dd>
<dt class="hdlist1">exec</dt>
<dd>
<p>Runs a command on <em>running</em> service</p>
</dd>
<dt class="hdlist1">logs</dt>
<dd>
<p>Prints the logs for a service</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Alright, now let&#8217;s bring up the web service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS docker-demo&gt;</span><span class="w"> </span>docker-compose up <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">Creating network "docker-demo_default" with the default driver <i class="conum" data-value="2"></i><b>(2)</b>
Building web
Step 1/2 : FROM httpd:2.4.43
</span><span class="gp"> ---&gt;</span><span class="w"> </span>b2c2ab6dcf2e
<span class="go">Step 2/2 : COPY index.html /usr/local/apache2/htdocs/
</span><span class="gp"> ---&gt;</span><span class="w"> </span>6ac4e496ced0
<span class="go">Successfully built 6ac4e496ced0
Successfully tagged docker-demo_web:latest
WARNING: Image for service web was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`. <i class="conum" data-value="3"></i><b>(3)</b>
Creating docker-demo_web_1 ... done
Attaching to docker-demo_web_1
web_1  | AH00558: httpd: Could not reliably determine the server's fully qualified domain name, using 172.18.0.2. Set the 'Serve
rName' directive globally to suppress this message
web_1  | AH00558: httpd: Could not reliably determine the server's fully qualified domain name, using 172.18.0.2. Set the 'Serve
rName' directive globally to suppress this message
web_1  | [Sat May 09 17:05:42.377243 2020] [mpm_event:notice] [pid 1:tid 140538714080384] AH00489: Apache/2.4.43 (Unix) configur
ed -- resuming normal operations
web_1  | [Sat May 09 17:05:42.377338 2020] [core:notice] [pid 1:tid 140538714080384] AH00094: Command line: 'httpd -D FOREGROUND
'
web_1  | 172.18.0.1 - - [09/May/2020:17:05:57 +0000] "GET / HTTP/1.1" 304 - <i class="conum" data-value="4"></i><b>(4)</b>
</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remember this command brings up <em>all</em> the services in the
<code>docker-compose.yml</code> file in the <em>current directory</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Docker Compose also create a network for your services to run in. This
helps with service communication later on.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This often trips up people the first time they use Docker Compose. If you
make changes to a Dockerfile you will have to rebuild the image, or specify
--build to <code>docker-compose up</code>, otherwise you won&#8217;t see your changes.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Docker Compose runs in the foreground by default and displays the aggregate
log information from all of the services running. Log messages are prefixed by
the service name. This can be <em>very</em> useful for debugging.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can test that things are working by going to <a href="http://localhost:8080" class="bare">http://localhost:8080</a>. Then
when we are all done we can close things down with by typing Ctrl+C in the
terminal.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resources_4">4.6. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.docker.com/get-started/overview/">Docker overview</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/get-started/">Docker Quickstart</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">
Best practices for writing Dockerfiles</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/compose/">Overview of Docker Compose</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_4">4.7. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What is the difference between a VM and a container?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between a Docker image and a Docker container?</em></p>
<p></p>
</li>
<li>
<p><em>How would you run a shell on an already running container?</em></p>
<p></p>
</li>
<li>
<p><em>What does the <code>-d</code> option do when passed to the <code>docker run</code> command? When may you want to use it? When may you <em>not</em> want to use it?</em></p>
<p></p>
</li>
<li>
<p><em>What does Docker Compose do and how it is different from the <code>docker</code> command?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_messaging">5. Messaging</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/messaging.png" alt="messaging" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_purpose_3">5.1. Purpose</h3>
<div class="paragraph">
<p>Messaging allows multiple components to use a common medium to exchange
information. The goal is to create a system that is more extensible,
future proof, and scalable. By using a messaging framework you can focus on the
interfaces between components and worry less about individual idiosyncrasies.</p>
</div>
<div class="paragraph">
<p>One of the easiest ways to understand the advantages of a messaging layer is to
view it as a bus carrying information between components. While you may only
have a few components now, what happens if you want to expand?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/messaging-bus.svg" alt="messaging bus" width="972" height="121">
</div>
</div>
<div class="paragraph">
<p>If the interfaces are well thought out, messaging frameworks can take advantage
of caching. Examine the following scenario:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/messaging-cache.svg" alt="messaging cache" width="703" height="344">
</div>
</div>
<div class="paragraph">
<p>For the second request, <code>GET Picture USER 42</code>, Messaging already knows the
answer and can respond with a cached copy. A well-designed messaging framework
will allow you to adjust cache parameters to achieve significant performance
gains without serving stale data. Cache invalidation is a
<a href="https://martinfowler.com/bliki/TwoHardThings.html">famously difficult</a> problem,
but at least with a messaging framework you are not trying to solve it by
yourself.</p>
</div>
<div class="paragraph">
<p>Messaging frameworks allow components to be built and profiled independent of
other components. Want to know how many requests a client is generating so you
can better build a back end to support it? Check the statistics of the messaging
queues you are using. Want to be able to completely swap out a component without
any of the other components noticing? Use a messaging framework.</p>
</div>
<div class="paragraph">
<p>That&#8217;s not to say that all projects take advantage of a messaging layer. Often
it&#8217;s viewed as "just another thing to get in the way" or another possible
bottleneck. Many projects attempt to shoe horn the messaging framework in later
on, a difficult feat. We will avoid that here by mandating that a messaging
framework be used from the start.</p>
</div>
</div>
<div class="sect2">
<h3 id="_frameworks">5.2. Frameworks</h3>
<div class="paragraph">
<p>The two most popular messaging frameworks are <a href="https://www.rabbitmq.com/">
RabbitMQ</a> and <a href="https://kafka.apache.org/">Kafka</a>. We will briefly discuss each
platform, but it is important to note that we will be using RabbitMQ in this
text. Milestones and deliverables in the project will require things specific
to RabbitMQ. All systems must function within constraints and one of the
constraints on the system we are going to design is that it <em>must</em> use
RabbitMQ.</p>
</div>
<div class="paragraph">
<p>RabbitMQ is built with <a href="https://www.erlang.org/">Erlang</a> and
<a href="https://erlang.org/doc/design_principles/users_guide.html">OTP</a>, a system meant
for solving the large-scale, distributed problems that are prevalent in the
telecom industry. It is hard to think of a platform more suited to the task of
messaging. RabbitMQ supports traditional messaging paradigms and uses a
standard messaging protocol: <a href="https://www.amqp.org/">AMQP</a>. This allows for
application libraries in <em>many</em> different languages including Python, Java,
Ruby, PHP, C#, JavaScript, Go, Elixir, Objective-C, Swift, and Spring AMQP.</p>
</div>
<div class="paragraph">
<p>Kafka was built by the Apache project in Java. It uses the publish and subscribe
model, the most common messaging model. It includes a broker by default meaning
it often requires less set up for standard messaging scenarios. While it may not
offer as much choice in <em>exactly</em> how messages are handled it does support large
data streams incredibly well.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rabbitmq_and_docker">5.3. RabbitMQ and Docker</h3>
<div class="paragraph">
<p>The <a href="https://hub.docker.com/_/rabbitmq">documentation for the official RabbitMQ
Docker image</a> is quite good and covers many of the topics we will touch on in
here in greater detail.</p>
</div>
<div class="paragraph">
<p>The stock RabbitMQ image uses different versions to specify if the management
interface should be enabled. You will probably want to use the web-based
management interface at first to see what is going on. You will also need to
expose port <code>15672</code> on your container to your local machine.</p>
</div>
<div class="paragraph">
<p>RabbitMQ can also use a few different environment variables to store secrets:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">RABBITMQ_DEFAULT_USER</dt>
<dd>
<p>By default, RabbitMQ will use the user name <code>guest</code>.
Technically we should only be able access our RabbitMQ container internally,
but it is still a good practice to change this to something specific to our
project.</p>
</dd>
<dt class="hdlist1">RABBITMQ_DEFAULT_PASS</dt>
<dd>
<p>By default, RabbitMQ will use the password <code>guest</code>. It
would be a good idea to change this as well.</p>
</dd>
<dt class="hdlist1">RABBITMQ_ERLANG_COOKIE</dt>
<dd>
<p>Erlang nodes use this for authentication. As far as we
are concerned this will only become important when we run multiple instances of
a RabbitMQ container and they need to communicate with each other.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Let&#8217;s start up a container running the management interface and take a look:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS <span class="o">&gt;</span> docker run <span class="nt">--env</span> <span class="nv">RABBITMQ_DEFAULT_USER</span><span class="o">=</span>example <span class="nt">--env</span> <span class="nv">RABBITMQ_DEFAULT_PASS</span><span class="o">=</span>example <span class="nt">-p</span> 15672:15672 rabbitmq:3.8.3-management<i class="conum" data-value="1"></i><b>(1)</b>
Unable to find image <span class="s1">'rabbitmq:3.8.3-management'</span> locally <i class="conum" data-value="2"></i><b>(2)</b>
3.8.3-management: Pulling from library/rabbitmq
23884877105a: Pull <span class="nb">complete
</span>bc38caa0f5b9: Pull <span class="nb">complete
</span>2910811b6c42: Pull <span class="nb">complete
</span>36505266dcc6: Pull <span class="nb">complete
</span>15c38f93e1dd: Pull <span class="nb">complete
</span>9e0786f6591b: Pull <span class="nb">complete
</span>8b3540df5774: Pull <span class="nb">complete
</span>32ac1b555e0d: Pull <span class="nb">complete
</span>15f10b4062cf: Pull <span class="nb">complete
</span>de41c89084c6: Pull <span class="nb">complete
</span>b7f855bfd426: Pull <span class="nb">complete
</span>3d2f86c64a6d: Pull <span class="nb">complete
</span>Digest: sha256:14453bd6c8c0717053d5cb7fa232f11c83f49b8acd1aff59a9b3e25f79c4f652
Status: Downloaded newer image <span class="k">for </span>rabbitmq:3.8.3-management
2020-05-02 20:45:37.770 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags: list of feature flags found:
2020-05-02 20:45:37.770 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> drop_unroutable_metric
2020-05-02 20:45:37.770 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> empty_basic_get_metric
2020-05-02 20:45:37.770 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> implicit_default_bindings
2020-05-02 20:45:37.770 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> quorum_queue
2020-05-02 20:45:37.770 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> virtual_host_metadata
2020-05-02 20:45:37.770 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags: feature flag states written to disk: <span class="nb">yes
</span>2020-05-02 20:45:37.803 <span class="o">[</span>info] &lt;0.269.0&gt; ra: meta data store initialised. 0 record<span class="o">(</span>s<span class="o">)</span> recovered
2020-05-02 20:45:37.803 <span class="o">[</span>info] &lt;0.274.0&gt; WAL: recovering <span class="o">[]</span>
2020-05-02 20:45:37.812 <span class="o">[</span>info] &lt;0.278.0&gt;
 Starting RabbitMQ 3.8.3 on Erlang 22.3.3 <i class="conum" data-value="3"></i><b>(3)</b>
 Copyright <span class="o">(</span>c<span class="o">)</span> 2007-2020 Pivotal Software, Inc.
 Licensed under the MPL 1.1. Website: https://rabbitmq.com

  <span class="c">##  ##      RabbitMQ 3.8.3</span>
  <span class="c">##  ##</span>
  <span class="c">##########  Copyright (c) 2007-2020 Pivotal Software, Inc.</span>
  <span class="c">######  ##</span>
  <span class="c">##########  Licensed under the MPL 1.1. Website: https://rabbitmq.com</span>

  Doc guides: https://rabbitmq.com/documentation.html
  Support:    https://rabbitmq.com/contact.html
  Tutorials:  https://rabbitmq.com/getstarted.html
  Monitoring: https://rabbitmq.com/monitoring.html

  Logs: &lt;stdout&gt;

  Config file<span class="o">(</span>s<span class="o">)</span>: /etc/rabbitmq/rabbitmq.conf

  Starting broker...2020-05-02 20:45:37.814 <span class="o">[</span>info] &lt;0.278.0&gt;
 node           : rabbit@53c4ff237fcd
 home <span class="nb">dir</span>       : /var/lib/rabbitmq
 config file<span class="o">(</span>s<span class="o">)</span> : /etc/rabbitmq/rabbitmq.conf
 cookie <span class="nb">hash</span>    : mCbpvRz5+sUotXe8uIyiKQ<span class="o">==</span> <i class="conum" data-value="4"></i><b>(4)</b>
 log<span class="o">(</span>s<span class="o">)</span>         : &lt;stdout&gt;
 database <span class="nb">dir</span>   : /var/lib/rabbitmq/mnesia/rabbit@53c4ff237fcd
2020-05-02 20:45:37.827 <span class="o">[</span>info] &lt;0.278.0&gt; Running boot step pre_boot defined by app rabbit
&lt;snip&gt; <i class="conum" data-value="5"></i><b>(5)</b>
2020-05-02 20:45:38.683 <span class="o">[</span>info] &lt;0.9.0&gt; Server startup <span class="nb">complete</span><span class="p">;</span> 3 plugins started.
 <span class="k">*</span> rabbitmq_management
 <span class="k">*</span> rabbitmq_management_agent
 <span class="k">*</span> rabbitmq_web_dispatch
 completed with 3 plugins. <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Notice how we specify a new user and password, forward a port from our
local machine, and request the management image.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since we don&#8217;t have the image, it will be pulled from Docker Hub
automatically.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>RabbitMQ tells you what version of Erlang it is using. Cluster requires
nodes to run similar versions, so this can be an important bit of information.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If you don&#8217;t specify an Erlang cookie, one will be chose randomly. This is
it, <a href="https://en.wikipedia.org/wiki/Base64">base64</a> encoded.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>There are <em>a lot</em> of startup messages and it can take some time for
RabbitMQ to start. I&#8217;ve cut them out of the output here.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Once you see this, you&#8217;re node is up and running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, we should be able to visit <a href="http://localhost:15672" class="bare">http://localhost:15672</a> and see the management
interface running. Using our user name / password of example / example, we can
sign in. Take a moment to look around the interface. Queues are created
automatically by applications so you won&#8217;t need to configure anything, but once
you have components up and using RabbitMQ you can look here to see the queues
they&#8217;ve created and to make sure that everything is working. When you are all
done type Ctrl-C to detach from the <code>docker run command</code> and use <code>docker stop</code>
to stop the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS <span class="o">&gt;</span> docker ps <i class="conum" data-value="1"></i><b>(1)</b>
CONTAINER ID        IMAGE                       COMMAND                  CREATED
53c4ff237fcd        rabbitmq:3.8.3-management   <span class="s2">"docker-entrypoint.s"</span>   12 minutes ago
PS <span class="o">&gt;</span> docker stop 53c4ff237fcd <i class="conum" data-value="2"></i><b>(2)</b>
53c4ff237fcd
PS <span class="o">&gt;</span> docker ps <i class="conum" data-value="3"></i><b>(3)</b>
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List all running containers</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Stop rabbitmq by ID</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Double-check to make sure nothing is running</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_resources_5">5.4. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.amqp.org/">AMQP</a></p>
</li>
<li>
<p><a href="https://www.rabbitmq.com/getstarted.html">RabbitMQ Getting Started</a></p>
</li>
<li>
<p><a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Docker Hub Image</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/network/">Docker Networking Overview</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_5">5.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>Why would a project choose to use a messaging framework?</em></p>
<p></p>
</li>
<li>
<p><em>What is caching and what are its benefits?</em></p>
<p></p>
</li>
<li>
<p><em>What is AMQP?</em></p>
<p></p>
</li>
<li>
<p><em>How can you specify that you want to enable the management interface in the official RabbitMQ Docker image?</em></p>
<p></p>
</li>
<li>
<p><em>Why should you change the RabbitMQ default password and how do you change it?</em></p>
<p></p>
</li>
<li>
<p><em>How would you start up a RabbitMQ instance in Docker Compose, with the same options we used in the example?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database">6. Database</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/database.png" alt="database" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction_2">6.1. Introduction</h3>
<div class="paragraph">
<p>Databases are used to store and organize information in a manner consistent
with the relationships in that data. This allows for more natural queries to
retrieve information. For example, if you typically look up a car part by its
ID, it would make sense to have a table of part IDs with names and
descriptions. A car can be thought of as a collection of parts, therefore you
could have a car table and a car_part table that relates a car ID to multiple
part IDs:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/tables.svg" alt="tables" width="243" height="414">
</div>
<div class="title">Figure 5. Tables in a Relational Database</div>
</div>
<div class="paragraph">
<p>Relational databases maintain the integrity of their relations at the cost of
being rigid and requiring more setup. In our system we will employ a relational
database for multiple reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relational databases are the most popular databases in use today.</p>
</li>
<li>
<p>SQL is the most marketable computer language in the world and with the growth
of data science, this is not changing any time soon.</p>
</li>
<li>
<p>Relational databases present unique challenges with regard to replication.
This will provide a good learning opportunity later in the text.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A database will be used for the <em>persistent</em> storage of information. In a
container environment, it is very important to make the distinction between
<em>ephemeral</em> and <em>persistent</em> storage. A container may have lots of information
on its filesystem but if that container is stopped, that information is lost.
All <em>stateful</em> information, that is information that needs to survive the
container lifecycle, should be stored on a database which utilizes an external
volume.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/volumes.svg" alt="volumes" width="350" height="140">
</div>
<div class="title">Figure 6. Containerized Database using a Volume</div>
</div>
<div class="paragraph">
<p>As can be seen above, the volume exists <em>outside</em> of the container running the
relational database management system (RDBMS). The volume holds the database
files the RDBMS uses to store information and if the container is stopped or
removed, the files remain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_popular_rdms">6.2. Popular RDMS</h3>
<div class="paragraph">
<p>For our project we can use any one of the following RDMS:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://www.mysql.com/">MySQL</a></dt>
<dd>
<p>MySQL is an RDMS that has grown out of the practical need for a relational
database in Linux. It quite literally puts the 'M' in the venerable LAMP stack
(Linux Apache MySQL PHP). It has native support for replication and many other
practical features that make it an excellent choice for any project.</p>
</dd>
<dt class="hdlist1"><a href="https://mariadb.org/">MariaDB</a></dt>
<dd>
<p>MariaDB is a RDMS that aims to be be feature and syntax compliant with MySQL.
It was originally forked from MySQL and developed as a response to Oracle&#8217;s
purchase of Sun Microsystems, who bought MySQL. It as actively developed and
widely popular.</p>
</dd>
<dt class="hdlist1"><a href="https://www.postgresql.org/">PostgreSQL</a></dt>
<dd>
<p>PostgreSQL is an <em>object</em> relational database management system that aims to
be more SQL compliant than MySQL. Where MySQL was borne out of workplace need,
PostgreSQL has an academic lineage. It is enterprise ready, massively scalable
(although it relies on several other tools for replication), and has fewer
licensing issues than MySQL. PostgreSQL is seeing growing adoption.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_example_2">6.3. Example</h3>
<div class="paragraph">
<p>In this example we will start a MySQL container, initialize it with the
SQL file shown below, and connect to it with the
<a href="https://dev.mysql.com/doc/refman/8.0/en/mysql.html">mysql client</a>. The
<code>setup.sql</code> file that initializes our database can be found in the
<code>db-demo</code> directory. It sets up a simple car part database for our example:</p>
</div>
<div class="listingblock">
<div class="title">db-demo/setup.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">car</span> <span class="p">(</span>
    <span class="n">car_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">make</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">model</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nb">year</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">car_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">part</span> <span class="p">(</span>
    <span class="n">part_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">description</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
    <span class="n">manufacturers_partnum</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="n">price</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">part_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">car_part</span> <span class="p">(</span>
    <span class="n">car_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">part_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">car_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">car</span><span class="p">(</span><span class="n">car_id</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">part_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">part</span><span class="p">(</span><span class="n">part_id</span><span class="p">),</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">car_id</span><span class="p">,</span> <span class="n">part_id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'HONDA'</span><span class="p">,</span> <span class="s1">'CIVIC'</span><span class="p">,</span> <span class="mi">2005</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'TOYOTA'</span><span class="p">,</span> <span class="s1">'COROLLA'</span><span class="p">,</span> <span class="mi">2010</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'FORD'</span><span class="p">,</span> <span class="s1">'F-150'</span><span class="p">,</span> <span class="mi">2009</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">part</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'Brake Pads'</span><span class="p">,</span> <span class="s1">'Duralast ceramic brake pads'</span><span class="p">,</span> <span class="s1">'MKD621'</span><span class="p">,</span> <span class="mi">19</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">part</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Alternator'</span><span class="p">,</span> <span class="s1">'Duralast gold new alternator'</span><span class="p">,</span> <span class="s1">'DLG12308'</span><span class="p">,</span> <span class="mi">175</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">part</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Radiator Cap'</span><span class="p">,</span> <span class="s1">'Duralast Radiator Cap'</span><span class="p">,</span> <span class="s1">'7036'</span><span class="p">,</span> <span class="mi">10</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">part</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Alternator'</span><span class="p">,</span> <span class="s1">'Duralast gold new alternator'</span><span class="p">,</span> <span class="s1">'DLG5540-17-2'</span><span class="p">,</span>
    <span class="mi">256</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">part</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'Rear Leaf Spring'</span><span class="p">,</span> <span class="s1">'1500lbs capacity'</span><span class="p">,</span> <span class="s1">'43-1781'</span><span class="p">,</span> <span class="mi">129</span><span class="p">.</span><span class="mi">99</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car_part</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car_part</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car_part</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car_part</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car_part</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car_part</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">car_part</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Be sure to check to <a href="https://hub.docker.com/_/mysql">documentation for the Docker
image you are using</a> to see how to initialize a database and to learn about
which environment variables you will need to use. In this case,
we will bind mount the current directory to <code>/docker-entrypoint-initdb.d/</code> on
the container so our <code>setup.sql</code> file is run the first time the container is
started. We will also use environment variables to set up a database, username,
and password.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s create a volume, and run our container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS db-demo&gt;</span><span class="w"> </span>docker volume create db-data <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">db-data
</span><span class="gp">PS db-demo&gt;</span><span class="w"> </span>docker volume <span class="nb">ls</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">DRIVER              VOLUME NAME
local               db-data
</span><span class="gp">PS db-demo&gt;</span><span class="w"> </span>docker run <span class="nt">-d</span> <span class="nt">--mount</span> <span class="s2">"type=volume,src=db-data,dst=/var/lib/mysql"</span> <span class="nt">--mount</span> <span class="s2">"type=bind,src=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">,dst=/docker-entrypoint-initdb.d"</span> <span class="nt">-e</span> <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>changeme <span class="nt">-e</span> <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>cars <span class="nt">-e</span> <span class="nv">MYSQL_USER</span><span class="o">=</span>car_user <span class="nt">-e</span> <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span>changeme mysql:8.0.20 <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">32193c2a74a16f73c44dc186a9b368fafd4b0d1fadc000c58ee8e3357fc24a6e
</span><span class="gp">PS db-demo&gt;</span><span class="w"> </span>docker ps <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                 NAMES
32193c2a74a1        mysql:8.0.20        "docker-entrypoint.s"   12 seconds ago      Up 12 seconds       3306/tcp, 33060/tcp   youthful_euler
</span><span class="gp">PS db-demo&gt;</span><span class="w"> </span>docker logs 32193c2a74a1 <i class="conum" data-value="5"></i><b>(5)</b>
<span class="go">2020-05-11 17:04:07+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.20-1debian10 started.
2020-05-11 17:04:07+00:00 [Note] [Entrypoint]: Switching to dedicated user 'mysql'
2020-05-11 17:04:07+00:00 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.0.20-1debian10 started.
2020-05-11 17:04:07+00:00 [Note] [Entrypoint]: Initializing database files
2020-05-11T17:04:07.809871Z 0 [Warning] [MY-011070] [Server] 'Disabling symbolic links using --skip-symbolic-links (or equivalent) is the default. Consider not using this option as it' is deprecated and will be removed in a future release.
2020-05-11T17:04:07.809922Z 0 [System] [MY-013169] [Server] /usr/sbin/mysqld (mysqld 8.0.20) initializing of server in progress as process 42
2020-05-11T17:04:07.814301Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
2020-05-11T17:04:08.700422Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.
2020-05-11T17:04:10.397851Z 6 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switchi
ng off the --initialize-insecure option.
2020-05-11 17:04:14+00:00 [Note] [Entrypoint]: Database files initialized
2020-05-11 17:04:14+00:00 [Note] [Entrypoint]: Starting temporary server
2020-05-11T17:04:14.850337Z 0 [Warning] [MY-011070] [Server] 'Disabling symbolic links using --skip-symbolic-links (or equivalent) is t
he default. Consider not using this option as it' is deprecated and will be removed in a future release.
2020-05-11T17:04:14.850452Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.20) starting as process 89
2020-05-11T17:04:14.874687Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
2020-05-11T17:04:15.108491Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.
2020-05-11T17:04:15.217674Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Socket: '/var/run/mysqld/mysqlx.sock'
2020-05-11T17:04:15.321264Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.
2020-05-11T17:04:15.325886Z 0 [Warning] [MY-011810] [Server] Insecure configuration for --pid-file: Location '/var/run/mysqld' in the p
ath is accessible to all OS users. Consider choosing a different directory.
2020-05-11T17:04:15.339834Z 0 [System] [MY-010931] [Server] /usr/sbin/mysqld: ready for connections. Version: '8.0.20'  socket: '/var/r
un/mysqld/mysqld.sock'  port: 0  MySQL Community Server - GPL.
2020-05-11 17:04:15+00:00 [Note] [Entrypoint]: Temporary server started.
Warning: Unable to load '/usr/share/zoneinfo/iso3166.tab' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/leap-seconds.list' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/zone.tab' as time zone. Skipping it.
Warning: Unable to load '/usr/share/zoneinfo/zone1970.tab' as time zone. Skipping it.
2020-05-11 17:04:17+00:00 [Note] [Entrypoint]: Creating database cars
2020-05-11 17:04:17+00:00 [Note] [Entrypoint]: Creating user car_user
2020-05-11 17:04:17+00:00 [Note] [Entrypoint]: Giving user car_user access to schema cars

2020-05-11 17:04:17+00:00 [Note] [Entrypoint]: /usr/local/bin/docker-entrypoint.sh: running /docker-entrypoint-initdb.d/setup.sql <i class="conum" data-value="6"></i><b>(6)</b>


2020-05-11 17:04:18+00:00 [Note] [Entrypoint]: Stopping temporary server
2020-05-11T17:04:18.137760Z 15 [System] [MY-013172] [Server] Received SHUTDOWN from user root. Shutting down mysqld (Version: 8.0.20).
2020-05-11T17:04:20.277911Z 0 [System] [MY-010910] [Server] /usr/sbin/mysqld: Shutdown complete (mysqld 8.0.20)  MySQL Community Server - GPL.
2020-05-11 17:04:21+00:00 [Note] [Entrypoint]: Temporary server stopped

2020-05-11 17:04:21+00:00 [Note] [Entrypoint]: MySQL init process done. Ready for start up.

2020-05-11T17:04:21.372922Z 0 [Warning] [MY-011070] [Server] 'Disabling symbolic links using --skip-symbolic-links (or equivalent) is the default. Consider not using this option as it' is deprecated and will be removed in a future release.
2020-05-11T17:04:21.373012Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.20) starting as process 1
2020-05-11T17:04:21.382956Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
2020-05-11T17:04:21.590667Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.
2020-05-11T17:04:21.691458Z 0 [System] [MY-011323] [Server] X Plugin ready for connections. Socket: '/var/run/mysqld/mysqlx.sock' bind-address: '::' port: 33060
2020-05-11T17:04:21.767017Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.
2020-05-11T17:04:21.770819Z 0 [Warning] [MY-011810] [Server] Insecure configuration for --pid-file: Location '/var/run/mysqld' in the path is accessible to all OS users. Consider choosing a different directory.
2020-05-11T17:04:21.787429Z 0 [System] [MY-010931] [Server] /usr/sbin/mysqld: ready for connections. Version: '8.0.20'  socket: '/var/run/mysqld/mysqld.sock'  port: 3306  MySQL Community Server - GPL.</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create a volume named <code>db-data</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>and now we can see it listed in the available volumes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This lengthy command translates to:
<div class="ulist">
<ul>
<li>
<p><code>run</code>: mysql version 8.0.20</p>
</li>
<li>
<p><code>-d</code>: in the background</p>
</li>
<li>
<p><code>--mount "type=volume,src=db-data,dst=/var/lib/mysql"</code>: mount the volume named
db-data to /var/lib/mysql on the container</p>
</li>
<li>
<p><code>--mount "type=bind,src=$(pwd),dst=/docker-entrypoint-initdb.d"</code>: mount the
current directory, we have to use pwd here because it wants an absolute path,
to /docker-entrypoint-initdb.d on the container. This is a bind mount which
is a quick linkage between a directory on the host and a directory on the
container. Bind mounts may not support all of the features you need, but for
our purposes it works well here. Our current directory has the <code>setup.sql</code>
file that we use to initialize our database.</p>
</li>
<li>
<p><code>-e MYSQL_ROOT_PASSWORD=changeme</code>: use an environment variable to set the root
password for mysql access</p>
</li>
<li>
<p><code>-e MYSQL_DATABASE=cars</code>: use an environment variable to set the database we
initialize</p>
</li>
<li>
<p><code>-e MYSQL_USER=car_user</code>: use an environment variable to create a new user
that can access the database we set up</p>
</li>
<li>
<p><code>-e MYSQL_PASSWORD=changeme</code>: use an environment variable to set a password
for the user we created above</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Check to see that our container is running and get the ID</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Examine the log output for our container (by ID)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We can see here in the output, that our <code>setup.sql</code> script was run</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With our container running in the background, we can now connect and make sure
that our database was initialized. To avoid having to download a mysql client
on the host, we will <code>exec</code> the mysql command on the running container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS db-demo&gt;</span><span class="w"> </span>docker <span class="nb">exec</span> <span class="nt">-it</span> 32193c2a74a1 mysql <span class="nt">-u</span> car_user <span class="nt">-p</span> cars
<span class="go">Enter password: <i class="conum" data-value="1"></i><b>(1)</b>
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

</span><span class="gp">Welcome to the MySQL monitor.  Commands end with ;</span><span class="w"> </span>or <span class="se">\g</span><span class="nb">.</span>
<span class="go">Your MySQL connection id is 12
Server version: 8.0.20 MySQL Community Server - GPL

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

</span><span class="gp">Type 'help;</span><span class="s1">' or '</span><span class="se">\h</span><span class="s1">' for help. Type '</span><span class="se">\c</span><span class="s1">' to clear the current input statement.
</span><span class="go">
</span><span class="gp">mysql&gt;</span><span class="w"> </span>show tables<span class="p">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">+----------------+
| Tables_in_cars |
+----------------+
| car            |
| car_part       |
| part           |
+----------------+
3 rows in set (0.00 sec)

</span><span class="gp">mysql&gt;</span><span class="w"> </span><span class="k">select</span> <span class="k">*</span> from car<span class="p">;</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">+--------+--------+---------+------+
| car_id | make   | model   | year |
+--------+--------+---------+------+
|      0 | HONDA  | CIVIC   | 2005 |
|      1 | TOYOTA | COROLLA | 2010 |
|      2 | FORD   | F-150   | 2009 |
+--------+--------+---------+------+
3 rows in set (0.00 sec)

</span><span class="gp">mysql&gt;</span><span class="w"> </span>SELECT name, description, price
<span class="gp">    -&gt;</span><span class="w"> </span>FROM car, car_part, part
<span class="gp">    -&gt;</span><span class="w"> </span>WHERE car.car_id<span class="o">=</span>car_part.car_id AND
<span class="gp">    -&gt;</span><span class="w"> </span>part.part_id<span class="o">=</span>car_part.part_id AND
<span class="gp">    -&gt;</span><span class="w"> </span>car.make<span class="o">=</span><span class="s1">'FORD'</span> AND car.model<span class="o">=</span><span class="s1">'F-150'</span> AND car.year<span class="o">=</span><span class="s1">'2009'</span><span class="p">;</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">+------------------+-----------------------+--------+
| name             | description           | price  |
+------------------+-----------------------+--------+
| Radiator Cap     | Duralast Radiator Cap |  10.99 |
| Rear Leaf Spring | 1500lbs capacity      | 129.99 |
+------------------+-----------------------+--------+
2 rows in set (0.00 sec)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>recall the we set the password to <code>changeme</code> via an environment variable</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>check that all the tables were created</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>check that the data was inserted into the tables</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>perform a sample query looking up all parts for a 2009 Ford F-150</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>docker volume prune</code> is a useful command for getting rid of volumes not
in use by any container. Just be sure that you don&#8217;t need the data on those
volumes anymore!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_resources_6">6.4. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://hub.docker.com/_/mysql">MySQL Docker Image</a></p>
</li>
<li>
<p><a href="https://hub.docker.com/_/mariadb">MariaDB Docker Image</a></p>
</li>
<li>
<p><a href="https://hub.docker.com/_/postgres">PostgreSQL Docker Image</a></p>
</li>
<li>
<p><a href="http://www.daniloaz.com/en/how-to-create-a-user-in-mysql-mariadb-and-grant-permissions-on-a-specific-database/">Creating Users / Granting Privileges in MySQL/MariaDB</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/storage/volumes/">Volumes in Docker</a></p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/connector-python/en/">MySQL Connector Python Module</a></p>
</li>
<li>
<p><a href="https://www.psycopg.org/">Psycopg Python Module</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_6">6.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What is a Docker volume and why should a containerized RDMS use it?</em></p>
<p></p>
</li>
<li>
<p><em>Pick one RDMS from the <a href="#_popular_rdms">list above</a>. What are the advantages of this particular RDMS over the others?</em></p>
<p></p>
</li>
<li>
<p><em>How do you set an environment variable via the <code>docker</code> command?</em></p>
<p></p>
</li>
<li>
<p><em>How do you initialize a database in the default MySQL docker image?</em></p>
<p></p>
</li>
<li>
<p><em>The command we used to run our database container was very complex and it would be quite tedious to type it out over and over. How would you run the example in Docker Compose instead?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_front_end">7. Front End</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/front-end.png" alt="front end" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction_3">7.1. Introduction</h3>
<div class="paragraph">
<p>The purpose of a front end is to interact with the user. Web applications are
applications that use a web server to present their front end. In our case, we
will build a traditional web application that interacts with the user via a web
server, but uses <strong>Messaging</strong> for any other communication:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/front-end.svg" alt="front end" width="520" height="103">
</div>
</div>
<div class="paragraph">
<p>To provide the web interface, most applications use some sort of web framework.
The decision of which web framework to use depends largely on the language(s)
the <strong>Front End</strong> developer is comfortable with and what features they would like.
The most common web frameworks for various languages are shown below. You are
encouraged to research them and determine what would best fit your needs.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://www.python.org/">Python</a></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a></p>
</li>
<li>
<p><a href="https://www.djangoproject.com/">Django</a></p>
</li>
<li>
<p><a href="https://bottlepy.org/docs/dev/">Bottle</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><a href="https://en.wikipedia.org/wiki/JavaScript">JavaScript</a></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://nodejs.org/en/">Plain NodeJS</a></p>
</li>
<li>
<p><a href="https://expressjs.com/">Express</a></p>
</li>
<li>
<p><a href="https://koajs.com/">Koa</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><a href="https://www.php.net/">PHP</a></dt>
<dd>
<p>Largely employed as a templating language, PHP is
still popular and can be used in conjunction with a web server as a framework.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To communicate with <strong>Messaging</strong> a library is used. Ultimately this will allow
for a more scalable application. The decision of which library to use is mostly
dependant on what language <strong>Front End</strong> is using. Fortunately RabbitMQ has
<a href="https://www.rabbitmq.com/getstarted.html">extensive documentation</a> on using the
most popular messaging libraries for various languages:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Python
</td>
<td class="hdlist2">
<p><a href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">pika</a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
JavaScript
</td>
<td class="hdlist2">
<p><a href="https://www.rabbitmq.com/tutorials/tutorial-one-javascript.html">
amqp</a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
PHP
</td>
<td class="hdlist2">
<p><a href="https://www.rabbitmq.com/tutorials/tutorial-one-php.html">php-amqplib</a></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <strong>Front End</strong> developer should be comfortable with HTML for the creation of
views that the user will see and they should keep in mind that at some point
their code will need to be run on a production server. There are many options
for production servers depending on what language <strong>Front End</strong> is using:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Python
</td>
<td class="hdlist2">
<p>Frameworks use <a href="https://www.fullstackpython.com/wsgi-servers.html">WSGI</a>
for which there are many options.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
JavaScript
</td>
<td class="hdlist2">
<p>Frameworks make use of Node and typically use a
<a href="https://deploybot.com/blog/guest-post-how-to-set-up-and-deploy-nodejs-express-application-for-production">
managed node processes</a>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
PHP
</td>
<td class="hdlist2">
<p>Usually served using CGI or a module for a standard web server.</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_example_3">7.2. Example</h3>
<div class="paragraph">
<p>As an example, we are going to set up a PHP application that presents a web
interface <em>and</em> communicates with <strong>Messaging</strong>. We will be basing our code of of
the <a href="https://www.rabbitmq.com/tutorials/tutorial-six-php.html">RabbitMQ RPC
tutorial for PHP</a> and using the <a href="https://hub.docker.com/_/php">official PHP Docker
Hub image</a>.</p>
</div>
<div class="paragraph">
<p>The first problem we have to solve is how to include
<a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a> with our application. To
do this, we will follow php-amqplib&#8217;s recommendation and use
<a href="https://getcomposer.org/">composer</a>. No matter what language you are using for
<strong>Front End</strong> it is <em>very</em> important that you learn to use its package management
system. To start, we create a <code>composer.json</code> file that lists what version of
PHP we wish to build for, what PHP extensions are needed, and what our
application&#8217;s requirements are:</p>
</div>
<div class="listingblock">
<div class="title">front-end-demo/web/composer.json</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"platform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"php"</span><span class="p">:</span><span class="w"> </span><span class="s2">"7.4.5"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ext-bcmath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ext-sockets"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"require"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"php-amqplib/php-amqplib"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&gt;=2.9.0"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to use composer to download and install packages in the <code>vendor</code>
directory of our application. Fortunately the official composer Docker image
makes this easy. We can run composer on the image and store the output through
careful use of a bind mount:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS front-end-demo\app&gt;</span><span class="w"> </span>docker run <span class="nt">--rm</span> <span class="nt">-it</span> <span class="nt">-v</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">:/app"</span> composer <span class="nb">install</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">Loading composer repositories with package information
Updating dependencies (including require-dev)
Package operations: 2 installs, 0 updates, 0 removals
  - Installing phpseclib/phpseclib (2.0.27): Downloading (100%)
  - Installing php-amqplib/php-amqplib (v2.11.2): Downloading (100%)
phpseclib/phpseclib suggests installing ext-libsodium (SSH2/SFTP can make use of some algorithms provided by the libsodium-php extension.)
phpseclib/phpseclib suggests installing ext-mcrypt (Install the Mcrypt extension in order to speed up a few other cryptographic operations.)
phpseclib/phpseclib suggests installing ext-gmp (Install the GMP (GNU Multiple Precision) extension in order to speed up arbitrary precision integer arithmetic operations.)
Writing lock file
Generating autoload files
1 package you are using is looking for funding.
Use the `composer fund` command to find out more!</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>--rm</code> option removes the container after it finishes. Notice how we
bind link the app directory <code>front-end-demo/app</code> (which we are in) with the
<code>/app</code> directory on the container. This way all the files that composer creates
are stored locally in our app directory.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will also need a PHP image with some extra PHP extensions enabled and our
application code in the <code>/var/www/html</code> directory. To do this, we use a simple
Dockerfile:</p>
</div>
<div class="listingblock">
<div class="title">front-end-demo/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> php:7.4.5-apache</span>
<span class="k">RUN </span>docker-php-ext-install bcmath sockets
<span class="k">COPY</span><span class="s"> app/ /var/www/html/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we are using a container for <strong>Messaging</strong> as well as one for <strong>Front End</strong>,
it would be easiest to use Docker Compose to bring them both up at the same
time. For that, we need to create a <code>docker-compose.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">front-end-demo/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">front-end</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_USER=${USER}</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_PASS=${PASS}</span>
    <span class="c1"># uncomment for development</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./app:/var/www/html"</span>
  <span class="na">messaging</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rabbitmq</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_DEFAULT_USER=${USER}</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_DEFAULT_PASS=${PASS}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how even though the <code>Dockerfile</code> copies the app files to <code>/var/www/html</code>
the <code>docker-compose.yml</code> still creates a bind mount. This allows us to actively
develop the PHP code while the container is running. When we are done
developing we can comment out the bind mount.</p>
</div>
<div class="paragraph">
<p>You may also notice that <code>docker-compose.yml</code> uses some environment variables.
It sets them in the container, which we have seen before, <em>and</em> it uses the
<code>USER</code> and <code>PASS</code> variables from its own environment. These variables are set
in the <code>.env</code> file, which Docker Compose reads by default:</p>
</div>
<div class="listingblock">
<div class="title">front-end-demo/.env</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">USER</span><span class="o">=</span><span class="s1">'front-end-demo'</span>
<span class="nv">PASS</span><span class="o">=</span><span class="s1">'changeme'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that our environment is set up. We can develop our PHP application. We start
by augmenting the example <code>RpcClient</code> class to use environment variables for
the username and password and <code>messaging</code> for the hostname. We will also add an
<code>send</code> method that sends JSON data.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Within the Docker Compose environment, service names will resolve to the IP
addresses of the container within that service. This makes service discovery
<em>much</em> easier.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Give some thought to what exchange format you want to use. Try to use
something that both <strong>Front End</strong> and <strong>Back End</strong> can support.
<a href="https://www.json.org/json-en.html">JSON</a> is currently the most common choice.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">front-end-demo/app/rpc_client.php</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">require_once</span> <span class="k">__DIR__</span> <span class="o">.</span> <span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">PhpAmqpLib\Connection\AMQPStreamConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">PhpAmqpLib\Message\AMQPMessage</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">RpcClient</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$connection</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$channel</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$callback_queue</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$response</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$corr_id</span><span class="p">;</span>

    <span class="k">public</span> <span class="nv">$timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$hostname</span> <span class="o">=</span> <span class="s1">'messaging'</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'MSG_USER'</span><span class="p">];</span>
        <span class="nv">$pass</span> <span class="o">=</span> <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'MSG_PASS'</span><span class="p">];</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AMQPStreamConnection</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hostname</span><span class="p">,</span>
            <span class="mi">5672</span><span class="p">,</span>
            <span class="nv">$user</span><span class="p">,</span>
            <span class="nv">$pass</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">channel</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">channel</span><span class="p">();</span>
        <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">callback_queue</span><span class="p">,</span> <span class="p">,)</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">channel</span><span class="o">-&gt;</span><span class="na">queue_declare</span><span class="p">(</span>
            <span class="s2">""</span><span class="p">,</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="kc">true</span><span class="p">,</span>
            <span class="kc">false</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">channel</span><span class="o">-&gt;</span><span class="na">basic_consume</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">callback_queue</span><span class="p">,</span>
            <span class="s1">''</span><span class="p">,</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="kc">true</span><span class="p">,</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="kc">false</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="nv">$this</span><span class="p">,</span>
                <span class="s1">'onResponse'</span>
            <span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">onResponse</span><span class="p">(</span><span class="nv">$rep</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$rep</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'correlation_id'</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">corr_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$rep</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">send</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">corr_id</span> <span class="o">=</span> <span class="nb">uniqid</span><span class="p">();</span>
        <span class="nv">$json</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'action'</span><span class="o">=&gt;</span><span class="nv">$action</span><span class="p">,</span> <span class="s1">'data'</span><span class="o">=&gt;</span><span class="nv">$data</span><span class="p">));</span>

        <span class="nv">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AMQPMessage</span><span class="p">(</span>
            <span class="nv">$json</span><span class="p">,</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">'correlation_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">corr_id</span><span class="p">,</span>
                <span class="s1">'reply_to'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">callback_queue</span>
            <span class="p">)</span>
        <span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">channel</span><span class="o">-&gt;</span><span class="na">basic_publish</span><span class="p">(</span><span class="nv">$msg</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">'requests'</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">channel</span><span class="o">-&gt;</span><span class="na">wait</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">timeout</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">response</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To test out our <code>RpcClient</code> class, let&#8217;s create a <code>action.php</code> endpoint that
takes a POST parameters of <code>action</code> and <code>data</code> and calls the send procedure with
those parameters:</p>
</div>
<div class="listingblock">
<div class="title">front-end-demo/app/action.php</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">require</span><span class="p">(</span><span class="s1">'rpc_client.php'</span><span class="p">);</span>

<span class="nv">$action</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'action'</span><span class="p">];</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">];</span>

<span class="k">echo</span> <span class="s2">"Establishing connection to messaging service... "</span><span class="p">;</span>
<span class="nv">$rpc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RpcClient</span><span class="p">();</span>
<span class="k">echo</span> <span class="s2">"[SUCCESS]&lt;br&gt;"</span><span class="p">;</span>

<span class="k">echo</span> <span class="s2">"Sending {action: </span><span class="se">\"</span><span class="nv">$action</span><span class="se">\"</span><span class="s2">, data: </span><span class="se">\"</span><span class="nv">$data</span><span class="se">\"</span><span class="s2">} to the send procedure and waiting for response..."</span><span class="p">;</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$rpc</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">"[SUCCESS]&lt;br&gt;"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"Response: &lt;br&gt;"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"&lt;pre&gt;"</span><span class="p">;</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$response</span><span class="p">);</span>
<span class="k">echo</span> <span class="s2">"&lt;/pre&gt;"</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll also need a basic form to test it out:</p>
</div>
<div class="listingblock">
<div class="title">front-end-demo/app/action.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/action.php"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"action"</span><span class="nt">&gt;</span>Action:<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"action"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"data"</span><span class="nt">&gt;</span>Data:<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"data"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Submit"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Try to avoid using GET parameters for these kinds of endpoints. It
makes it too easy for a third party to give a user (presumably authenticated)
an evil link that they can just click on and take an action, ie:
<a href="http://localhost:8080/action.php?action=DO+BAD+THINGS" class="bare">http://localhost:8080/action.php?action=DO+BAD+THINGS</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now with these components we should be able to run <code>docker-compose up</code> in our
<code>front-end-demo</code> directory, watch the services start up, and then open up
<a href="http://localhost:8080/action.html" class="bare">http://localhost:8080/action.html</a> to test the functionality:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS front-end-demo&gt;</span><span class="w"> </span>docker-compose up
<span class="go">Starting front-end-demo_web_1       ... done
Starting front-end-demo_messaging_1 ... done
Attaching to front-end-demo_messaging_1, front-end-demo_web_1
web_1        | AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 172.19.0.3. Set the 'ServerName' directive globally to suppress this message
web_1        | AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 172.19.0.3. Set the 'ServerName' directive globally to suppress this message
web_1        | [Thu May 14 01:24:32.120352 2020] [mpm_prefork:notice] [pid 1] AH00163: Apache/2.4.38 (Debian) PHP/7.4.5 configured -- resuming normal operations
web_1        | [Thu May 14 01:24:32.120940 2020] [core:notice] [pid 1] AH00094: Command line: 'apache2 -D FOREGROUND'
</span><span class="gp">messaging_1  | 2020-05-14 01:24:37.668 [info] &lt;0.9.0&gt;</span><span class="w"> </span>Feature flags: list of feature flags found:
<span class="gp">&lt;snip&gt;</span><span class="w">
</span><span class="gp">messaging_1  | 2020-05-14 01:24:38.252 [info] &lt;0.9.0&gt;</span><span class="w"> </span>Server startup <span class="nb">complete</span><span class="p">;</span> 0 plugins started.
<span class="go">messaging_1  |  completed with 0 plugins.
</span><span class="gp">web_1        | 172.19.0.1 - - [14/May/2020:01:36:09 +0000] "GET /action.html HTTP/1.1" 200 484 "-" "Mozilla/5.0 (Windows NT 10.0;</span><span class="w"> </span>Win64<span class="p">;</span> x64<span class="p">;</span> rv:76.0<span class="o">)</span> Gecko/20100101 Firefox/76.0<span class="s2">" <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="gp">web_1        | 172.19.0.1 - - [14/May/2020:01:36:09 +0000] "GET /favicon.ico HTTP/1.1" 404 489 "-" "Mozilla/5.0 (Windows NT 10.0;</span><span class="w"> </span><span class="s2">Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0"</span>
<span class="gp">messaging_1  | 2020-05-14 01:36:13.729 [info] &lt;0.1183.0&gt;</span><span class="w"> </span>accepting AMQP connection &lt;0.1183.0&gt; <span class="o">(</span>172.19.0.3:60104 -&gt; 172.19.0.2:5672<span class="o">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="gp">messaging_1  | 2020-05-14 01:36:13.731 [info] &lt;0.1183.0&gt;</span><span class="w"> </span>connection &lt;0.1183.0&gt; <span class="o">(</span>172.19.0.3:60104 -&gt; 172.19.0.2:5672<span class="o">)</span>: user <span class="s1">''</span>front-end-demo<span class="s1">''</span> authenticated and granted access to vhost <span class="s1">'/'</span>
<span class="gp">messaging_1  | 2020-05-14 01:36:23.756 [warning] &lt;0.1183.0&gt;</span><span class="w"> </span>closing AMQP connection &lt;0.1183.0&gt; <span class="o">(</span>172.19.0.3:60104 -&gt; 172.19.0.2:5672, vhost: <span class="s1">'/'</span>, user: <span class="s1">''</span>front-end-demo<span class="s1">''</span><span class="o">)</span>:
<span class="go">messaging_1  | client unexpectedly closed TCP connection <i class="conum" data-value="3"></i><b>(3)</b>
</span><span class="gp">web_1        | 172.19.0.1 - - [14/May/2020:01:36:13 +0000] "POST /action.php HTTP/1.1" 200 718 "http://localhost:8080/echo.html" "Mozilla/5.0 (Windows NT 10.0;</span><span class="w"> </span>Win64<span class="p">;</span> x64<span class="p">;</span> rv:76.0<span class="o">)</span> Gecko/20100101 Firefox/76.0<span class="s2">" <i class="conum" data-value="4"></i><b>(4)</b>
</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The front-end service will report the pages being served as you are testing it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The messaging service will show you the PHP code connecting.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>At some point we should make <code>RpcClient</code> shut down gracefully.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Because of how logging is handled, you may not see log messages in the order
you expect.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you test it, I used the ECHO action and the text "This is a test", you should
see the following output after 10 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plaintext">Establishing connection to messaging service... [SUCCESS] <i class="conum" data-value="1"></i><b>(1)</b>
Sending {action: "ECHO", data: "This is a test"} to the send procedure and waiting for response...[SUCCESS]
Fatal error: Uncaught PhpAmqpLib\Exception\AMQPTimeoutException: The connection timed out after 10 sec while awaiting incoming data in /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Wire/AMQPReader.php:141 Stack trace: #0 /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Wire/AMQPReader.php(163): PhpAmqpLib\Wire\AMQPReader-&gt;wait() #1 /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Wire/AMQPReader.php(106): PhpAmqpLib\Wire\AMQPReader-&gt;rawread(7) #2 /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Connection/AbstractConnection.php(566): PhpAmqpLib\Wire\AMQPReader-&gt;read(7) #3 /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Connection/AbstractConnection.php(623): PhpAmqpLib\Connection\AbstractConnection-&gt;wait_frame(10) #4 /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Channel/AbstractChannel.php(234): PhpAmqpLib\Connection\AbstractConnection-&gt;wait_channel(1, 10) #5 /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Channel/AbstractChannel.php(352): PhpAmqpLib\Channel\Abstrac in /var/www/html/vendor/php-amqplib/php-amqplib/PhpAmqpLib/Wire/AMQPReader.php on line 141 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We can connect to messaging, so we know that works</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>But there is nothing listening and responding to our RPC request&#8230;&#8203; yet.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_resources_7">7.3. Resources</h3>
<div class="sect3">
<h4 id="_python">7.3.1. Python</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://runnable.com/docker/python/dockerize-your-flask-application">Dockerize
Your Flask Application</a></p>
</li>
<li>
<p><a href="https://www.palletsprojects.com/p/flask/">Flask Web Framework</a></p>
</li>
<li>
<p><a href="https://www.rabbitmq.com/tutorials/tutorial-six-python.html">Python: RabbitMQ
Tutorial 6 - Remote Procedure Call</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_javascript">7.3.2. JavaScript</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://hub.docker.com/_/node/">node - Docker Hub</a></p>
</li>
<li>
<p><a href="https://www.rabbitmq.com/tutorials/tutorial-six-node.html">Node: RabbitMQ
Tutorial 6 - Remote Procedure Call</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_php">7.3.3. PHP</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://hub.docker.com/_/php">php - Docker Hub</a></p>
</li>
<li>
<p><a href="https://github.com/mlocati/docker-php-extension-installer">Easy installation
of PHP extensions in official PHP Docker images</a></p>
</li>
<li>
<p><a href="https://hub.docker.com/_/composer">composer - Docker Hub</a></p>
</li>
<li>
<p><a href="https://www.rabbitmq.com/tutorials/tutorial-six-php.html">PHP: RabbitMQ
Tutorial 6 - Remote Procedure Call</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_questions_7">7.4. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>Why are we using a messaging layer for communications to / from <strong>Front End</strong>?</em></p>
<p></p>
</li>
<li>
<p><em>What does RPC stand for and what is it?</em></p>
<p></p>
</li>
<li>
<p><em>What are the most important criteria when picking a language to develop a front end in?</em></p>
<p></p>
</li>
<li>
<p><em>Describe the most common package management option for <em>one</em> of the following environments: Python, PHP, or JavaScript.</em></p>
<p></p>
</li>
<li>
<p><em>How are environment variables used in Docker Compose and what kinds of things can they be used for?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_back_end">8. Back End</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/back-end.png" alt="back end" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction_4">8.1. Introduction</h3>
<div class="paragraph">
<p><strong>Back End</strong> is responsible for reading messages from <strong>Front End</strong>, storing
things in <strong>Database</strong>, and acquiring any other data needed. It has no
user-facing component, which spares us the trouble of having to run another
web server. Everything can basically be done with a single script.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_4">8.2. Example</h3>
<div class="paragraph">
<p>For this example we will be implementing a script in JavaScript that reads and
replies to messages via <strong>Messaging</strong>, reads and writes from / to <strong>Database</strong>, and
performs some web scraping. JavaScript is being used in contrast to our previous
<strong>Front End</strong> coding in PHP to highlight one of the benefits of having a
<strong>Messaging</strong> component: we can use different programming languages but still
share a common interface. This code is based off of the
<a href="https://www.rabbitmq.com/tutorials/tutorial-six-javascript.html">RabbitMQ
Javascript RPC Tutorial</a>.</p>
</div>
<div class="paragraph">
<p>As stated in <a href="#_front_end">Front End</a>, one of the most important parts of being able to
work with a programming language is knowing its how it handles package
mangement. For node (server-side Javascript), that&#8217;s the <a href="https://www.npmjs.com/">
Node Package Manager (NPM)</a>.  NPM utilizes a <code>package.json</code> file that tells it
what dependencies to install and how to run the application:</p>
</div>
<div class="listingblock">
<div class="title">back-end-demo/app/package.json</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"back-end"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Example back end for Systems Integration"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"server.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ryan Tolboom"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISC"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"amqplib"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.5.6"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"mariadb"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^2.3.1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we will be using amqplib to connect to <strong>Messaging</strong> and mariadb
to connect to <strong>Database</strong>.</p>
</div>
<div class="paragraph">
<p>It will also make our lives simpler if we create a custom Docker image that uses
npm to install the packages we need <em>before</em> our app is run. We will base our&#8217;s
off of the <a href="https://hub.docker.com/_/node/">official node image</a>:</p>
</div>
<div class="listingblock">
<div class="title">back-end-demo/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="dockerfile"><span class="k">FROM</span><span class="s"> node:12.16.2</span>
<span class="k">COPY</span><span class="s"> ./app/ /home/node/app</span>
<span class="k">WORKDIR</span><span class="s"> /home/node/app</span>
<span class="k">RUN </span>npm <span class="nb">install</span>
<span class="k">CMD</span><span class="s"> sh -c 'sleep 10; npm start'</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If <strong>Back End</strong> comes up before <strong>Messaging</strong> it will be unable to connect.
This can be handled in the code for the component,
<a href="https://docs.docker.com/compose/startup-order/">via a separate script</a>, or
simply by delaying the start of the component as shown on the CMD line above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, we will need a <code>docker-compose.yml</code> that brings up <strong>Messaging</strong>,
<strong>Database</strong>, <strong>Front End</strong>, <em>and</em> <strong>Back End</strong>, since <strong>Back End</strong> is the only
component that actually uses all three. You&#8217;ll notice we try not to repeat
ourselves by using images that have already been created in the other demos. As
we did <a href="#_front_end">previously</a>, we will be using environment variables to
store some configuration data. These variables can be found in <code>.env</code>.</p>
</div>
<div class="listingblock">
<div class="title">back-end-demo/.env</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">MSG_USER</span><span class="o">=</span>back-end-demo
<span class="nv">MSG_PASS</span><span class="o">=</span>changeme
<span class="nv">DB_ROOT_PASS</span><span class="o">=</span>changemetoo
<span class="nv">DB_USER</span><span class="o">=</span>car_user
<span class="nv">DB_PASS</span><span class="o">=</span>changemethree
<span class="nv">DB_DATABASE</span><span class="o">=</span>cars</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">back-end-demo/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">front-end</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">../front-end-demo</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">MSG_USER=${MSG_USER}</span>
      <span class="pi">-</span> <span class="s">MSG_PASS=${MSG_PASS}</span>
  <span class="na">messaging</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rabbitmq:3.8.3</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_DEFAULT_USER=${MSG_USER}</span>
      <span class="pi">-</span> <span class="s">RABBITMQ_DEFAULT_PASS=${MSG_PASS}</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">mariadb:10.5.3</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">MYSQL_USER=${DB_USER}</span>
      <span class="pi">-</span> <span class="s">MYSQL_PASSWORD=${DB_PASS}</span>
      <span class="pi">-</span> <span class="s">MYSQL_ROOT_PASSWORD=${DB_ROOT_PASS}</span>
      <span class="pi">-</span> <span class="s">MYSQL_DATABASE=${DB_DATABASE}</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">../db-demo:/docker-entrypoint-initdb.d"</span>
  <span class="na">back-end</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">NODE_ENV=development</span>
      <span class="pi">-</span> <span class="s">MSG_USER=${MSG_USER}</span>
      <span class="pi">-</span> <span class="s">MSG_PASS=${MSG_PASS}</span>
      <span class="pi">-</span> <span class="s">DB_USER=${DB_USER}</span>
      <span class="pi">-</span> <span class="s">DB_PASS=${DB_PASS}</span>
      <span class="pi">-</span> <span class="s">DB_DATABASE=${DB_DATABASE}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We use different (albiet bad) passwords for different services. Even
though no one outside our Docker network should be able to access these
services this is still a good idea.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our <strong>Back End</strong> script is a basic dispatcher that listens for commands in the
<strong>Messaging</strong> <code>requests</code> queue, performs actions, and responds via each message&#8217;s
exclusive reply-to queue:</p>
</div>
<div class="listingblock">
<div class="title">back-end-demo/app/server.js</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="js"><span class="cp">#!/usr/bin/env node
</span>
<span class="kd">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">https</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// Messaging configuration</span>
<span class="kd">const</span> <span class="nx">messaging_host</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">messaging</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">messaging_user</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MSG_USER</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">messaging_pass</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MSG_PASS</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">requests</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">messaging_url</span> <span class="o">=</span> <span class="s2">`amqp://</span><span class="p">${</span><span class="nx">messaging_user</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">messaging_pass</span><span class="p">}</span><span class="s2">@</span><span class="p">${</span><span class="nx">messaging_host</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">amqp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">amqplib/callback_api</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Database configuration</span>
<span class="kd">const</span> <span class="nx">db_host</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">db</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">db_user</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_USER</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">db_pass</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PASS</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">db_database</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_DATABASE</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">mariadb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mariadb/callback</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">db_pool</span> <span class="o">=</span> <span class="nx">mariadb</span><span class="p">.</span><span class="nx">createPool</span><span class="p">({</span><span class="na">host</span><span class="p">:</span> <span class="nx">db_host</span><span class="p">,</span> <span class="na">user</span><span class="p">:</span> <span class="nx">db_user</span><span class="p">,</span>
  <span class="na">password</span><span class="p">:</span> <span class="nx">db_pass</span><span class="p">,</span> <span class="na">database</span><span class="p">:</span> <span class="nx">db_database</span><span class="p">});</span>

<span class="kd">function</span> <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">channel</span><span class="p">.</span><span class="nx">sendToQueue</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">replyTo</span><span class="p">,</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">)),</span> <span class="p">{</span>
    <span class="na">correlationId</span><span class="p">:</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">correlationId</span>
  <span class="p">});</span>
  <span class="nx">channel</span><span class="p">.</span><span class="nx">ack</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">amqp</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">messaging_url</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error0</span><span class="p">,</span> <span class="nx">connection</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">error0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nx">error0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">createChannel</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error1</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nx">error1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">channel</span><span class="p">.</span><span class="nx">assertQueue</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">durable</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">});</span>
    <span class="nx">channel</span><span class="p">.</span><span class="nx">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Listening for requests...</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">channel</span><span class="p">.</span><span class="nx">consume</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">reply</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Received: </span><span class="p">${</span><span class="nx">msg</span><span class="p">.</span><span class="nx">content</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">received_json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">received_json</span><span class="p">[</span><span class="dl">'</span><span class="s1">action</span><span class="dl">'</span><span class="p">];</span>
      <span class="k">switch</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">ECHO</span><span class="dl">'</span><span class="p">:</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="nx">received_json</span><span class="p">[</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">];</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Echoing </span><span class="p">${</span><span class="nx">data</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
          <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">status</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OK</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">:</span> <span class="nx">data</span><span class="p">});</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">CARS</span><span class="dl">'</span><span class="p">:</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Returning a list of cars from the database</span><span class="dl">'</span><span class="p">);</span>
          <span class="nx">db_pool</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">status</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ERROR</span><span class="dl">'</span><span class="p">,</span>
                <span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">:</span> <span class="s2">`Unable to connect to database: </span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2">`</span><span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">conn</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="dl">"</span><span class="s2">SELECT * FROM car</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">status</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ERROR</span><span class="dl">'</span><span class="p">,</span>
                    <span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">:</span> <span class="s2">`Unable to execute query: </span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2">`</span><span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">status</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">OK</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">:</span> <span class="nx">rows</span><span class="p">});</span>
                <span class="p">}</span>
              <span class="p">});</span>
              <span class="nx">conn</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">});</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="dl">'</span><span class="s1">SCRAPE</span><span class="dl">'</span><span class="p">:</span>
          <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">received_json</span><span class="p">[</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">];</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Returning a list of events from NJ.com for </span><span class="p">${</span><span class="nx">date</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
          <span class="nx">https</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span>
            <span class="dl">'</span><span class="s1">https://www.nj.com/web/gateway.php?</span><span class="dl">'</span> <span class="o">+</span>
            <span class="dl">'</span><span class="s1">affil=nj&amp;site=default&amp;hidemap=1&amp;tpl=v3_regular_event_grid&amp;</span><span class="dl">'</span> <span class="o">+</span>
            <span class="s2">`date=</span><span class="p">${</span><span class="nx">date</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
            <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">);</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">json_data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
                <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">json_data</span><span class="p">);</span>
              <span class="p">});</span>
              <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
              <span class="p">});</span>
            <span class="p">});</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="nl">default</span><span class="p">:</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unknown action</span><span class="dl">'</span><span class="p">);</span>
          <span class="nx">send_response</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">status</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ERROR</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Unknown action</span><span class="dl">'</span><span class="p">});</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
You almost certainly want to cache replies that are network or
computationally intensive. The <code>SCRAPE</code> action is a good example of something
that could benefit from caching. Do you really need to reach out to NJ.com to
get the daily events <em>every</em> time? Perhaps they&#8217;re only updated every 24 hours.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Web scraping is notoriously difficult to keep up with. What happens if
NJ.com changes their endpoints? What happens if they detect excessive traffic
and decide to throttle your connections?
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see the three actions it current supports are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
ECHO
</td>
<td class="hdlist2">
<p>reply with whatever data was sent</p>
</td>
</tr>
<tr>
<td class="hdlist1">
CARS
</td>
<td class="hdlist2">
<p>get list of of cars from our database</p>
</td>
</tr>
<tr>
<td class="hdlist1">
SCRAPE
</td>
<td class="hdlist2">
<p>get a list of events from NJ.com for a date</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While these actions are not particularly useful as currently configured, they
do demonstrate the tasks that <strong>Back End</strong> needs to perform: reading / writing
from <strong>Messaging</strong>, reading / writing from <strong>Database</strong>, and obtaining additional
information from websites.</p>
</div>
<div class="paragraph">
<p>You should be able to run <code>docker-compose up</code> in the <code>back-end-demo</code> and test
actions with the <a href="http://localhost:8080/action.html" class="bare">http://localhost:8080/action.html</a> form. Try the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Action: <code>ECHO</code> Data: <code>This is a test</code></p>
</li>
<li>
<p>Action: <code>CARS</code> Data: ``</p>
</li>
<li>
<p>Action: <code>SCRAPE</code> Data: <code>2020-05-18</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Take note of the date format, it is the
<a href="https://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a> standard, very common in web
development. Also note that JSON is used as the exchange format, which can be
converted easily into native objects on <strong>Front End</strong> and <strong>Back End</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resources_8">8.3. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://hub.docker.com/_/node/">node - Docker Hub</a></p>
</li>
<li>
<p><a href="https://github.com/nodejs/docker-node/blob/master/README.md#how-to-use-this-image">
docker-node/README - How to use this image</a></p>
</li>
<li>
<p><a href="https://www.sitepoint.com/beginners-guide-node-package-manager/">Beginners
Guide to Node Package Manager</a></p>
</li>
<li>
<p><a href="https://github.com/mariadb-corporation/mariadb-connector-nodejs/blob/master/documentation/callback-api.md">
MariaDB Callback API Documentation</a></p>
</li>
<li>
<p><a href="https://nodejs.dev/making-http-requests-with-nodejs">Making HTTP Requests with
Node.js</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_8">8.4. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What is the common package manager for Node.js?</em></p>
<p></p>
</li>
<li>
<p><em>What three things does <strong>Back End</strong> have to do?</em></p>
<p></p>
</li>
<li>
<p><em>How do <strong>Back End</strong> and <strong>Front End</strong> communicate?</em></p>
<p></p>
</li>
<li>
<p><em>What is an exchange format and why is it important?</em></p>
<p></p>
</li>
<li>
<p><em>In this example, <strong>Back End</strong> is running in an event loop. What main event does it respond to?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_midterm_example">9. Midterm Example</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/all.png" alt="all" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction_5">9.1. Introduction</h3>
<div class="paragraph">
<p>This section summarizes the content so far and provides an example of a system
that implements basic the midterm milestones. This example is just one way to
build a system . It&#8217;s not the only way, in fact it&#8217;s not even the best way.
Your system will likely be quite different to meet the individual needs of your
project. The example&#8217;s purpose is to show you a solution that avoids common
pitfalls. Hopefully you can integrate some of the lessons of this example into
your project.</p>
</div>
<div class="paragraph">
<p>The project is structured in such a way that <strong>Front End</strong> and <strong>Back End</strong> never
communicate directly and <strong>Back End</strong> is the only service that can write to the
<strong>Database</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/overview_compose.svg" alt="overview compose" width="587" height="103">
</div>
</div>
<div class="paragraph">
<p>This allows for more scalability when we introduce replication in the second
half of the semester.</p>
</div>
<div class="paragraph">
<p>The entire example can be found in the <code>example-midterm</code> directory which has the
following directory structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   .env
   docker-compose.yml

back_end
       app.py
       Dockerfile
       requirements.txt

db
       Dockerfile
       setup.sql

front_end
       app.py
       Dockerfile
       requirements.txt
       wait-for-it.sh
    
    templates
            base.html
            login.html
            register.html</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Notice the <code>.env</code> file in the directory structure. docker-compose will
load environment variables from this file that you can then use in the
<code>docker-compose.yml</code> file. This keeps you from having to repeat yourself when
multiple services need the same information. For example, both <strong>Database</strong> and
<strong>Back End</strong> need to know the <code>POSTGRES_PASSWORD</code>. It also allows you to have a
single secret file that you can put in <code>.gitignore</code> to keep out of your
repository.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_messaging_2">9.2. Messaging</h3>
<div class="paragraph">
<p>In our example, the <strong>Messaging</strong> can be run straight from the
<a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Docker Hub image</a> via the
<code>docker-compose.yml</code> file, hence the absence of a <code>messaging</code> directory with a
<code>Dockerfile</code> in the directory structure. The image allows for sufficient
configuration via its environment variables. At this point it is recommended
that you still run the management interface and forward the management interface
port, 15672, so that you can see how the queues are being used. The messaging
service will be used in the
<a href="https://www.rabbitmq.com/tutorials/tutorial-six-python.html">request / reply pattern</a>
detailed in the diagram below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/messaging.svg" alt="messaging" width="349" height="293">
</div>
</div>
<div class="paragraph">
<p>Fortunately this works out-of-the-box since queue creation is handled by the
by the clients. The service simply has to be up and running to function.</p>
</div>
<div class="paragraph">
<p>The service definition in <code>docker-compose.yml</code> can be seen here:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml">    <span class="na">messaging</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">rabbitmq:3-management'</span>
        <span class="na">environment</span><span class="pi">:</span>
            <span class="na">RABBITMQ_DEFAULT_USER</span><span class="pi">:</span> <span class="s">${RABBITMQ_DEFAULT_USER}</span>
            <span class="na">RABBITMQ_DEFAULT_PASS</span><span class="pi">:</span> <span class="s">${RABBITMQ_DEFAULT_PASS}</span>
            <span class="na">RABBITMQ_ERLANG_COOKIE</span><span class="pi">:</span> <span class="s">${RABBITMQ_ERLANG_COOKIE}</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">15672:15672</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_database_2">9.3. Database</h3>
<div class="paragraph">
<p><strong>Database</strong> is responsible for storing the persistent information the system
uses. It only communicates with <strong>Back End</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/database.svg" alt="database" width="234" height="117">
</div>
</div>
<div class="paragraph">
<p>In this example, <strong>Database</strong> creates a database and the appropriate tables <em>if</em>
the database is currently empty. This can be done by placing the SQL file that
we want executed in <code>/docker-entrypoint-initdb.d/</code> of the image. Our
<code>example-midterm/db/Dockerfile</code> handles copying our initialization SQL
appropriately:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/db/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> postgres</span>
<span class="k">COPY</span><span class="s"> setup.sql /docker-entrypoint-initdb.d/</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">example-midterm/db/setup.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">example</span><span class="p">;</span>
<span class="err">\</span><span class="k">c</span> <span class="n">example</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span><span class="p">(</span>
    <span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">hash</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The schema in this example is quite simple, consisting of a database and a
single table for holding emails and hashes. It should be noted that the <code>\c</code>
command is specific to PostgreSQL and it is the equivalent of a <code>USE</code> statement
in MySQL, meaning <em>use</em> that particular database.</p>
</div>
<div class="paragraph">
<p>The relevant service definition in the <code>docker-compose.yml</code> file can be seen
here:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml">    <span class="na">db</span><span class="pi">:</span>
        <span class="na">build</span><span class="pi">:</span> <span class="s">./db</span>
        <span class="na">environment</span><span class="pi">:</span>
            <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">${POSTGRES_PASSWORD}</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">data-volume:/var/lib/postgresql/data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The database files are stored in a Docker volume named <code>data-volume</code> and the
password for our database is loaded from an environment variable defined in
<code>.env</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="https://hub.docker.com/_/adminer/">adminer</a> image is a great way to see
what&#8217;s going on in your database. It provides a web interface to many different
types of databases that can be easily accessed via port 8080. See the example
<code>docker-compose.yml</code> file for an example of its use.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_back_end_2">9.4. Back End</h3>
<div class="paragraph">
<p><strong>Back End</strong> brokers the exchange of information between <strong>Messaging</strong> and
<strong>Database</strong>. It also provides an area to perform the tasks needed to support the
complete system such as web scraping or computation. At this point, our example
does not include any of the latter and mainly focuses on storing / utilizing
authentication information in the database.</p>
</div>
<div class="paragraph">
<p>You can think of <strong>Back End</strong> as providing an API that is accessible through
<strong>Messaging</strong>. Any language can be a good choice for the <strong>Back End</strong> as long as it
has libraries to interface with <strong>Database</strong> and <strong>Messaging</strong>.</p>
</div>
<div class="dlist">
<div class="title">Popular Libraries used by <strong>Back End</strong></div>
<dl>
<dt class="hdlist1">Python</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.psycopg.org/">psycopg2</a> (PostgreSQL)</p>
</li>
<li>
<p><a href="https://dev.mysql.com/doc/connector-python/en/">mysql.connector</a> (MySQL / MariaDB)</p>
</li>
<li>
<p><a href="https://github.com/pika/pika">pika</a> (RabbitMQ)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">PHP</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.php.net/manual/en/book.mysqli.php">mysqli</a> (MySQL / MariaDB)</p>
</li>
<li>
<p><a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a> (RabbitMQ)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">JavaScript</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://node-postgres.com/">node-postgres</a> (PostgreSQL)</p>
</li>
<li>
<p><a href="https://mariadb.com/kb/en/getting-started-with-the-nodejs-connector/">mariadb</a> (MySQL / MariaDB)</p>
</li>
<li>
<p><a href="http://www.squaremobius.net/amqp.node/">amqplib</a> (RabbitMQ)</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="images/backend.svg" alt="backend" width="693" height="245">
</div>
</div>
<div class="paragraph">
<p>The code for the <strong>Back End</strong> example is entirely contained in
<code>example-midterm/back_end/app.py</code>. <strong>Back End</strong> starts by connecting to both
<strong>Messaging</strong> and <strong>Database</strong> using the pika and psycopg2 libraries respectively.
With Docker Compose you don&#8217;t know when the services will become available so
the example repeatedly attempts to connect, waiting up to 60 seconds and
<a href="https://en.wikipedia.org/wiki/Exponential_backoff">backing off exponentially</a>
each time. Below is an example of typical startup output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-midterm&gt;</span><span class="w"> </span>docker-compose logs <span class="nt">--tail</span><span class="o">=</span>100 back_end | Select-String <span class="nt">-Pattern</span> root
<span class="go">
back_end_1   | INFO:root:Waiting 1s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Waiting 2s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Waiting 4s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Waiting 8s...
back_end_1   | INFO:root:Connecting to the database...
back_end_1   | INFO:root:Connecting to messaging service...
back_end_1   | INFO:root:Starting consumption...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The example then creates the required database cursor, messaging channel,
messaging queues, and sets up a callback for messages arriving in the <code>requests</code>
queue. This is where the majority of work is performed and the function can be
seen here:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/back_end/app.py (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="s">"""
    Gets a request from the queue, acts on it, and returns a response to the
    reply-to queue
    """</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">'action'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">'message'</span><span class="p">:</span> <span class="s">"Request does not have action"</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">'GETHASH'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">'data'</span><span class="p">]</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
            <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"GETHASH request for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s"> received"</span><span class="p">)</span>
            <span class="n">curr</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT hash FROM users WHERE email=%s;'</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,))</span>
            <span class="n">row</span> <span class="o">=</span>  <span class="n">curr</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'hash'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s">'REGISTER'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">'data'</span><span class="p">]</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
            <span class="n">hashed</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'hash'</span><span class="p">]</span>
            <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"REGISTER request for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s"> received"</span><span class="p">)</span>
            <span class="n">curr</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * FROM users WHERE email=%s;'</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">curr</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'message'</span><span class="p">:</span> <span class="s">'User already exists'</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curr</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'INSERT INTO users VALUES (%s, %s);'</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">hashed</span><span class="p">))</span>
                <span class="n">conn</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'message'</span><span class="p">:</span> <span class="s">"Unknown action"</span><span class="p">}</span>
    <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
        <span class="n">routing_key</span><span class="o">=</span><span class="n">properties</span><span class="p">.</span><span class="n">reply_to</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Notice that psycopg2 functions are used to put variables into the SQL
statements. Do <strong>NOT</strong> use Python string formating to build your SQL statements.
You may be thinking that we are in <strong>Back End</strong> and the parameters we receive are
already <a href="https://xkcd.com/327/">sanitized</a> by <strong>Front End</strong> but this is not always
the case.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_front_end_2">9.5. Front End</h3>
<div class="paragraph">
<p><strong>Front End</strong> can be created using any web framework, but the most popular choices
are <a href="https://www.php.net">PHP</a> or <a href="https://palletsprojects.com/p/flask">Flask</a>. The
most popular Docker Hub images for those frameworks are
<a href="https://hub.docker.com/_/php">php:apache</a> and
<a href="https://hub.docker.com/_/python">python</a> respectively. For interacting with
<strong>Messaging</strong> there are a few options, but groups tend to gravitate towards
<a href="https://github.com/php-amqplib/php-amqplib">php-amqplib</a> for PHP and
<a href="https://github.com/pika/pika">pika</a> for Python Flask. This is probably due to
the fact that the
<a href="https://www.rabbitmq.com/getstarted.html">documentation for RabbitMQ</a> references
those libraries.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/frontend.svg" alt="frontend" width="505" height="264">
</div>
</div>
<div class="paragraph">
<p>A custom <code>example-midterm/front_end/Dockerfile</code> is used for creating the image:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/front_end/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> python</span>
<span class="k">COPY</span><span class="s"> . /app</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
<span class="k">ENV</span><span class="s"> FLASK_APP=app.py</span>
<span class="k">CMD</span><span class="s"> ["./wait-for-it.sh", "messaging:5672", "--", \</span>
     "flask", "run", "--host=0.0.0.0"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A script called <a href="https://github.com/vishnubob/wait-for-it"><code>wait-for-it.sh</code></a> is
included with the image. It is used
<a href="https://docs.docker.com/compose/startup-order/">as recommended by the Docker documentation</a>
to make sure <strong>Messaging</strong> is up before <strong>Front End</strong> starts. This way <strong>Front End</strong>
will not give errors to users who attempt to use it before the full system has
started.</p>
</div>
<div class="paragraph">
<p><code>example-midterm/front_end/Dockerfile</code> is built in the service section of the
<code>example-midterm/docker-compose.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml">    <span class="na">front_end</span><span class="pi">:</span>
        <span class="na">build</span><span class="pi">:</span> <span class="s">./front_end</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">5000:5000</span>
        <span class="na">environment</span><span class="pi">:</span>
            <span class="na">RABBITMQ_DEFAULT_USER</span><span class="pi">:</span> <span class="s">${RABBITMQ_DEFAULT_USER}</span>
            <span class="na">RABBITMQ_DEFAULT_PASS</span><span class="pi">:</span> <span class="s">${RABBITMQ_DEFAULT_PASS}</span>
            <span class="na">FLASK_ENV</span><span class="pi">:</span> <span class="s">development</span>
            <span class="na">FLASK_SECRET_KEY</span><span class="pi">:</span> <span class="s">${FLASK_SECRET_KEY}</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./front_end:/app"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a few things in this service definition that should be noted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Port <code>5000</code> needs to be forwarded as it will be accessed externally</p>
</li>
<li>
<p>The <code>FLASK_ENV</code> environment variable is useful for development. It causes
Flask to print more friendly error messages right inside the web browser.</p>
</li>
<li>
<p><code>front_end/</code> is bind mounted to <code>/app</code> in the container even though the
<code>Dockerfile</code> copies those files to the <code>/app</code> directory when the image is
created. This allows for easier development, the container can be running
while you edit the files Flask is using. The development server will
automatically restart if changes are detected.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To make communication with <strong>Messaging</strong> easier,
<code>example-midterm/front_end/messaging.py</code> defines a <code>Messaging</code> class that
initializes the connection, shuts down the connection, and provides a send and
receive function. All messages are sent to the general <code>requests</code> queue and
replies are returned via an exclusive reply queue.</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/front_end/messaging.py</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">Messaging</span><span class="p">:</span>
    <span class="s">"""
    Helper class for dealing with the messaging service
    """</span>
    <span class="n">request_queue_name</span> <span class="o">=</span> <span class="s">'request'</span>

    <span class="c1"># Get credentials from the environment
</span>    <span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'RABBITMQ_DEFAULT_USER'</span><span class="p">],</span>
                                        <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'RABBITMQ_DEFAULT_PASS'</span><span class="p">])</span>

    <span class="c1"># docker-compose will resolve this host to our messaging service
</span>    <span class="n">host</span> <span class="o">=</span> <span class="s">'messaging'</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Establishes connection and creates queues as needed
        """</span>
        <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Messaging: Establishing connection"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="p">.</span><span class="n">BlockingConnection</span><span class="p">(</span>
            <span class="n">pika</span><span class="p">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">credentials</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">connection</span><span class="p">.</span><span class="n">channel</span><span class="p">()</span>
        <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Messaging: Creating queues"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">request_queue_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">result_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">''</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">method</span><span class="p">.</span><span class="n">queue</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Closes down the connection
        """</span>
        <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Messaging: Closing down connection"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="s">"""
        Sends an action and data to the request queue in JSON. Sets the
        reply_to property to the custom result queue.
        """</span>
        <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"Messaging: send(action=</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s">, data=</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span>
            <span class="n">exchange</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
            <span class="n">routing_key</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">request_queue_name</span><span class="p">,</span>
            <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="p">.</span><span class="n">BasicProperties</span><span class="p">(</span>
                <span class="n">reply_to</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">result_queue</span><span class="p">),</span>
                <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'action'</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s">'data'</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Waits for a single message and returns it. Waits up to 1s, checking
        every 0.1s.
        """</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">method_frame</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">basic_get</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">result_queue</span><span class="p">,</span> <span class="n">auto_ack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method_frame</span><span class="p">:</span>
                <span class="n">received</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"Messaging: received=</span><span class="si">{</span><span class="n">received</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">received</span>
            <span class="k">elif</span> <span class="n">attempts</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Messaging: receive did not get message"</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Every HTTP request received by <strong>Front End</strong> will result in a full
connection sequence with <strong>Messaging</strong> which is not optimal. A
<a href="https://github.com/eandersson/python-rabbitmq-examples/blob/master/Flask-examples/pika_async_rpc_example.py">better solution</a>
is to have the <code>Messaging</code> class run in its own thread and maintain a permanent
connection.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at a registration sequence involving the <strong>User</strong>, <strong>Front End</strong>,
and <strong>Back End</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/registration.svg" alt="registration" width="481" height="283">
</div>
</div>
<div class="paragraph">
<p>The relevant code in <code>example-midterm/front_end/app.py</code> follows:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/front_end/app.py (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/register'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">'password'</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">messaging</span><span class="p">.</span><span class="n">Messaging</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">send</span><span class="p">(</span>
            <span class="s">'REGISTER'</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s">'email'</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
                <span class="s">'hash'</span><span class="p">:</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s">'success'</span><span class="p">]:</span>
            <span class="n">session</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">f"</span><span class="si">{</span><span class="n">response</span><span class="p">[</span><span class="s">'message'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'register.html'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Fortunately password hashing functions are readily available in the
<code>werkzeug.security</code> module. <a href="https://palletsprojects.com/p/werkzeug/">Werkzeug</a>
is a WSGI utility library that Flask already uses, so we don&#8217;t need to add
anything to <code>requirements.txt</code>. We can use the functions <code>check_password_hash</code>
and <code>generate_password_hash</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do <strong>NOT</strong> store user passwords in cleartext. There are plenty of good
hashing options in both PHP and Python. Try to minimize systems that come in
contact with unencrypted passwords as well. In this example it is hashed before
it is even passed to the <strong>Back End</strong>. For the same reason, in production your
users should only be able to connect via TLS (HTTPS). This will secure the
channel between <strong>User</strong> and <strong>Front End</strong> which passes the password when the user
registers or logs in.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>register</code> function will also set <code>email</code> in the user session upon
successful completion. This is akin to having a user log in automatically once
they have created an account.
<a href="https://flask.palletsprojects.com/en/1.1.x/api/#flask.session">Flask sessions</a>
are a good way of storing things on the client that can&#8217;t be modified. They
default to a lifetime of 31 days.</p>
</div>
<div class="paragraph">
<p>A similar sequence is used to log in a user:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/login.svg" alt="login" width="426" height="283">
</div>
</div>
<div class="paragraph">
<p>The relevant code in <code>example-midterm/front_end/app.py</code> follows:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/front_end/app.py (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">'password'</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">messaging</span><span class="p">.</span><span class="n">Messaging</span><span class="p">()</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">'GETHASH'</span><span class="p">,</span> <span class="p">{</span> <span class="s">'email'</span><span class="p">:</span> <span class="n">email</span> <span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s">'success'</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Login failed."</span>
        <span class="k">if</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">'hash'</span><span class="p">],</span> <span class="n">password</span><span class="p">):</span>
            <span class="n">session</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"Login failed."</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'login.html'</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Compared to the <code>register</code> function, handling a login is simpler. A few other
routes of interest with brief descriptions are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>/</code>
</td>
<td class="hdlist2">
<p>serves <code>index.html</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>/logout</code>
</td>
<td class="hdlist2">
<p>removes <code>email</code> from the user&#8217;s session and redirects to <code>/</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>/secret</code>
</td>
<td class="hdlist2">
<p>protected by the <code>@login_required</code> decorator (see below), serves
<code>secret.html</code></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://realpython.com/primer-on-python-decorators/">Python decorators</a> are used
for routing in Flask so it is a natural fit to use them to protect routes as
well. The <code>@login_required</code> decorator does exactly that:</p>
</div>
<div class="listingblock">
<div class="title">example-midterm/front_end/app.py (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="s">"""
    Decorator that returns a redirect if session['email'] is not set
    """</span>
    <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">'email'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/login'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated_function</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_questions_9">9.6. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What is the advantage of using a <code>.env</code> file and referencing it from docker-compose.yml?</em></p>
<p></p>
</li>
<li>
<p><em>Why do we store password <em>hashes</em> instead of just the passwords?</em></p>
<p></p>
</li>
<li>
<p><em>Why is port <code>5000</code> the only port that needs to be forwarded to the local host?</em></p>
<p></p>
</li>
<li>
<p><em>What does the <code>adminer</code> image do?</em></p>
<p></p>
</li>
<li>
<p><em>What role does <strong>Messaging</strong> play in this system?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_replication">10. Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replicating a service can provide many benefits. In this section we will
replicate a <a href="http://postgresql.org">PostgreSQL</a> database service to analyze the
advantages and complexity costs. PostgreSQL was purposefully chosen because it
leaves much of work, which is understandably outside the purview of a Database
Management System (DBMS), to the user. We will be using Docker compose so that
we do not have to introduce a new tool as well.</p>
</div>
<div class="sect2">
<h3 id="_background">10.1. Background</h3>
<div class="imageblock">
<div class="content">
<img src="images/replication.svg" alt="replication" width="199" height="140">
</div>
<div class="title">Figure 7. Basic Replication</div>
</div>
<div class="paragraph">
<p>In the simplest sense, replication is running more than one service for a given
component of our system. We can do this in Docker Compose by declaring more
than one service:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/docker-compose.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml">    <span class="na">db1</span><span class="pi">:</span>
        <span class="na">build</span><span class="pi">:</span> <span class="s">./db</span>
        <span class="na">environment</span><span class="pi">:</span>
            <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">asdffdsa</span>
            <span class="na">POSTGRES_REPLICA_PASSWORD</span><span class="pi">:</span> <span class="s">asdffdsa</span>
            <span class="na">POSTGRES_NODES</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db1</span><span class="nv"> </span><span class="s">db2"</span>
    <span class="na">db2</span><span class="pi">:</span>
        <span class="na">build</span><span class="pi">:</span> <span class="s">./db</span>
        <span class="na">environment</span><span class="pi">:</span>
            <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">asdffdsa</span>
            <span class="na">POSTGRES_REPLICA_PASSWORD</span><span class="pi">:</span> <span class="s">asdffdsa</span>
            <span class="na">POSTGRES_NODES</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db1</span><span class="nv"> </span><span class="s">db2"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A better solution would be to use a more complete orchestration solution
than Docker Compose. For syntax that you are used to, see
<a href="https://docs.docker.com/compose/compose-file/#deploy">the deploy option and
Docker Swarm</a>. You could also bite the bullet and migrate to
<a href="https://kubernetes.io">kubernetes</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In most DBMS, replication can be implemented via Volume Sharing or Hot / Warm
Standby:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/volshare.svg" alt="volshare" width="441" height="445">
</div>
<div class="title">Figure 8. Volume Sharing</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/standby.svg" alt="standby" width="510" height="311">
</div>
<div class="title">Figure 9. Hot / Warm Standby</div>
</div>
<div class="paragraph">
<p>Volume Sharing has the advantage of being easy to implement <em>if</em> you already
have network storage. You can scale simply by increasing the amount of
database instances (db3, db4, db5&#8230;&#8203;). Each instance has full read / write
access, making it easy to load balance. Despite that, reading / writing from
network storage tends to be a bottleneck. Also, shared access to files and the
issues that arise (file locking, etc.) are difficult problems. Your DBMS may
not be able to handle them. Even if they can be handled, performance can be an
issue. Lastly, this method puts all of your eggs in one basket with regard to
where your data is stored. There may be no duplicates of the data depending on
how you handle your network storage.</p>
</div>
<div class="paragraph">
<p>Hot / Warm Standby mode is typically already implemented by the DBMS. It is
usually performed via <em>Log Shipping</em>, sending logs of all actions between a
primary node and standby nodes. The standby nodes can keep up with transactions
and be <em>promoted</em> in the event of an issue. Each node maintains a separate data
volume. With this system, only the primary node is capable of performing write
operations. If the standby node is a <em>hot</em> standby node it can perform reads as
well. Fortunately, write operations tend to be less frequent that read
operations, meaning you may see significant performance gains from scaling with
this type of system.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
What&#8217;s the difference between a hot and warm standby? A hot standby can
perform read operations while replicating the primary. This allows for load
balancing to be performed. A warm standby simply keeps up with the primary so
that it can be brought up in the event of a problem.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_implementation">10.2. Implementation</h3>
<div class="paragraph">
<p>This example implements a
<a href="https://www.postgresql.org/docs/current/hot-standby.html">Hot Standby in PostgreSQL</a>.
Actually implementing <em>replication</em> is largely handled for us by the DMBS. It is
simply a matter of setting configuration variables, starting the databases are
in the correct state, and bringing up the services in the right order. We can
handle this in the <code>docker-entrypoint.sh</code> file that is used as the ENTRYPOINT
for the container. In the <a href="https://hub.docker.com/_/postgres">official Docker
image</a> this script is responsible for setting up the database and running the
user-specified command, <code>postgres</code> by default.</p>
</div>
<div class="paragraph">
<p>A basic Dockerfile that builds from this image and adds some extra needed
utilities will be used:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> postgres</span>
<span class="k">RUN </span>apt-get <span class="nt">-y</span> update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nt">-y</span> <span class="nb">install </span>iputils-ping dnsutils
<span class="k">COPY</span><span class="s"> docker-entrypoint.sh /usr/local/bin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rather than create separate primary and standby images, this example employs one
image that detects the status of the cluster on startup and creates either a
primary or standby node accordingly. The logic for startup is as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/startup_logic.svg" alt="startup logic" width="486" height="530">
</div>
</div>
<div class="paragraph">
<p>By passing a list of all nodes in an environment variable, we can create a bash
function to see who is up and who is the primary when <code>docker-entrypoint.sh</code> is
called at container creation:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="k">function </span>find_primary<span class="o">()</span> <span class="o">{</span>
    <span class="c"># Goes through all the nodes in POSTGRES_NODES and looks for one that is up</span>
    <span class="c"># and is a PRIMARY</span>
    <span class="nb">echo</span> <span class="s2">"Looking for a primary node..."</span>
    <span class="nv">PRIMARY</span><span class="o">=</span><span class="s2">""</span>
    <span class="k">for </span>NODE <span class="k">in</span> <span class="nv">$POSTGRES_NODES</span><span class="p">;</span> <span class="k">do
        </span><span class="nv">NODE_IP</span><span class="o">=</span><span class="si">$(</span> dig +short <span class="nv">$NODE</span> <span class="si">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="nv">$NODE_IP</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nv">$NODE_IP</span> <span class="o">!=</span> <span class="nv">$MY_IP</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="c"># https://stackoverflow.com/questions/11231937/bash-ignoring-error-for-a-particular-command</span>
            <span class="nv">EXIT_CODE</span><span class="o">=</span>0
            pg_isready <span class="nt">-h</span> <span class="nv">$NODE</span> <span class="o">||</span> <span class="nv">EXIT_CODE</span><span class="o">=</span><span class="nv">$?</span>
            <span class="k">if</span> <span class="o">[</span> <span class="nv">$EXIT_CODE</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
                </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$NODE</span><span class="s2">:5432:postgres:postgres:</span><span class="nv">$POSTGRES_PASSWORD</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> ~/.pgpass
                <span class="nv">VALUE</span><span class="o">=</span><span class="si">$(</span>psql <span class="nt">-U</span> postgres <span class="nt">-t</span> <span class="nt">-h</span> <span class="nv">$NODE</span> <span class="nt">-d</span> postgres <span class="nt">-c</span> <span class="s2">"select pg_is_in_recovery()"</span><span class="si">)</span>
                <span class="k">if</span> <span class="o">[</span> <span class="nv">$VALUE</span> <span class="o">==</span> <span class="s2">"f"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                    </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$NODE</span><span class="s2"> is primary node"</span>
                    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="nv">$PRIMARY</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                        </span><span class="nb">echo</span> <span class="s2">"Two primary nodes detected! Exiting..."</span>
                        <span class="nb">exit </span>1
                    <span class="k">fi
                    </span><span class="nv">PRIMARY</span><span class="o">=</span><span class="nv">$NODE</span>
                <span class="k">fi
            fi
        fi
    done</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a situation arises where there are two primaries on the network, this
function will prevent a new db container from being created. No sense adding to
the confusion.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now all that is left is to configure either a primary or a standby node.
The code to configure a primary node follows:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">    <span class="nb">echo</span> <span class="s2">"Configuring a PRIMARY instance..."</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$PGDATA</span><span class="s2">/PG_VERSION"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Database already exists, NOT creating a new one"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Creating a new database..."</span>

        initdb <span class="nt">--username</span><span class="o">=</span>postgres <span class="nt">--pwfile</span><span class="o">=</span>&lt;<span class="o">(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$POSTGRES_PASSWORD</span><span class="s2">"</span><span class="o">)</span>

        <span class="c"># Start a temporary server listening on localhost</span>
        pg_ctl <span class="nt">-D</span> <span class="s2">"</span><span class="nv">$PGDATA</span><span class="s2">"</span> <span class="nt">-w</span> start

        <span class="c"># Create a user for replication operations</span>
        psql <span class="nt">-v</span> <span class="nv">ON_ERROR_STOP</span><span class="o">=</span>1 <span class="nt">--username</span> <span class="s2">"</span><span class="nv">$POSTGRES_USER</span><span class="s2">"</span> <span class="nt">--dbname</span> <span class="s2">"</span><span class="nv">$POSTGRES_DB</span><span class="s2">"</span> <span class="o">&lt;&lt;</span> <span class="no">EOSQL</span><span class="sh">
            CREATE USER repuser REPLICATION LOGIN ENCRYPTED PASSWORD '</span><span class="nv">$POSTGRES_REPLICA_PASSWORD</span><span class="sh">';
</span><span class="no">EOSQL

</span>        <span class="c"># Stop the temporary server</span>
        pg_ctl <span class="nt">-D</span> <span class="s2">"</span><span class="nv">$PGDATA</span><span class="s2">"</span> <span class="nt">-m</span> fast <span class="nt">-w</span> stop

        <span class="c"># Set up authentication parameters</span>
        <span class="nb">echo</span> <span class="s2">"host replication all all md5"</span> <span class="o">&gt;&gt;</span> <span class="nv">$PGDATA</span>/pg_hba.conf
        <span class="nb">echo</span> <span class="s2">"host all all all md5"</span> <span class="o">&gt;&gt;</span> <span class="nv">$PGDATA</span>/pg_hba.conf
    <span class="k">fi</span>

    <span class="c"># if, for some reason, a cold standby is being brought up as a primary</span>
    <span class="c"># remove the standby.signal file</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="nv">$PGDATA</span>/standby.signal <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">rm</span> <span class="nv">$PGDATA</span>/standby.signal
    <span class="k">fi</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is self-explanatory, but it should be noted that the actual building
of the database, including auth configuration, and the create of a replication
user is a rare occurrence. That should only happen once when the volume is
initialized.</p>
</div>
<div class="paragraph">
<p>The code to configure a standby node is shown below:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">    <span class="nb">echo</span> <span class="s2">"Configuring a STANDBY instance..."</span>

    <span class="c"># Set up our password so we can connect to replicate</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$PRIMARY</span><span class="s2">:5432:replication:repuser:</span><span class="nv">$POSTGRES_REPLICA_PASSWORD</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /var/lib/postgresql/.pgpass

    <span class="c"># Clone the primary database</span>
    <span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$PGDATA</span>/<span class="k">*</span>
    pg_basebackup <span class="nt">-h</span> <span class="nv">$PRIMARY</span> <span class="nt">-D</span> <span class="nv">$PGDATA</span> <span class="nt">-U</span> repuser <span class="nt">-v</span> <span class="nt">-P</span> <span class="nt">-X</span> stream
    <span class="nb">chmod</span> <span class="nt">-R</span> 700 <span class="nv">$PGDATA</span>

    <span class="c"># Add connection info</span>
    <span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; </span><span class="nv">$PGDATA</span><span class="sh">/postgresql.conf
        primary_conninfo = 'host=</span><span class="nv">$PRIMARY</span><span class="sh"> port=5432 user=repuser password=</span><span class="nv">$POSTGRES_REPLICA_PASSWORD</span><span class="sh">'
</span><span class="no">EOF

</span>    <span class="c"># Notify postgres that this is a standby server</span>
    <span class="nb">touch</span> <span class="nv">$PGDATA</span>/standby.signal

    <span class="c"># Make sure there is a primary server and failover if there isn't</span>
    monitor &amp;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a standby is brought up, any database on the volume is removed and the
entire database from the primary is backed up You may want to revisit this
design decision if your database becomes large. Connection info is also added to
the end of <code>postgres.conf</code>. This does mean that if a standby is promoted the
previous connect line will be synced to any new standbys that are brought up.
This will result in an ever growing <code>postgres.conf</code> file. The monitor function
will be covered in the next section.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may notice that primaries and standbys have a very similar
configuration. This is by design in PostgreSQL &gt;= 12, to simplify the failover
procedure.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the relevant log messages of db1 and db2 when we bring them
both up with <code>docker-compose up</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">db1 - Looking for a primary node...
db1 - db2:5432 - no response
db1 - Configuring a PRIMARY instance...
db2 - Looking for a primary node...
db2 - db1:5432 - no response
db2 - Giving the first node a 10s head start...
db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node
db2 - Configuring a STANDBY instance...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen, db2 wasn&#8217;t able to detect db1 at first but the additional 10s
delay prevented a multiple-primary situation.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Having multiple primaries in a cluster is bad. So bad, that most
solutions implement a <a href="https://en.wikipedia.org/wiki/STONITH">STONITH</a> policy. It
is quite possibly the greatest acronym in all of technology.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Just because we have our database replicated on two volumes <strong>does not</strong>
mean that we have backups. Those volumes are designed to be used as part of a
running system and are not a reliable long-term solution. Create and implement
a reliable backup plan as you would for any other database.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_high_availability">10.3. High Availability</h3>
<div class="paragraph">
<p>Even though we now have a replicated database, it isn&#8217;t doing us much good. If
we want to make our database service highly available (HA) we will need to
monitor for problems and promote a standby server if the primary server fails.
This is referred to as <em>failover</em> and is often handled by a
<a href="https://wiki.clusterlabs.org/wiki/Pacemaker">a separate component</a>.  In this
simple example it is implemented in the <code>monitor</code> function shown below:</p>
</div>
<div class="listingblock">
<div class="title">replication-demo/db/docker-entrypoint.sh (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="k">function </span>monitor<span class="o">()</span> <span class="o">{</span>
    <span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do</span>
        <span class="c"># spread out our checks to avoid the chance of two nodes promoting at</span>
        <span class="c"># the same time</span>
        <span class="nv">WAIT</span><span class="o">=</span><span class="k">$((</span><span class="m">20</span> <span class="o">+</span> <span class="nv">$RANDOM</span> <span class="o">%</span> <span class="m">10</span><span class="k">))</span>
        <span class="nb">sleep</span> <span class="nv">$WAIT</span>
        find_primary
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="nv">$PRIMARY</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">echo</span> <span class="s2">"Can't find a primary failing over..."</span>
            pg_ctl promote
            <span class="c"># we don't need to monitor any more if we are the primary</span>
            <span class="nb">exit
        </span><span class="k">fi
    done</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This function is run in the background on every standby instance. The
timeout is randomized to decrease the likelihood that two standby instances
will promote themselves at exactly the same time. To better understand this,
let&#8217;s examine the <strong>non-randomized</strong> scenario shown in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/dualpromotion.svg" alt="dualpromotion" width="487" height="240">
</div>
<div class="title">Figure 10. Dual Promotion</div>
</div>
<div class="paragraph">
<p>In the above scenario each standby node is checking to see that there is a
primary node every 30s. The primary fails at 50s and <em>both</em> nodes check for a
primary at exactly 60s. At that moment, neither node is a primary, no primary
can be found, and they both begin the promotion process. This leaves the
cluster with two primary nodes. This can be largely avoided by randomizing
the check intervals.</p>
</div>
<div class="paragraph">
<p>Finally, lets simulate a failure and a recovery to see that our HA system is
working.  The following commands were executed and the Docker Compose logs were
captured.  Each command was run with about a minute pause between them:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>docker-compose up</code></p>
</li>
<li>
<p><code>docker-compose stop db1</code></p>
</li>
<li>
<p><code>docker-compose up db1</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The relevant, simplified log messages and descriptions follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">db2 - Looking for a primary node...
db1 - Looking for a primary node...
db2 - db1:5432 - no response
db1 - db2:5432 - no response
db2 - Giving the first node a 10s head start...
db1 - Configuring a PRIMARY instance...
db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node
db2 - Configuring a STANDBY instance...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both db1 and db2 are brought up at the same time. db1 ends up being
the primary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node
db2 - Looking for a primary node...
db2 - db1:5432 - accepting connections
db2 - db1 is primary node</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>db1 begins checking to make sure there is a primary node about every 30s.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">db1 - LOG:  shutting down
db2 - Looking for a primary node...
db2 - db1:5432 - no response
db2 - Can't find a primary failing over...
db2 - server promoted</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>db1 is shut down. db2 performs its regularly scheduled check and self promotes
because it cannot find a primary.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="go">db1 - Looking for a primary node...
db1 - db2:5432 - accepting connections
db1 - db2 is primary node
db1 - Configuring a STANDBY instance...
db1 - Looking for a primary node...
db1 - db2:5432 - accepting connections
db1 - db2 is primary node
db1 - Looking for a primary node...
db1 - db2:5432 - accepting connections
db1 - db2 is primary node</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>db1 is brought back up, finds another primary and makes itself a standby. db1
begins checking to make sure the primary is available at regular intervals.</p>
</div>
</div>
<div class="sect2">
<h3 id="_load_balancing">10.4. Load Balancing</h3>
<div class="paragraph">
<p>Another advantage to replication is the ability to split the work among
different nodes in the cluster. In our particular case, the primary node can
handle any request, while the standby node can only handle read requests. Since
we also control the application, we could create a connection for read requests
and a separate connection for write requests.</p>
</div>
<div class="paragraph">
<p>Fortunately this can be accomplished by
<a href="https://www.percona.com/blog/2019/10/23/seamless-application-failover-using-libpq-features-in-postgresql/">changing
the connect string that is used</a> in your application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="c1"># get a read / write connection
</span><span class="n">psycopg</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">database</span><span class="o">=</span><span class="s">"example"</span><span class="p">,</span>
    <span class="n">host</span><span class="o">=</span><span class="s">"db1,db2"</span><span class="p">,</span>
    <span class="n">user</span><span class="o">=</span><span class="s">"postgres"</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
    <span class="n">target_session_attrs</span><span class="o">=</span><span class="s">"read-write"</span>
<span class="p">)</span>

<span class="c1"># get a read connection
</span><span class="n">psycopg</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="n">database</span><span class="o">=</span><span class="s">"example"</span><span class="p">,</span>
    <span class="n">host</span><span class="o">=</span><span class="s">"db2,db1"</span><span class="p">,</span> <span class="c1"># order should be randomized
</span>    <span class="n">user</span><span class="o">=</span><span class="s">"postgres"</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
    <span class="n">target_session_attrs</span><span class="o">=</span><span class="s">"any"</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The other option is to employ a proxy to forward requests, the most popular
being <a href="http://www.haproxy.org/">HAProxy</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Load balancing is often referenced as a part of <em>horizontal scaling</em>.
You can think of horizontal scaling as adding more instances to serve requests.
<em>Vertical scaling</em> refers to making instances more powerful so that each
individual one can serve more requests.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_questions_10">10.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What are some of the issues with a volume sharing database?</em></p>
<p></p>
</li>
<li>
<p><em>Why does our example have a startup delay? What could happen if we brought all of the nodes up at the same time?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between high availability and load balancing?</em></p>
<p></p>
</li>
<li>
<p><em>What does a <em>hot</em> standby node do?</em></p>
<p></p>
</li>
<li>
<p><em>Our example starts up two nodes, but what would we have to change in our docker-compose.yml file if we wanted to start ten nodes? Is this congruent with the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">"Don&#8217;t Repeat Yourself" (DRY)</a> principle?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kubernetes">11. Kubernetes</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/k8s-logo.svg" alt="Kubernetes Logo" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction_6">11.1. Introduction</h3>
<div class="paragraph">
<p>Kubernetes is a container orchestration system originally designed by Google.
It is currently the most popular orchestration system and is notorious for
being difficult to learn. Fortunately, we have already covered most of the
concepts and the command syntax is similar to Docker.</p>
</div>
<div class="paragraph">
<p>A Kubernetes cluster is made up of nodes. Each node is capable of running
pods, which in turn are running containers:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/k8s_cluster.svg" alt="k8s cluster" width="714" height="262">
</div>
<div class="title">Figure 11. Kubernetes Cluster</div>
</div>
<div class="paragraph">
<p>Kubernetes is designed to solve the hard problems of multi-node deployment,
replication, volume sharing, container communication, updates, roll-backs,
service discovery and monitoring. It does this by defining objects and
providing an API to interact with them. Some of the first objects we will be
working with are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deployment</dt>
<dd>
<p>Defines how to handle the creation / maintenance of pods</p>
</dd>
<dt class="hdlist1">Service</dt>
<dd>
<p>Defines what pods offer to the cluster and how it should be accessed</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_minikube">11.2. Minikube</h3>
<div class="paragraph">
<p>For our purposes we will be using a single-node, local version of Kubernetes
called <a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">minikube</a>.
minikube acts as a single-node cluster by running Linux in a virtual machine on
the host. It provides a several options for how the VM is run:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/minikube_arch.svg" alt="minikube arch" width="645" height="451">
</div>
<div class="title">Figure 12. Minikube Architecture</div>
</div>
<div class="paragraph">
<p><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">Follow these directions
to install minikube.</a> There are a few virtualization options depending on the
OS that you are running.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have Docker Desktop running, minikube defaults to the Docker
driver. This driver is still experimental and may not work well. You can
explicitly specify another driver when you start minikube with the <code>--driver=</code>
option.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hyper-V and VirtualBox were still mutually exclusive in Windows at the
time of this writing. You will need to choose one or the other.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Hyper-V will require you to run your commands as an Administrator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When you start minikube, you should see output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; minikube start <span class="nt">--driver</span><span class="o">=</span>hyperv
<span class="k">*</span> minikube v1.9.0 on Microsoft Windows 10 Enterprise 10.0.18362 Build 18362
<span class="k">*</span> Using the hyperv driver based on existing profile
<span class="k">*</span> Retarting existing hyperv VM <span class="k">for</span> <span class="s2">"minikube"</span> ...
<span class="k">*</span> Preparing Kubernetes v1.18.0 on Docker 19.03.8 ...
<span class="k">*</span> Enabling addons: default-storageclass, storage-provisioner
<span class="k">*</span> Done! kubectl is now configured to use <span class="s2">"minikube"</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you get errors due to low memory, close a few applications and try
again. Typically you can restart the applications after minikube is running.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Kubernetes will attempt to pull all container images from a container
repository by default. To avoid having to upload our images to a repository, we
can set environment variables in our terminal so that we interact with the
Docker daemon <em>inside</em> our minikube virtual
machine.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> Fortunately, minikube has the
<code>docker-env</code> command to make this easier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; minikube docker-env | Invoke-Expression
PS minikube-demo&gt; docker ps
CONTAINER ID        IMAGE                  COMMAND                  CREATED
1bf91c2ca7df        4689081edb10           <span class="s2">"/storage-provisioner"</span>   7 minutes ago
a9866f5f5838        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago
03a4f7f5e320        67da37a9a360           <span class="s2">"/coredns -conf /etc"</span>   7 minutes ago
05061b993702        67da37a9a360           <span class="s2">"/coredns -conf /etc"</span>   7 minutes ago
78977b068886        43940c34f24f           <span class="s2">"/usr/local/bin/kube"</span>   7 minutes ago
b5312ba91086        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago
968acc692934        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago
0a72059bbe5f        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago
d9c5aa3d43d0        303ce5db0e90           <span class="s2">"etcd --advertise-cl"</span>   7 minutes ago
21b09398206f        74060cea7f70           <span class="s2">"kube-apiserver --ad"</span>   7 minutes ago
313982f14a1c        d3e55153f52f           <span class="s2">"kube-controller-man"</span>   7 minutes ago
35813d25f0bf        a31f78c7c8ce           <span class="s2">"kube-scheduler --au"</span>   7 minutes ago
e6cdb564a306        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago
b6bfe0e6f093        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago
da47e560edab        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago
3c599f97ecec        k8s.gcr.io/pause:3.2   <span class="s2">"/pause"</span>                 7 minutes ago</code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen from the output of the <code>docker ps</code> command, our Kubernetes
cluster is made up of many containers running in a VM. If you ran <code>docker ps</code>
without setting up the environment first, you would only see the containers you
had running on your local Docker daemon (which may actually be
<a href="https://inception.davepedu.com/">running on a VM itself</a> if you are using Docker
Toolbox).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>minikube</code> commands will work in a new terminal, but if you want to build
docker images and have them available on your Kubernetes cluster you will need
to use minikube&#8217;s docker-env command for each new terminal you open.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are experiencing errors with minikube, the first thing you should
try is running <code>minikube delete</code> and <code>minikube start --driver=&lt;your driver&gt;</code>.
This addresses the vast majority of issues by wiping all traces of the old VM,
creating a new one, and starting fresh.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>minikube includes a popular command line tool called kubectl. This is the
command that we will be using for interacting with our Kubernetes cluster. To
show that everything is working, lets create and build a basic Dockerfile that
should print some output to standard out:</p>
</div>
<div class="listingblock">
<div class="title">minikube-demo/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="Dockerfile">FROM alpine
ENTRYPOINT ["/bin/sh", "-c", "echo 'Hello from a Kubernetes log!'; sleep 30"]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; docker build <span class="nt">-t</span> k8s-example:v1 <span class="nb">.</span>
Sending build context to Docker daemon  2.048kB
Step 1/2 : FROM alpine
latest: Pulling from library/alpine
aad63a933944: Pull <span class="nb">complete
</span>Digest: sha256:b276d875eeed9c7d3f1cfa7edb06b22ed22b14219a7d67c52c56612330348239
Status: Downloaded newer image <span class="k">for </span>alpine:latest
 <span class="nt">---</span><span class="o">&gt;</span> a187dde48cd2
Step 2/2 : ENTRYPOINT <span class="o">[</span><span class="s2">"/bin/sh"</span>, <span class="s2">"-c"</span>, <span class="s2">"echo 'Hello from a Kubernetes log!'; sleep 30"</span><span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>96c1739d805e
Removing intermediate container 96c1739d805e
 <span class="nt">---</span><span class="o">&gt;</span> 7b9898952ce0
Successfully built 7b9898952ce0
Successfully tagged k8s-example:v1</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
We built our image with a tag <em>and</em> a version. You need the tag so you
can reference it from Kubernetes. If you don&#8217;t specify a version Kubernetes
will try to pull the <code>latest</code> from a repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we&#8217;ll create a deployment, which by default will make one pod that runs
your image. We also run the <code>get deployment</code> and <code>get pod</code> commands so we can
see the outcome. Lastly, we will inspect the logs for the pod that was created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; kubectl create deployment k8s-example <span class="nt">--image</span><span class="o">=</span>k8s-example:v1
deployment.apps/k8s-example created
PS minikube-demo&gt; kubectl get deployment
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
k8s-example   1/1     1            1           7s
PS minikube-demo&gt; kubectl get pod
NAME                           READY   STATUS    RESTARTS   AGE
k8s-example-5787cd97dc-ft2cr   1/1     Running   0          12s
PS minikube-demo&gt; kubectl logs k8s-example-5787cd97dc-ft2cr
Hello from a Kubernetes log!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our image is up and running, but remember that after 30 seconds it should exit.
As an orchestration system, Kubernetes defaults to restarting pods that have
stopped. Lets wait a while (14 minutes to be exact) and then execute the <code>get
pod</code> command again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; kubectl get pod
NAME                           READY   STATUS             RESTARTS   AGE
k8s-example-5787cd97dc-ft2cr   0/1     CrashLoopBackOff   6          14m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Kubernetes has restarted our pod six times now. In fact, it restarted it so
much that it is now waiting before trying again (<code>CrashLoopBackOff</code>). You now
have a minikube single-node Kubernetes cluster running on your local machine.
You can build custom Docker images and have them run on your cluster.</p>
</div>
<div class="paragraph">
<p>To bring everything down, use the <code>delete deployment</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; kubectl delete deployment k8s-example
deployment.apps <span class="s2">"k8s-example"</span> deleted
PS minikube-demo&gt; kubectl get pod
No resources found <span class="k">in </span>default namespace.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging">11.3. Debugging</h3>
<div class="paragraph">
<p>The official Kubernetes documentation has an
<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-service/">
excellent article</a> on debugging services. What follows are some tips they may
help reinforce or fill-in-the-blanks for topics in the article.</p>
</div>
<div class="paragraph">
<p>Two <code>kubectl</code> commands are especially useful for finding out more information
about an object:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kubectl get</code></dt>
<dd>
<p>gets brief information about an object or all of the objects of
that type</p>
</dd>
<dt class="hdlist1"><code>kubectl describe</code></dt>
<dd>
<p>gets more information about an object</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; kubectl get pod
NAME                           READY   STATUS    RESTARTS   AGE
k8s-example-5787cd97dc-fbrxl   1/1     Running   0          33s
PS minikube-demo&gt; kubectl describe pod k8s-example-5787cd97dc-fbrxl
Name:         k8s-example-5787cd97dc-fbrxl
Namespace:    default
Priority:     0
Node:         minikube/172.17.0.2
Start Time:   Mon, 13 Apr 2020 18:22:39 <span class="nt">-0400</span>
Labels:       <span class="nv">app</span><span class="o">=</span>k8s-example
              pod-template-hash<span class="o">=</span>5787cd97dc
Annotations:  &lt;none&gt;
Status:       Running
IP:           172.18.0.3
IPs:
  IP:           172.18.0.3
Controlled By:  ReplicaSet/k8s-example-5787cd97dc
Containers:
  k8s-example:
    Container ID:   docker://f22a1be8401f256c42c8c8ad82cf6757bc9e34ec7ae1fe0c4329fff57ff09bcb
    Image:          k8s-example:v1
    Image ID:       docker://sha256:374b52c1385d25269a05e9542e65690fe9dc00146b869580db8ab51b5027096a
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Mon, 13 Apr 2020 18:23:37 <span class="nt">-0400</span>
    Last State:     Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Mon, 13 Apr 2020 18:23:06 <span class="nt">-0400</span>
      Finished:     Mon, 13 Apr 2020 18:23:36 <span class="nt">-0400</span>
    Ready:          True
    Restart Count:  1
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5mgft <span class="o">(</span>ro<span class="o">)</span>
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-5mgft:
    Type:        Secret <span class="o">(</span>a volume populated by a Secret<span class="o">)</span>
    SecretName:  default-token-5mgft
    Optional:    <span class="nb">false
</span>QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="k">for </span>300s
                 node.kubernetes.io/unreachable:NoExecute <span class="k">for </span>300s
Events:
  Type     Reason     Age                From               Message
  <span class="nt">----</span>     <span class="nt">------</span>     <span class="nt">----</span>               <span class="nt">----</span>               <span class="nt">-------</span>
  Normal   Scheduled  &lt;unknown&gt;          default-scheduler  Successfully assigned default/k8s-example-5787cd97dc-fbrxl to minikube
  Normal   BackOff    62s                kubelet, minikube  Back-off pulling image <span class="s2">"k8s-example:v1"</span>
  Warning  Failed     62s                kubelet, minikube  Error: ImagePullBackOff
  Normal   Pulling    50s <span class="o">(</span>x2 over 62s<span class="o">)</span>  kubelet, minikube  Pulling image <span class="s2">"k8s-example:v1"</span>
  Warning  Failed     50s <span class="o">(</span>x2 over 62s<span class="o">)</span>  kubelet, minikube  Failed to pull image <span class="s2">"k8s-example:v1"</span>: rpc error: code <span class="o">=</span> Unknown desc <span class="o">=</span> Error
 response from daemon: pull access denied <span class="k">for </span>k8s-example, repository does not exist or may require <span class="s1">'docker login'</span>: denied: requested acc
ess to the resource is denied
  Warning  Failed     50s <span class="o">(</span>x2 over 62s<span class="o">)</span>  kubelet, minikube  Error: ErrImagePull
  Normal   Pulled     5s <span class="o">(</span>x2 over 36s<span class="o">)</span>   kubelet, minikube  Container image <span class="s2">"k8s-example:v1"</span> already present on machine
  Normal   Created    5s <span class="o">(</span>x2 over 36s<span class="o">)</span>   kubelet, minikube  Created container k8s-example
  Normal   Started    5s <span class="o">(</span>x2 over 36s<span class="o">)</span>   kubelet, minikube  Started container k8s-example</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see there, is lots of useful information here including a full
history of events that have occured.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Seeing <code>ErrImagePull</code> or <code>ImagePullBackOff</code> in the status section of
<code>kubectl get pod</code> is a common problem. Check to make sure you&#8217;ve set up your
environment correctly to use the Docker daemon <em>in</em> minikube and then try the
<code>docker pull &lt;image&gt;</code> command yourself. If Docker can&#8217;t pull it check to see
that you are connected to the network and if it&#8217;s a custom image check to see
that you built it. <code>docker images</code> will show you all of the images minikube can
access.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Many of the same techniques used for debugging Docker images can be used for
debugging Kubernetes objects. For example you can execute interactive commands
(including a shell) on running docker images with <code>kubectl exec -it</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS minikube-demo&gt; kubectl <span class="nb">exec</span> <span class="nt">-it</span> k8s-example-5787cd97dc-7j6cc <span class="nt">--</span> /bin/sh
/ <span class="c"># ps ax</span>
PID   USER     TIME  COMMAND
    1 root      0:00 <span class="nb">sleep </span>30
   11 root      0:00 /bin/sh
   16 root      0:00 ps ax
/ <span class="c"># ls</span>
bin    dev    etc    home   lib    media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var
/ <span class="c"># exit</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If, for some reason, an image does not start up, you can replace the ENTRYPOINT
of the Dockerfile from within the <code>template</code> definition of a <strong>Deployment</strong>. By
replacing it with something you know will work, you can then execute an
interactive shell in the container to see what is going on. The following is an
example of executing the sleep command, assuring that the pod will run for at
least an hour:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">kind: Deployment
metadata:
  name: db-rw
  labels:
    app: db-rw
spec:
  replicas: 1
  selector:
    matchLabels:
      app: db-rw
  template:
    metadata:
      labels:
        app: db-rw
    spec:
      containers:
        - name: db-rw
          image: postgres
          env:
            - name: POSTGRES_PASSWORD
              value: "changeme"
            - name: POSTGRES_REPLICA_PASSWORD
              value: "changeme"
          command: ["bash", "-c", "sleep 3600"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes your objects are applied, but no pods start up. This may mean
that Kubernetes started your <strong>Deployment</strong> or <strong>StatefulSet</strong> which created a
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/">
<strong>ReplicaSet</strong></a>, but the <strong>ReplicaSet</strong> was unable to start your pods. Try running
<code>kubectl get replicaset</code> to find which <strong>ReplicaSet</strong> is running and then
<code>kubectl describe replicaset &lt;replicaset_name&gt;</code> where &lt;replicaset_name&gt; is the
name of your <strong>ReplicaSet</strong>.</p>
</div>
<div class="paragraph">
<p>Finally, you may find yourself in a situation where you need to run <code>kubectl</code>
from within a pod. This can be helpful for sorting out role based access
control issues, namely "how can this pod interact with the Kubernetes API?"
<a href="https://itnext.io/running-kubectl-commands-from-within-a-pod-b303e8176088">
This guide</a> is a great resource. It largely boils down to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From within the pod (<code>kubectl exec -it &lt;pod-name&gt;&#8201;&#8212;&#8201;bash</code>) install curl:
<code>apt-get install curl</code>.</p>
</li>
<li>
<p>Download <code>kubectl</code>:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>VERSION=curl <a href="https://storage.googleapis.com/kubernetes-release/release/stable.txt" class="bare">https://storage.googleapis.com/kubernetes-release/release/stable.txt</a></code></p>
</li>
<li>
<p><code>curl -LO <a href="https://storage.googleapis.com/kubernetes-release/release/$VERSION/bin/linux/amd64/kubectl" class="bare">https://storage.googleapis.com/kubernetes-release/release/$VERSION/bin/linux/amd64/kubectl</a></code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Make it executable and install it:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>chmod +x ./kubectl</code></p>
</li>
<li>
<p><code>mv ./kubectl /usr/local/bin/</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">11.4. Conclusion</h3>
<div class="paragraph">
<p>Hopefully you can see the benefit of working with an orchestration framework.
While it may be daunting at first to learn all of the objects and to use new,
unfamiliar commands, Kubernetes does provide a lot of options for someone
looking to deploy scalable applications. Kubernetes has emerged as the
<a href="https://www.forbes.com/sites/udinachmany/2018/11/01/kubernetes-evolution-of-an-it-revolution/#67e70c2454e1">
de facto standard</a> and knowing how to use it is a <em>very</em> marketable skill.</p>
</div>
</div>
<div class="sect2">
<h3 id="_questions_11">11.5. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What is the role of a pod in Kubernetes?</em></p>
<p></p>
</li>
<li>
<p><em>What does a <strong>Deployment</strong> do?</em></p>
<p></p>
</li>
<li>
<p><em>What is minikube used for and what platforms can it run on?</em></p>
<p></p>
</li>
<li>
<p><em>If you were given an image to deploy on Kubernetes and it continually failed to start, what steps would you take to figure out what was going wrong?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database_in_kubernetes">12. Database in Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_7">12.1. Introduction</h3>
<div class="paragraph">
<p>In this example we implement a primary / standby replication setup for
PostgreSQL. Two <strong>Services</strong> will be provided: one for read/write requests and
another exclusively for read requests. We will try to use Kubernetes to handle
the initialization and monitoring functions that had to be done by hand in
<a href="#_replication">previously</a>.</p>
</div>
<div class="paragraph">
<p>Rather than passing command line options to the <code>kubectl</code> command, we will be
defining what we create in a YAML file: <code>example-final/db-k8s.yml</code>. kubectl can
load object definitions from YAML files with the <code>apply</code> command.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at the Kubernetes objects we are defining:</p>
</div>
</div>
<div class="sect2">
<h3 id="_persistentvolumeclaims">12.2. PersistentVolumeClaims</h3>
<div class="paragraph">
<p>A <strong>PersistentVolumeClaim</strong> lets the cluster know that you are expecting certain
storage resources. In this case, we are looking for a place to store our
primary database files. This claim will be fulfilled by a
<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/"><strong>StorageClass</strong></a>
that is built into minikube. As far as we are concerned, we just have to tell
it what we want and it will make it happen.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>.</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: db-primary-pv-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 512M</code></pre>
</div>
</div>
<div class="paragraph">
<p>This claim will be used by our <em>one</em> <code>db-rw</code> pod, so we don&#8217;t have to worry
about shared access. The supported accessModes are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ReadWriteOnce</strong> - can be mounted read / write by only one pod</p>
</li>
<li>
<p><strong>ReadOnlyMany</strong>  can be mounted read-only by many pods</p>
</li>
<li>
<p><strong>ReadWriteMany</strong>  can be mounted as read-write by many pods</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_services">12.3. Services</h3>
<div class="paragraph">
<p>A <strong>Service</strong> exposes an application on a group of pods. In our case we will be
providing two <strong>Services</strong>: a <code>db-rw</code> <strong>Service</strong> which connects to our primary
PostgreSQL instance and a <code>db-r</code> <strong>Service</strong> which connects to our standby
PostgreSQL instances. Unlike Docker Compose, even on our internal network we
have to explicitly state which ports we make available.</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: v1
kind: Service
metadata:
  name: db-rw
  labels:
    app: db-rw
spec:
  selector:
    app: db-rw
  ports:
    - protocol: TCP
      port: 5432

---
apiVersion: v1
kind: Service
metadata:
  name: db-r
  labels:
    app: db-r
spec:
  selector:
    app: db-r
  ports:
    - protocol: TCP
      port: 5432</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>selector</code> field above defines how a <strong>Service</strong> knows which pods to utilize.
In our case all pods with the app label <code>db-r</code> are used by the <code>db-r</code> <strong>Service</strong>
and a similar rule is applied to the <code>db-rw</code> <strong>Service</strong>. Both services accept
incoming connections on port 5432 and route those connections to 5432. In the
case where there are multiple pods in a <strong>Service</strong> a load balancing scheme is
used by default.</p>
</div>
<div class="paragraph">
<p>From a service discovery perspective, Kubernetes <strong>Services</strong> make things easier.
If you want to connect to a read-only database instance all you have to do is
use the hostname <code>db-r</code>. Similarly, if you want to connect to a read-write
database, use the hostname <code>db-rw</code>. The DNS resolution, load-balancing proxy,
and routing are set up automatically.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deployments">12.4. Deployments</h3>
<div class="paragraph">
<p>A <strong>Deployment</strong> tells Kubernetes how to create and monitor pods. The bulk of our
work will be done in the <code>db-r</code> and <code>db-rw</code> <strong>Deployments</strong>. Fortunately we have
already covered the logic of what needs to happen <a href="#_replication">previously</a>, so
let&#8217;s jump right in and take a look at the <strong>Deployment</strong> for our primary
PostgreSQL instance:</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db-rw
  labels:
    app: db-rw
spec:
  replicas: 1
  selector:
    matchLabels:
      app: db-rw
  template:
    metadata:
      labels:
        app: db-rw
    spec:
      containers:
        - name: db-rw
          image: postgres:12.2
          env:
            - name: POSTGRES_PASSWORD
              value: "changeme"
            - name: POSTGRES_REPLICA_PASSWORD
              value: "changeme"
          command:
            - bash
            - "-c"
            - |
              set -ex

              if [ -s "/var/lib/postgresql/data/PG_VERSION" ]; then
                echo "Database already exists, not creating a new one."
              else
                rm -rf /var/lib/postgresql/data/*
                chown postgres /var/lib/postgresql/data

                su -c "initdb --username=postgres --pwfile=&lt;(echo \"$POSTGRES_PASSWORD\")" postgres

                # Start a temporary server listening on localhost
                su -c "pg_ctl -D /var/lib/postgresql/data -w start" postgres

                # Create a user for replication operations and initialize our
                # example database
                psql -v ON_ERROR_STOP=1 --username postgres --dbname postgres &lt;&lt;EOF
                  CREATE USER repuser REPLICATION LOGIN ENCRYPTED PASSWORD '$POSTGRES_REPLICA_PASSWORD';
                  CREATE DATABASE example;
                  \c example
                  CREATE TABLE users(
                    email VARCHAR(255) PRIMARY KEY,
                    hash VARCHAR(255) NOT NULL
                  );
              EOF
              # ^ this EOF has to be in line with the YAML scalar block

                # Stop the temporary server
                su -c "pg_ctl -D /var/lib/postgresql/data -m fast -w stop" postgres

                # Set up authentication parameters
                echo "host replication all all md5" &gt;&gt; /var/lib/postgresql/data/pg_hba.conf
                echo "host all all all md5" &gt;&gt; /var/lib/postgresql/data/pg_hba.conf
              fi

              # Now run the server
              su -c postgres postgres
          volumeMounts:
            - name: db-primary-storage
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: db-primary-storage
          persistentVolumeClaim:
            claimName: db-primary-pv-claim</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ths <strong>Deployment</strong> tells Kubernetes to maintain one <code>replica</code> of the pod defined
in the <code>template</code> section. The <code>containers</code> section is a list of one container
that uses the <code>postgres</code> image from Docker Hub and overrides the ENTRYPOINT of
that Dockerfile (this is <code>command</code> in Kubernetespeak). Our script is taken
almost line-for-line from our <a href="#_replication">previous example</a>. Lastly, this
deployment makes use of our <strong>PersistentVolumeClaim</strong> defined previously and
mounts it in <code>/var/lib/postgresql/data</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the <strong>Deployment</strong> for our standby PostgreSQL instances:</p>
</div>
<div class="listingblock">
<div class="title">example-final/db-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db-r
  labels:
    app: db-r
spec:
  replicas: 2
  selector:
    matchLabels:
      app: db-r
  template:
    metadata:
      labels:
        app: db-r
    spec:
      containers:
        - name: db-r
          image: postgres:12.2
          env:
            - name: POSTGRES_REPLICA_PASSWORD
              value: "changeme"
          command:
            - bash
            - "-c"
            - |
              set -ex

              # Set up our password in .pgpass so we can connect to replicate
              # without a prompt
              echo "db-rw:5432:replication:repuser:$POSTGRES_REPLICA_PASSWORD" &gt;&gt; /var/lib/postgresql/.pgpass
              chown postgres /var/lib/postgresql/.pgpass
              chmod 600 /var/lib/postgresql/.pgpass

              # we may start before their are WALs, so we need to make this directory
              mkdir -p /var/lib/postgresql/data/pg_wal
              chown postgres /var/lib/postgresql/data/pg_wal

              # Clone the database from db-rw
              rm -rf /var/lib/postgresql/data/*
              chown postgres /var/lib/postgresql/data
              chmod -R 700 /var/lib/postgresql/data
              su -c "pg_basebackup -h db-rw -D /var/lib/postgresql/data -U repuser -w -v -P -X stream" postgres

              # Add connection info
              cat &lt;&lt; EOF &gt;&gt; /var/lib/postgresql/data/postgresql.conf
                primary_conninfo = 'host=db-rw port=5432 user=repuser password=$POSTGRES_REPLICA_PASSWORD'
              EOF

              # Notify postgres that this is a standby server
              touch /var/lib/postgresql/data/standby.signal

              # Now run the server
              su -c postgres postgres</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <strong>Deployment</strong> stands up two replicas. Each replica clones the primary
database (using the hostname <code>db-rw</code> provided by our <code>db-rw</code> <strong>Service</strong>) and then
acts as a hot standby. A <strong>PersistentVolumeClaim</strong> is <em>not</em> used, meaning if push
came to shove, we may not be able to easily recover the database from one of
these containers.</p>
</div>
<div class="paragraph">
<p>Notice that neither <strong>Deployment</strong> has to search for the primary or monitor the
other instances. Kubernetes handles this for us. In fact, the standbys don&#8217;t
even have to wait for the primary to be up. If they can&#8217;t clone the database,
they will fail and Kubernetes will restart them until they work.</p>
</div>
<div class="paragraph">
<p>Much of the hard work of our <a href="#_replication">earlier example</a> is now handled for
us by a <em>proper</em> orchestration framework.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_example">12.5. Running the Example</h3>
<div class="paragraph">
<p>Let&#8217;s take a look at the example in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl apply <span class="nt">-f</span> .<span class="se">\d</span>b-k8s.yml
persistentvolumeclaim/db-primary-pv-claim created
service/db-rw created
service/db-r created
deployment.apps/db-rw created
deployment.apps/db-r created</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kubectl apply -f</code> command can be used to bring up all of the objects
defined in a file. It should also be noted that it can work with an entire
directory of files, allowing for separation of logical segments, unlike a
<code>docker-compose.yml</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
db-r-54d9bc6496-cjhn8    1/1     Running   1          2m31s
db-r-54d9bc6496-pg8b2    1/1     Running   0          2m31s
db-rw-6fd7767ddd-g6kvj   1/1     Running   0          2m31s</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>kubectl get pod</code> show you all of the pods that are currently running. All of
the pods in our deployment are now up. They are given hash codes for the second
part of their name to keep them unique. You may notice that
<code>db-r-54d9bc6496-cjhn8</code> had to be restarted once. It probably came up before
<code>db-rw-6fd7767ddd-g6kvj</code> was ready to have its database cloned.</p>
</div>
<div class="paragraph">
<p>Using the command <code>kubectl logs</code> we can get the logs for a pod. Let&#8217;s take a
look at our primary PostgreSQL instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl logs db-rw-6fd7767ddd-g6kvj
+ <span class="s1">'['</span> <span class="nt">-s</span> /var/lib/postgresql/PG_VERSION <span class="s1">']'</span>
+ <span class="nb">rm</span> <span class="nt">-rf</span> <span class="s1">'/var/lib/postgresql/data/*'</span>
+ <span class="nb">chown </span>postgres /var/lib/postgresql/data
+ su <span class="nt">-c</span> <span class="s1">'initdb --username=postgres --pwfile=&lt;(echo "changeme")'</span> postgres
The files belonging to this database system will be owned by user <span class="s2">"postgres"</span><span class="nb">.</span>
This user must also own the server process.

The database cluster will be initialized with locale <span class="s2">"en_US.utf8"</span><span class="nb">.</span>
The default database encoding has accordingly been <span class="nb">set </span>to <span class="s2">"UTF8"</span><span class="nb">.</span>
The default text search configuration will be <span class="nb">set </span>to <span class="s2">"english"</span><span class="nb">.</span>

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/data ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default <span class="nb">time </span>zone ... Etc/UTC
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
initdb: warning: enabling <span class="s2">"trust"</span> authentication <span class="k">for </span><span class="nb">local </span>connections
You can change this by editing pg_hba.conf or using the option <span class="nt">-A</span>, or
<span class="nt">--auth-local</span> and <span class="nt">--auth-host</span>, the next <span class="nb">time </span>you run initdb.
syncing data to disk ... ok


Success. You can now start the database server using:

    pg_ctl <span class="nt">-D</span> /var/lib/postgresql/data <span class="nt">-l</span> logfile start

+ su <span class="nt">-c</span> <span class="s1">'pg_ctl -D /var/lib/postgresql/data -w start'</span> postgres
waiting <span class="k">for </span>server to start....2020-04-06 01:34:45.086 UTC <span class="o">[</span>27] LOG:  starting PostgreSQL 12.2 <span class="o">(</span>Debian 12.2-2.pgdg100+1<span class="o">)</span> on x86_64
<span class="nt">-pc-linux-gnu</span>, compiled by gcc <span class="o">(</span>Debian 8.3.0-6<span class="o">)</span> 8.3.0, 64-bit
2020-04-06 01:34:45.086 UTC <span class="o">[</span>27] LOG:  listening on IPv4 address <span class="s2">"0.0.0.0"</span>, port 5432
2020-04-06 01:34:45.086 UTC <span class="o">[</span>27] LOG:  listening on IPv6 address <span class="s2">"::"</span>, port 5432
2020-04-06 01:34:45.091 UTC <span class="o">[</span>27] LOG:  listening on Unix socket <span class="s2">"/var/run/postgresql/.s.PGSQL.5432"</span>
2020-04-06 01:34:45.104 UTC <span class="o">[</span>28] LOG:  database system was shut down at 2020-04-06 01:34:44 UTC
2020-04-06 01:34:45.109 UTC <span class="o">[</span>27] LOG:  database system is ready to accept connections
 <span class="k">done
</span>server started
+ psql <span class="nt">-v</span> <span class="nv">ON_ERROR_STOP</span><span class="o">=</span>1 <span class="nt">--username</span> postgres <span class="nt">--dbname</span> postgres
CREATE ROLE
+ su <span class="nt">-c</span> <span class="s1">'pg_ctl -D /var/lib/postgresql/data -m fast -w stop'</span> postgres
waiting <span class="k">for </span>server to shut down....2020-04-06 01:34:45.238 UTC <span class="o">[</span>27] LOG:  received fast shutdown request
2020-04-06 01:34:45.242 UTC <span class="o">[</span>27] LOG:  aborting any active transactions
2020-04-06 01:34:45.244 UTC <span class="o">[</span>27] LOG:  background worker <span class="s2">"logical replication launcher"</span> <span class="o">(</span>PID 34<span class="o">)</span> exited with <span class="nb">exit </span>code 1
2020-04-06 01:34:45.244 UTC <span class="o">[</span>29] LOG:  shutting down
2020-04-06 01:34:45.275 UTC <span class="o">[</span>27] LOG:  database system is shut down
 <span class="k">done
</span>server stopped
+ <span class="nb">echo</span> <span class="s1">'host replication all all md5'</span>
+ <span class="nb">echo</span> <span class="s1">'host all all all md5'</span>
+ su <span class="nt">-c</span> postgres postgres
2020-04-06 01:34:45.362 UTC <span class="o">[</span>46] LOG:  starting PostgreSQL 12.2 <span class="o">(</span>Debian 12.2-2.pgdg100+1<span class="o">)</span> on x86_64-pc-linux-gnu, compiled by gcc
<span class="o">(</span>Debian 8.3.0-6<span class="o">)</span> 8.3.0, 64-bit
2020-04-06 01:34:45.363 UTC <span class="o">[</span>46] LOG:  listening on IPv4 address <span class="s2">"0.0.0.0"</span>, port 5432
2020-04-06 01:34:45.363 UTC <span class="o">[</span>46] LOG:  listening on IPv6 address <span class="s2">"::"</span>, port 5432
2020-04-06 01:34:45.368 UTC <span class="o">[</span>46] LOG:  listening on Unix socket <span class="s2">"/var/run/postgresql/.s.PGSQL.5432"</span>
2020-04-06 01:34:45.383 UTC <span class="o">[</span>47] LOG:  database system was shut down at 2020-04-06 01:34:45 UTC
2020-04-06 01:34:45.388 UTC <span class="o">[</span>46] LOG:  database system is ready to accept connections</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as <a href="#_replication">before</a>, the primary node initialized a database, set
up a replication user, and started <code>postgres</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at one of the standby nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl logs db-r-54d9bc6496-cjhn8
+ <span class="nb">echo </span>db-rw:5432:replication:repuser:changeme
+ <span class="nb">chown </span>postgres /var/lib/postgresql/.pgpass
+ <span class="nb">chmod </span>600 /var/lib/postgresql/.pgpass
+ <span class="nb">mkdir</span> <span class="nt">-p</span> /var/lib/postgresql/data/pg_wal
+ <span class="nb">chown </span>postgres /var/lib/postgresql/data/pg_wal
+ <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/postgresql/data/pg_wal
+ <span class="nb">chown </span>postgres /var/lib/postgresql/data
+ <span class="nb">chmod</span> <span class="nt">-R</span> 700 /var/lib/postgresql/data
+ su <span class="nt">-c</span> <span class="s1">'pg_basebackup -h db-rw -D /var/lib/postgresql/data -U repuser -w -v -P -X stream'</span> postgres
pg_basebackup: initiating base backup, waiting <span class="k">for </span>checkpoint to <span class="nb">complete
</span>pg_basebackup: checkpoint completed
pg_basebackup: write-ahead log start point: 0/3000028 on timeline 1
pg_basebackup: starting background WAL receiver
pg_basebackup: created temporary replication slot <span class="s2">"pg_basebackup_57"</span>
    0/24554 kB <span class="o">(</span>0%<span class="o">)</span>, 0/1 tablespace <span class="o">(</span>...lib/postgresql/data/backup_label<span class="o">)</span>
24564/24564 kB <span class="o">(</span>100%<span class="o">)</span>, 0/1 tablespace <span class="o">(</span>...ostgresql/data/global/pg_control<span class="o">)</span>
24564/24564 kB <span class="o">(</span>100%<span class="o">)</span>, 1/1 tablespace
pg_basebackup: write-ahead log end point: 0/3000100
pg_basebackup: waiting <span class="k">for </span>background process to finish streaming ...
pg_basebackup: syncing data to disk ...
pg_basebackup: base backup completed
+ <span class="nb">cat</span>
+ <span class="nb">touch</span> /var/lib/postgresql/data/standby.signal
+ su <span class="nt">-c</span> postgres postgres
2020-04-06 01:34:47.283 UTC <span class="o">[</span>18] LOG:  starting PostgreSQL 12.2 <span class="o">(</span>Debian 12.2-2.pgdg100+1<span class="o">)</span> on x86_64-pc-linux-gnu, compiled by gcc
<span class="o">(</span>Debian 8.3.0-6<span class="o">)</span> 8.3.0, 64-bit
2020-04-06 01:34:47.283 UTC <span class="o">[</span>18] LOG:  listening on IPv4 address <span class="s2">"0.0.0.0"</span>, port 5432
2020-04-06 01:34:47.283 UTC <span class="o">[</span>18] LOG:  listening on IPv6 address <span class="s2">"::"</span>, port 5432
2020-04-06 01:34:47.289 UTC <span class="o">[</span>18] LOG:  listening on Unix socket <span class="s2">"/var/run/postgresql/.s.PGSQL.5432"</span>
2020-04-06 01:34:47.304 UTC <span class="o">[</span>19] LOG:  database system was interrupted<span class="p">;</span> last known up at 2020-04-06 01:34:46 UTC
2020-04-06 01:34:47.442 UTC <span class="o">[</span>19] LOG:  entering standby mode
2020-04-06 01:34:47.446 UTC <span class="o">[</span>19] LOG:  redo starts at 0/3000028
2020-04-06 01:34:47.449 UTC <span class="o">[</span>19] LOG:  consistent recovery state reached at 0/3000100
2020-04-06 01:34:47.449 UTC <span class="o">[</span>18] LOG:  database system is ready to accept <span class="nb">read </span>only connections
2020-04-06 01:34:47.455 UTC <span class="o">[</span>23] LOG:  started streaming WAL from primary at 0/4000000 on timeline 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This standby backed up the primary database and started streaming logs from the
primary.</p>
</div>
<div class="paragraph">
<p>The <code>kubectl exec</code> command lets you execute a command on a running pod. Lets
use this to run psql on one of the standbys, connect to the primary, create
a table, and then check to see if it shows up on the standbys:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl <span class="nb">exec</span> <span class="nt">-it</span> db-r-54d9bc6496-pg8b2 <span class="nt">--</span> bash
root@db-r-54d9bc6496-pg8b2:/# psql <span class="nt">-h</span> db-rw <span class="nt">-U</span> postgres
Password <span class="k">for </span>user postgres:
psql <span class="o">(</span>12.2 <span class="o">(</span>Debian 12.2-2.pgdg100+1<span class="o">))</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="nv">postgres</span><span class="o">=</span><span class="c"># \dt</span>
Did not find any relations.
<span class="nv">postgres</span><span class="o">=</span><span class="c"># CREATE TABLE test(test_column INTEGER);</span>
CREATE TABLE
<span class="nv">postgres</span><span class="o">=</span><span class="c"># \dt</span>
        List of relations
 Schema | Name | Type  |  Owner
<span class="nt">--------</span>+------+-------+----------
 public | <span class="nb">test</span> | table | postgres
<span class="o">(</span>1 row<span class="o">)</span>

<span class="nv">postgres</span><span class="o">=</span><span class="c"># \q</span>
root@db-r-54d9bc6496-pg8b2:/# psql <span class="nt">-h</span> db-r <span class="nt">-U</span> postgres
Password <span class="k">for </span>user postgres:
psql <span class="o">(</span>12.2 <span class="o">(</span>Debian 12.2-2.pgdg100+1<span class="o">))</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="nv">postgres</span><span class="o">=</span><span class="c"># \dt</span>
        List of relations
 Schema | Name | Type  |  Owner
<span class="nt">--------</span>+------+-------+----------
 public | <span class="nb">test</span> | table | postgres
<span class="o">(</span>1 row<span class="o">)</span>

<span class="nv">postgres</span><span class="o">=</span><span class="c"># \q</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sure enough, anything we create on the primary (which we access by resolving
the name <code>db-rw</code> shows up on the standby. Now lets try performing a write
operation on a standby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">root@db-r-54d9bc6496-pg8b2:/# psql <span class="nt">-h</span> db-r <span class="nt">-U</span> postgres
Password <span class="k">for </span>user postgres:
psql <span class="o">(</span>12.2 <span class="o">(</span>Debian 12.2-2.pgdg100+1<span class="o">))</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="nv">postgres</span><span class="o">=</span><span class="c"># CREATE TABLE test2(test_column INTEGER);</span>
ERROR:  cannot execute CREATE TABLE <span class="k">in </span>a read-only transaction</code></pre>
</div>
</div>
<div class="paragraph">
<p>It fails, as it should. Lets take a look at how <strong>Services</strong> glue all of this
together with the <code>kubectl get service</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl get service
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
db-r         ClusterIP   10.106.33.23    &lt;none&gt;        5432/TCP   41m
db-rw        ClusterIP   10.99.113.228   &lt;none&gt;        5432/TCP   41m
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    35h</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>db-r</code> and <code>db-rw</code> are <strong>Services</strong>, so if a pod tries to resolve on of those
names, they will get the CLUSTER-IP (10.106.33.23 and 10.99.113.228
respectively). That ClusterIP is a proxy that will forward their request to
a pod that can handle it. This allows for load-balancing and high availability.</p>
</div>
<div class="paragraph">
<p>On the subject of HA, the last thing we have to check is that pods will be
automatically restarted. Let&#8217;s do something bad to one of our pods with the
<code>kubectl exec</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl <span class="nb">exec</span> <span class="nt">-it</span> db-rw-6fd7767ddd-g6kvj <span class="nt">--</span> bash
root@db-rw-6fd7767ddd-g6kvj:/# killall5 <span class="nt">-9</span>
<span class="nb">command </span>terminated with <span class="nb">exit </span>code 137
PS C:<span class="se">\U</span>sers<span class="se">\r</span>xt1077<span class="se">\i</span>t490<span class="se">\e</span>xample-final&gt; kubectl get pods
NAME                     READY   STATUS    RESTARTS   AGE
db-r-54d9bc6496-cjhn8    1/1     Running   1          48m
db-r-54d9bc6496-pg8b2    1/1     Running   0          48m
db-rw-6fd7767ddd-g6kvj   1/1     Running   1          48m</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>killall5 -9</code> will send a kill signal to all processes on the pod, causing it
to shut down. Kubernetes brought it back up again as evidenced by RESTARTS
being equal to one. While the primary is restarting you will lose write
access, but the standbys will continue to provide read access. Once it is back
up (a matter of seconds), everything should be functioning as normal.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion_2">12.6. Conclusion</h3>
<div class="paragraph">
<p>Using Kubernetes we were able to quickly build a HA PostgreSQL cluster. This is
just the tip of the iceberg for what Kubernetes supports and as you learn more
about it you should be able to revisit and improve this implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_questions_12">12.7. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>A systems architect was using a stock Docker Hub image with a custom ENTRYPOINT point script she had designed. This required a Dockerfile, BASH script, and a directory to store them. When she migrated to Kubernetes she was able to do this all in one YAML file. Describe how this is possible.</em></p>
<p></p>
</li>
<li>
<p><em>Why are <strong>Services</strong> essential to replication?</em></p>
<p></p>
</li>
<li>
<p><em>Why do we define two <strong>Deployments</strong> for our example?</em></p>
<p></p>
</li>
<li>
<p><em>How can our database deployment be improved?</em></p>
<p></p>
</li>
<li>
<p><em>Compare and contrast Kubernetes PersistentVolumeClaims with Docker compose named volumes.</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_messaging_in_kubernetes">13. Messaging in Kubernetes</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/messaging.png" alt="messaging" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction_8">13.1. Introduction</h3>
<div class="paragraph">
<p>In this section we will build a RabbitMQ cluster in Kubernetes to support our
application.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rabbitmq">13.2. RabbitMQ</h3>
<div class="paragraph">
<p>RabbitMQ is built on Erlang/OTP, a platform designed in the telecom industry.
Given the nature of that industry, Erlang/OTP was designed to be highly scalable
and have strong concurrency support. In other words, it is the perfect platform
for building non-hierarchical, distributed applications. To give you an example
that you may be familiar with, Whatsapp runs on Erlang/OTP and it handles about
two million connected users per server.</p>
</div>
<div class="paragraph">
<p>All nodes in a RabbitMQ cluster are equal peers, there is no primary / standby
structure like we used in the database example. The <a href="https://raft.github.io/">
RAFT</a> consensus algorithm is used to make decisions for the cluster and as such,
it is <a href="https://www.rabbitmq.com/quorum-queues.html">highly recommended</a> that the
number of nodes be odd. Given the amount of traffic and the need for quick
communication, clustering is designed to function at the LAN level, not the WAN
level.</p>
</div>
<div class="paragraph">
<p>Messages in queues are <strong>not</strong> replicated by default, although that
<a href="https://www.rabbitmq.com/ha.html">can be turned on.</a> For us, this only really
matters for the <code>incoming</code> queue as our other queues are exclusive. Any node can
route requests through the node that happens to contain the <code>incoming</code> queue
and given the short nature of our connections this should function just fine.
It is also worth nothing that when a node joins a cluster, its state is reset.
Once again, given the nature of our connections this shouldn&#8217;t have much of an
impact on our application.</p>
</div>
<div class="paragraph">
<p>It is recommended that all nodes run the same version of Erlang/OTP. This
should be easy for us since our nodes will be built from the same image. Nodes
also need to have the same Erlang cookie (shared secret) so they can communicate
with each other securely. This can be passed via the <code>RABBITMQ_ERLANG_COOKIE</code>
environment variable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kubernetes_2">13.3. Kubernetes</h3>
<div class="paragraph">
<p>RabbitMQ has a peer discovery plugin for Kubernetes that is included with its
base image. It just needs to be enabled. RabbitMQ also provides a
<a href="https://github.com/rabbitmq/rabbitmq-peer-discovery-k8s/tree/master/examples">
repository</a> that demonstrates how to use it. This example will implement
something similar, but before we do, we need to go over some new Kubernetes
objects.</p>
</div>
<div class="paragraph">
<p>Our example will make use of
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/">
<strong>StatefulSets</strong></a>, which are similar to <strong>Deployments</strong> in that they use a template
to build pods. <strong>StatefulSets</strong> also maintain a unique, predictable, enumerated
name which in our case will be: <code>messaging-0</code>, <code>messaging-1</code>, <code>messaging-2</code>,
etc. Lastly, <strong>StatefulSets</strong> bring up their pods one-at-a-time, solving some
initialization / cluster-building problems we&#8217;ve encountered in the past.</p>
</div>
<div class="paragraph">
<p>The peer discovery plugin, rabbit_peer_discovery_k8s, uses the Kubernetes API to
find other nodes. Kubernetes uses Role Based Access Control (RBAC) by default to
grant permissions to use the Kubernetes API.  Therefore we will need to
configure a <strong>ServiceAccount</strong>, <strong>Role</strong>, and <strong>RoleBinding</strong> to allow the plugin to
make the requests it needs.</p>
</div>
<div class="paragraph">
<p>RabbitMQ requires that the hostnames of all cluster members be fully resolvable
via DNS. By setting up a <strong>Service</strong> we can let Kubernetes handle the hostname
resolution for us. While this isn&#8217;t new to us, for RabbitMQ it is important to
understand exactly how Kubernetes assigns fully qualified domain names (FQDN).
By default, it uses the form
<code>&lt;hostname&gt;.&lt;servicename&gt;.&lt;namespace&gt;.svc.cluster.local</code>. If you don&#8217;t specify
a namespace, you are working in the <code>default</code> namespace, therefore we could
expect the FQDN for the first node of our RabbitMQ cluster to be
<code>messaging-0.messaging.default.svc.cluster.local</code>.</p>
</div>
<div class="paragraph">
<p>To make things easier we will be using a
<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">
<strong>ConfigMap</strong></a> to store our custom configs for RabbitMQ. This allows us to put
our config files directly inside our YAML definitions and then mount them as
volumes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_5">13.4. Example</h3>
<div class="paragraph">
<p>Now we&#8217;ll look at our actual Kubernetes objects. These can be found in
<code>../example-final/messaging-k8s.yml</code>.</p>
</div>
<div class="sect3">
<h4 id="_rbac">13.4.1. RBAC</h4>
<div class="paragraph">
<p>Let&#8217;s start by establishing a <strong>ServiceAccount</strong> for our pods and binding it to a
<strong>Role</strong> that allows us to GET or LIST endpoints for a <strong>Service</strong>:</p>
</div>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: messaging

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: rabbitmq-peer-discovery-rbac
rules:
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: rabbitmq-peer-discovery-rbac
subjects:
  - kind: ServiceAccount
    name: messaging
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rabbitmq-peer-discovery-rbac</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>ServiceAccount</strong> <code>messaging</code> will be used in our <strong>StatefulSet</strong> so that when
a node is brought up, it can query the Kubernetes API to discover the other
nodes. You will see this process in the logs later.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configmap">13.4.2. <strong>ConfigMap</strong></h4>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
data:
  enabled_plugins: |
    [rabbitmq_management,rabbitmq_peer_discovery_k8s].
  rabbitmq.conf: |
    cluster_formation.peer_discovery_backend  = rabbit_peer_discovery_k8s
    cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
    cluster_formation.k8s.address_type = hostname
    cluster_formation.node_cleanup.interval = 30
    cluster_formation.node_cleanup.only_log_warning = true
    cluster_partition_handling = autoheal
    queue_master_locator=min-masters
    loopback_users.guest = false</code></pre>
</div>
</div>
<div class="paragraph">
<p>The keys and values in the <code>data</code> section of a <strong>ConfigMap</strong> are used to hold
information that is later placed in a file in a pod template. <strong>ConfigMaps</strong> are
mounted as volumes in the template as we will see in a moment.</p>
</div>
</div>
<div class="sect3">
<h4 id="_services_2">13.4.3. <strong>Services</strong></h4>
<div class="paragraph">
<p>We will use a <strong>Service</strong> for two purposes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To keep track of what nodes are in the RabbitMQ cluster. The
rabbit_peer_discovery_k8s plugin will use this when RabbitMQ is started on a
pod.</p>
</li>
<li>
<p>To load balance requests. We can send AMQP traffic <em>and</em> HTTP traffic to any
node for messaging and administrative interface purposes respectively.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: v1
kind: Service
metadata:
  name: messaging
  labels:
    app: messaging
spec:
  selector:
    app: messaging
  ports:
    - name: amqp
      protocol: TCP
      port: 5672
    - name: http
      protocol: TCP
      port: 15672</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a standard Kubernetes service that will be given a <code>ClusterIP</code> and will
load balance requests for port <code>5672</code> and <code>15672</code> (AMQP and RabbitMQ admin
interface, respectively).</p>
</div>
</div>
<div class="sect3">
<h4 id="_statefulset">13.4.4. <strong>StatefulSet</strong></h4>
<div class="listingblock">
<div class="title">example-final/messaging-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="YAML">---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: messaging
  labels:
    app: messaging
spec:
  serviceName: messaging
  replicas: 3
  selector:
    matchLabels:
      app: messaging
  template:
    metadata:
      labels:
        app: messaging
    spec:
      serviceAccountName: messaging
      containers:
        - name: rabbitmq
          image: rabbitmq:3.8.3-management
          env:
            - name: MY_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: RABBITMQ_USE_LONGNAME
              value: "true"
            - name: K8S_SERVICE_NAME
              value: messaging
            - name: K8S_HOSTNAME_SUFFIX
              value: .messaging.default.svc.cluster.local
            - name: RABBITMQ_NODENAME
              value: rabbit@$(MY_POD_NAME).messaging.default.svc.cluster.local
            - name: RABBITMQ_ERLANG_COOKIE
              value: "changeme"
          volumeMounts:
            - name: config-volume
              mountPath: /etc/rabbitmq
      volumes:
        - name: config-volume
          configMap:
            name: rabbitmq-config
            items:
              - key: rabbitmq.conf
                path: rabbitmq.conf
              - key: enabled_plugins
                path: enabled_plugins</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should look pretty similar to the <strong>Deployment</strong> we worked on
<a href="#_kubernetes">earlier</a>. It creates three replicas by default. Some new things
that it has introduced:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Environment variables can be pulled from Kubernetes parameters, see
<code>MY_POD_NAME</code> for an example.</p>
</li>
<li>
<p><strong>ConfigMaps</strong> can be mounted in a directory. The keys in the data section serve
as file names and the values service as the file contents.
<a href="https://yaml-multiline.info/">You may want to brush up on your YAML multiline
strings.</a></p>
</li>
<li>
<p>The environment variables <code>K8S_SERVICE_NAME</code> and <code>K8S_HOSTNAME_SUFFIX</code> are
used by the discovery plugin. If they are not defined it <em>will</em> fail.</p>
</li>
<li>
<p><code>serviceAccountName</code> is set to messaging to take advantage of our RBAC
configuration.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_example_2">13.4.5. Running the Example</h4>
<div class="paragraph">
<p>Let&#8217;s apply our system to a Kubernetes cluster and perform some analysis:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS <span class="se">\e</span>xample-final&gt; kubectl apply <span class="nt">-f</span> .<span class="se">\m</span>essaging-k8s.yml
serviceaccount/messaging created
role.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
rolebinding.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
configmap/rabbitmq-config created
service/messaging created
statefulset.apps/messaging created
PS C:<span class="se">\U</span>sers<span class="se">\r</span>xt1077<span class="se">\i</span>t490<span class="se">\e</span>xample-final&gt; kubectl get pod
NAME          READY   STATUS    RESTARTS   AGE
messaging-0   1/1     Running   0          4m2s
messaging-1   1/1     Running   0          4m1s
messaging-2   1/1     Running   0          4m</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, it brings up three pods. Unlike a <strong>Deployment</strong> which uses
hashes, the pod names are enumerated. Also unlink a <strong>Deployment</strong> they are
brought up one-at-a-time.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the logs and see how startup proceeded for <code>messaging-0</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS C:<span class="se">\U</span>sers<span class="se">\r</span>xt1077<span class="se">\i</span>t490<span class="se">\e</span>xample-final&gt; kubectl logs messaging-0
2020-04-11 18:38:08.118 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags: list of feature flags found:
2020-04-11 18:38:08.118 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> drop_unroutable_metric
&lt;snip&gt;
 cookie <span class="nb">hash</span>    : TLnIqASP0CKUR3/LGkEZGg<span class="o">==</span><i class="conum" data-value="1"></i><b>(1)</b>
&lt;snip&gt;
2020-04-11 18:38:08.301 <span class="o">[</span>info] &lt;0.278.0&gt; Node database directory at /var/lib/rabbitmq/mnesia/rabbit@messaging-0.messaging.default.svc.cluster.local is empty. Assuming we need to <span class="nb">join </span>an existing cluster or initialise from scratch...
2020-04-11 18:38:08.301 <span class="o">[</span>info] &lt;0.278.0&gt; Configured peer discovery backend: rabbit_peer_discovery_k8s
2020-04-11 18:38:08.301 <span class="o">[</span>info] &lt;0.278.0&gt; Will try to lock with peer discovery backend rabbit_peer_discovery_k8s
2020-04-11 18:38:08.301 <span class="o">[</span>info] &lt;0.278.0&gt; Peer discovery backend does not support locking, falling back to randomized delay
2020-04-11 18:38:08.301 <span class="o">[</span>info] &lt;0.278.0&gt; Peer discovery backend rabbit_peer_discovery_k8s supports registration.
2020-04-11 18:38:08.302 <span class="o">[</span>info] &lt;0.278.0&gt; Will <span class="nb">wait </span><span class="k">for </span>1638 milliseconds before proceeding with registration...<i class="conum" data-value="2"></i><b>(2)</b>
2020-04-11 18:38:09.975 <span class="o">[</span>info] &lt;0.278.0&gt; All discovered existing cluster peers: rabbit@messaging-2.messaging.default.svc.cluster.local, rabbit@messaging-1.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:09.975 <span class="o">[</span>info] &lt;0.278.0&gt; Peer nodes we can cluster with: rabbit@messaging-2.messaging.default.svc.cluster.local, rabbit@messaging-1.messaging.default.svc.cluster.local<i class="conum" data-value="3"></i><b>(3)</b>
2020-04-11 18:38:09.981 <span class="o">[</span>warning] &lt;0.278.0&gt; Could not auto-cluster with node rabbit@messaging-2.messaging.default.svc.cluster.local: <span class="o">{</span>error,mnesia_not_running<span class="o">}</span>
2020-04-11 18:38:09.985 <span class="o">[</span>warning] &lt;0.278.0&gt; Could not auto-cluster with node rabbit@messaging-1.messaging.default.svc.cluster.local: <span class="o">{</span>error,tables_not_present<span class="o">}</span>
2020-04-11 18:38:09.985 <span class="o">[</span>warning] &lt;0.278.0&gt; Could not successfully contact any node of: rabbit@messaging-2.messaging.default.svc.c
luster.local,rabbit@messaging-1.messaging.default.svc.cluster.local <span class="o">(</span>as <span class="k">in </span>Erlang distribution<span class="o">)</span><span class="nb">.</span> Starting as a blank standalone node...<i class="conum" data-value="4"></i><b>(4)</b>
&lt;snip&gt;
2020-04-11 18:38:11.041 <span class="o">[</span>info] &lt;0.9.0&gt; Server startup <span class="nb">complete</span><span class="p">;</span> 5 plugins started.
 <span class="k">*</span> rabbitmq_management
 <span class="k">*</span> rabbitmq_web_dispatch
 <span class="k">*</span> rabbitmq_management_agent
 <span class="k">*</span> rabbitmq_peer_discovery_k8s
 <span class="k">*</span> rabbitmq_peer_discovery_common
 completed with 5 plugins.
2020-04-11 18:38:11.650 <span class="o">[</span>info] &lt;0.535.0&gt; rabbit on node <span class="s1">'rabbit@messaging-2.messaging.default.svc.cluster.local'</span> up <i class="conum" data-value="5"></i><b>(5)</b>
2020-04-11 18:38:11.859 <span class="o">[</span>info] &lt;0.535.0&gt; rabbit on node <span class="s1">'rabbit@messaging-1.messaging.default.svc.cluster.local'</span> up</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This should match the cookie on the other nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This randomized wait could be optimized since we know we will start in
order. See the official example for a better implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Other peers were detected, but RabbitMQ was not fully initialized on them.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Therefore <code>messaging-0</code> became a standalone node.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Eventually the other nodes joined us.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the logs and see how startup proceeded for <code>messaging-1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl logs messaging-1
2020-04-11 18:38:09.658 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags: list of feature flags found:
2020-04-11 18:38:09.658 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> drop_unroutable_metric
2020-04-11 18:38:09.658 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> empty_basic_get_metric
&lt;snip&gt;
 cookie <span class="nb">hash</span>    : TLnIqASP0CKUR3/LGkEZGg<span class="o">==</span><i class="conum" data-value="1"></i><b>(1)</b>
&lt;snip&gt;
2020-04-11 18:38:09.790 <span class="o">[</span>info] &lt;0.278.0&gt; Node database directory at /var/lib/rabbitmq/mnesia/rabbit@messaging-1.messaging.default.svc.cluster.local is empty. Assuming we need to <span class="nb">join </span>an existing cluster or initialise from scratch...
2020-04-11 18:38:09.790 <span class="o">[</span>info] &lt;0.278.0&gt; Configured peer discovery backend: rabbit_peer_discovery_k8s
2020-04-11 18:38:09.791 <span class="o">[</span>info] &lt;0.278.0&gt; Will try to lock with peer discovery backend rabbit_peer_discovery_k8s
2020-04-11 18:38:09.791 <span class="o">[</span>info] &lt;0.278.0&gt; Peer discovery backend does not support locking, falling back to randomized delay
2020-04-11 18:38:09.791 <span class="o">[</span>info] &lt;0.278.0&gt; Peer discovery backend rabbit_peer_discovery_k8s supports registration.
2020-04-11 18:38:09.791 <span class="o">[</span>info] &lt;0.278.0&gt; Will <span class="nb">wait </span><span class="k">for </span>855 milliseconds before proceeding with registration...
2020-04-11 18:38:10.670 <span class="o">[</span>info] &lt;0.278.0&gt; All discovered existing cluster peers: rabbit@messaging-2.messaging.default.svc.cluster.local, rabbit@messaging-1.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:10.670 <span class="o">[</span>info] &lt;0.278.0&gt; Peer nodes we can cluster with: rabbit@messaging-2.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:10.673 <span class="o">[</span>warning] &lt;0.278.0&gt; Could not auto-cluster with node rabbit@messaging-2.messaging.default.svc.cluster.local: <span class="o">{</span>error,tables_not_present<span class="o">}</span>
2020-04-11 18:38:10.696 <span class="o">[</span>info] &lt;0.278.0&gt; Node <span class="s1">'rabbit@messaging-0.messaging.default.svc.cluster.local'</span> selected <span class="k">for </span>auto-clustering<i class="conum" data-value="2"></i><b>(2)</b>
&lt;snip&gt;
2020-04-11 18:38:12.118 <span class="o">[</span>info] &lt;0.9.0&gt; Server startup <span class="nb">complete</span><span class="p">;</span> 5 plugins started.
 <span class="k">*</span> rabbitmq_management
 <span class="k">*</span> rabbitmq_web_dispatch
 <span class="k">*</span> rabbitmq_management_agent
 <span class="k">*</span> rabbitmq_peer_discovery_k8s
 <span class="k">*</span> rabbitmq_peer_discovery_common
 completed with 5 plugins.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sure enough, our cookie is the same</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>messaging-0</code> is up an available for peering, but <code>messaging-1</code> is not. We
peered with <code>messaging-0</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s look at the logs and see how startup proceeded for <code>messaging-2</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl logs messaging-2
2020-04-11 18:38:10.155 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags: list of feature flags found:
2020-04-11 18:38:10.155 <span class="o">[</span>info] &lt;0.9.0&gt; Feature flags:   <span class="o">[</span> <span class="o">]</span> drop_unroutable_metric
&lt;snip&gt;
 cookie <span class="nb">hash</span>    : TLnIqASP0CKUR3/LGkEZGg<span class="o">==</span><i class="conum" data-value="1"></i><b>(1)</b>
&lt;snip&gt;
2020-04-11 18:38:10.279 <span class="o">[</span>info] &lt;0.287.0&gt; Configured peer discovery backend: rabbit_peer_discovery_k8s
2020-04-11 18:38:10.279 <span class="o">[</span>info] &lt;0.287.0&gt; Will try to lock with peer discovery backend rabbit_peer_discovery_k8s
2020-04-11 18:38:10.279 <span class="o">[</span>info] &lt;0.287.0&gt; Peer discovery backend does not support locking, falling back to randomized delay
2020-04-11 18:38:10.279 <span class="o">[</span>info] &lt;0.287.0&gt; Peer discovery backend rabbit_peer_discovery_k8s supports registration.
2020-04-11 18:38:10.279 <span class="o">[</span>info] &lt;0.287.0&gt; Will <span class="nb">wait </span><span class="k">for </span>598 milliseconds before proceeding with registration...
2020-04-11 18:38:10.891 <span class="o">[</span>info] &lt;0.287.0&gt; All discovered existing cluster peers: rabbit@messaging-2.messaging.default.svc.cluster.local, rabbit@messaging-1.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local
2020-04-11 18:38:10.891 <span class="o">[</span>info] &lt;0.287.0&gt; Peer nodes we can cluster with: rabbit@messaging-1.messaging.default.svc.cluster.local, rabbit@messaging-0.messaging.default.svc.cluster.local<i class="conum" data-value="2"></i><b>(2)</b>
2020-04-11 18:38:10.946 <span class="o">[</span>info] &lt;0.287.0&gt; Node <span class="s1">'rabbit@messaging-1.messaging.default.svc.cluster.local'</span> selected <span class="k">for </span>auto-clustering
&lt;snip&gt;
2020-04-11 18:38:12.009 <span class="o">[</span>info] &lt;0.9.0&gt; Server startup <span class="nb">complete</span><span class="p">;</span> 5 plugins started.
 <span class="k">*</span> rabbitmq_management
 <span class="k">*</span> rabbitmq_web_dispatch
 <span class="k">*</span> rabbitmq_management_agent
 <span class="k">*</span> rabbitmq_peer_discovery_k8s
 <span class="k">*</span> rabbitmq_peer_discovery_common</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Same cookie as all the other nodes, good.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>messaging-2</code> could peer with either <code>messaging-0</code> or <code>messaging-1</code> as it
was started last. It chose <code>messaging-1</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The last thing we can do is look at the output of <code>rabbitmqctl cluster_status</code>
to see how our cluster is running. Executing
<a href="https://www.rabbitmq.com/rabbitmqctl.8.html">this command</a> on any node will tell
you about the health of the entire RabbitMQ cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PS example-final&gt; kubectl <span class="nb">exec</span> <span class="nt">-it</span> messaging-0 <span class="nt">--</span> rabbitmqctl cluster_status
Cluster status of node rabbit@messaging-0.messaging.default.svc.cluster.local ...
Basics

Cluster name: rabbit@messaging-0.messaging.default.svc.cluster.local

Disk Nodes

rabbit@messaging-0.messaging.default.svc.cluster.local
rabbit@messaging-1.messaging.default.svc.cluster.local
rabbit@messaging-2.messaging.default.svc.cluster.local

Running Nodes

rabbit@messaging-0.messaging.default.svc.cluster.local
rabbit@messaging-1.messaging.default.svc.cluster.local
rabbit@messaging-2.messaging.default.svc.cluster.local

Versions

rabbit@messaging-0.messaging.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.1
rabbit@messaging-1.messaging.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.1
rabbit@messaging-2.messaging.default.svc.cluster.local: RabbitMQ 3.8.3 on Erlang 22.3.1

Alarms

<span class="o">(</span>none<span class="o">)</span>

Network Partitions

<span class="o">(</span>none<span class="o">)</span>

Listeners

Node: rabbit@messaging-0.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@messaging-0.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Node: rabbit@messaging-0.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@messaging-1.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@messaging-1.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Node: rabbit@messaging-1.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@messaging-2.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@messaging-2.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Node: rabbit@messaging-2.messaging.default.svc.cluster.local, interface: <span class="o">[</span>::], port: 15672, protocol: http, purpose: HTTP API

Feature flags

Flag: drop_unroutable_metric, state: enabled
Flag: empty_basic_get_metric, state: enabled
Flag: implicit_default_bindings, state: enabled
Flag: quorum_queue, state: enabled
Flag: virtual_host_metadata, state: enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>This shows us that there are three nodes, the nodes are all running the same
version of RabbitMQ and Erlang, and that they are listening for AMQP and admin
interface connections.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resources_9">13.5. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.rabbitmq.com/clustering.html">RabbitMQ Clustering Guide</a></p>
</li>
<li>
<p><a href="https://www.rabbitmq.com/cluster-formation.html">RabbitMQ Cluster Formation and Peer Discovery</a></p>
</li>
<li>
<p><a href="https://hub.docker.com/_/rabbitmq">RabbitMQ Documentation on Docker Hub</a></p>
</li>
<li>
<p><a href="https://github.com/rabbitmq/rabbitmq-peer-discovery-k8s/tree/master/examples">
Deploy RabbitMQ on Kubernetes with the Kubernetes Peer Discovery Plugin</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_13">13.6. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>What sets RabbitMQ clustering apart from more traditional primary / standby replication?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between a <strong>Deployment</strong> and a <strong>StatefulSet</strong>? Why did we choose a <strong>StatefulSet</strong> for this application?</em></p>
<p></p>
</li>
<li>
<p><em>Why does our peer discovery plugin use the Kubernetes API and what alternatives are there?</em></p>
<p></p>
</li>
<li>
<p><em>What role does RBAC play in the Kubernetes cluster?</em></p>
<p></p>
</li>
<li>
<p><em>What does a <strong>ConfigMap</strong> do and how is it used?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_front_end_in_kubernetes">14. Front End in Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_9">14.1. Introduction</h3>
<div class="paragraph">
<p>Migrating <strong>Front End</strong> to Kubernetes should be a relatively simple. It is already
designed with horizontal scaling in mind. All communication with the other
components is handled by <strong>Messaging</strong> and <strong>Front End</strong> does not maintain any
state. Multiple <strong>Front Ends</strong> can be run at the same time and as far as the
client is concerned, any instance can be used. Kubernetes <strong>Services</strong> can be used
to manage our <strong>Messaging</strong> and <strong>Front End</strong> instances, making connections easy:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/front-end-k8s.svg" alt="front end k8s" width="729" height="383">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice how the front-end instances don&#8217;t need to communicate with each
other unlike the messaging instances which are part of a cluster. This makes
scaling much less complex.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_kubernetes_3">14.2. Kubernetes</h3>
<div class="paragraph">
<p><strong>Front End</strong> requires a way of accessing a <strong>Service</strong> from the outside world. The
traditional way of doing this is through a load balancer, which has an external
IP and forwards traffic from a standard port, 80 for HTTP or 443 for HTTPS, to
the <strong>Service</strong> and ultimately one of the running pods. The concept of load
balancing isn&#8217;t new to us, we have been using it implicitly when we create a
<strong>Service</strong>. The new concept is a method of external access.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/loadbalancer.svg" alt="loadbalancer" width="734" height="438">
</div>
<div class="title">Figure 13. Load Balancer Architecture</div>
</div>
<div class="paragraph">
<p>Our Flask application will listen on port 5000 by default. In an actual
production environment (not minikube) the load balancer would be given an
external IP listening on a standard port. Minikube will support the definition
of a LoadBalancer type <strong>Service</strong> object, but it will actually use a slightly
simpler object called a
<a href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport">
NodePort</a> to access the service. For us, this means we can get to our service
via a local IP and a random port between 30000 and 32767. The
<code>minikube service</code> command will automatically open the URL for the service in
your default web browser.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_6">14.3. Example</h3>
<div class="sect3">
<h4 id="_updating_the_docker_image">14.3.1. Updating the Docker Image</h4>
<div class="paragraph">
<p>The Docker image for use in Kubernetes can actually be simplified from what we
were running before. We can remove the <code>wait-for-it.sh</code> script and we no longer
have to call it from the Dockerfile:</p>
</div>
<div class="listingblock">
<div class="title">example-final/front-end/Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> python:3.9.0a5-buster</span>
<span class="k">COPY</span><span class="s"> . /app</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
<span class="k">ENV</span><span class="s"> FLASK_APP=app.py</span>
<span class="k">CMD</span><span class="s"> ["flask", "run", "--host=0.0.0.0"]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our <strong>Service</strong> name for <strong>Messaging</strong> is still messaging, so we don&#8217;t even need
to change the hostname the Messaging class connects to. If you look at the
source code you will see that I just changed the comment to reference
Kubernetes instead of Docker Compose.</p>
</div>
</div>
<div class="sect3">
<h4 id="_building_the_docker_image">14.3.2. Building the Docker Image</h4>
<div class="paragraph">
<p>In order for Kubernetes to be able to use our custom image, we need to build it
and make it available to the Docker daemon running <em>inside</em> minikube. With
minikube started, but without the environment set up correctly, <code>docker ps</code>
will only show the containers you have running natively on the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>docker ps
<span class="go">CONTAINER ID  IMAGE                                COMMAND
9689f05c2fca  gcr.io/k8s-minikube/kicbase:v0.0.8   "/usr/local/bin/entr"</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this example the only container I have running is the container used
by the minikube <code>docker</code> driver. If you are running it under <code>virtualbox</code> or
<code>hyperv</code> you may not see any containers running. If you don&#8217;t have docker
running on your host, you may not even be able to execute the <code>docker ps</code>
command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now if we execute the <code>minikube docker-env</code> command and follow the directions,
<code>docker ps</code> should show the entire Kubernetes environment running in containers
as it is querying the Docker daemon running <em>inside</em> minikube:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>minikube docker-env <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">$</span>Env:DOCKER_TLS_VERIFY <span class="o">=</span> <span class="s2">"1"</span>
<span class="gp">$</span>Env:DOCKER_HOST <span class="o">=</span> <span class="s2">"tcp://127.0.0.1:32769"</span>
<span class="gp">$</span>Env:DOCKER_CERT_PATH <span class="o">=</span> <span class="s2">"C:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\r</span><span class="s2">xt1077</span><span class="se">\.</span><span class="s2">minikube</span><span class="se">\c</span><span class="s2">erts"</span>
<span class="gp">$</span>Env:MINIKUBE_ACTIVE_DOCKERD <span class="o">=</span> <span class="s2">"minikube"</span>
<span class="gp">#</span><span class="w"> </span>To point your shell to minikube<span class="s1">'s docker-daemon, run:
</span><span class="gp">#</span><span class="w"> </span><span class="s1">&amp; minikube -p minikube docker-env | Invoke-Expression <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span><span class="s1">minikube docker-env | Invoke-Expression <i class="conum" data-value="3"></i><b>(3)</b>
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span><span class="s1">docker ps <i class="conum" data-value="4"></i><b>(4)</b>
</span><span class="go">CONTAINER ID        IMAGE                  COMMAND                  CREATED
47eff1ee88b2        67da37a9a360           "/coredns -conf /etc"   15 hours ago
79d53aceb8f2        67da37a9a360           "/coredns -conf /etc"   15 hours ago
c0eebfebded2        aa67fec7d7ef           "/bin/kindnetd"          15 hours ago
b6a95759fdbe        43940c34f24f           "/usr/local/bin/kube"   15 hours ago
2173eeb16643        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
3b72a0aa725b        4689081edb10           "/storage-provisioner"   15 hours ago
4616fd610301        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
78e245e291fb        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
764d41d70f58        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
29f46b453297        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
fa87bf3bdcfb        a31f78c7c8ce           "kube-scheduler --au"   15 hours ago
5e51df5cc257        d3e55153f52f           "kube-controller-man"   15 hours ago
dc051639dbed        74060cea7f70           "kube-apiserver --ad"   15 hours ago
01cb4068fc8b        303ce5db0e90           "etcd --advertise-cl"   15 hours ago
efb620d9f59a        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
f723dce3ac9d        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
89d58b537cae        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago
d05cf6dbe82a        k8s.gcr.io/pause:3.2   "/pause"                 15 hours ago</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Running docker-env by itself prints out how the command should be executed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here it is telling us how to run it</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Now we actually run it as recommended and change the environment</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>docker ps</code> now lists everything running on the minikube docker daemon</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can build our front-end image and it will be available to minikube:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>docker build <span class="nt">-t</span> front-end:v1 ./front-end
<span class="go">Sending build context to Docker daemon  9.728kB
Step 1/6 : FROM python
latest: Pulling from library/python
7e2b2a5af8f6: Pull complete
09b6f03ffac4: Pull complete
dc3f0c679f0f: Pull complete
fd4b47407fc3: Pull complete
b32f6bf7d96d: Pull complete
3940e1b57073: Pull complete
ce1fce2a6cf9: Pull complete
1f593157bb4c: Pull complete
bde1ccd8f1b8: Pull complete
Digest: sha256:3df040cc8e804b731a9e98c82e2bc5cf3c979d78288c28df4f54bbdc18dbb521
Status: Downloaded newer image for python:latest
</span><span class="gp"> ---&gt;</span><span class="w"> </span>b55669b4130e
<span class="go">Step 2/6 : COPY . /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>b88600cc635a
<span class="go">Step 3/6 : WORKDIR /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>20bc72069ed8
<span class="go">Removing intermediate container 20bc72069ed8
</span><span class="gp"> ---&gt;</span><span class="w"> </span>61eb3608a02a
<span class="go">Step 4/6 : RUN pip install -r requirements.txt
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>da9520ffee48
<span class="go">Collecting Flask
  Downloading Flask-1.1.2-py2.py3-none-any.whl (94 kB)
Collecting pika
  Downloading pika-1.1.0-py2.py3-none-any.whl (148 kB)
</span><span class="gp">Collecting itsdangerous&gt;</span><span class="o">=</span>0.24
<span class="go">  Downloading itsdangerous-1.1.0-py2.py3-none-any.whl (16 kB)
</span><span class="gp">Collecting Werkzeug&gt;</span><span class="o">=</span>0.15
<span class="go">  Downloading Werkzeug-1.0.1-py2.py3-none-any.whl (298 kB)
</span><span class="gp">Collecting click&gt;</span><span class="o">=</span>5.1
<span class="go">  Downloading click-7.1.1-py2.py3-none-any.whl (82 kB)
</span><span class="gp">Collecting Jinja2&gt;</span><span class="o">=</span>2.10.1
<span class="go">  Downloading Jinja2-2.11.2-py2.py3-none-any.whl (125 kB)
</span><span class="gp">Collecting MarkupSafe&gt;</span><span class="o">=</span>0.23
<span class="go">  Downloading MarkupSafe-1.1.1-cp38-cp38-manylinux1_x86_64.whl (32 kB)
Installing collected packages: itsdangerous, Werkzeug, click, MarkupSafe, Jinja2, Flask, pika
Successfully installed Flask-1.1.2 Jinja2-2.11.2 MarkupSafe-1.1.1 Werkzeug-1.0.1 click-7.1.1 itsdangerous-1.1.0 pika-1.1.0
Removing intermediate container da9520ffee48
</span><span class="gp"> ---&gt;</span><span class="w"> </span>8d2f4da8b8b4
<span class="go">Step 5/6 : ENV FLASK_APP=app.py
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>4cdf7ad5a96e
<span class="go">Removing intermediate container 4cdf7ad5a96e
</span><span class="gp"> ---&gt;</span><span class="w"> </span>4b5853571124
<span class="go">Step 6/6 : CMD ["flask", "run", "--host=0.0.0.0"]
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>ff512bc5e42b
<span class="go">Removing intermediate container ff512bc5e42b
</span><span class="gp"> ---&gt;</span><span class="w"> </span>52ec5d015433
<span class="go">Successfully built 52ec5d015433
Successfully tagged front-end:v1</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure you give your image a tag with a version ("v1" in our
example). Kubernetes will automatically try to pull the "latest" version
for untagged images and since we are not using a Docker image repository
that pull will fail.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_service">14.3.3. Service</h4>
<div class="paragraph">
<p>Let&#8217;s take a look at our <strong>Service</strong> definition:</p>
</div>
<div class="listingblock">
<div class="title">example-final/front-end-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">front-end</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">front-end</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">front-end</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="s">5000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only new things in this definition are <code>type: LoadBalancer</code> in the <code>spec</code>
and <code>targetPort</code> in the <code>ports</code> list. This allows us to access this service
externally on port 80 and have it routed internally to port 5000 on one of the
pods. It is worth noting that in a real-life scenario, this will create a load
balancer with an external IP via your IaaS provider. These cost money and it can
add up as you expose more services to the outside world. Fortunately, as
explained in the previous <a href="#_kubernetes_3">Kubernetes</a> section, we can still use
minikube to test externally connecting to our service with the <code>minikube
service</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deployment">14.3.4. Deployment</h4>
<div class="paragraph">
<p>For <strong>Front End</strong> we can use a simple deployment:</p>
</div>
<div class="listingblock">
<div class="title">example-final/front-end-k8s.yml (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">front-end</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">front-end</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">front-end</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">front-end</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">front-end</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">front-end:v1</span>
          <span class="c1">#image: gcr.io/example-20200503/front-end:v1</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RABBITMQ_DEFAULT_USER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">guest"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RABBITMQ_DEFAULT_PASS</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">guest"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FLASK_SECRET_KEY</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">changeme"</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_example_3">14.3.5. Running the Example</h4>
<div class="paragraph">
<p>Now let&#8217;s apply both <strong>Messaging</strong> and <strong>Front End</strong>. This will let us check to see
if the <strong>Front End</strong> serves web pages <em>and</em> if the <strong>Front End</strong> can connect to
<strong>Messaging</strong> and create queues. We won&#8217;t be able to login / register users
entirely yet because we don&#8217;t have <strong>Back End</strong> running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl apply <span class="nt">-f</span> messaging-k8s.yml <span class="nt">-f</span> front-end-k8s.yml <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">serviceaccount/messaging created
role.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
rolebinding.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
configmap/rabbitmq-config created
service/messaging created
statefulset.apps/messaging created
service/front-end created
deployment.apps/front-end created
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl get pod <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">NAME                         READY   STATUS    RESTARTS   AGE
front-end-7f7c4f5455-6qbcx   1/1     Running   0          4h46m
front-end-7f7c4f5455-htdlv   1/1     Running   0          4h46m
front-end-7f7c4f5455-q2nn6   1/1     Running   0          4h46m
messaging-0                  1/1     Running   0          16m
messaging-1                  1/1     Running   0          16m
messaging-2                  1/1     Running   0          16m
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>minikube service front-end <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">|-----------|-----------|-------------|----------------------------|
| NAMESPACE |   NAME    | TARGET PORT |            URL             |
|-----------|-----------|-------------|----------------------------|
| default   | front-end | http/5000   | http://192.168.135.5:31232 |
|-----------|-----------|-------------|----------------------------|
* Opening service default/front-end in default browser...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>kubectl apply</code> command can be used with multiple files or all YAML
files in a directory. Here we specify the two components we want to start.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After a little while, you should see six pods running: three for
<strong>Messaging</strong> and three for <strong>Front End</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This command will start the default browser and pass it the URL to the
front-end <strong>Service</strong>. If you just want the URL instead of having it open the
browser you can use <code>kubectl service --url front-end</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you apply the objects, run the <code>kubectl get pod</code> command, and see
<code>ErrImagePull</code> or <code>ImagePullBackOff</code> it means that Kubernetes can&#8217;t pull your
Docker images. Either you&#8217;ve misnamed a stock image that in the <code>name</code>
attribute of your container, or you are trying to use a custom image that
you did not make available to minikube. See <a href="#_building_the_docker_image">Building the Docker Image</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If your connections are timing out with the <code>minikube service</code> command
and you are using the minikube <code>docker</code> driver, try with <code>hyperv</code> or
<code>virtualbox</code>. The <code>docker</code> driver seems to have some issues with port
forwarding.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We see our <strong>Front End</strong> website in our default browser. If we try to register
a user we get a message saying "No response from back end."</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to test things quickly, without opening a browser the
<a href="https://curl.haxx.se/">curl</a> command is a great thing to know. In PowerShell
curl is an alias to Invoke-WebRequest, but it will still work for simple
testing. Try <code>curl $(minikube service --url front-end)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s run a shell in our RabbitMQ cluster and use the <code>rabbitmqctl</code> command
to verify that a <code>requests</code> queue has actually been created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS C:\Users\rxt1077\it490\example-final&gt;</span><span class="w"> </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> messaging-0 <span class="nt">--</span> bash <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">root@messaging-0:/#</span><span class="w"> </span>rabbitmqctl list_queues
<span class="go">Timeout: 60.0 seconds ...
Listing queues for vhost / ...
name    messages
request 1 <i class="conum" data-value="2"></i><b>(2)</b>
</span><span class="gp">root@messaging-0:/#</span><span class="w"> </span><span class="nb">exit</span>
<span class="go">exit</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It doesn&#8217;t matter which node we run a shell on, they should all be able to
see all queues. I chose <code>messaging-0</code> because it is easy to remember.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>There is a request queue, with one message in it.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_questions_14">14.4. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>Why is it easier to set up <strong>Front End</strong> in Kubernetes than it is to set up <strong>Messaging</strong>?</em></p>
<p></p>
</li>
<li>
<p><em>What does a LoadBalancer type <strong>Service</strong> do?</em></p>
<p></p>
</li>
<li>
<p><em>When creating custom images for use with minikube, why do you have to set up your Docker environment variables before building images?</em></p>
<p></p>
</li>
<li>
<p><em>How do you make a <strong>Service</strong> accessible from outside the Kubernetes cluster?</em></p>
<p></p>
</li>
<li>
<p><em>If you wanted to use the RabbitMQ web-based admin interface for testing, what would you have to do to access it?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_back_end_in_kubernetes">15. Back End in Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last key to our Kubernetes migration is a functioning <strong>Back End</strong>. In this
section we will build the Kubernetes object (yes, singular) needed to support
this role.</p>
</div>
<div class="sect2">
<h3 id="_introduction_10">15.1. Introduction</h3>
<div class="paragraph">
<p><strong>Back End</strong> is our conduit between <strong>Messaging</strong> and <strong>Database</strong> and we have
implemented it as a Python script. Replicas of <strong>Back End</strong> can function
independently since messages can only be pulled off the queue one-at-a-time,
they are removed after they are pulled, and an exclusive response queue is
created for the response:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/backend-arch.svg" alt="backend arch" width="407" height="491">
</div>
<div class="title">Figure 14. <strong>Back End</strong> Architecture</div>
</div>
<div class="paragraph">
<p>In the above diagram two different <strong>Front Ends</strong> are communicating with
<strong>Messaging</strong>. Two different <strong>Back Ends</strong> are pulling requests (FE1, FE2, etc.)
out of the requests queue and processing them. Notice that each <strong>Front End</strong> has
a separate response queue (that can be derived from the message in the requests
queue). This architecture allows multiple <strong>Backends</strong> to run at the same time
without needing to be in communication with each other.</p>
</div>
<div class="paragraph">
<p>We do not need to learn about any new Kubernetes objects to migrate <strong>Back End</strong>.
It does not require an external connection to any port or even an internal
connection to a port, therefore a <strong>Service</strong> object isn&#8217;t even required.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_7">15.2. Example</h3>
<div class="paragraph">
<p>The only changes you will see in <strong>Back Ends</strong> application code is separating
database requests into read and read / write, to correspond to our
<a href="#_database_in_kubernetes">new load-balanced service</a>. Here is the new connect
sequence:</p>
</div>
<div class="listingblock">
<div class="title">example-final/back-end/app.py (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python">        <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Connecting to the read-only database..."</span><span class="p">)</span>
        <span class="n">postgres_password</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'POSTGRES_PASSWORD'</span><span class="p">]</span>
        <span class="n">conn_r</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s">'db-r'</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="s">'example'</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="s">'postgres'</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">postgres_password</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Connecting to the read-write database..."</span><span class="p">)</span>
        <span class="n">postgres_password</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'POSTGRES_PASSWORD'</span><span class="p">]</span>
        <span class="n">conn_rw</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s">'db-rw'</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="s">'example'</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="s">'postgres'</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">postgres_password</span>
        <span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes <code>curr_r</code>, <code>conn_r</code>, <code>curr_rw</code>, <code>conn_rw</code> available for read and
read / write requests respectively. <code>process_request</code> then uses correct
connection depending on the action:</p>
</div>
<div class="listingblock">
<div class="title">example-final/back-end/app.py (excerpted)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="s">"""
    Gets a request from the queue, acts on it, and returns a response to the
    reply-to queue
    """</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">'action'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">'message'</span><span class="p">:</span> <span class="s">"Request does not have action"</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">'action'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">'GETHASH'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">'data'</span><span class="p">]</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
            <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"GETHASH request for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s"> received"</span><span class="p">)</span>
            <span class="n">curr_r</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT hash FROM users WHERE email=%s;'</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,))</span>
            <span class="n">row</span> <span class="o">=</span>  <span class="n">curr_r</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">'hash'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s">'REGISTER'</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s">'data'</span><span class="p">]</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
            <span class="n">hashed</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'hash'</span><span class="p">]</span>
            <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">f"REGISTER request for </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s"> received"</span><span class="p">)</span>
            <span class="n">curr_r</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT * FROM users WHERE email=%s;'</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">curr_r</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'message'</span><span class="p">:</span> <span class="s">'User already exists'</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curr_rw</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'INSERT INTO users VALUES (%s, %s);'</span><span class="p">,</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">hashed</span><span class="p">))</span>
                <span class="n">conn_rw</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'message'</span><span class="p">:</span> <span class="s">"Unknown action"</span><span class="p">}</span>
    <span class="n">logging</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">ch</span><span class="p">.</span><span class="n">basic_publish</span><span class="p">(</span>
        <span class="n">exchange</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
        <span class="n">routing_key</span><span class="o">=</span><span class="n">properties</span><span class="p">.</span><span class="n">reply_to</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Dockerfile does not require any changes, but minikube does requires that an
image be built and available. The only object we need to create is a
<strong>Deployment</strong>:</p>
</div>
<div class="listingblock">
<div class="title">example-final/back-end-k8s.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">back-end</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">back-end</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">back-end</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">back-end</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">back-end</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">back-end:v1</span>
          <span class="c1">#image: gcr.io/example-20200503/back-end:v1</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RABBITMQ_DEFAULT_USER</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">guest"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RABBITMQ_DEFAULT_PASS</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">guest"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">POSTGRES_PASSWORD</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">changeme"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s build and tag our back-end:v1 image to make it available to minikube:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>minikube docker-env | Invoke-Expression <i class="conum" data-value="1"></i><b>(1)</b>
<span class="gp">PS example-final&gt;</span><span class="w"> </span><span class="nb">cd</span> .<span class="se">\b</span>ack-end<span class="se">\</span>
PS example-final<span class="se">\b</span>ack-end&gt; docker build <span class="nt">-t</span> back-end:v1 <span class="nb">.</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">Sending build context to Docker daemon  7.168kB
Step 1/5 : FROM python
</span><span class="gp"> ---&gt;</span><span class="w"> </span>b55669b4130e
<span class="go">Step 2/5 : COPY . /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>6aacbd4f55d8
<span class="go">Step 3/5 : WORKDIR /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>5f993e9c691d
<span class="go">Removing intermediate container 5f993e9c691d
</span><span class="gp"> ---&gt;</span><span class="w"> </span>c8b736fd9f9c
<span class="go">Step 4/5 : RUN pip install -r requirements.txt
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>f423d983860c
<span class="go">Collecting pika
  Downloading pika-1.1.0-py2.py3-none-any.whl (148 kB)
Collecting psycopg2
  Downloading psycopg2-2.8.5.tar.gz (380 kB)
Building wheels for collected packages: psycopg2
  Building wheel for psycopg2 (setup.py): started
  Building wheel for psycopg2 (setup.py): finished with status 'done'
  Created wheel for psycopg2: filename=psycopg2-2.8.5-cp38-cp38-linux_x86_64.whl size=500514 sha256=6a53ea80799efeaeb8f4aeec9b7e
b4d7fe0451d9efb02258f9a57801fa5d1b0a
  Stored in directory: /root/.cache/pip/wheels/35/64/21/9c9e2c1bb9cd6bca3c1b97b955615e37fd309f8e8b0b9fdf1a
Successfully built psycopg2
Installing collected packages: pika, psycopg2
Successfully installed pika-1.1.0 psycopg2-2.8.5
Removing intermediate container f423d983860c
</span><span class="gp"> ---&gt;</span><span class="w"> </span>af068e0b4647
<span class="go">Step 5/5 : CMD ["python", "app.py"]
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>969562a251ec
<span class="go">Removing intermediate container 969562a251ec
</span><span class="gp"> ---&gt;</span><span class="w"> </span>a1f03249f42c
<span class="go">Successfully built a1f03249f42c
Successfully tagged back-end:v1</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Don&#8217;t forget to have your environment set up to build for the minikube
docker daemon. I started a new terminal to run this, so I had to set up the
environment again.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Don&#8217;t forget to use a tag, back-end:v1 in this case.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we&#8217;ll apply our minikube objects for the <strong>Back End</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl apply <span class="nt">-f</span> .<span class="se">\b</span>ack-end-k8s.yml
<span class="go">deployment.apps/back-end created
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl get pod
<span class="go">NAME                         READY   STATUS             RESTARTS   AGE
back-end-7685957868-fbzqk    1/1     Running            0          3s
back-end-7685957868-t4n9x    1/1     Running            0          3s
back-end-7685957868-ws2ss    1/1     Running            0          3s
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl logs back-end-7685957868-fbzqk
<span class="go">INFO:root:Waiting 1s...
INFO:root:Connecting to the database...
INFO:root:Waiting 2s...
INFO:root:Connecting to the database...
INFO:root:Waiting 4s...
INFO:root:Connecting to the database...
INFO:root:Waiting 8s...
INFO:root:Connecting to the database...
INFO:root:Waiting 16s...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, it is waiting for <strong>Database</strong> to start up. Since we have all of
the components, why don&#8217;t we try bringing the entire system up?
<code>kubectl apply -f .</code> will apply <em>all</em> of the YAML files in the current
directory. Since we are using the <code>apply</code> command, only changes that are needed
to reach the state of the objects in the files will be made. Lastly, we need to
make sure that the <code>front-end:v1</code> image is built and available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>docker build <span class="nt">-t</span> front-end:v1 ./front-end
<span class="go">Sending build context to Docker daemon   16.9kB
Step 1/6 : FROM python
latest: Pulling from library/python
90fe46dd8199: Pull complete
35a4f1977689: Pull complete
bbc37f14aded: Pull complete
74e27dc593d4: Pull complete
4352dcff7819: Pull complete
deb569b08de6: Pull complete
98fd06fa8c53: Pull complete
7b9cc4fdefe6: Pull complete
e8e1fd64f499: Pull complete
Digest: sha256:adcfb73e4ca83b126cc3275f3851c73aecca20e59a48782e9ddebb3a88e57f96
Status: Downloaded newer image for python:latest
</span><span class="gp"> ---&gt;</span><span class="w"> </span>a6be143418fc
<span class="go">Step 2/6 : COPY . /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>d0441d56a485
<span class="go">Step 3/6 : WORKDIR /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>31809274a574
<span class="go">Removing intermediate container 31809274a574
</span><span class="gp"> ---&gt;</span><span class="w"> </span>4cd78efa655a
<span class="go">Step 4/6 : RUN pip install -r requirements.txt
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>7c1603cf2503
<span class="go">Collecting Flask
  Downloading Flask-1.1.2-py2.py3-none-any.whl (94 kB)
Collecting pika
  Downloading pika-1.1.0-py2.py3-none-any.whl (148 kB)
</span><span class="gp">Collecting Werkzeug&gt;</span><span class="o">=</span>0.15
<span class="go">  Downloading Werkzeug-1.0.1-py2.py3-none-any.whl (298 kB)
</span><span class="gp">Collecting Jinja2&gt;</span><span class="o">=</span>2.10.1
<span class="go">  Downloading Jinja2-2.11.2-py2.py3-none-any.whl (125 kB)
</span><span class="gp">Collecting click&gt;</span><span class="o">=</span>5.1
<span class="go">  Downloading click-7.1.1-py2.py3-none-any.whl (82 kB)
</span><span class="gp">Collecting itsdangerous&gt;</span><span class="o">=</span>0.24
<span class="go">  Downloading itsdangerous-1.1.0-py2.py3-none-any.whl (16 kB)
</span><span class="gp">Collecting MarkupSafe&gt;</span><span class="o">=</span>0.23
<span class="go">Installing collected packages: Werkzeug, MarkupSafe, Jinja2, click, itsdangerous, Flask, pika
Successfully installed Flask-1.1.2 Jinja2-2.11.2 MarkupSafe-1.1.1 Werkzeug-1.0.1 click-7.1.1 itsdangerous-1.1.0 pika-1.1.0
Removing intermediate container 7c1603cf2503
</span><span class="gp"> ---&gt;</span><span class="w"> </span>a6a9f8d6b40c
<span class="go">Step 5/6 : ENV FLASK_APP=app.py
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>008548ce7dfb
<span class="go">Removing intermediate container 008548ce7dfb
</span><span class="gp"> ---&gt;</span><span class="w"> </span>28fce011bbd3
<span class="go">Step 6/6 : CMD ["flask", "run", "--host=0.0.0.0"]
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>7adb0edc6b4e
<span class="go">Removing intermediate container 7adb0edc6b4e
</span><span class="gp"> ---&gt;</span><span class="w"> </span>34f3b5c20f75
<span class="go">Successfully built 34f3b5c20f75
Successfully tagged front-end:v1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can bring everything in the directory up with the <code>kubectl apply -f .</code>
command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS C:\Users\rxt1077\it490\example-final&gt;</span><span class="w"> </span>kubectl apply <span class="nt">-f</span> <span class="nb">.</span>
<span class="go">deployment.apps/back-end unchanged
persistentvolumeclaim/db-primary-pv-claim created
service/db-rw created
service/db-r created
deployment.apps/db-rw created
deployment.apps/db-r created
service/front-end created
deployment.apps/front-end created
serviceaccount/messaging created
role.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
rolebinding.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
configmap/rabbitmq-config created
service/messaging created
statefulset.apps/messaging created</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, running the <code>minikube service front-end</code> command should start the
default browser with the URL needed to access <strong>Front End</strong>. You can test
registering and logging in as a user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_questions_15">15.3. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>Why did we have to change the application code for <strong>Back End</strong>?</em></p>
<p></p>
</li>
<li>
<p><em>Why <em>doesn&#8217;t</em> <strong>Back End</strong> need a <strong>Service</strong>?</em></p>
<p></p>
</li>
<li>
<p><em>How do we make sure that the <code>back-end:v1</code> image is available to minikube?</em></p>
<p></p>
</li>
<li>
<p><em>What particular issues, with regard to the entire system, might horizontally scaling <strong>Back End</strong> help with?</em></p>
<p></p>
</li>
<li>
<p><em>How can you apply more than one YAML file with the <code>kubectl</code> command?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_google_kubernetes_engine">16. Google Kubernetes Engine</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="images/gke.svg" alt="gke" width="25%">
</div>
</div>
<div class="sect2">
<h3 id="_introduction_11">16.1. Introduction</h3>
<div class="paragraph">
<p>Several times over the course of this text you probably asked yourself, "Why
are we doing it this way?" Hopefully the chapters answered most of those
questions. This chapter hopes to answer the question, "Why did we migrate to
Kubernetes?" The answer being, "To create a scalable system that can be run on
enterprise-grade hardware." The best way to see what that looks like is to
actually do it.</p>
</div>
<div class="paragraph">
<p>In this chapter we will deploy our full system on Google Kubernetes Engine
(GKE). If you want to follow along with the examples on your own, you will need
to sign up for a <a href="https://cloud.google.com/gpc">Google Cloud login</a>. Please note
that while Google Cloud does have a <a href="https://cloud.google.com/free">free tier</a>,
you will still need to add a credit card to your account and <em>you can be charged
money for the services you use</em>. If you are worried about incurring an expense,
feel free to simply read through the examples.</p>
</div>
<div class="paragraph">
<p>Google Cloud provides many services that work with each other. We will be using
GKE and Google Container Registry (GCR) which in-turn will be using other
supporting services:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/google-cloud.svg" alt="google cloud" width="1041" height="340">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_gcloud">16.2. Setting up gcloud</h3>
<div class="paragraph">
<p>We will be doing as much of this is possible from the command line so we will
need to install a CLI to interact with Google Cloud. The <code>gcloud</code> command is
installed as part of the Google Cloud SDK. Install it using the
<a href="https://cloud.google.com/sdk/docs/downloads-interactive">Google Cloud SDK
Interactive Installer</a> and follow the prompts to run <code>gcloud init</code> once it is
installed (this is the default).</p>
</div>
<div class="paragraph">
<p>The init procedure will open the default browser and prompt you to sign in with
a Google account.  Once authenticated, you can refer back to the terminal it
opened and <code>Create a new project</code>, with any unique name you can think of. The
project id <em>must be globally unique</em>, so you may want to use a timestamp as part
of your ID: <code>example-2020428</code>.</p>
</div>
<div class="paragraph">
<p>Now that we have gcloud installed and we have a project, we need to specify
what zone/region we would like to use for the project. Google Cloud has
<a href="https://cloud.google.com/compute/docs/regions-zones#available">many geographic
regions with multiple zones available</a> depending on where you are expecting
your application to be used and what you&#8217;re computer needs are, respectively.
In this example we will set it to <code>us-central1-c</code> with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>gcloud config <span class="nb">set </span>compute/zone us-central1-c
<span class="go">Updated property [compute/zone].</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s try to add a Kubernetes cluster named <code>example</code> and see what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>gcloud container clusters create example
<span class="go">WARNING: Currently VPC-native is not the default mode during cluster creation. In the future, this will become the default mode
and can be disabled using `--no-enable-ip-alias` flag. Use `--[no-]enable-ip-alias` flag to suppress this warning.
WARNING: Newly created clusters and node-pools will have node auto-upgrade enabled by default. This can be disabled using the `-
-no-enable-autoupgrade` flag.
WARNING: Starting with version 1.18, clusters will have shielded GKE nodes by default.
WARNING: Your Pod address range (`--cluster-ipv4-cidr`) can accommodate at most 1008 node(s).
This will enable the autorepair feature for nodes. Please see https://cloud.google.com/kubernetes-engine/docs/node-auto-repair f
or more information on node autorepairs.
ERROR: (gcloud.container.clusters.create) ResponseError: code=403, message=Kubernetes Engine API is not enabled for this project
. Please ensure it is enabled in Google Cloud Console and try again: visit https://console.cloud.google.com/apis/api/container.g
oogleapis.com/overview?project=example-20200428 to do so.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the directions in the error, visit the URL specified (it will be
different depending on your project name), and enable the GKE API for this
project.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure you are signed in with the Google account that you linked to
Google Cloud. If you want to be certain, you can open an incognito / private
browsing tab and paste the URL in there. That will force you to have to log in.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once we&#8217;ve enabled the GKE API, let&#8217;s try our <code>create cluster</code> command again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>gcloud container clusters create example
<span class="go">WARNING: Currently VPC-native is not the default mode during cluster creation. In the future, this will become the default mode
and can be disabled using `--no-enable-ip-alias` flag. Use `--[no-]enable-ip-alias` flag to suppress this warning.
WARNING: Newly created clusters and node-pools will have node auto-upgrade enabled by default. This can be disabled using the `-
-no-enable-autoupgrade` flag.
WARNING: Starting with version 1.18, clusters will have shielded GKE nodes by default.
WARNING: Your Pod address range (`--cluster-ipv4-cidr`) can accommodate at most 1008 node(s).
This will enable the autorepair feature for nodes. Please see https://cloud.google.com/kubernetes-engine/docs/node-auto-repair f
or more information on node autorepairs.
Creating cluster example in us-central1-c... Cluster is being health-checked (master is healthy)...done.
Created [https://container.googleapis.com/v1/projects/example-20200428/zones/us-central1-c/clusters/example].
To inspect the contents of your cluster, go to: https://console.cloud.google.com/kubernetes/workload_/gcloud/us-central1-c/examp
le?project=example-20200428
kubeconfig entry generated for example.
NAME     LOCATION       MASTER_VERSION  MASTER_IP       MACHINE_TYPE   NODE_VERSION    NUM_NODES  STATUS
example  us-central1-c  1.14.10-gke.27  35.223.164.188  n1-standard-1  1.14.10-gke.27  3          RUNNING</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our last step will be setting up Docker to use our gcloud credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>gcloud auth configure-docker
<span class="go">Adding credentials for all GCR repositories.
WARNING: A long list of credential helpers may cause delays running 'docker build'. We recommend passing the registry name to co
nfigure only the registry you are using.
After update, the following will be written to your Docker config file
 located at [.docker\config.json]:
 {
  "credHelpers": {
    "gcr.io": "gcloud",
    "marketplace.gcr.io": "gcloud",
    "eu.gcr.io": "gcloud",
    "us.gcr.io": "gcloud",
    "staging-k8s.gcr.io": "gcloud",
    "asia.gcr.io": "gcloud"
  }
}

Do you want to continue (Y/n)?  Y

Docker configuration file updated.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Congratulations! You&#8217;ve now downloaded and installed gcloud and built your first
cluster in Google Cloud. From here on, we will be working with more familiar
utilities: kubectl and Docker.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pushing_images">16.3. Pushing Images</h3>
<div class="paragraph">
<p>Unlike minikube, which we set up to use images from its native Docker daemon
(remember <code>minikube docker-env</code>?), GKE expects to be able to pull custom images
from an actual repository. Since we&#8217;re already using Google Cloud, it makes
sense to push our custom images to
<a href="https://cloud.google.com/container-registry">GCR</a>. Here is how we do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>docker build <span class="nt">-t</span> gcr.io/example-20200428/front-end:v1 ./front-end/ <i class="conum" data-value="1"></i><b>(1)</b>
<span class="go">Sending build context to Docker daemon   16.9kB
Step 1/6 : FROM python:3.9.0a5-buster
3.9.0a5-buster: Pulling from library/python
90fe46dd8199: Pull complete
35a4f1977689: Pull complete
bbc37f14aded: Pull complete
74e27dc593d4: Pull complete
4352dcff7819: Pull complete
deb569b08de6: Pull complete
c7360a3495cf: Pull complete
f58442eaf6a4: Pull complete
617f2eb777a8: Pull complete
Digest: sha256:f7251883daa3d6484055af80ebcd72f083d58de9276ee772d95d2dc50e0ea951
Status: Downloaded newer image for python:3.9.0a5-buster
</span><span class="gp"> ---&gt;</span><span class="w"> </span>b5f66cb660dd
<span class="go">Step 2/6 : COPY . /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>f288da00c29c
<span class="go">Step 3/6 : WORKDIR /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>40540d7524d3
<span class="go">Removing intermediate container 40540d7524d3
</span><span class="gp"> ---&gt;</span><span class="w"> </span>1da446e063c3
<span class="go">Step 4/6 : RUN pip install -r requirements.txt
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>0873978faef8
<span class="go">Collecting Flask
  Downloading Flask-1.1.2-py2.py3-none-any.whl (94 kB)
Collecting pika
  Downloading pika-1.1.0-py2.py3-none-any.whl (148 kB)
</span><span class="gp">Collecting Werkzeug&gt;</span><span class="o">=</span>0.15
<span class="go">  Downloading Werkzeug-1.0.1-py2.py3-none-any.whl (298 kB)
</span><span class="gp">Collecting Jinja2&gt;</span><span class="o">=</span>2.10.1
<span class="go">  Downloading Jinja2-2.11.2-py2.py3-none-any.whl (125 kB)
</span><span class="gp">Collecting click&gt;</span><span class="o">=</span>5.1
<span class="go">  Downloading click-7.1.2-py2.py3-none-any.whl (82 kB)
</span><span class="gp">Collecting itsdangerous&gt;</span><span class="o">=</span>0.24
<span class="go">  Downloading itsdangerous-1.1.0-py2.py3-none-any.whl (16 kB)
</span><span class="gp">Collecting MarkupSafe&gt;</span><span class="o">=</span>0.23
<span class="go">  Downloading MarkupSafe-1.1.1.tar.gz (19 kB)
Building wheels for collected packages: MarkupSafe
  Building wheel for MarkupSafe (setup.py): started
  Building wheel for MarkupSafe (setup.py): finished with status 'done'
  Created wheel for MarkupSafe: filename=MarkupSafe-1.1.1-cp39-cp39-linux_x86_64.whl size=32073 sha256=ff3d6994faed1b54ea40c09ef
64f972aec74cb3f3d77fbdc55335143c959bcea
  Stored in directory: /root/.cache/pip/wheels/e0/19/6f/6ba857621f50dc08e084312746ed3ebc14211ba30037d5e44e
Successfully built MarkupSafe
Installing collected packages: Werkzeug, MarkupSafe, Jinja2, click, itsdangerous, Flask, pika
Successfully installed Flask-1.1.2 Jinja2-2.11.2 MarkupSafe-1.1.1 Werkzeug-1.0.1 click-7.1.2 itsdangerous-1.1.0 pika-1.1.0
Removing intermediate container 0873978faef8
</span><span class="gp"> ---&gt;</span><span class="w"> </span>d77de60ef20e
<span class="go">Step 5/6 : ENV FLASK_APP=app.py
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>d8af1dd55084
<span class="go">Removing intermediate container d8af1dd55084
</span><span class="gp"> ---&gt;</span><span class="w"> </span>69ae9b270fb9
<span class="go">Step 6/6 : CMD ["flask", "run", "--host=0.0.0.0"]
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>c7c300db2f56
<span class="go">Removing intermediate container c7c300db2f56
</span><span class="gp"> ---&gt;</span><span class="w"> </span>a8f79c7b4cd1
<span class="go">Successfully built a8f79c7b4cd1
Successfully tagged gcr.io/example-20200428/front-end:v1
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>docker push gcr.io/example-20200428/front-end:v1 <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">The push refers to repository [gcr.io/example-20200428/front-end]
aae3053b9026: Pushed
07a7dd71e46e: Pushed
62cc2f2db459: Pushed
f3f43710db31: Pushed
e68e29bcc308: Pushed
baf481fca4b7: Layer already exists
3d3e92e98337: Layer already exists
8967306e673e: Layer already exists
9794a3b3ed45: Layer already exists
5f77a51ade6a: Layer already exists
e40d297cf5f8: Layer already exists
v1: digest: sha256:ab9c121705a4f4c47b7e32012d13da96cf0e8e2bc807c49a37b04c2099c7fb2e size: 2636
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>docker build <span class="nt">-t</span> gcr.io/example-20200428/back-end:v1 ./back-end/ <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">Sending build context to Docker daemon   7.68kB
Step 1/5 : FROM python:3.9.0a5-buster
</span><span class="gp"> ---&gt;</span><span class="w"> </span>b5f66cb660dd
<span class="go">Step 2/5 : COPY . /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>a8faf7d98529
<span class="go">Step 3/5 : WORKDIR /app
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>385122bd0d0e
<span class="go">Removing intermediate container 385122bd0d0e
</span><span class="gp"> ---&gt;</span><span class="w"> </span>7e517e6b75b1
<span class="go">Step 4/5 : RUN pip install -r requirements.txt
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>a28a17d13909
<span class="go">Collecting pika
  Downloading pika-1.1.0-py2.py3-none-any.whl (148 kB)
Collecting psycopg2
  Downloading psycopg2-2.8.5.tar.gz (380 kB)
Building wheels for collected packages: psycopg2
  Building wheel for psycopg2 (setup.py): started
  Building wheel for psycopg2 (setup.py): finished with status 'done'
  Created wheel for psycopg2: filename=psycopg2-2.8.5-cp39-cp39-linux_x86_64.whl size=498130 sha256=6a715ba7fcf21deca5712a1e404c
51b1b0168ad64c7612890f30935845a6562f
  Stored in directory: /root/.cache/pip/wheels/c2/17/82/f619fa1d1a361445c4ff28634f734936f2d54891c79840b345
Successfully built psycopg2
Installing collected packages: pika, psycopg2
Successfully installed pika-1.1.0 psycopg2-2.8.5
Removing intermediate container a28a17d13909
</span><span class="gp"> ---&gt;</span><span class="w"> </span>53827a4ffaea
<span class="go">Step 5/5 : CMD ["python", "app.py"]
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>5aef1da46ef1
<span class="go">Removing intermediate container 5aef1da46ef1
</span><span class="gp"> ---&gt;</span><span class="w"> </span>65c9dfe66eb8
<span class="go">Successfully built 65c9dfe66eb8
Successfully tagged gcr.io/example-20200428/back-end:v1
</span><span class="gp">PS C:\Users\rxt1077\it490\example-final&gt;</span><span class="w"> </span>docker push gcr.io/example-20200428/back-end:v1 <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">The push refers to repository [gcr.io/example-20200428/back-end]
303c8c71682c: Pushed
50f2e9234064: Pushed
62cc2f2db459: Layer already exists
f3f43710db31: Layer already exists
e68e29bcc308: Layer already exists
baf481fca4b7: Layer already exists
3d3e92e98337: Layer already exists
8967306e673e: Layer already exists
9794a3b3ed45: Layer already exists
5f77a51ade6a: Layer already exists
e40d297cf5f8: Layer already exists
v1: digest: sha256:9446a3d91fa555a84457e51ba2ac3b8e2821f31a531ab21d0e85cd9e37e11dbb size: 2636</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Build/tag the front-end image for GCR. Notice how we use the project-id.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Push the front-end image.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Build/tag the back-end image for GCR.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Push the back-end image.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will also need to change the <code>image</code> mapping to point to the image on GCR in
<code>back-end-k8s.yml</code> and <code>front-end-k8s.yml</code>. You can see them there, commented
out, if you check the source repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_objects">16.4. Creating Objects</h3>
<div class="paragraph">
<p>At this point, we should have access to two Kubernetes clusters: our local
minikube cluster and a cluster we created in Google Cloud called <code>example</code>.
Fortunately for us, gcloud has already configured our
<a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">
kubeconfig</a> file for access to the <code>example</code> cluster. kubectl refers to these
different clusters as <code>contexts</code> and we can see what is available with the
following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl config get-contexts
<span class="go">CURRENT NAME                                       CLUSTER
*       gke_example-20200428_us-central1-c_example gke_example-20200428_us-central1-c_example<i class="conum" data-value="1"></i><b>(1)</b>
        minikube                                   minikube</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We are currently using the Google Cloud context, but if you need to switch
contexts, you can use the <code>kubectl config use-context</code> command.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ve already pushed our images to GCR and updated the <strong>Front End</strong> and
<strong>Back End</strong> objects to reflect that. Now all we need to do to create objects is
use the kubectl commands we&#8217;re familiar with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl get pod
<span class="go">No resources found in default namespace. <i class="conum" data-value="1"></i><b>(1)</b>
</span><span class="gp">PS C:\Users\rxt1077\it490\example-final&gt;</span><span class="w"> </span>kubectl apply <span class="nt">-f</span> <span class="nb">.</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="go">deployment.apps/back-end created
persistentvolumeclaim/db-primary-pv-claim created
service/db-rw created
service/db-r created
deployment.apps/db-rw created
deployment.apps/db-r created
service/front-end created
deployment.apps/front-end created
serviceaccount/messaging created
role.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
rolebinding.rbac.authorization.k8s.io/rabbitmq-peer-discovery-rbac created
configmap/rabbitmq-config created
service/messaging created
statefulset.apps/messaging created
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl get pod <i class="conum" data-value="3"></i><b>(3)</b>
<span class="go">NAME                         READY   STATUS    RESTARTS   AGE
back-end-84cd7447d-6j7b7     1/1     Running   0          5s
back-end-84cd7447d-lthqc     1/1     Running   0          5s
back-end-84cd7447d-vlrqz     1/1     Running   0          5s
db-r-5b9977874b-ghj54        1/1     Running   2          13m
db-r-5b9977874b-ngbs5        1/1     Running   2          13m
db-rw-7755dddd76-f9krt       1/1     Running   0          13m
front-end-856bc468cc-dddh4   1/1     Running   0          13m
front-end-856bc468cc-f9ltq   1/1     Running   0          13m
front-end-856bc468cc-rm6dg   1/1     Running   0          13m
messaging-0                  1/1     Running   0          13m
messaging-1                  1/1     Running   0          13m
messaging-2                  1/1     Running   0          13m
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>kubectl get service <i class="conum" data-value="4"></i><b>(4)</b>
<span class="go">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)              AGE
</span><span class="gp">db-r         ClusterIP      10.47.242.137   &lt;none&gt;</span><span class="w">          </span>5432/TCP             14m
<span class="gp">db-rw        ClusterIP      10.47.252.2     &lt;none&gt;</span><span class="w">          </span>5432/TCP             14m
<span class="go">front-end    LoadBalancer   10.47.244.185   35.238.67.247   80:30337/TCP         14m <i class="conum" data-value="5"></i><b>(5)</b>
</span><span class="gp">kubernetes   ClusterIP      10.47.240.1     &lt;none&gt;</span><span class="w">          </span>443/TCP              21m
<span class="gp">messaging    ClusterIP      10.47.253.17    &lt;none&gt;</span><span class="w">          </span>5672/TCP,15672/TCP   14m</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Checking to see what is running initially shows that there are no pods on
our cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Applying all of the YAML files in our current, <code>example-final</code>, directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Running <code>kubectl get pod</code> shows all our replicated components.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Checking to see what services are running</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The only external, LoadBalancer, service is <code>front-end</code>. A quick visit to
<a href="http://35.238.67.247" class="bare">http://35.238.67.247</a> will give you front-end access to the
system.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We now have a scalable system running on enterprise-grade hardware.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cleaning_up">16.5. Cleaning Up</h3>
<div class="paragraph">
<p>Don&#8217;t forget that Google Cloud is not a free platform. While we do have free
credits to experiment with, the compute and storage resources that we are using
are very real. Once we are done, we have to remember to delete our cluster and
the resources that our project uses. That can be done with the following
commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">PS example-final&gt;</span><span class="w"> </span>gcloud container clusters delete example
<span class="go">The following clusters will be deleted.
 - [example] in [us-central1-c]

Do you want to continue (Y/n)?

Deleting cluster example...done.
Deleted [https://container.googleapis.com/v1/projects/example-20200428/zones/us-central1-c/clusters/example].
</span><span class="gp">PS example-final&gt;</span><span class="w"> </span>gcloud projects delete example-20200428
<span class="go">Your project will be deleted.

Do you want to continue (Y/n)?  Y

Deleted [https://cloudresourcemanager.googleapis.com/v1/projects/example-20200428].

You can undo this operation for a limited period by running the command below.
</span><span class="gp">    $</span><span class="w"> </span>gcloud projects undelete example-20200428
<span class="go">
See https://cloud.google.com/resource-manager/docs/creating-managing-projects for information on shutting down projects.</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resources_10">16.6. Resources</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/quickstart">Google Kubernetes
Engine Quickstart</a></p>
</li>
<li>
<p><a href="https://cloud.google.com/sdk/docs/downloads-interactive">Google Cloud SDK
Interactive Installer</a></p>
</li>
<li>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl">
Configuring cluster access for kubectl</a></p>
</li>
<li>
<p><a href="https://cloud.google.com/container-registry/docs/pushing-and-pulling">Pushing
and pulling images</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_questions_16">16.7. Questions</h3>
<div class="qlist qanda">
<ol>
<li>
<p><em>Name at least two Google Cloud services that GKE uses.</em></p>
<p></p>
</li>
<li>
<p><em>What does GCR do and why does GKE use it?</em></p>
<p></p>
</li>
<li>
<p><em>What is the difference between the gcloud and kubectl commands?</em></p>
<p></p>
</li>
<li>
<p><em>Compare and contrast the gcloud and minikube commands.</em></p>
<p></p>
</li>
<li>
<p><em>In the output for <code>kubectl get service</code>, why is <code>front-end</code> the only service with an external IP?</em></p>
<p></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. If you&#8217;re looking to take things a bit further <a href="https://asciidoctor.org/docs/asciidoc-writers-guide/">AsciiDoc</a>, <a href="https://docutils.sourceforge.io/rst.html">reStructuredText</a>, and <a href="https://docs.racket-lang.org/scribble/">scribble</a> are worth exploring too. This book is written in AsciiDoc.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://medium.com/@maumribeiro/running-your-own-docker-images-in-minikube-for-windows-ea7383d931f6"> See this great blog post for more details</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://platform9.com/blog/tutorial-dynamic-provisioning-of-persistent-storage-in-kubernetes-with-minikube"> The fascinating details of how this works are revealed in this blog post.</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. By the time you&#8217;re reading this, this site should be unavailable. If it&#8217;s still available, let me know because it&#8217;s costing me money!
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-05-26 21:32:28 -0400
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>